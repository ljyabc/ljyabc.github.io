<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="01.Nginx基础Http原理1.Http协议概述HTTP全称HyperText Transfer Protocol中文名为超文本传输协议 1.什么是超文本? 包含有超链接(Link)和各种多媒体元素标记的文本。这些超文本文件彼此链接，形成网状(Web)，因此又被称为网页(Web Page)。这些链接使用URL表示。最常见的超文本格式是超文本标记语言HTML。  html文件-&amp;gt;包含各种各">
<meta name="keywords" content="代理服务">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx高级">
<meta property="og:url" content="https://ljyabc.github.io/2025/04/08/nginx高级/index.html">
<meta property="og:site_name" content="择墅居:李江洋">
<meta property="og:description" content="01.Nginx基础Http原理1.Http协议概述HTTP全称HyperText Transfer Protocol中文名为超文本传输协议 1.什么是超文本? 包含有超链接(Link)和各种多媒体元素标记的文本。这些超文本文件彼此链接，形成网状(Web)，因此又被称为网页(Web Page)。这些链接使用URL表示。最常见的超文本格式是超文本标记语言HTML。  html文件-&amp;gt;包含各种各">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15332019122445.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/2018-10-11-15392584112083.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/2018-10-11-15392586458477.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15332030834441.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15437656930280.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15387461326148.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15438271468263.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15443636497710.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15443641844997.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15443658141286.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15443663820104.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15443659980121.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15443656285476.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15403801758720.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15427289498863.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15245396916857.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15427844051466.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15474508101457.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15403843143144.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225664326245.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225665571756.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225666163228.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225666862893.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225667481528.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225667635141.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225668466175.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225681757457.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225681916241.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225684171105.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225684446008.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15225684700848.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15428787548940.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15432286714848.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15439294311862.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15239420127242.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15427999258261.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15378036144456.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15428029782740.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15428030503929.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15427911480446.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15427930199904.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15388903914496.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15241531083453.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15241533422852.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15241533901974.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15241534612860.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15241535185103.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15242015035436.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15242013807100.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15242016134675.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15378065298018.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15239542175571.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15239534300637.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15239536246178.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15378071410074.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15388917816881.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15388917904538.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15474556169486.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15474561465676.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15458176984471.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15458179007791.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15432145274991.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15388909626532.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15388909196129.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15380382983622.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15380383555722.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15380383842331.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15380384613416.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15380385494628.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15433176983763.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15433175379655.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15433176717221.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15433256817089.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15433246260118.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15433263413643.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15433266834755.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15433268185373.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15433268889462.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15483458976370.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15483459635184.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15433209333857.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15433221479695.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15392608988224.jpg?imageView2/0/q/75%7Cwatermark/2/text/d3d3Lnh1bGlhbmd3ZWkuY29t/font/5qW35L2T/fontsize/400/fill/I0Y4MEEwQQ==/dissolve/100/gravity/SouthEast/dx/25/dy/25%7Cimageslim">
<meta property="og:image" content="http://cdn.xuliangwei.com/15241223412056.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15241221586628.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15241222179952.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15241227477621.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15241238662546.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15241239372426.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15241249792088.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15241258755067.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15392608988224.jpg?imageView2/0/q/75%7Cwatermark/2/text/d3d3Lnh1bGlhbmd3ZWkuY29t/font/5qW35L2T/fontsize/400/fill/I0Y4MEEwQQ==/dissolve/100/gravity/SouthEast/dx/25/dy/25%7Cimageslim">
<meta property="og:image" content="http://cdn.xuliangwei.com/15486014538664.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15486015004226.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15486016099496.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15343385261215.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/1551715068138.png">
<meta property="og:image" content="http://cdn.xuliangwei.com/15135014773236.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15437571296661.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15437571977645.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15501103467175.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15501550306679.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15239378783506.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15238172798743.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15238174255523.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15238178566448.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15238178751169.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15501375442639.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15501377714379.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15501389407353.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15238200686278.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15501542901544.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15501544412616.jpg">
<meta property="og:image" content="http://cdn.xuliangwei.com/15134382581864.jpg">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/1551715154946.png">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/1551715186038.png">
<meta property="og:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/1551715198534.png">
<meta property="og:image" content="http://docs.etiantian.org/media/15474544342637/15487157044671.jpg">
<meta property="og:image" content="http://docs.etiantian.org/media/15474544342637/15487159641102.jpg">
<meta property="og:updated_time" content="2025-04-08T14:37:44.648Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx高级">
<meta name="twitter:description" content="01.Nginx基础Http原理1.Http协议概述HTTP全称HyperText Transfer Protocol中文名为超文本传输协议 1.什么是超文本? 包含有超链接(Link)和各种多媒体元素标记的文本。这些超文本文件彼此链接，形成网状(Web)，因此又被称为网页(Web Page)。这些链接使用URL表示。最常见的超文本格式是超文本标记语言HTML。  html文件-&amp;gt;包含各种各">
<meta name="twitter:image" content="https://ljyabc.github.io/2025/04/08/nginx高级/15332019122445.jpg">






  <link rel="canonical" href="https://ljyabc.github.io/2025/04/08/nginx高级/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>nginx高级 | 择墅居:李江洋</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">择墅居:李江洋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">争做长沙别墅豪装第一品牌</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-schedule">

    
    
    
      
    

    

    <a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>日程表</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-book">

    
    
    
      
    

    

    <a href="/book" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>book</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ljyabc.github.io/2025/04/08/nginx高级/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李江洋">
      <meta itemprop="description" content="记录学习的技能和遇到的问题">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="择墅居:李江洋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">nginx高级

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2025-04-08 23:55:59 / 修改时间：22:37:44" itemprop="dateCreated datePublished" datetime="2025-04-08T23:55:59+08:00">2025-04-08</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/记忆/" itemprop="url" rel="index"><span itemprop="name">记忆</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2025/04/08/nginx高级/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2025/04/08/nginx高级/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="01-Nginx基础Http原理"><a href="#01-Nginx基础Http原理" class="headerlink" title="01.Nginx基础Http原理"></a>01.Nginx基础Http原理</h1><h2 id="1-Http协议概述"><a href="#1-Http协议概述" class="headerlink" title="1.Http协议概述"></a>1.Http协议概述</h2><p><code>HTTP</code>全称<code>HyperText Transfer Protocol</code>中文名为超文本传输协议</p>
<p><em>1.什么是超文本?</em></p>
<p><em>包含有超链接(Link)和各种多媒体元素标记的文本。这些超文本文件彼此链接，形成网状(Web)，因此又被称为网页(Web Page)。这些链接使用URL表示。最常见的超文本格式是超文本标记语言HTML。</em></p>
<blockquote>
<p>html文件-&gt;包含各种各样的元素（URL链接）-&gt;形成web page简称web页面。</p>
</blockquote>
<p><em>2.那什么是URL，URL简称统一资源定位符。那URL的组成部分是由协议, 域名:端口, 路径和文件名</em></p>
<p><img src="/2025/04/08/nginx高级/15332019122445.jpg" alt="img"></p>
<p><em>3.那超文本传输http协议是什么?</em><br>是一种按照<code>URL</code>指示，将超文本文档从一台主机(Web服务器)传输到另一台主机(浏览器)的应用层协议，以实现超链接的功能。</p>
<p><img src="/2025/04/08/nginx高级/2018-10-11-15392584112083.jpg" alt="img"></p>
<h2 id="2-Http工作原理"><a href="#2-Http工作原理" class="headerlink" title="2.Http工作原理"></a>2.Http工作原理</h2><p><img src="/2025/04/08/nginx高级/2018-10-11-15392586458477.jpg" alt="img"></p>
<h2 id="3-Http协议版本"><a href="#3-Http协议版本" class="headerlink" title="3.Http协议版本"></a>3.Http协议版本</h2><p><em>http1.0协议使用的是短连接：建立一次tcp的连接，发起一次http的请求，结束，tcp断开。http1.1协议使用的是长连接：建立一次tcp的连接，发起多次http的请求，结束，tcp端口。</em></p>
<h2 id="3-Http请求响应"><a href="#3-Http请求响应" class="headerlink" title="3.Http请求响应"></a>3.Http请求响应</h2><p><em>1.http请求报文的方法</em></p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get     # 获得请求文件信息的数据内容（下载）</span><br><span class="line">post    # 用户提交数据至服务器端存储（上传）</span><br><span class="line"></span><br><span class="line">Request URL:http:<span class="comment">//10.0.0.7/index.html # 请求的URL</span></span><br><span class="line">Request <span class="function"><span class="keyword">Method</span>:</span>GET                     # 请求的方法</span><br><span class="line">Status Code:<span class="number">200</span> OK                     # 当前的状态</span><br><span class="line">Remote Address:<span class="number">10.0</span>.<span class="number">0.7</span>:<span class="number">80</span>             # 远程的主机</span><br></pre></td></tr></table></figure>
<p><em>2.http返回状态码(Status-Code), 以3位数字组成</em></p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">200 </span>    # 成功请求</span><br><span class="line"><span class="symbol">301 </span>    # 永久重定向(redirect) </span><br><span class="line"><span class="symbol">302 </span>    # 临时重定向(redirect) </span><br><span class="line"><span class="symbol">304 </span>    # 浏览器缓存</span><br><span class="line"><span class="symbol">403 </span>    # 请求不到首页或权限被拒绝</span><br><span class="line"><span class="symbol">404 </span>    # 请求的资源不存在(找不到文件)</span><br><span class="line"><span class="symbol">500 </span>    # 服务器内部错误，程序代码错误</span><br><span class="line"><span class="symbol">502 </span>    # 找不到后端的资源(后端web连不上)</span><br><span class="line"><span class="symbol">503 </span>    # 响应慢</span><br><span class="line"><span class="symbol">504 </span>    # 请求超时</span><br></pre></td></tr></table></figure>
<p><em>3.用户访问网站携带的参数，以及服务端返回的参数</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.概况</span></span><br><span class="line"><span class="attr">Request URL:</span> <span class="string">http://10.0.0.7/index.html</span>         <span class="comment"># 请求的URL地址</span></span><br><span class="line"><span class="attr">Request Method:</span> <span class="string">GET</span>                             <span class="comment"># 请求的方法(获取)</span></span><br><span class="line"><span class="attr">Status Code:</span> <span class="number">304</span> <span class="string">Not</span> <span class="string">Modified</span>                   <span class="comment"># 返回的状态</span></span><br><span class="line"><span class="attr">Remote Address:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.7</span><span class="string">:80</span>                     <span class="comment"># 请求的地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.客户端请求的头部信息</span></span><br><span class="line"><span class="attr">Accept:</span> <span class="string">text/html,</span>                              <span class="comment"># 请求的类型</span></span><br><span class="line"><span class="attr">Accept-Encoding:</span> <span class="string">gzip,</span> <span class="string">deflate</span>                  <span class="comment"># 是否进行压缩</span></span><br><span class="line"><span class="attr">Accept-Language:</span> <span class="string">zh-CN,zh;q=0.9</span>                 <span class="comment"># 请求的语言</span></span><br><span class="line"><span class="attr">Cache-Control:</span> <span class="string">max-age=0</span>                        <span class="comment"># 缓存</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span>                          <span class="comment"># TCP长连接</span></span><br><span class="line"><span class="attr">Host:</span> <span class="string">www.oldboyedu.com</span>                         <span class="comment"># 请求的域名</span></span><br><span class="line"><span class="attr">If-Modified-Since:</span> <span class="string">Fri,</span> <span class="number">04</span> <span class="string">May</span> <span class="number">2018</span> <span class="number">08</span><span class="string">:13:44</span> <span class="string">GMT#</span> <span class="string">修改的时间</span></span><br><span class="line"><span class="attr">User-Agent:</span> <span class="string">Mozilla/5.0</span>                         <span class="comment"># 请求浏览器的工具</span></span><br><span class="line"><span class="string">"=== 请求一个空行 ==="</span></span><br><span class="line"><span class="string">"=== 请求内容主体 ==="</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.服务端响应的头部信息</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">304</span> <span class="string">Not</span> <span class="string">Modified</span>                       <span class="comment"># 返回服务器的http协议，状态码</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">14</span> <span class="string">Sep</span> <span class="number">2018</span> <span class="number">09</span><span class="string">:14:28</span> <span class="string">GMT</span>             <span class="comment"># 返回服务器的时间</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">Apache/2.4.6</span> <span class="string">(CentOS)</span> <span class="string">PHP/5.4.16</span>        <span class="comment"># 返回服务器使用的软件（Apache php）</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">Keep-Alive</span>                          <span class="comment"># TCP长连接</span></span><br><span class="line"><span class="attr">Keep-Alive:</span> <span class="string">timeout=5,</span> <span class="string">max=100</span>                  <span class="comment"># 长连接的超时时间</span></span><br><span class="line"><span class="string">"=== 返回一个空行 ==="</span></span><br><span class="line"><span class="string">"=== 返回内容主体 ==="</span></span><br></pre></td></tr></table></figure>
<p><em>4.Http相关术语pv、ip、uv 假设公司有一座大厦，大厦有100人，每个人有一台电脑和一部手机，上网都是通过nat转换出口，每个人点击网站2次, 请问对应的pv,uv,ip分别是多少</em></p>
<blockquote>
<p>PV：页面浏览量, 400<br>uv：独立的客户, 200<br>ip：独立IP, 1个</p>
</blockquote>
<h2 id="6-Http访问流程"><a href="#6-Http访问流程" class="headerlink" title="6.Http访问流程"></a>6.Http访问流程</h2><p><img src="/2025/04/08/nginx高级/15332030834441.jpg" alt="img"></p>
<p><em>1.http协议原理总结</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1.用户输入域名-&gt;浏览器跳转-&gt;浏览器缓存-&gt;Hosts文件-&gt;DNS解析( 递归查询 | 迭代查询 )</span><br><span class="line">    客户端向服务端发起查询-&gt;递归查询</span><br><span class="line">    服务端向服务端发起查询-&gt;迭代查询</span><br><span class="line">2.由浏览器向服务端发起TCP连接（三次握手）</span><br><span class="line">    客户端  --&gt;请求包连接<span class="attribute">-syn</span>=1 <span class="attribute">seq</span>=x           服务端</span><br><span class="line">    服务端  --&gt;向应客户端<span class="attribute">syn</span>=1 <span class="attribute">ack</span>=x+1 <span class="attribute">seq</span>=y    客户端</span><br><span class="line">    客户端  --&gt;建立连接  <span class="attribute">ack</span>=y+1 <span class="attribute">seq</span>=x+1        服务端</span><br><span class="line">3.客户端发起http请求：</span><br><span class="line">    1.请求的方法是什么： <span class="builtin-name">Get</span> 获取</span><br><span class="line">    2.请求的Host主机是： www.oldboyedu.com</span><br><span class="line">    3.请求的资源是什么： /index.html</span><br><span class="line">    4.请求的端口是什么： 默认http是80  https 443</span><br><span class="line">    5.请求携带的参数是： 属性（请求的类型、压缩、认证、浏览器信息、等等）</span><br><span class="line">    6.请求最后的空行</span><br><span class="line">4.服务端响应的内容是</span><br><span class="line">    1.服务端响应使用的WEB服务软件</span><br><span class="line">    2.服务端响应请求文件的类型</span><br><span class="line">    3.服务端响应请求的文件是否进行压缩</span><br><span class="line">    4.服务端响应请求的主机是否进行长连接</span><br><span class="line">5.客户端向服务端发起TCP断开（四次挥手）</span><br><span class="line">    客户端  --&gt; 断开请求 <span class="attribute">fin</span>=1 <span class="attribute">seq</span>=x           --&gt;      服务端</span><br><span class="line">    服务端  --&gt; 响应断开 <span class="attribute">fin</span>=1 <span class="attribute">ack</span>=x+1 <span class="attribute">seq</span>=y   --&gt;      客户端</span><br><span class="line">    服务端  --&gt; 断开连接 <span class="attribute">fin</span>=1 <span class="attribute">ack</span>=x+1 <span class="attribute">seq</span>=z   --&gt;      客户端</span><br><span class="line">    客户端  --&gt; 确认断开 <span class="attribute">fin</span>=1 <span class="attribute">ack</span>=z+1 <span class="attribute">seq</span>=sj  --&gt;      服务端</span><br></pre></td></tr></table></figure>
<p><em>2.用户访问网站集群架构流程</em></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.客户端发起http请求，请求会先抵达前端的防火墙</span><br><span class="line"><span class="number">2</span>.防火墙识别用户身份，正常的请求通过内部交换机通过tcp连接后端的负载均衡，传递用户的http请求</span><br><span class="line"><span class="number">3</span>.负载接收到请求，会根据请求的内容进行下发任务，通过tcp连接后端的web，转发发用户的http请求</span><br><span class="line"><span class="number">4</span>.web接收到用户的http请求后，会根据用户请求的内容进行解析，解析分为如下：</span><br><span class="line">    静态请求<span class="symbol">:web</span>直接返回给负载均衡-&gt;防火墙-&gt;用户</span><br><span class="line">    动态请求<span class="symbol">:web</span>向后端的动态程序建立TCP连接，将用户的动态http请求传递至动态程序-&gt;由动态程序进行解析</span><br><span class="line"><span class="number">5</span>.动态程序在解析的过程中，如果碰到查询数据库请求，则优先与缓存建立tcp连接，并发起数据查询操作。</span><br><span class="line"><span class="number">6</span>.如果缓存没有对应的数据，动态程序再次向数据库建立tcp连接，并发起查询操作。</span><br><span class="line"><span class="number">7</span>.最后数据由, 数据库-&gt;动态程序-&gt;缓存-&gt;web服务-&gt;负载均衡-&gt;防火墙-&gt;用户。</span><br></pre></td></tr></table></figure>
<p><em>3.面试时建议按照如下五层，进行分层讲解给面试官。</em></p>
<p><img src="/2025/04/08/nginx高级/15437656930280.jpg" alt="img"></p>
<h1 id="02-Nginx-Web快速入门"><a href="#02-Nginx-Web快速入门" class="headerlink" title="02.Nginx Web快速入门"></a>02.Nginx Web快速入门</h1><h2 id="1-Nginx基本简述"><a href="#1-Nginx基本简述" class="headerlink" title="1.Nginx基本简述"></a>1.Nginx基本简述</h2><p><strong>Nginx是一个开源且高性能、可靠的Http Web服务、代理服务。</strong><br><em>开源: 直接获取源代码高性能: 支持海量并发可靠: 服务稳定</em></p>
<p><strong>我们为什么选择 Nginx服务</strong><br><strong>Nginx非常轻量</strong><br><em>功能模块少 (源代码仅保留http与核心模块代码,其余不够核心代码会作为插件来安装)代码模块化 (易读，便于二次开发，对于开发人员非常友好)</em></p>
<p><strong>互联网公司都选择Nginx</strong><br><em>1.Nginx技术成熟，具备的功能是企业最常使用而且最需要的2.适合当前主流架构趋势, 微服务、云架构、中间层3.统一技术栈, 降低维护成本, 降低技术更新成本。</em></p>
<p><strong>Nginx采用Epool网络模型，Apache采用Select模型</strong><br><em>Select: 当用户发起一次请求，select模型就会进行一次遍历扫描，从而导致性能低下。Epool: 当用户发起请求，epool模型会直接进行处理，效率高效，并无连接限制。</em></p>
<p><strong>Nginx 典型应用场景</strong><br><img src="/2025/04/08/nginx高级/15387461326148.jpg" alt="img"></p>
<h2 id="2-Nginx快速安装"><a href="#2-Nginx快速安装" class="headerlink" title="2.Nginx快速安装"></a>2.Nginx快速安装</h2><p><em>Nginx软件安装的方式有很多种</em></p>
<blockquote>
<p>1.源码编译=&gt;Nginx (1.版本随意 2.安装复杂 3.升级繁琐)<br>2.epel仓库=&gt;Nginx (1.版本较低 2.安装简单 3.配置不易读)<br>3.官方仓库=&gt;Nginx (1.版本较新 2.安装简单 3.配置易读，推荐)</p>
</blockquote>
<p><em>1.安装Nginx软件所需依赖包</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web</span> ~]<span class="meta"># yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake wget httpd-tools vim tree</span></span><br></pre></td></tr></table></figure>
<p><em>2.配置nginx官方 yum源</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@web ~]</span><span class="comment"># vim /etc/yum.repos.d/nginx.repo</span></span><br><span class="line"><span class="section">[nginx]</span></span><br><span class="line"><span class="attr">name</span>=nginx repo</span><br><span class="line"><span class="attr">baseurl</span>=http://nginx.org/packages/centos/<span class="number">7</span>/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><em>3.安装Nginx服务，启动并加入开机自启</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web</span> ~]<span class="meta"># yum install nginx -y</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@web</span> ~]<span class="meta"># systemctl enable nginx</span></span><br><span class="line">[root<span class="symbol">@web</span> ~]<span class="meta"># systemctl start nginx</span></span><br></pre></td></tr></table></figure>
<p><em>4.通过浏览器访问该服务器ip或url地址</em></p>
<p><img src="/2025/04/08/nginx高级/15438271468263.jpg" alt="img"></p>
<p><em>5.检查Nginx软件版本以及编译参数</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web</span> ~]<span class="meta"># nginx -v</span></span><br><span class="line">nginx version: nginx/<span class="number">1.14</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@web</span> ~]<span class="meta"># nginx -V</span></span><br></pre></td></tr></table></figure>
<p><em>6.为了让大家更清晰的了解Nginx软件的全貌，可使用rpm -ql nginx查看整体的目录结构及对应的功能，如下表格整理了Nginx比较重要的配置文件</em></p>
<p><em>1.Nginx主配置文件</em></p>
<table>
<thead>
<tr>
<th>路径</th>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>/etc/nginx/nginx.conf</td>
<td>配置文件</td>
<td>nginx主配置文件</td>
</tr>
<tr>
<td>/etc/nginx/conf.d/default.conf</td>
<td>配置文件</td>
<td>默认网站配置文件</td>
</tr>
</tbody>
</table>
<p><em>2.Nginx代理相关参数文件</em></p>
<table>
<thead>
<tr>
<th>路径</th>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>/etc/nginx/fastcgi_params</td>
<td>配置文件</td>
<td>Fastcgi代理配置文件</td>
</tr>
<tr>
<td>/etc/nginx/scgi_params</td>
<td>配置文件</td>
<td>scgi代理配置文件</td>
</tr>
<tr>
<td>/etc/nginx/uwsgi_params</td>
<td>配置文件</td>
<td>uwsgi代理配置文件</td>
</tr>
</tbody>
</table>
<p><em>3.Nginx编码相关配置文件</em></p>
<table>
<thead>
<tr>
<th>路径</th>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>/etc/nginx/win-utf</td>
<td>配置文件</td>
<td>Nginx编码转换映射文件</td>
</tr>
<tr>
<td>/etc/nginx/koi-utf</td>
<td>配置文件</td>
<td>Nginx编码转换映射文件</td>
</tr>
<tr>
<td>/etc/nginx/koi-win</td>
<td>配置文件</td>
<td>Nginx编码转换映射文件</td>
</tr>
<tr>
<td>/etc/nginx/mime.types</td>
<td>配置文件</td>
<td>Content-Type与扩展名</td>
</tr>
</tbody>
</table>
<p><em>4.Nginx管理相关命令</em></p>
<table>
<thead>
<tr>
<th>路径</th>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>/usr/sbin/nginx</td>
<td>命令</td>
<td>Nginx命令行管理终端工具</td>
</tr>
<tr>
<td>/usr/sbin/nginx-debug</td>
<td>命令</td>
<td>Nginx命令行与终端调试工具</td>
</tr>
</tbody>
</table>
<p><em>4.Nginx日志相关目录与文件</em></p>
<table>
<thead>
<tr>
<th>路径</th>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>/var/log/nginx</td>
<td>目录</td>
<td>Nginx默认存放日志目录</td>
</tr>
<tr>
<td>/etc/logrotate.d/nginx</td>
<td>配置文件</td>
<td>Nginx默认的日志切割</td>
</tr>
</tbody>
</table>
<h2 id="3-Nginx默认配置"><a href="#3-Nginx默认配置" class="headerlink" title="3.Nginx默认配置"></a>3.Nginx默认配置</h2><p><em>Nginx主配置文件/etc/nginx/nginx.conf是一个纯文本类型的文件，整个配置文件是以区块的形式组织的。一般，每个区块以一对大括号{}来表示开始与结束。Nginx主配置文件整体分为三块进行学习，分别是CoreModule(核心模块)，EventModule(事件驱动模块)，HttpCoreModule(http内核模块)</em></p>
<p><em>CoreModule核心模块</em></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user www;                       <span class="comment">#Nginx进程所使用的用户</span></span><br><span class="line">worker_processes <span class="number">1</span>;             <span class="comment">#Nginx运行的work进程数量(建议与CPU数量一致或auto)</span></span><br><span class="line">error_log /<span class="built_in">log</span>/nginx/<span class="keyword">error</span>.<span class="built_in">log</span>  <span class="comment">#Nginx错误日志存放路径</span></span><br><span class="line">pid /var/<span class="built_in">run</span>/nginx.pid          <span class="comment">#Nginx服务运行后产生的pid进程号</span></span><br></pre></td></tr></table></figure>
<p><em>events事件模块</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;            </span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">25535</span>;  <span class="comment">#每个worker进程支持的最大连接数</span></span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;                  <span class="comment">#事件驱动模型, epoll默认</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>http内核模块</em></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http &#123;  <span class="comment">#http层开始</span></span><br><span class="line"><span class="string">...</span>    </span><br><span class="line">    <span class="comment">#使用Server配置网站, 每个Server&#123;&#125;代表一个网站(简称虚拟主机)</span></span><br><span class="line">    'server' &#123;</span><br><span class="line">        listen       80;            <span class="comment">#监听端口, 默认80</span></span><br><span class="line">        server_name  bgx.com;       <span class="comment">#提供的域名</span></span><br><span class="line">        access_log  access.log;     <span class="comment">#该网站的访问日志</span></span><br><span class="line">        <span class="comment">#控制网站访问路径</span></span><br><span class="line">        'location' / &#123;</span><br><span class="line">            root   <span class="string">/usr/share/nginx/html</span>;   <span class="comment">#存放网站源代码的位置</span></span><br><span class="line">            index  index.html index.htm;    <span class="comment">#默认返回网站的文件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="comment">#第二个虚拟主机配置</span></span><br><span class="line">    'server' &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    include <span class="string">/etc/nginx/conf.d/</span>*<span class="string">.conf</span>;  <span class="comment">#包含/etc/nginx/conf.d/目录下所有以.conf结尾的文件</span></span><br><span class="line"></span><br><span class="line">&#125;   <span class="comment">#http层结束</span></span><br></pre></td></tr></table></figure>
<p><strong>http server location扩展了解项</strong><br><em>http{}层下允许有多个Server{}层，一个Server{}层下又允许有多个Locationhttp{} 标签主要用来解决用户的请求与响应。server{} 标签主要用来响应具体的某一个网站。location{} 标签主要用于匹配网站具体URL路径。</em></p>
<h2 id="4-Nginx网站配置"><a href="#4-Nginx网站配置" class="headerlink" title="4.Nginx网站配置"></a>4.Nginx网站配置</h2><p><em>1.新增nginx配置文件</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat /etc/nginx/conf.d/game.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name game.oldboy.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.放置游戏源代码文件至nginx配置文件root指定的目录</em></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# mkdir /<span class="keyword">code</span> &amp;&amp; cd /<span class="keyword">code</span></span><br><span class="line">[root@web01 <span class="keyword">code</span>]# rz  html5.zip</span><br><span class="line">[root@web01 <span class="keyword">code</span>]# unzip html5.zip</span><br><span class="line">[root@web01 <span class="keyword">code</span>]# ls</span><br><span class="line">ceshi  game  html5.zip  img  index.html  readme.txt</span><br></pre></td></tr></table></figure>
<p><em>3.检查nginx的语法是否存在错误</em></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 code]# nginx -t</span><br><span class="line">nginx: the configuration <span class="keyword">file</span> /etc/nginx/nginx.<span class="keyword">conf</span> <span class="keyword">syntax</span> <span class="keyword">is</span> ok</span><br><span class="line">nginx: configuration <span class="keyword">file</span> /etc/nginx/nginx.<span class="keyword">conf</span> test <span class="keyword">is</span> successful</span><br></pre></td></tr></table></figure>
<p><em>4.重载Nginx [reload|restart]</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> code]<span class="meta"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>
<h2 id="5-Nginx虚拟主机"><a href="#5-Nginx虚拟主机" class="headerlink" title="5.Nginx虚拟主机"></a>5.Nginx虚拟主机</h2><p><em>通常在企业中可能会有很多业务系统，那么多套业务服务如何使用Nginx配置?</em><br><img src="/2025/04/08/nginx高级/15443636497710.jpg" alt="img"></p>
<p><em>如果使用如上方式部署，则需要多台服务器配置Nginx，但如果使用虚拟主机方式，则在同一个Nginx上运行多套单独服务，这些服务是相互独立的。简单来说，看似多套业务系统，实则可以运行在一台Nginx服务上</em></p>
<p><img src="/2025/04/08/nginx高级/15443641844997.jpg" alt="img"></p>
<p><strong>Nginx配置虚拟主机有如下三种方式：</strong><br><em>方式一、基于主机多IP方式方式二、基于端口的配置方式方式三、基于多个hosts名称方式(多域名方式)</em></p>
<p><strong>1.基于多IP的虚拟主机配置实战</strong><br><img src="/2025/04/08/nginx高级/15443658141286.jpg" alt="img"></p>
<p><em>那么基于多IP的方式，有如下两种方式：</em><br><img src="/2025/04/08/nginx高级/15443663820104.jpg" alt="img"></p>
<p><em>1.配置多网卡多IP的方式</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    listen 10.0.0.10:80;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    listen 10.0.0.11:80;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>1.配置单网卡多IP的方式</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加一个IP</span></span><br><span class="line">[root@web01 ~]#<span class="built_in"> ip </span>addr <span class="builtin-name">add</span> 10.0.0.11/24 dev eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 虚拟机配置方案</span></span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/addr1.conf</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    listen 10.0.0.10:80;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/addr2.conf</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    listen 10.0.0.11:80;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.基于端口虚拟主机配置实战</strong></p>
<p><img src="/2025/04/08/nginx高级/15443659980121.jpg" alt="img"></p>
<p><em>Nginx多端口虚拟主机方式，具体配置如下</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#仅修改listen监听端口即可, 但不能和系统端口出现冲突</span></span><br><span class="line"></span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/port1.conf</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    listen 80;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/port2.conf</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    listen 81;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/port3.conf</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    listen 82;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3.基于host名称的虚拟主机方式配置实战</strong></p>
<p><img src="/2025/04/08/nginx高级/15443656285476.jpg" alt="img"></p>
<p><em>1.创建对应的web站点目录以及程序代码</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># mkdir /soft/code/&#123;server1,server2&#125;</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># echo <span class="string">"server1"</span> &gt; /code/server1/index.html</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># echo <span class="string">"server2"</span> &gt; /code/server2/index.html</span></span><br></pre></td></tr></table></figure>
<p><em>2.配置不同域名的虚拟主机</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 ~]# cat /etc/nginx/conf.d/server1.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  1.xuliangwei.com;</span><br><span class="line">    root /code/server1;</span><br><span class="line">    index index.html;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/server2.conf</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  2.xuliangwei.com;</span><br><span class="line">    root /code/server2;</span><br><span class="line">    index index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-Nginx日志管理"><a href="#6-Nginx日志管理" class="headerlink" title="6.Nginx日志管理"></a>6.Nginx日志管理</h2><p><em>Nginx有非常灵活的日志记录模式，每个级别的配置可以有各自独立的访问日志。日志格式通过log_format命令定义格式。</em></p>
<p><em>1.log_format定义日志格式语法</em></p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 配置语法: 包括: <span class="keyword">error</span>.<span class="built_in">log</span> access.<span class="built_in">log</span></span><br><span class="line">Syntax: log_format name [escape=<span class="keyword">default</span>|json] <span class="built_in">string</span> ...;</span><br><span class="line"><span class="keyword">Default</span>: log_format combined <span class="string">"..."</span>;</span><br><span class="line">Context: http</span><br></pre></td></tr></table></figure>
<p><em>2.默认Nginx定义语法格式如下</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br></pre></td></tr></table></figure>
<p><em>3.Nginx日志格式允许包含的内置变量</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">remote_addr        <span class="comment"># 记录客户端IP地址</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">remote_user        <span class="comment"># 记录客户端用户名</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">time_local         <span class="comment"># 记录通用的本地时间</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">time_iso8601       <span class="comment"># 记录ISO8601标准格式下的本地时间</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">request            <span class="comment"># 记录请求的方法以及请求的http协议</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">status             <span class="comment"># 记录请求状态码(用于定位错误信息)</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">body_bytes_sent    <span class="comment"># 发送给客户端的资源字节数，不包括响应头的大小</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">bytes_sent         <span class="comment"># 发送给客户端的总字节数</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">msec               <span class="comment"># 日志写入时间。单位为秒，精度是毫秒。</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">http_referer       <span class="comment"># 记录从哪个页面链接访问过来的</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">http_user_agent    <span class="comment"># 记录客户端浏览器相关信息</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">http_x_forwarded_for <span class="comment">#记录客户端IP地址</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_length     <span class="comment"># 请求的长度（包括请求行， 请求头和请求正文）。</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">request_time       <span class="comment"># 请求花费的时间，单位为秒，精度毫秒</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注:如果Nginx位于负载均衡器，nginx反向代理之后， web服务器无法直接获取到客 户端真实的IP地址。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$remote_addr</span>获取的是反向代理的IP地址。 反向代理服务器在转发请求的http头信息中，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 增加X-Forwarded-For信息，用来记录客户端IP地址和客户端请求的服务器地址。</span></span><br></pre></td></tr></table></figure>
<p><em>4.access_log日志配置语法</em></p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax: access_log path [<span class="keyword">format</span> [buffer=<span class="built_in">size</span>] [gzip[=level]] [<span class="keyword">flush</span>=time] [<span class="keyword">if</span>=condition]];</span><br><span class="line">access_log off;</span><br><span class="line"><span class="keyword">Default</span>: access_log logs/<span class="keyword">access</span>.<span class="built_in">log</span> combined;</span><br><span class="line">Context: http, server, location, <span class="keyword">if</span> <span class="keyword">in</span> location, limit_except</span><br></pre></td></tr></table></figure>
<p>5.<code>Nginx Access</code>日志配置实践</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> code.oldboy.com;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#将当前的server网站的访问日志记录至对应的目录，使用main格式</span></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/code.oldboy.com.log main;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#当有人请求改favicon.ico时，不记录日志</span></span><br><span class="line">    <span class="attribute">location</span> /favicon.ico &#123;</span><br><span class="line">        <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>6.日志切割logrotate</em></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx conf.d]<span class="meta"># cat /etc/logrotate.d/nginx</span></span><br><span class="line"><span class="meta-keyword">/var/</span>log<span class="meta-keyword">/nginx/</span>*.<span class="class">log </span>&#123;</span><br><span class="line">        daily                   <span class="meta"># 每天切割日志</span></span><br><span class="line">        missingok               <span class="meta"># 日志丢失忽略</span></span><br><span class="line">        rotate <span class="number">52</span>               <span class="meta"># 日志保留52天</span></span><br><span class="line">        compress                <span class="meta"># 日志文件压缩</span></span><br><span class="line">        delaycompress           <span class="meta"># 延迟压缩日志</span></span><br><span class="line">        notifempty              <span class="meta"># 不切割空文件</span></span><br><span class="line">        create <span class="number">640</span> nginx adm    <span class="meta"># 日志文件权限</span></span><br><span class="line">        sharedscripts</span><br><span class="line">        postrotate      <span class="meta"># 切割日志执行的命令</span></span><br><span class="line">                if [ -f <span class="meta-keyword">/var/</span>run/nginx.pid ]; then</span><br><span class="line">                        kill -USR1 `cat <span class="meta-keyword">/var/</span>run/nginx.pid`</span><br><span class="line">                fi</span><br><span class="line">        endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>7.日志切割后的效果</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@bgx</span> <span class="string">~]#</span> <span class="string">ll</span> <span class="string">/var/log/nginx/</span></span><br><span class="line"><span class="string">total</span> <span class="number">4044</span></span><br><span class="line"><span class="string">-rw-r-----</span> <span class="number">1</span> <span class="string">www</span> <span class="string">adm</span>  <span class="number">54438</span> <span class="string">Oct</span> <span class="number">12</span> <span class="number">03</span><span class="string">:28</span> <span class="string">access.log-20181012.gz</span></span><br><span class="line"><span class="string">-rw-r-----</span> <span class="number">1</span> <span class="string">www</span> <span class="string">adm</span>  <span class="number">28657</span> <span class="string">Oct</span> <span class="number">13</span> <span class="number">03</span><span class="string">:48</span> <span class="string">access.log-20181013.gz</span></span><br><span class="line"><span class="string">-rw-r-----</span> <span class="number">1</span> <span class="string">www</span> <span class="string">adm</span>  <span class="number">10135</span> <span class="string">Oct</span> <span class="number">12</span> <span class="number">03</span><span class="string">:28</span> <span class="string">error.log-20181130.gz</span></span><br><span class="line"><span class="string">-rw-r-----</span> <span class="number">1</span> <span class="string">www</span> <span class="string">adm</span>   <span class="number">7452</span> <span class="string">Oct</span> <span class="number">13</span> <span class="number">03</span><span class="string">:48</span> <span class="string">error.log-20181201.gz</span></span><br></pre></td></tr></table></figure>
<h1 id="03-Nginx常用基础模块"><a href="#03-Nginx常用基础模块" class="headerlink" title="03.Nginx常用基础模块"></a>03.Nginx常用基础模块</h1><blockquote>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-Nginx目录索引"><a href="#1-Nginx目录索引" class="headerlink" title="1.Nginx目录索引"></a>1.Nginx目录索引</h2><p><em>ngx_http_autoindex_module模块处理以斜杠字符(‘/‘)结尾的请求，并生成目录列表。当ngx_http_index_module模块找不到索引文件时，通常会将请求传递给模块。</em></p>
<p><em>1.指令</em></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#启用或禁用目录列表输出，on开启，off关闭。</span></span><br><span class="line">Syntax: autoindex <span class="keyword">on</span> | <span class="keyword">off</span>;</span><br><span class="line"><span class="keyword">Default</span>:    autoindex <span class="keyword">off</span>;</span><br><span class="line">Context:    http, server, location</span><br><span class="line"></span><br><span class="line"><span class="meta">#指定是否应在目录列表中输出确切的文件大小，on显示字节，off显示大概单位。</span></span><br><span class="line">Syntax: autoindex_exact_size <span class="keyword">on</span> | <span class="keyword">off</span>;</span><br><span class="line"><span class="keyword">Default</span>: autoindex_exact_size <span class="keyword">on</span>;</span><br><span class="line">Context:    http, server, location</span><br><span class="line"></span><br><span class="line"><span class="meta">#指定目录列表中的时间是应以本地时区还是UTC输出。on本地时区，off UTC时间。</span></span><br><span class="line">Syntax: autoindex_localtime <span class="keyword">on</span> | <span class="keyword">off</span>;</span><br><span class="line"><span class="keyword">Default</span>: autoindex_localtime <span class="keyword">off</span>;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>
<p><em>2.示例配置</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@web ~]# cat /etc/nginx/conf.d/module.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name module.bgx.com;</span><br><span class="line">    charset utf-8,gbk;  #设定字符集，防止中文字符乱码显示。</span><br><span class="line">    </span><br><span class="line">    location /download &#123;</span><br><span class="line">        root /code/;</span><br><span class="line">        autoindex on;</span><br><span class="line">        autoindex_exact_size off;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-Nginx状态监控"><a href="#2-Nginx状态监控" class="headerlink" title="2.Nginx状态监控"></a>2.Nginx状态监控</h2><p><em>ngx_http_stub_status_module模块提供对基本状态信息的访问。默认情况下不构建此模块，应使用–with-http_stub_status_module 配置参数启用它 。</em></p>
<p><em>1.指令</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Syntax:</span> stub_status<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> —</span><br><span class="line"><span class="symbol">Context:</span> server, location</span><br></pre></td></tr></table></figure>
<p><em>2.示例配置</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@web ~]# cat /etc/nginx/conf.d/module.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name module.bgx.com;</span><br><span class="line">    access_log off;</span><br><span class="line">    </span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3.此配置创建一个简单的网页，其基本状态数据可能如下所示：</em></p>
<p><img src="/2025/04/08/nginx高级/15403801758720.jpg" alt="img"></p>
<p><em>4.提供以下状态信息</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Active</span> connections  <span class="comment"># 当前活动客户端连接数，包括Waiting等待连接数。</span></span><br><span class="line">accepts             <span class="comment"># 已接受总的TCP连接数。</span></span><br><span class="line">handled             <span class="comment"># 已处理总的TCP连接数。</span></span><br><span class="line">requests            <span class="comment"># 客户端总的http请求数。</span></span><br><span class="line"></span><br><span class="line">Reading             <span class="comment"># 当前nginx读取请求头的连接数。</span></span><br><span class="line">Writing             <span class="comment"># 当前nginx将响应写回客户端的连接数。</span></span><br><span class="line">Waiting             <span class="comment"># 当前等待请求的空闲客户端连接数。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意, 一次TCP的连接，可以发起多次http的请求, 如下参数可配置进行验证</span></span><br><span class="line">keepalive_timeout  <span class="number">0</span>;   <span class="comment"># 类似于关闭长连接</span></span><br><span class="line"><span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;  <span class="comment"># 65s没有活动则断开连接</span></span><br></pre></td></tr></table></figure>
<h2 id="3-Nginx访问控制"><a href="#3-Nginx访问控制" class="headerlink" title="3.Nginx访问控制"></a>3.Nginx访问控制</h2><p><em>ngx_http_access_module模块允许限制对某些客户端地址的访问。</em></p>
<p><em>1.指令</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#允许配置语法</span></span><br><span class="line">Syntax: allow<span class="built_in"> address </span>| CIDR | unix: | all;</span><br><span class="line">Default:    —</span><br><span class="line">Context:    http, server, location, limit_except</span><br><span class="line"></span><br><span class="line"><span class="comment">#拒绝配置语法</span></span><br><span class="line">Syntax: deny<span class="built_in"> address </span>| CIDR | unix: | all;</span><br><span class="line">Default:    —</span><br><span class="line">Context:    http, server, location, limit_except</span><br></pre></td></tr></table></figure>
<p><em>2.示例配置，拒绝指定的IP访问该网站的/nginx_status, 其他IP全部允许访问</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@web ~]# cat /etc/nginx/conf.d/module.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name module.bgx.com;</span><br><span class="line"></span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">        deny 10.0.0.1/32;   #拒绝指定的地址或地址段</span><br><span class="line">        allow all;          #允许所有的地址</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3.示例配置，只允许指定的来源IP能访问/nginx_status, 其它网段全部拒绝</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@web ~]# cat /etc/nginx/conf.d/module.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name module.bgx.com;</span><br><span class="line">        </span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">        allow 127.0.0.1;</span><br><span class="line">        allow 10.0.0.1/32;  #允许地址或地址段</span><br><span class="line">        deny all;              #拒绝所有人</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意:deny和allow的顺序是有影响的</strong><br><em>默认情况下，从第一条规则进行匹配如果匹配成功，则不继续匹配下面的内容。如果匹配不成功，则继续往下寻找能匹配成功的内容。</em></p>
<h2 id="4-Nginx资源限制"><a href="#4-Nginx资源限制" class="headerlink" title="4.Nginx资源限制"></a>4.Nginx资源限制</h2><p><em>ngx_http_auth_basic_module模块允许使用HTTP基本身份验证，验证用户名和密码来限制对资源的访问。</em></p>
<p><em>1.指令</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#使用HTTP基本身份验证协议启用用户名和密码验证。</span></span><br><span class="line"><span class="symbol">Syntax:</span> auth_basic string| off<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> auth_basic off<span class="comment">;</span></span><br><span class="line"><span class="symbol">Context:</span> http, server, location, limit_except</span><br><span class="line"></span><br><span class="line"><span class="meta">#指定保存用户名和密码的文件</span></span><br><span class="line"><span class="symbol">Syntax:</span> auth_basic_user_file file<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> -</span><br><span class="line"><span class="symbol">Context:</span> http, server, location, limit_except</span><br></pre></td></tr></table></figure>
<p><em>2.指定保存用户名和密码的文件，格式如下：</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#可以使用htpasswd程序或<span class="string">"openssl passwd"</span>命令生成对应的密码<span class="comment">;</span></span></span><br><span class="line">name1：passwd1</span><br><span class="line">name2：passwd2</span><br><span class="line"></span><br><span class="line"><span class="meta">#使用htpaaswd创建新的密码文件, -c创建新文件 -b允许命令行输入密码</span></span><br><span class="line">[root<span class="symbol">@xuliangwei</span> ~]<span class="meta"># yum install httpd-tools</span></span><br><span class="line">[root<span class="symbol">@xuliangwei</span> ~]<span class="meta"># htpasswd -b -c /etc/nginx/auth_conf xuliangwei 123456</span></span><br></pre></td></tr></table></figure>
<p><em>3.示例配置，基于用户名和密码认证实践</em></p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span><span class="comment">;</span></span><br><span class="line">    server_name module.bgx.com<span class="comment">;</span></span><br><span class="line">    access_log off<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">        stub_status<span class="comment">;</span></span><br><span class="line">        auth_basic <span class="string">"Auth access Blog Input your Passwd!"</span><span class="comment">;</span></span><br><span class="line">        auth_basic_user_file /etc/nginx/auth_conf<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-Nginx访问限制"><a href="#4-Nginx访问限制" class="headerlink" title="4.Nginx访问限制"></a>4.Nginx访问限制</h2><p><em>经常会遇到这种情况，服务器流量异常，负载过大等等。对于大流量恶意的攻击访问，会带来带宽的浪费，服务器压力，从而影响业务，针对这种情况我们可以考虑对同一个ip的连接数，请求数、进行限制。</em></p>
<p><em>ngx_http_limit_conn_module模块用于限制定义key的连接数，特别是来自单个IP地址的连接数。但并非所有连接都被计算在内，仅当连接已经读取了整个请求头时才计算连接。</em></p>
<p><em>1.指令</em></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span>:  limit_conn_zone key zone=name:size;</span><br><span class="line"><span class="attribute">Default</span>: —</span><br><span class="line"><span class="attribute">Context</span>: http</span><br><span class="line"></span><br><span class="line"><span class="attribute">Syntax</span>: limit_conn zone number;</span><br><span class="line"><span class="attribute">Default</span>: —</span><br><span class="line"><span class="attribute">Context</span>: http, server, location</span><br></pre></td></tr></table></figure>
<p><em>2.设置共享内存区域和给定键值的最大允许连接数。超过此限制时，服务器将返回错误以回复请求</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http标签段定义连接限制</span></span><br><span class="line">http&#123;</span><br><span class="line">    limit_conn_zone <span class="variable">$binary_remote_addr</span> <span class="attribute">zone</span>=conn_zone:10m;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    # 同一时刻只允许一个客户端连接</span><br><span class="line">    limit_conn conn_zone 1; </span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><em>3).使用ab工具进行压力测试</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@xuliangwei</span> ~]<span class="meta"># yum install -y httpd-tools</span></span><br><span class="line">[root<span class="symbol">@xuliangwei</span> ~]<span class="meta"># ab -n 20 -c 2  http://127.0.0.1/index.html</span></span><br></pre></td></tr></table></figure>
<p><em>4).nginx日志结果</em></p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span>/<span class="number">10</span>/<span class="number">24</span> <span class="number">18</span>:<span class="number">04</span>:<span class="number">49</span> <span class="string">[error]</span> <span class="number">28656</span>#<span class="number">28656</span>: *<span class="number">1148</span> limiting connections by zone <span class="string">"conn_zone"</span>, client: <span class="number">123</span>.<span class="number">66</span>.<span class="number">146</span>.<span class="number">123</span>, server: www.xuliangwei.com, request: <span class="string">"<span class="keyword">GET</span> / HTTP/1.0"</span>, host: <span class="string">"www.xuliangwei.com"</span></span><br><span class="line"><span class="number">2018</span>/<span class="number">10</span>/<span class="number">24</span> <span class="number">18</span>:<span class="number">04</span>:<span class="number">49</span> <span class="string">[error]</span> <span class="number">28656</span>#<span class="number">28656</span>: *<span class="number">1155</span> limiting connections by zone <span class="string">"conn_zone"</span>, client: <span class="number">123</span>.<span class="number">66</span>.<span class="number">146</span>.<span class="number">123</span>, server: www.xuliangwei.com, request: <span class="string">"<span class="keyword">GET</span> / HTTP/1.0"</span>, host: <span class="string">"www.xuliangwei.com"</span></span><br></pre></td></tr></table></figure>
<p><em>ngx_http_limit_req_module模块用于限制定义key请求的处理速率，特别单一的IP地址的请求的处理速率。</em></p>
<p><em>1.指令</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#模块名ngx_http_limit_req_module</span></span><br><span class="line"><span class="symbol">Syntax:</span>  limit_req_zone key zone=name:size rate=rate<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> —</span><br><span class="line"><span class="symbol">Context:</span> http</span><br><span class="line"></span><br><span class="line"><span class="symbol">Syntax:</span> limit_conn zone number [burst=number] [nodelay]<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> —</span><br><span class="line"><span class="symbol">Context:</span> http, server, location</span><br></pre></td></tr></table></figure>
<p><em>2.设置共享内存区域和请求的最大突发大小。过多的请求被延迟，直到它们的数量超过最大的限制，在这种情况下请求以错误终止。</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http标签段定义请求限制, rate限制速率，限制一秒钟最多一个IP请求</span></span><br><span class="line">http &#123;</span><br><span class="line">    limit_req_zone <span class="variable">$binary_remote_addr</span> <span class="attribute">zone</span>=req_zone:10m <span class="attribute">rate</span>=1r/s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name module.bgx.com;</span><br><span class="line">    # 1r/s只接收一个请求,其余请求拒绝处理并返回错误码给客户端</span><br><span class="line">    #limit_req <span class="attribute">zone</span>=req_zone;</span><br><span class="line">    </span><br><span class="line">    # 请求超过1r/s,剩下的将被延迟处理,请求数超过burst定义的数量, 多余的请求返回503</span><br><span class="line">    limit_req <span class="attribute">zone</span>=req_zone <span class="attribute">burst</span>=3 nodelay;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3).使用ab工具进行压力测试</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@xuliangwei</span> ~]<span class="meta"># yum install -y httpd-tools</span></span><br><span class="line">[root<span class="symbol">@xuliangwei</span> ~]<span class="meta"># ab -n 20 -c 2  http://127.0.0.1/index.html</span></span><br></pre></td></tr></table></figure>
<p><em>4).nginx日志结果</em></p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span>/<span class="number">10</span>/<span class="number">24</span> <span class="number">07</span>:<span class="number">38</span>:<span class="number">53</span> <span class="string">[error]</span> <span class="number">81020</span>#<span class="number">0</span>: *<span class="number">8</span> limiting requests, excess: <span class="number">3</span>.<span class="number">998</span> by zone <span class="string">"req_zone"</span>, client: <span class="number">10</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">10</span>, server: module.bgx.com, request: <span class="string">"<span class="keyword">GET</span> /index.html HTTP/1.0"</span>, host: <span class="string">"10.0.0.10"</span></span><br><span class="line"><span class="number">2018</span>/<span class="number">10</span>/<span class="number">24</span> <span class="number">07</span>:<span class="number">38</span>:<span class="number">53</span> <span class="string">[error]</span> <span class="number">81020</span>#<span class="number">0</span>: *<span class="number">9</span> limiting requests, excess: <span class="number">3</span>.<span class="number">998</span> by zone <span class="string">"req_zone"</span>, client: <span class="number">10</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">10</span>, server: module.bgx.com, request: <span class="string">"<span class="keyword">GET</span> /index.html HTTP/1.0"</span>, host: <span class="string">"10.0.0.10"</span></span><br></pre></td></tr></table></figure>
<p><strong>Nginx连接限制没有请求限制有效?</strong></p>
<p><em>我们先来回顾一下http协议的连接与请求，首先HTTP是建立在TCP基础之上, 在完成HTTP请求需要先建立TCP三次握手（称为TCP连接）,在连接的基础上在完成HTTP的请求。</em></p>
<p><em>所以多个HTTP请求可以建立在一次TCP连接之上, 那么我们对请求的精度限制，当然比对一个连接的限制会更加的有效，因为同一时刻只允许一个TCP连接进入, 但是同一时刻多个HTTP请求可以通过一个TCP连接进入。所以针对HTTP的请求限制才是比较优的解决方案。</em></p>
<h2 id="6-Nginx-Location"><a href="#6-Nginx-Location" class="headerlink" title="6.Nginx Location"></a>6.Nginx Location</h2><p><em>使用Nginx Location可以控制访问网站的路径, 但一个server允许出现多个location配置, 那多个location出现冲突谁的优先级会更高呢</em></p>
<p><em>1.Location语法示例</em></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">location [=|<span class="string">^~</span>|<span class="string">~</span>|<span class="string">~*</span>|<span class="string">!~</span>|<span class="string">!~*</span>|<span class="string">/] /uri/ &#123; ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p><em>2.Location语法优先级排列</em></p>
<table>
<thead>
<tr>
<th>匹配符</th>
<th>匹配规则</th>
<th>优先级</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>精确匹配</td>
<td>1</td>
</tr>
<tr>
<td>^~</td>
<td>以某个字符串开头</td>
<td>2</td>
</tr>
<tr>
<td>~</td>
<td>区分大小写的正则匹配</td>
<td>3</td>
</tr>
<tr>
<td>~*</td>
<td>不区分大小写的正则匹配</td>
<td>4</td>
</tr>
<tr>
<td>!~</td>
<td>区分大小写不匹配的正则</td>
<td>5</td>
</tr>
<tr>
<td>!~*</td>
<td>不区分大小写不匹配的正则</td>
<td>6</td>
</tr>
<tr>
<td>/</td>
<td>通用匹配，任何请求都会匹配到</td>
<td>7</td>
</tr>
</tbody>
</table>
<p><em>3.配置网站验证Location优先级</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx conf.d]<span class="comment"># cat testserver.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name module.oldboy.com;</span><br><span class="line">    <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">        default_type</span> text/html;</span><br><span class="line">        return <span class="number">200</span> <span class="string">"location /"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">location</span> <span class="title">=/ &#123;</span></span><br><span class="line"><span class="title">        default_type</span> text/html;</span><br><span class="line">        return <span class="number">200</span> <span class="string">"location =/"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">location</span> <span class="title">~ / &#123;</span></span><br><span class="line"><span class="title">        default_type</span> text/html;</span><br><span class="line">        return <span class="number">200</span> <span class="string">"location ~/"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># location ^~ / &#123;</span></span><br><span class="line">    <span class="comment">#   default_type text/html;</span></span><br><span class="line">    <span class="comment">#   return 200 "location ^~";</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>4.测试Location优先级</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优先级最高符号=</span></span><br><span class="line">[root@Nginx conf.d]<span class="comment"># curl module.oldboy.com</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">=/</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title"># 注释掉精确匹配=, 重启Nginx</span></span><br><span class="line">[root@Nginx ~]<span class="comment"># curl module.oldboy.com</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">~/</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title"># 注释掉~, 重启Nginx</span></span><br><span class="line">[root@Nginx ~]<span class="comment"># curl module.oldboy.com</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">/</span></span><br></pre></td></tr></table></figure>
<p><em>5.Locaiton规则配置应用场景</em></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通用匹配，任何请求都会匹配到</span></span><br><span class="line">location / &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 严格区分大小写，匹配以.php结尾的都走这个location    </span></span><br><span class="line">location ~ \<span class="string">.php</span>$ &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 严格区分大小写，匹配以.jsp结尾的都走这个location </span></span><br><span class="line">location ~ \<span class="string">.jsp</span>$ &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条location</span></span><br><span class="line">location ~* .*\.<span class="params">(jpg|gif|png|js|css)</span>$ &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不区分大小写匹配</span></span><br><span class="line">location ~* <span class="string">"\.(sql|bak|tgz|tar.gz|.git)$"</span> &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="04-Nginx搭建流行架构"><a href="#04-Nginx搭建流行架构" class="headerlink" title="04.Nginx搭建流行架构"></a>04.Nginx搭建流行架构</h1><h2 id="1-LNMP架构概述"><a href="#1-LNMP架构概述" class="headerlink" title="1.LNMP架构概述"></a>1.LNMP架构概述</h2><p><strong>1.什么是LNMP</strong><br><em>LNMP是一套技术的组合，L=Linux、N=Nginx、M~=MySQL、P~=PHP</em></p>
<p><strong>2.LNMP架构是如何工作的</strong></p>
<p><em>首先Nginx服务是不能处理动态请求，那么当用户发起动态请求时, Nginx又是如何进行处理的。当用户发起http请求，请求会被Nginx处理，如果是静态资源请求Nginx则直接返回，如果是动态请求Nginx则通过fastcgi协议转交给后端的PHP程序处理，具体如下图所示</em></p>
<p><img src="/2025/04/08/nginx高级/15427289498863.jpg" alt="img"></p>
<p><strong>3.Nginx与Fast-CGI详细工作流程如下图所示</strong></p>
<p><img src="/2025/04/08/nginx高级/15245396916857.jpg" alt="img"></p>
<p><em>1.用户通过http协议发起请求，请求会先抵达LNMP架构中的Nginx2.Nginx会根据用户的请求进行Location规则匹配3.Location如果匹配到请求是静态，则由Nginx读取本地直接返回4.Location如果匹配到请求是动态，则由Nginx将请求转发给fastcgi协议5.fastgi收到后会将请求交给php-fpm管理进程，php-fpm管理进程接收到后会调用具体的工作进程warrap6.warrap进程会调用php程序进行解析，如果只是解析代码，php直接返回7.如果有查询数据库操作，则由php连接数据库(用户 密码 IP)发起查询的操作8.最终数据由mysql-&gt;php-&gt;php-fpm-&gt;fastcgi-&gt;nginx-&gt;http-&gt;user</em></p>
<h2 id="2-LNMP架构环境部署"><a href="#2-LNMP架构环境部署" class="headerlink" title="2.LNMP架构环境部署"></a>2.LNMP架构环境部署</h2><p><em>1) 使用官方仓库安装Nginx</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@nginx ~]</span><span class="comment"># cat /etc/yum.repos.d/nginx.repo </span></span><br><span class="line"><span class="section">[nginx]</span></span><br><span class="line"><span class="attr">name</span>=nginx repo</span><br><span class="line"><span class="attr">baseurl</span>=http://nginx.org/packages/centos/<span class="number">7</span>/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装Nginx</span></span><br><span class="line"><span class="section">[root@nginx ~]</span><span class="comment"># yum install nginx -y</span></span><br></pre></td></tr></table></figure>
<p><em>2) 配置Nginx进程运行用户</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># groupadd -g666 www</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># useradd -u666 -g666 www</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># sed -i <span class="string">'/^user/c user  www;'</span> /etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure>
<p><em>3) 启动Nginx，并将Nginx加入开机自启</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># systemctl start nginx</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># systemctl enable nginx</span></span><br></pre></td></tr></table></figure>
<p><em>4) 使用第三方扩展源安装php7.1</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#不要安装如下rpm会导致失败</span></span><br><span class="line"><span class="comment"># rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span></span><br><span class="line"><span class="comment"># rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[root@nginx ~]</span><span class="comment"># yum remove php-mysql-5.4 php php-fpm php-common</span></span><br><span class="line"><span class="section">[root@nginx ~]</span><span class="comment"># cat /etc/yum.repos.d/php.repo</span></span><br><span class="line"><span class="section">[webtatic-php]</span></span><br><span class="line"><span class="attr">name</span> = php Repository</span><br><span class="line"><span class="attr">baseurl</span> = http://us-east.repo.webtatic.com/yum/el7/x<span class="number">86_64</span>/</span><br><span class="line"><span class="attr">gpgcheck</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[root@nginx ~]</span><span class="comment"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span></span><br></pre></td></tr></table></figure>
<p><em>5) 配置php-fpm用户与Nginx的运行用户保持一致</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># sed -i <span class="string">'/^user/c user = www'</span> /etc/php-fpm.d/www.conf </span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># sed -i <span class="string">'/^group/c group = www'</span> /etc/php-fpm.d/www.conf</span></span><br></pre></td></tr></table></figure>
<p><em>6) 启动php-fpm，并将其加入开机自启</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># systemctl start php-fpm</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># systemctl enable php-fpm</span></span><br></pre></td></tr></table></figure>
<p><em>7) 安装Mariadb数据库</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># yum install mariadb-server mariadb -y</span></span><br></pre></td></tr></table></figure>
<p><em>8) 启动Mariadb数据库, 并加入开机自动</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># systemctl start mariadb</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># systemctl enable mariadb</span></span><br></pre></td></tr></table></figure>
<p><em>9) 给Mariadb配置登陆密码,并是新密码进行登录数据库</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># mysqladmin password <span class="string">'Bgx123.com'</span></span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># mysql -uroot -pBgx123.com</span></span><br></pre></td></tr></table></figure>
<h2 id="2-LNMP架构环境配置"><a href="#2-LNMP架构环境配置" class="headerlink" title="2.LNMP架构环境配置"></a>2.LNMP架构环境配置</h2><p><strong>在将Nginx与PHP集成过程中, 需要先了解 Fastcgi代理配置语法</strong></p>
<p><em>1.设置fastcgi服务器的地址，该地址可以指定为域名或IP地址，以及端口</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Syntax: fastcgi_pass address;</span><br><span class="line">Default: —</span><br><span class="line">Context: location, <span class="keyword">if</span> <span class="keyword">in</span> location</span><br><span class="line"></span><br><span class="line"><span class="comment">#语法示例</span></span><br><span class="line">fastcgi_pass localhost:9000;</span><br><span class="line">fastcgi_pass unix:/tmp/fastcgi.socket;</span><br></pre></td></tr></table></figure>
<p><em>2.设置fastcgi默认的首页文件，需要结合fastcgi_param一起设置</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Syntax:</span> fastcgi_index name<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> —</span><br><span class="line"><span class="symbol">Context:</span> http, server, location</span><br></pre></td></tr></table></figure>
<p><em>3.通过fastcgi_param设置变量，并将设置的变量传递到后端的fastcgi服务器</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span>: fastcgi_param parameter value [if_not_empty];</span><br><span class="line"><span class="attribute">Default</span>: —</span><br><span class="line"><span class="attribute">Context</span>: http, server, location</span><br><span class="line"></span><br><span class="line">#语法示例</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME /code$fastcgi_script_name;</span><br></pre></td></tr></table></figure>
<p><em>4.通过图形方式展示fastcgi_index与fastcgi_param作用</em><br><img src="/2025/04/08/nginx高级/15427844051466.jpg" alt="img"></p>
<p><em>5.最终Nginx连接Fastcgi服务器配置如下</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# cat /etc/nginx/conf.d/php.conf </span><br><span class="line">server &#123;</span><br><span class="line">        server_name php.oldboy.com;</span><br><span class="line">        listen 80;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.php index.html;</span><br><span class="line"></span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            root /code;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>6.在/code目录下创建info.php文件，测试能否通过浏览器访问，访问成功如下图</em></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># cat /code/info.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">        phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/08/nginx高级/15474508101457.jpg" alt="img"></p>
<p><em>7 在/code目录下创建mysqli.php文件，填入对应的数据库IP、用户名、密码</em></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># cat /code/mysqli.php</span></span><br><span class="line">       <span class="meta">&lt;?php</span></span><br><span class="line">        $servername = <span class="string">"localhost"</span>;</span><br><span class="line">        $username = <span class="string">"root"</span>;</span><br><span class="line">        $password = <span class="string">"Bgx123.com"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建连接</span></span><br><span class="line">        $conn = mysqli_connect($servername, $username, $password);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检测连接</span></span><br><span class="line">        <span class="keyword">if</span> (!$conn) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Connection failed: "</span> . mysqli_connect_error());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"php连接MySQL数据库成功"</span>;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>8 最后通过浏览器访问/mysqli.php文件，如成功访问如下图</em></p>
<p><img src="/2025/04/08/nginx高级/15403843143144.jpg" alt="img"></p>
<h2 id="4-部署博客产品Wordpress"><a href="#4-部署博客产品Wordpress" class="headerlink" title="4.部署博客产品Wordpress"></a>4.部署博客产品Wordpress</h2><p><em>1) 配置Nginx虚拟主机站点，域名为blog.bgx.com</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.nginx具体配置信息</span></span><br><span class="line">[root@nginx ~]# cat /etc/nginx/conf.d/wordpress.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name blog.bgx.com;</span><br><span class="line">    root /code/wordpress;</span><br><span class="line">    index index.php index.html;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2) 重启nginx服务</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>3) 获取wordpress产品，解压并部署wordress</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># mkdir /code</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># cd /code</span></span><br><span class="line">[root<span class="symbol">@nginx</span> code]<span class="meta"># wget https://cn.wordpress.org/wordpress-4.9.4-zh_CN.tar.gz</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># tar xf wordpress-4.9.4-zh_CN.tar.gz</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># chown -R www.www /code/wordpress/</span></span><br></pre></td></tr></table></figure>
<p><em>4) 由于wordpress产品需要依赖数据库, 所以需要手动建立数据库</em></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># mysql -uroot -pBgx123.com</span></span><br><span class="line">mysql&gt; create database wordpress;</span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<p><em>5) 通过浏览器访问wordpress, 并部署该产品</em></p>
<p><img src="/2025/04/08/nginx高级/15225664326245.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225665571756.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225666163228.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225666862893.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225667481528.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225667635141.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225668466175.jpg" alt="img"></p>
<h2 id="5-部署知乎产品Wecenter"><a href="#5-部署知乎产品Wecenter" class="headerlink" title="5.部署知乎产品Wecenter"></a>5.部署知乎产品Wecenter</h2><p><em>1.配置Nginx虚拟主机站点，域名为zh.bgx.com</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@http-server ~]# cat /etc/nginx/conf.d/zh.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name zh.bgx.com;</span><br><span class="line">    root /code/zh;</span><br><span class="line">    index index.php index.html;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root /code/zh;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx服务</span></span><br><span class="line">[root@http-server ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p><em>2.下载Wecenter产品，部署Wecenter并授权</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># wget http://ahdx.down.chinaz.com/201605/WeCenter_v3.2.1.zip</span></span><br><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># unzip WeCenter_v3.1.9.zip </span></span><br><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># mv UPLOAD/ /code/zh</span></span><br><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># chown -R www.www /code/zh/</span></span><br></pre></td></tr></table></figure>
<p><em>3.由于wecenter产品需要依赖数据库, 所以需要手动建立数据库</em></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@http-server ~]<span class="comment"># mysql -uroot -pBgx123.com  #登陆数据库</span></span><br><span class="line">MariaDB [(none)]&gt; create database zh;   <span class="comment">#创建zh数据库</span></span><br><span class="line">MariaDB [(none)]&gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<p><em>3.通过浏览器访问网站</em></p>
<p><img src="/2025/04/08/nginx高级/15225681757457.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225681916241.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225684171105.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225684446008.jpg" alt="img"><br><img src="/2025/04/08/nginx高级/15225684700848.jpg" alt="img"></p>
<h2 id="7-拆分数据库至至独立服务器"><a href="#7-拆分数据库至至独立服务器" class="headerlink" title="7.拆分数据库至至独立服务器"></a>7.拆分数据库至至独立服务器</h2><p><strong>1.为什么要进行数据库的拆分</strong><br><em>由于单台服务器运行LNMP架构会导致网站访问缓慢，当内存被吃满时，很容易导致系统出现oom，从而kill掉MySQL数据库，所以需要将web和数据库进行独立部署。</em></p>
<p><strong>2.数据库拆分后解决了什么问题</strong><br><em>1.缓解web网站的压力2.增强数据库读写性能3.提高用户访问的速度</em></p>
<p><strong>3.数据库拆分架构演变过程，如下图所示</strong></p>
<p><img src="/2025/04/08/nginx高级/15428787548940.jpg" alt="img"></p>
<p><strong>4.数据库拆分环境规划</strong></p>
<table>
<thead>
<tr>
<th>主机名称</th>
<th>应用环境</th>
<th>外网地址</th>
<th>内网地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>web01</td>
<td>nginx+php</td>
<td>10.0.0.7</td>
<td>172.16.1.7</td>
</tr>
<tr>
<td>db01</td>
<td>mysql</td>
<td></td>
<td>172.16.1.51</td>
</tr>
</tbody>
</table>
<p><strong>5.数据库拆分架构详细步骤</strong></p>
<p><strong>1.web01网站服务器操作如下</strong></p>
<p><em>1) 备份web01上的数据库，Bgx123.com是数据库密码</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># mysqldump -uroot -p<span class="string">'Bgx123.com'</span> --all-databases --single-transaction &gt; mysql-all.sql</span></span><br></pre></td></tr></table></figure>
<p><em>2) 将web01上备份的数据库拷贝至db01服务器上</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># scp mysql-all.sql  root@172.16.1.51:/tmp</span></span><br></pre></td></tr></table></figure>
<p><strong>2.db01数据库服务器操作如下</strong></p>
<p><em>1) 将web01服务器上推送的数据库备份文件恢复至db01服务器新数据库中</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># yum install mariadb mariadb-server -y</span></span><br><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># systemctl start mariadb</span></span><br><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># systemctl enable mariadb</span></span><br><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># mysql -uroot -p<span class="string">'Bgx123.com'</span> &lt; /tmp/mysql-all.sql</span></span><br></pre></td></tr></table></figure>
<p><em>2) 数据库导入完成后，重启数据库，使用新密码进行登录，并检查数据库已被导入成功</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># systemctl restart mariadb</span></span><br><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># mysql -uroot -pBgx123.com</span></span><br><span class="line">mysql&gt; show databases<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p><em>3) 在新数据库上授权, 允许所有网段, 通过all账户连接并操作该数据库</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">授权所有权限   grant all privileges</span></span><br><span class="line"><span class="meta">#</span><span class="bash">授权所有库所有表 *.* </span></span><br><span class="line"><span class="meta">#</span><span class="bash">将授权赋予给哪个用户，这个用户只能通过哪个网段过来(%所有) <span class="string">'all'</span>@<span class="string">'%'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">授权该用户登录的密码 identified by</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> grant all on  *.* to all@<span class="string">'%'</span> identified by <span class="string">'Bgx123.com'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><strong>3.web01修改代码连接新数据库环境</strong></p>
<p><em>1) 修改Wordpress产品代码连接数据库的配置文件</em></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# vim /code/wordpress/wp-config.php</span><br><span class="line"><span class="meta"># 数据库名称</span></span><br><span class="line">define(<span class="string">'DB_NAME'</span>, <span class="string">'wordpress'</span>);</span><br><span class="line"><span class="meta"># 数据库用户</span></span><br><span class="line">define(<span class="string">'DB_USER'</span>, <span class="string">'all'</span>);</span><br><span class="line"><span class="meta"># 数据库密码</span></span><br><span class="line">define(<span class="string">'DB_PASSWORD'</span>, <span class="string">'Bgx123.com'</span>);</span><br><span class="line"><span class="meta"># 数据库地址</span></span><br><span class="line">define(<span class="string">'DB_HOST'</span>, <span class="string">'172.16.1.51'</span>);</span><br></pre></td></tr></table></figure>
<p><em>2) 修改wecenter产品代码连接数据库的配置文件</em></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 zh]<span class="comment">#  grep -iR "Bgx123.com"|grep -v cache</span></span><br><span class="line">system/config/database.php:  <span class="string">'password'</span> =&gt; <span class="string">'Bgx123.com'</span>,</span><br><span class="line">[root@web01 zh]<span class="comment"># vim /code/zh/system/config/database.php</span></span><br><span class="line"><span class="string">'host'</span> =&gt; <span class="string">'172.16.1.51'</span>,</span><br><span class="line"><span class="string">'username'</span> =&gt; <span class="string">'all'</span>,</span><br><span class="line"><span class="string">'password'</span> =&gt; <span class="string">'Bgx123.com'</span>,</span><br><span class="line"><span class="string">'dbname'</span> =&gt; <span class="string">'zh'</span>,</span><br></pre></td></tr></table></figure>
<p><em>3) 最后访问网站，成功打开，至此拆分数据库完成</em></p>
<h2 id="8-扩展多台相同的Web服务器"><a href="#8-扩展多台相同的Web服务器" class="headerlink" title="8.扩展多台相同的Web服务器"></a>8.扩展多台相同的Web服务器</h2><p><strong>1.为什么要扩展多台web节点</strong><br><em>单台web服务器能抗住的访问量是有限的，配置多台web服务器能提升更高的访问速度。</em></p>
<p><strong>2.扩展多台web解决了什么问题</strong><br><em>1.单台web节点如果故障，会导致业务down机2.多台web节点能保证业务的持续稳定，扩展性高3.多台web节点能有效的提升用户访问网站的速度</em></p>
<p><strong>3.多台web节点技术架构组成，如下图所示</strong></p>
<p><img src="/2025/04/08/nginx高级/15432286714848.jpg" alt="img"></p>
<p><strong>4.快速扩展一台web节点环境规划</strong></p>
<table>
<thead>
<tr>
<th>主机名称</th>
<th>应用环境</th>
<th>外网地址</th>
<th>内网地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>web01</td>
<td>nginx+php</td>
<td>10.0.0.7</td>
<td>172.16.1.7</td>
</tr>
<tr>
<td>web02</td>
<td>nginx+php</td>
<td>10.0.0.8</td>
<td>172.16.1.8</td>
</tr>
<tr>
<td>db01</td>
<td>mysql</td>
<td></td>
<td>172.16.1.51</td>
</tr>
</tbody>
</table>
<p><strong>5.快速扩展一台web节点详细步骤</strong></p>
<p><em>通过web01现有环境快速的扩展一台web02的服务器，数据库统一使用db01</em></p>
<p><em>1) 创建www用户</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># groupadd -g666 www</span></span><br><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># useradd -u666 -g666 www</span></span><br></pre></td></tr></table></figure>
<p><em>2) 安装LNP</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># scp -rp root@172.16.1.7:/etc/yum.repos.d/* /etc/yum.repos.d/</span></span><br><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># scp -rp root@172.16.1.7:/etc/pki/rpm-gpg/* /etc/pki/rpm-gpg/</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># yum install nginx -y</span></span><br><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span></span><br></pre></td></tr></table></figure>
<p><em>3) 将web01的nginx配置文件导入到web02</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># scp -rp root@172.16.1.7:/etc/nginx /etc/</span></span><br></pre></td></tr></table></figure>
<p><em>4) 将web01的php配置文件导入到web02</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># scp -rp root@172.16.1.7:/etc/php-fpm.d /etc/</span></span><br></pre></td></tr></table></figure>
<p><em>5) 将web01的产品代码打包传输到web02服务器上,在web1上线进行打包操作</em></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# tar czf <span class="keyword">code</span>.tar.gz /<span class="keyword">code</span></span><br><span class="line">[root@web01 ~]# scp <span class="keyword">code</span>.tar.gz root@<span class="number">172.16</span><span class="number">.1</span><span class="number">.8</span>:/tmp</span><br><span class="line"></span><br><span class="line">#在web02服务器上进行解压</span><br><span class="line">[root@web02 ~]# tar xf /tmp/<span class="keyword">code</span>.tar.gz -C /</span><br></pre></td></tr></table></figure>
<p><em>6) 最后启动nginx与php-fpm，并加入开机自启</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web03</span> ~]<span class="meta"># systemctl start nginx php-fpm </span></span><br><span class="line">[root<span class="symbol">@web03</span> ~]<span class="meta"># systemctl enable nginx php-fpm</span></span><br></pre></td></tr></table></figure>
<h2 id="9-拆分静态资源至独立服务器"><a href="#9-拆分静态资源至独立服务器" class="headerlink" title="9.拆分静态资源至独立服务器"></a>9.拆分静态资源至独立服务器</h2><p><strong>1.为什么拆分静态资源至独立存储服务器</strong><br><em>当后端的web节点出现多台时，会导致用户上传的图片、视频附件等内容仅上传至一台web服务器，那么其他的web服务器则无法访问到该图片。</em></p>
<p><strong>2.新增一台nfs存储解决了什么问题</strong><br><em>1.保证了多台web节点静态资源一致。2.有效节省多台web节点的存储空间。3.统一管理静态资源，便于后期推送至CDN进行静态资源加速</em></p>
<p><strong>3.多台web节点技术架构组成，如下图所示</strong></p>
<p><img src="/2025/04/08/nginx高级/15439294311862.jpg" alt="img"></p>
<p><strong>4.快速扩展一台web节点环境规划</strong></p>
<table>
<thead>
<tr>
<th>主机名称</th>
<th>应用环境</th>
<th>外网地址</th>
<th>内网地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>web01</td>
<td>nginx+php</td>
<td>10.0.0.7</td>
<td>172.16.1.7</td>
</tr>
<tr>
<td>web02</td>
<td>nginx+php</td>
<td>10.0.0.8</td>
<td>172.16.1.8</td>
</tr>
<tr>
<td>nfs</td>
<td>nfs</td>
<td></td>
<td>172.16.1.31</td>
</tr>
<tr>
<td>db01</td>
<td>mysql</td>
<td></td>
<td>172.16.1.51</td>
</tr>
</tbody>
</table>
<p><strong>5.快速扩展一台web节点详细步骤</strong></p>
<p><strong>1.nfs服务端，操作步骤如下</strong></p>
<p><em>1) 安装并配置nfs</em></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs ~]# yum install nfs-utils -y</span><br><span class="line">[root@nfs ~]# cat /etc/exports</span><br><span class="line">/data/blog <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>(rw,sync,all_squash,anonuid=<span class="number">666</span>,anongid=<span class="number">666</span>)</span><br><span class="line">/data/zh <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>(rw,sync,all_squash,anonuid=<span class="number">666</span>,anongid=<span class="number">666</span>)</span><br></pre></td></tr></table></figure>
<p><em>2) 创建共享目录，并进行授权</em></p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 ~]# mkdir /<span class="class"><span class="keyword">data</span>/&#123;<span class="title">blog</span>,<span class="title">zh</span>&#125; -p</span></span><br><span class="line">[root@nfs01 ~]# chown -<span class="type">R</span> www.www /<span class="class"><span class="keyword">data</span>/</span></span><br></pre></td></tr></table></figure>
<p><em>3) 启动nfs服务，并加入开机自启</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nfs01</span> ~]<span class="meta"># systemctl restart nfs-server</span></span><br></pre></td></tr></table></figure>
<p><strong>2.web01端操作步骤如下</strong></p>
<p><em>1) web01节点安装nfs，然后使用showmount查看服务端共享的资源</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@web01</span> <span class="string">~]#</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">nfs-utils</span> <span class="string">-y</span></span><br><span class="line"><span class="string">[root@web01</span> <span class="string">~]#</span> <span class="string">showmount</span> <span class="string">-e</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.31</span></span><br><span class="line"><span class="attr">Export list for 172.16.1.31:</span></span><br><span class="line"><span class="string">/data/zh</span>   <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="string">/data/blog</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br></pre></td></tr></table></figure>
<p><em>2) 如何查找Wordpress静态资源存放的位置</em></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">浏览器-&gt;右键-&gt;检查-&gt;Network-&gt;选择左上角的Select按钮-&gt;点击对应的图片，然后能获取到对应的url地址，如下</span><br><span class="line"># http:<span class="comment">//blog.oldboy.com/wp-content/uploads/2018/11/timg.gif</span></span><br></pre></td></tr></table></figure>
<p><em>3) 备份web01服务器上Wordpress的静态资源，因为该服务器上的资源资源最全</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># cd /code/wordpress/wp-content</span></span><br><span class="line">[root<span class="symbol">@web01</span> wp-content]<span class="meta"># cp uploads/ uploads_bak/</span></span><br></pre></td></tr></table></figure>
<p><em>4) web01客户端执行挂载操作</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> wp-content]<span class="meta"># mount -t nfs 172.16.1.31:/data/blog /code/wordpress/wp-content/uploads/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#恢复对应的数据</span></span><br><span class="line">[root<span class="symbol">@web01</span> wp-content]<span class="meta"># cp -rp uploads_bak/* uploads/</span></span><br></pre></td></tr></table></figure>
<p><em>5) 将挂载信息加入开机自启</em></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@web01</span> wp-content]<span class="comment"># tail -1 /etc/fstab </span></span><br><span class="line"><span class="number">172.16</span>.<span class="number">1.31</span><span class="symbol">:/data/blog</span>  /code/wordpress/wp-content/uploads nfs defaults 0 0</span><br><span class="line">[root<span class="variable">@web01</span> wp-content]<span class="comment"># mount -a</span></span><br></pre></td></tr></table></figure>
<p><strong>3.web02端，操作步骤如下</strong></p>
<p><em>1) web02客户端直接挂载nfs即可</em></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 ~]# mount -t nfs <span class="number">172.16</span>.<span class="number">1.31</span>:<span class="regexp">/data/</span>blog <span class="regexp">/code/</span>wordpress<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/</span></span><br></pre></td></tr></table></figure>
<p><em>2) 将挂载信息加入开机自启</em></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@web02</span> ~]<span class="comment"># tail -1 /etc/fstab </span></span><br><span class="line"><span class="number">172.16</span>.<span class="number">1.31</span><span class="symbol">:/data/blog</span>  /code/wordpress/wp-content/uploads nfs defaults 0 0</span><br><span class="line">[root<span class="variable">@web02</span> ~]<span class="comment"># mount -a</span></span><br></pre></td></tr></table></figure>
<h1 id="05-Nginx反向代理服务"><a href="#05-Nginx反向代理服务" class="headerlink" title="05.Nginx反向代理服务"></a>05.Nginx反向代理服务</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQyNzg0OTkyNzEzNi5odG1sI3RvY18w" title="http://docs.etiantian.org/15427849927136.html#toc_0">1.Nginx代理服务基本概述<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQyNzg0OTkyNzEzNi5odG1sI3RvY18x" title="http://docs.etiantian.org/15427849927136.html#toc_1">2.Nginx代理服务常见模式<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQyNzg0OTkyNzEzNi5odG1sI3RvY18y" title="http://docs.etiantian.org/15427849927136.html#toc_2">3.Nginx代理服务支持协议<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQyNzg0OTkyNzEzNi5odG1sI3RvY18z" title="http://docs.etiantian.org/15427849927136.html#toc_3">4.Nginx反向代理配置语法<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQyNzg0OTkyNzEzNi5odG1sI3RvY180" title="http://docs.etiantian.org/15427849927136.html#toc_4">5.Nginx反向代理场景实践<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-Nginx代理服务基本概述"><a href="#1-Nginx代理服务基本概述" class="headerlink" title="1.Nginx代理服务基本概述"></a>1.Nginx代理服务基本概述</h2><p><em>1.代理一词往往并不陌生, 该服务我们常常用到如(代理理财、代理租房、代理收货等等)，如下图所示</em></p>
<p><img src="/2025/04/08/nginx高级/15239420127242.jpg" alt="img"></p>
<p><em>2.在没有代理模式的情况下，客户端和Nginx服务端，都是客户端直接请求服务端，服务端直接响应客户端。</em><br><img src="/2025/04/08/nginx高级/15427999258261.jpg" alt="img"></p>
<p><em>3.那么在互联网请求里面, 客户端往往无法直接向服务端发起请求, 那么就需要用到代理服务, 来实现客户端和服务通信，如下图所示</em><br><img src="/2025/04/08/nginx高级/15378036144456.jpg" alt="img"></p>
<h2 id="2-Nginx代理服务常见模式"><a href="#2-Nginx代理服务常见模式" class="headerlink" title="2.Nginx代理服务常见模式"></a>2.Nginx代理服务常见模式</h2><p><em>那Nginx作为代理服务, 按照应用场景模式进行总结，代理分为正向代理、反向代理</em></p>
<p><em>正向代理，(内部上网) 客户端<-->代理-&gt;服务端</--></em></p>
<p><img src="/2025/04/08/nginx高级/15428029782740.jpg" alt="img"></p>
<p><em>反向代理，用于公司集群架构中，客户端-&gt;代理<-->服务端</--></em><br><img src="/2025/04/08/nginx高级/15428030503929.jpg" alt="img"></p>
<p><em>5.正向与反向代理的区别</em></p>
<blockquote>
<p>区别在于形式上服务的”对象”不一样<br>正向代理代理的对象是客户端，为客户端服务<br>反向代理代理的对象是服务端，为服务端服务</p>
</blockquote>
<h2 id="3-Nginx代理服务支持协议"><a href="#3-Nginx代理服务支持协议" class="headerlink" title="3.Nginx代理服务支持协议"></a>3.Nginx代理服务支持协议</h2><p><em>1.Nginx作为代理服务，可支持的代理协议非常的多，具体如下图</em></p>
<p><img src="/2025/04/08/nginx高级/15427911480446.jpg" alt="img"></p>
<p><em>2.如果将Nginx作为反向代理服务，常常会用到如下几种代理协议，如下图所示</em><br><img src="/2025/04/08/nginx高级/15427930199904.jpg" alt="img"></p>
<p><em>3.反向代理模式与Nginx代理模块总结如表格所示</em></p>
<table>
<thead>
<tr>
<th>反向代理模式</th>
<th>Nginx配置模块</th>
</tr>
</thead>
<tbody>
<tr>
<td>http、websocket、https</td>
<td>ngx_http_proxy_module</td>
</tr>
<tr>
<td>fastcgi</td>
<td>ngx_http_fastcgi_module</td>
</tr>
<tr>
<td>uwsgi</td>
<td>ngx_http_uwsgi_module</td>
</tr>
<tr>
<td>grpc</td>
<td>ngx_http_v2_module</td>
</tr>
</tbody>
</table>
<h2 id="4-Nginx反向代理配置语法"><a href="#4-Nginx反向代理配置语法" class="headerlink" title="4.Nginx反向代理配置语法"></a>4.Nginx反向代理配置语法</h2><p><em>1.Nginx代理配置语法</em></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span>: proxy_pass URL;</span><br><span class="line"><span class="attribute">Default</span>:    —</span><br><span class="line"><span class="attribute">Context</span>:    location, if in location, limit_except</span><br><span class="line"></span><br><span class="line"><span class="attribute">http://localhost:8000/uri/</span></span><br><span class="line"><span class="attribute">http://192.168.56.11:8000/uri/</span></span><br><span class="line"><span class="attribute">http://unix:/tmp/backend.socket:/uri/</span></span><br></pre></td></tr></table></figure>
<p><em>2.url跳转修改返回Location[不常用]参考URL</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax: proxy_redirect default;</span><br><span class="line">proxy_redirect off;proxy_redirect redirect replacement;</span><br><span class="line">Default:    proxy_redirect default;</span><br><span class="line">Context:    http, server, location</span><br></pre></td></tr></table></figure>
<p><em>3.添加发往后端服务器的请求头信息, 如图</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Syntax: proxy_set_header field value;</span><br><span class="line">Default:    proxy_set_header Host <span class="variable">$proxy_host</span>;</span><br><span class="line">            proxy_set_header<span class="built_in"> Connection </span>close;</span><br><span class="line">Context:    http, server, location</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户请求的时候HOST的值是www.bgx.com, 那么代理服务会像后端传递请求的还是www.bgx.com</span></span><br><span class="line">proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line"><span class="comment"># 将$remote_addr的值放进变量X-Real-IP中，$remote_addr的值为客户端的ip</span></span><br><span class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="comment"># 客户端通过代理服务访问后端服务, 后端服务通过该变量会记录真实客户端地址</span></span><br><span class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br></pre></td></tr></table></figure>
<p><em>4.代理到后端的TCP连接、响应、返回等超时时间, 如图</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#nginx代理与后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line"><span class="symbol">Syntax:</span> proxy_connect_timeout time<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> proxy_connect_timeout <span class="number">60</span>s<span class="comment">;</span></span><br><span class="line"><span class="symbol">Context:</span> http, server, location</span><br><span class="line"></span><br><span class="line"><span class="meta">#nginx代理等待后端服务器的响应时间</span></span><br><span class="line"><span class="symbol">Syntax:</span> proxy_read_timeout time<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span>    proxy_read_timeout <span class="number">60</span>s<span class="comment">;</span></span><br><span class="line"><span class="symbol">Context:</span>    http, server, location</span><br><span class="line"></span><br><span class="line"><span class="meta">#后端服务器数据回传给nginx代理超时时间</span></span><br><span class="line"><span class="symbol">Syntax:</span> proxy_send_timeout time<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> proxy_send_timeout <span class="number">60</span>s<span class="comment">;</span></span><br><span class="line"><span class="symbol">Context:</span> http, server, location</span><br></pre></td></tr></table></figure>
<p><em>5.proxy_buffer代理缓冲区, 如图</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nignx会把后端返回的内容先放到缓冲区当中，然后再返回给客户端,边收边传, 不是全部接收完再传给客户端</span></span><br><span class="line"><span class="attr">Syntax:</span> <span class="string">proxy_buffering</span> <span class="string">on</span> <span class="string">|</span> <span class="string">off;</span></span><br><span class="line"><span class="attr">Default:</span> <span class="string">proxy_buffering</span> <span class="string">on;</span></span><br><span class="line"><span class="attr">Context:</span> <span class="string">http,</span> <span class="string">server,</span> <span class="string">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置nginx代理保存用户头信息的缓冲区大小</span></span><br><span class="line"><span class="attr">Syntax:</span> <span class="string">proxy_buffer_size</span> <span class="string">size;</span></span><br><span class="line"><span class="attr">Default:</span> <span class="string">proxy_buffer_size</span> <span class="string">4k|8k;</span></span><br><span class="line"><span class="attr">Context:</span> <span class="string">http,</span> <span class="string">server,</span> <span class="string">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#proxy_buffers 缓冲区</span></span><br><span class="line"><span class="attr">Syntax:</span> <span class="string">proxy_buffers</span> <span class="string">number</span> <span class="string">size;</span></span><br><span class="line"><span class="attr">Default:</span> <span class="string">proxy_buffers</span> <span class="number">8</span> <span class="string">4k|8k;</span></span><br><span class="line"><span class="attr">Context:</span> <span class="string">http,</span> <span class="string">server,</span> <span class="string">location</span></span><br></pre></td></tr></table></figure>
<p><em>6.Proxy代理网站常用优化配置如下，将配置写入新文件，调用时使用include引用即可</em></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# vim /etc/nginx/proxy_params</span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout <span class="number">30</span>;</span><br><span class="line">proxy_send_timeout <span class="number">60</span>;</span><br><span class="line">proxy_read_timeout <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffer_size <span class="number">32</span>k;</span><br><span class="line">proxy_buffers <span class="number">4</span> <span class="number">128</span>k;</span><br></pre></td></tr></table></figure>
<p><em>7.代理配置location时调用, 方便后续多个Location重复使用</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">    <span class="attribute">include</span> proxy_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-Nginx反向代理场景实践"><a href="#5-Nginx反向代理场景实践" class="headerlink" title="5.Nginx反向代理场景实践"></a>5.Nginx反向代理场景实践</h2><p><code>Nginx</code>反向代理配置实例</p>
<p><img src="/2025/04/08/nginx高级/15388903914496.jpg" alt="img"></p>
<p>1.环境准备</p>
<table>
<thead>
<tr>
<th>角色</th>
<th>外网IP(NAT)</th>
<th>内网IP(LAN)</th>
<th>主机名</th>
</tr>
</thead>
<tbody>
<tr>
<td>Proxy</td>
<td>eth0:10.0.0.5</td>
<td>eth1:172.16.1.5</td>
<td>lb01</td>
</tr>
<tr>
<td>web01</td>
<td></td>
<td>eth1:172.16.1.7</td>
<td>web01</td>
</tr>
</tbody>
</table>
<p><em>2.web01服务器, 配置一个网站，监听在8080，此时网站仅172网段的用户能访问</em></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]<span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># vim web.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="keyword">listen</span> <span class="number">8080</span>;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code_808<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">index</span> index.html;</span><br><span class="line">        deny <span class="number">10.0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">24</span>;</span><br><span class="line">        allow all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 conf.d]<span class="comment"># mkdir /code_8080</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># echo "web01-7...." &gt;/code_8080/index.html</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>2.proxy代理服务器, 配置监听eth0的80端口，使10.0.0.0网段的用户，能够通过代理服务器访问到后端的172.16.1.7的8080端口站点内容</em></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@lb01 ~</span>]<span class="meta"># cd /etc/nginx/conf.d/</span></span><br><span class="line">[<span class="meta">root@lb01 conf.d</span>]<span class="meta"># cat proxy_web_node1.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name nginx.oldboy.com;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//172.16.1.7:8080;</span></span><br><span class="line">        include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">root@lb01 conf.d</span>]<span class="meta"># systemctl enable nginx</span></span><br><span class="line">[<span class="meta">root@lb01 conf.d</span>]<span class="meta"># systemctl start nginx</span></span><br></pre></td></tr></table></figure>
<h1 id="06-Nginx代理缓存服务"><a href="#06-Nginx代理缓存服务" class="headerlink" title="06.Nginx代理缓存服务"></a>06.Nginx代理缓存服务</h1><p>通常情况下缓存是用来减少后端压力, <strong>将压力尽可能的往前推</strong>, 减少后端压力,提高网站并发延时</p>
<p><img src="/2025/04/08/nginx高级/15241531083453.jpg" alt="img"></p>
<h2 id="1-缓存常见类型"><a href="#1-缓存常见类型" class="headerlink" title="1.缓存常见类型"></a>1.缓存常见类型</h2><p>服务端缓存</p>
<p><img src="/2025/04/08/nginx高级/15241533422852.jpg" alt="img"></p>
<p>代理缓存, 获取服务端内容进行缓存</p>
<p><img src="/2025/04/08/nginx高级/15241533901974.jpg" alt="img"></p>
<p>客户端浏览器缓存</p>
<p><img src="/2025/04/08/nginx高级/15241534612860.jpg" alt="img"></p>
<p><code>Nginx</code>代理缓存原理</p>
<p><img src="/2025/04/08/nginx高级/15241535185103.jpg" alt="img"></p>
<h2 id="2-缓存配置语法"><a href="#2-缓存配置语法" class="headerlink" title="2.缓存配置语法"></a>2.缓存配置语法</h2><p><em>1.proxy_cache配置语法</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span>: proxy_cache zone | off;</span><br><span class="line"><span class="attribute">Default</span>: proxy_cache off;</span><br><span class="line"><span class="attribute">Context</span>: http, server, location</span><br><span class="line"></span><br><span class="line">#1.缓存路径</span><br><span class="line"><span class="attribute">Syntax</span>: proxy_cache_path path [levels=levels]</span><br><span class="line">[use_temp_path=on|off] keys_zone=name:size [inactive=time]</span><br><span class="line">[max_size=size] [manager_files=number] [manager_sleep=time][manager_threshold=time]</span><br><span class="line">[loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off]</span><br><span class="line">[purger_files=number] [purger_sleep=time] [purger_threshold=time];</span><br><span class="line"><span class="attribute">Default</span>: —</span><br><span class="line"><span class="attribute">Context</span>: http</span><br><span class="line"></span><br><span class="line">#2.缓存过期周期</span><br><span class="line"><span class="attribute">Syntax</span>: proxy_cache_valid [code ...] time;</span><br><span class="line"><span class="attribute">Default</span>: —</span><br><span class="line"><span class="attribute">Context</span>: http, server, location</span><br><span class="line"></span><br><span class="line">#示例</span><br><span class="line">proxy_cache_valid 200 302 10m;</span><br><span class="line">proxy_cache_valid 404   1m;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#3.缓存的维度</span><br><span class="line"><span class="attribute">Syntax</span>: proxy_cache_key string;</span><br><span class="line"><span class="attribute">Default</span>:    proxy_cache_key $scheme$proxy_host$request_uri;</span><br><span class="line"><span class="attribute">Context</span>: http, server, location</span><br><span class="line">#示例</span><br><span class="line">proxy_cache_key "$host$request_uri $cookie_user";</span><br><span class="line">proxy_cache_key $scheme$proxy_host$uri$is_args$args;</span><br></pre></td></tr></table></figure>
<h2 id="3-缓存配置实践"><a href="#3-缓存配置实践" class="headerlink" title="3.缓存配置实践"></a>3.缓存配置实践</h2><p><em>1.缓存准备</em></p>
<table>
<thead>
<tr>
<th>操作系统</th>
<th>应用服务</th>
<th>外网地址</th>
<th>内网地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS7.5</td>
<td>Nginx Proxy</td>
<td>10.0.0.5</td>
<td>172.16.1.5</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>Nginx Web</td>
<td></td>
<td>172.16.1.7</td>
</tr>
</tbody>
</table>
<p><em>2.web节点准备</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建立相关目录</span></span><br><span class="line">[root@web01 ~]# mkdir -p /soft/code&#123;1<span class="built_in">..</span>3&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#建立相关html文件</span></span><br><span class="line">[root@web01 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1<span class="built_in">..</span>3&#125;;<span class="keyword">do</span> echo Code1-Url<span class="variable">$i</span> &gt; /soft/code1/url<span class="variable">$i</span>.html;done </span><br><span class="line">[root@web01 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1<span class="built_in">..</span>3&#125;;<span class="keyword">do</span> echo Code2-Url<span class="variable">$i</span> &gt; /soft/code2/url<span class="variable">$i</span>.html;done</span><br><span class="line">[root@web01 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1<span class="built_in">..</span>3&#125;;<span class="keyword">do</span> echo Code3-Url<span class="variable">$i</span> &gt; /soft/code3/url<span class="variable">$i</span>.html;done</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置Nginx</span></span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/web_node.conf </span><br><span class="line">server &#123;</span><br><span class="line">        listen 8081;</span><br><span class="line">        root /soft/code1;</span><br><span class="line">        index index.html;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 8082;</span><br><span class="line">        root /soft/code2;</span><br><span class="line">        index index.html;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 8083;</span><br><span class="line">        root /soft/code3;</span><br><span class="line">        index index.html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查监听端口</span></span><br><span class="line">[root@web01 ~]# netstat -lntp|grep 80</span><br><span class="line">tcp        0      0 0.0.0.0:8081            0.0.0.0:*               LISTEN      50922/nginx: master </span><br><span class="line">tcp        0      0 0.0.0.0:8082            0.0.0.0:*               LISTEN      50922/nginx: master </span><br><span class="line">tcp        0      0 0.0.0.0:8083            0.0.0.0:*               LISTEN      50922/nginx: master</span><br></pre></td></tr></table></figure>
<p><em>3.代理配置缓存</em></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# mkdir /soft/cache</span><br><span class="line">[root@lb01 ~]# cat /etc/nginx/conf.d/proxy_cache.conf</span><br><span class="line">upstream cache &#123;</span><br><span class="line">    server <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">8081</span>;</span><br><span class="line">    server <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">8082</span>;</span><br><span class="line">    server <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">8083</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#proxy_cache存放缓存临时文件</span></span><br><span class="line"><span class="meta">#levels     按照两层目录分级</span></span><br><span class="line"><span class="meta">#keys_zone  开辟空间名, 10m:开辟空间大小, 1m可存放8000key</span></span><br><span class="line"><span class="meta">#max_size   控制最大大小, 超过后Nginx会启用淘汰规则</span></span><br><span class="line"><span class="meta">#inactive   60分钟没有被访问缓存会被清理</span></span><br><span class="line"><span class="meta">#use_temp_path  临时文件, 会影响性能, 建议关闭</span></span><br><span class="line">proxy_cache_path /soft/cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=code_cache:<span class="number">10</span>m max_size=<span class="number">10</span>g inactive=<span class="number">60</span>m use_temp_path=off;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name cache.bgx.com;</span><br><span class="line"></span><br><span class="line"><span class="meta">#proxy_cache        开启缓存</span></span><br><span class="line"><span class="meta">#proxy_cache_valid  状态码200|304的过期为12h, 其余状态码10分钟过期</span></span><br><span class="line"><span class="meta">#proxy_cache_key    缓存key</span></span><br><span class="line"><span class="meta">#add_header         增加头信息, 观察客户端respoce是否命中</span></span><br><span class="line"><span class="meta">#proxy_next_upstream 出现502-504或错误, 会跳过此台服务器访问下台</span></span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http:<span class="comment">//cache;</span></span><br><span class="line">                proxy_cache code_cache;</span><br><span class="line">                proxy_cache_valid <span class="number">200</span> <span class="number">304</span> <span class="number">12</span>h;</span><br><span class="line">                proxy_cache_valid any <span class="number">10</span>m;</span><br><span class="line">                add_header Nginx-Cache <span class="string">"$upstream_cache_status"</span>;</span><br><span class="line">                proxy_next_upstream error timeout invalid_header http_500 http_502 http_503  http_504;</span><br><span class="line">                include proxy_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3.客户端测试</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#第一次访问无法命中</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># curl -s -I http://cache.bgx.com/url3.html|grep <span class="string">"Nginx-Cache"</span></span></span><br><span class="line">Nginx-Cache: MISS</span><br><span class="line"></span><br><span class="line"><span class="meta">#第二次访问命中</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># curl -s -I http://cache.bgx.com/url3.html|grep <span class="string">"Nginx-Cache"</span></span></span><br><span class="line">Nginx-Cache: HIT</span><br></pre></td></tr></table></figure>
<h2 id="4-缓存如何清理"><a href="#4-缓存如何清理" class="headerlink" title="4.缓存如何清理"></a>4.缓存如何清理</h2><p>如何清理proxy_cache代理的缓存</p>
<p><em>1.使用rm删除已缓存数据</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># rm -rf /soft/cache/*</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># curl -s -I http://cache.bgx.com/url3.html|grep <span class="string">"Nginx-Cache"</span></span></span><br><span class="line">Nginx-Cache: MISS</span><br></pre></td></tr></table></figure>
<p><em>2.通过ngx_cache_purge扩展模块清理, 需要编译安装Nginx</em></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建立对应目录</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># mkdir /soft/src</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># cd /soft/src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#下载Nginx包</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># wget http://nginx.org/download/nginx-1.12.2.tar.gz</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># tar xf nginx-1.12.2.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#下载ngx_cache_purge</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># wget http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># tar xf ngx_cache_purge-2.3.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译Nginx</span></span><br><span class="line"></span><br><span class="line">[root@lb01 ~]<span class="comment"># cd nginx-1.12.2/ &amp;&amp; ./configure \</span></span><br><span class="line">--prefix=/server/nginx --add-<span class="built_in">module</span>=../ngx_cache_purge-<span class="number">2.3</span> <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-http_stub_status_module --<span class="keyword">with</span>-http_ssl_module</span><br><span class="line">[root@lb01 ~]<span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<p><em>3.增加清理缓存的location，配置如下内容</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@lb01</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">/etc/nginx/conf.d/proxy_cache.conf</span></span><br><span class="line"><span class="string">upstream</span> <span class="string">cache</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span><span class="string">:8081;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span><span class="string">:8082;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span><span class="string">:8083;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">proxy_cache_path</span> <span class="string">/soft/cache</span> <span class="string">levels=1:2</span> <span class="string">keys_zone=code_cache:10m</span> <span class="string">max_size=10g</span> <span class="string">inactive=60m</span> <span class="string">use_temp_path=off;</span></span><br><span class="line"></span><br><span class="line"><span class="string">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">    <span class="string">server_name</span> <span class="string">cache.bgx.com;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">location</span> <span class="string">/</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">proxy_pass</span> <span class="string">http://cache;</span></span><br><span class="line">        <span class="string">proxy_cache</span> <span class="string">code_cache;</span></span><br><span class="line">        <span class="string">proxy_cache_valid</span> <span class="number">200</span> <span class="number">304</span> <span class="string">12h;</span></span><br><span class="line">        <span class="string">proxy_cache_valid</span> <span class="string">any</span> <span class="string">10m;</span></span><br><span class="line">        <span class="string">add_header</span> <span class="string">Nginx-Cache</span> <span class="string">"$upstream_cache_status"</span><span class="string">;</span></span><br><span class="line">        <span class="string">proxy_next_upstream</span> <span class="string">error</span> <span class="string">timeout</span> <span class="string">invalid_header</span> <span class="string">http_500</span> <span class="string">http_502</span> <span class="string">http_503</span>  <span class="string">http_504;</span></span><br><span class="line">        <span class="string">include</span> <span class="string">proxy_params;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line">    <span class="string">location</span> <span class="string">~</span> <span class="string">/purge(/.*)</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">allow</span>   <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">;</span></span><br><span class="line">        <span class="string">allow</span>   <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24;</span></span><br><span class="line">        <span class="string">deny</span>    <span class="string">all;</span></span><br><span class="line">        <span class="string">proxy_cache_purge</span> <span class="string">code_cache</span> <span class="string">$host$1$is_args$args;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测配置重新加载</span></span><br><span class="line"><span class="string">[root@nginx</span> <span class="string">conf.d]#</span> <span class="string">/server/nginx/sbin/nginx</span> <span class="string">-t</span></span><br><span class="line"><span class="string">[root@nginx</span> <span class="string">conf.d]#</span> <span class="string">/server/nginx/sbin/nginx</span> <span class="string">-s</span> <span class="string">reload</span></span><br></pre></td></tr></table></figure>
<p><em>4.使用浏览器访问建立缓存</em></p>
<p><img src="/2025/04/08/nginx高级/15242015035436.jpg" alt="img"></p>
<p><em>5.通过访问purge/url地址，删除对应的缓存</em></p>
<p><img src="/2025/04/08/nginx高级/15242013807100.jpg" alt="img"></p>
<p><em>6.再次刷新就会因为缓存内容已清理，而出现404错误</em></p>
<p><img src="/2025/04/08/nginx高级/15242016134675.jpg" alt="img"></p>
<h2 id="5-指定页面不缓存"><a href="#5-指定页面不缓存" class="headerlink" title="5.指定页面不缓存"></a>5.指定页面不缓存</h2><p><em>1.如何配置指定部分页面不进行proxy_Cache缓存</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># cat /etc/nginx/conf.d/proxy_cache.conf</span></span><br><span class="line">upstream cache&#123;</span><br><span class="line">    server <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">8081</span><span class="comment">;</span></span><br><span class="line">    server <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">8082</span><span class="comment">;</span></span><br><span class="line">    server <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">8083</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">proxy_cache_path /soft/cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=code_cache:<span class="number">10</span>m max_size=<span class="number">10</span>g inactive=<span class="number">60</span>m use_temp_path=off<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span><span class="comment">;</span></span><br><span class="line">    server_name cache.bgx.com<span class="comment">;</span></span><br><span class="line">    <span class="meta">#如果请求文件如下，则设定nocache为1</span></span><br><span class="line">    <span class="keyword">if</span> ($request_uri ~ ^/(url3|login|register|password)) &#123;</span><br><span class="line">        set $nocache <span class="number">1</span><span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://cache<span class="comment">;</span></span><br><span class="line">        proxy_cache code_cache<span class="comment">;</span></span><br><span class="line">        proxy_cache_valid <span class="number">200</span> <span class="number">304</span> <span class="number">12</span>h<span class="comment">;</span></span><br><span class="line">        proxy_cache_valid any <span class="number">10</span>m<span class="comment">;</span></span><br><span class="line">        proxy_cache_key $host$uri$is_args$args<span class="comment">;</span></span><br><span class="line">        proxy_no_cache $nocache $arg_nocache $arg_comment<span class="comment">;  #不缓存变量为nocache</span></span><br><span class="line">        proxy_no_cache $http_pargma $http_authorization<span class="comment">;    #不缓存http参数以及http认证</span></span><br><span class="line">        add_header Nginx-Cache <span class="string">"$upstream_cache_status"</span><span class="comment">;</span></span><br><span class="line">        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503  http_504<span class="comment">;</span></span><br><span class="line">        include proxy_params<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#先清理所有缓存</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># rm -rf /soft/cache/*</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#无论如何请求url3都无法命中</span></span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># curl -s -I http://192.168.69.112/url3.html|grep <span class="string">"Nginx-Cache"</span>    </span></span><br><span class="line">Nginx-Cache: MISS</span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># curl -s -I http://192.168.69.112/url3.html|grep <span class="string">"Nginx-Cache"</span></span></span><br><span class="line">Nginx-Cache: MISS</span><br><span class="line">[root<span class="symbol">@nginx</span> ~]<span class="meta"># curl -s -I http://192.168.69.112/url3.html|grep <span class="string">"Nginx-Cache"</span></span></span><br><span class="line">Nginx-Cache: MISS</span><br></pre></td></tr></table></figure>
<h2 id="6-缓存日志记录"><a href="#6-缓存日志记录" class="headerlink" title="6.缓存日志记录"></a>6.缓存日志记录</h2><p><em>通过日志记录proxy_cache命中情况与对应url</em></p>
<p><em>1.修改nginx的log_format格式，增加”$upstream_cache_status”，该变量包含如下几种状态</em></p>
<blockquote>
<p>MISS 未命中，请求被传送到后端<br>HIT 缓存命中，通过缓存返回数据<br>EXPIRED 缓存已经过期请求被传送到后端<br>UPDATING 正在更新缓存，将使用旧的应答<br>STALE 后端将得到过期的应答</p>
</blockquote>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="keyword">http</span> &#123;</span><br><span class="line">    log_format  <span class="keyword">main</span>  <span class="string">'<span class="variable">$http_user_agent</span>'</span> <span class="string">'<span class="variable">$request_uri</span>'</span> <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span> <span class="string">'"<span class="variable">$upstream_cache_status</span>"'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.在server标签中添加对应的access日志</em></p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    <span class="params">...</span></span><br><span class="line">    access_log /<span class="built_in">var</span>/<span class="keyword">log</span>/nginx/proxy_cache.<span class="keyword">log</span> main;</span><br><span class="line">    <span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3.使用curl访问, 最后检查日志命令情况</em></p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@lb01 ~]</span># tail /var/log/nginx/proxy_cache.log</span><br><span class="line"><span class="number">10.0.0.1</span> - - <span class="string">[19/Apr/2018:11:48:43 -0400]</span> <span class="string">"<span class="keyword">HEAD</span> /url3.html HTTP/1.1"</span> <span class="number">200</span> <span class="number">0</span> <span class="string">"-"</span> <span class="string">"curl/7.29.0"</span> <span class="string">"-"</span><span class="string">"MISS"</span></span><br><span class="line"><span class="number">10.0.0.1</span> - - <span class="string">[19/Apr/2018:11:48:45 -0400]</span> <span class="string">"<span class="keyword">HEAD</span> /url2.html HTTP/1.1"</span> <span class="number">200</span> <span class="number">0</span> <span class="string">"-"</span> <span class="string">"curl/7.29.0"</span> <span class="string">"-"</span><span class="string">"HIT"</span></span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cDovL3d3dy4zNjF3YXkuY29tL25naW54LWNhY2hlLzI2NjUuaHRtbA==" title="http://www.361way.com/nginx-cache/2665.html">Nginx查看命中率<i class="fa fa-external-link"></i></span></p>
<h1 id="07-Nginx七层负载均衡"><a href="#07-Nginx七层负载均衡" class="headerlink" title="07.Nginx七层负载均衡"></a>07.Nginx七层负载均衡</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMjU1NzgxMS5odG1sI3RvY18w" title="http://docs.etiantian.org/15332922557811.html#toc_0">1.Nginx负载均衡基本概述<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMjU1NzgxMS5odG1sI3RvY18x" title="http://docs.etiantian.org/15332922557811.html#toc_1">2.Nginx负载均衡配置场景<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMjU1NzgxMS5odG1sI3RvY18y" title="http://docs.etiantian.org/15332922557811.html#toc_2">3.Nginx负载均衡调度算法<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMjU1NzgxMS5odG1sI3RvY18z" title="http://docs.etiantian.org/15332922557811.html#toc_3">4.Nginx负载均衡后端状态<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMjU1NzgxMS5odG1sI3RvY180" title="http://docs.etiantian.org/15332922557811.html#toc_4">5.Nginx负载均衡健康检查<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMjU1NzgxMS5odG1sI3RvY181" title="http://docs.etiantian.org/15332922557811.html#toc_5">6.Nginx负载均衡会话共享<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-Nginx负载均衡基本概述"><a href="#1-Nginx负载均衡基本概述" class="headerlink" title="1.Nginx负载均衡基本概述"></a>1.Nginx负载均衡基本概述</h2><p><strong>为什么需要使用负载均衡</strong></p>
<p><em>当我们的Web服务器直接面向用户，往往要承载大量并发请求，单台服务器难以负荷，我使用多台WEB服务器组成集群，前端使用Nginx负载均衡，将请求分散的打到我们的后端服务器集群中，实现负载的分发。那么会大大提升系统的吞吐率、请求性能、高容灾</em></p>
<p><img src="/2025/04/08/nginx高级/15378065298018.jpg" alt="img"></p>
<p><em>往往我们接触的最多的是SLB(Server Load Balance)负载均衡，实现最多的也是SLB、那么SLB它的调度节点和服务节点通常是在一个地域里面。那么它在这个小的逻辑地域里面决定了他对部分服务的实时性、响应性是非常好的。所以说当海量用户请求过来以后，它同样是请求调度节点，调度节点将用户的请求转发给后端对应的服务节点，服务节点处理完请求后在转发给调度节点，调度节点最后响应给用户节点。这样也能实现一个均衡的作用，那么Nginx则是一个典型的SLB</em></p>
<p><img src="/2025/04/08/nginx高级/15239542175571.jpg" alt="img"></p>
<p><strong>负载均衡能实现的应用场景一: 四层负载均衡</strong></p>
<p><em>所谓四层负载均衡指的是OSI七层模型中的传输层，那么传输层Nginx已经能支持TCP/IP的控制，所以只需要对客户端的请求进行TCP/IP协议的包转发就可以实现负载均衡，那么它的好处是性能非常快、只需要底层进行应用处理，而不需要进行一些复杂的逻辑。</em></p>
<p><img src="/2025/04/08/nginx高级/15239534300637.jpg" alt="img"></p>
<p><strong>负载均衡能实现的应用场景二: 七层负载均衡</strong></p>
<p><em>七层负载均衡它是在应用层，那么它可以完成很多应用方面的协议请求，比如我们说的http应用的负载均衡，它可以实现http信息的改写、头信息的改写、安全应用规则控制、URL匹配规则控制、以及转发、rewrite等等的规则，所以在应用层的服务里面，我们可以做的内容就更多，那么Nginx则是一个典型的七层负载均衡SLB</em></p>
<p><img src="/2025/04/08/nginx高级/15239536246178.jpg" alt="img"></p>
<p><strong>3.四层负载均衡与七层负载均衡区别</strong></p>
<p><em>四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发、由此可以看出，七层负载均衡效率没有四负载均衡高。</em></p>
<p><em>但七层负载均衡更贴近于服务，如:http协议就是七层协议，我们可以用Nginx可以作会话保持，URL路径规则匹配、head头改写等等，这些是四层负载均衡无法实现的。</em></p>
<h2 id="2-Nginx负载均衡配置场景"><a href="#2-Nginx负载均衡配置场景" class="headerlink" title="2.Nginx负载均衡配置场景"></a>2.Nginx负载均衡配置场景</h2><p><em>Nginx要实现负载均衡需要用到proxy_pass代理模块配置.Nginx负载均衡与Nginx代理不同地方在于，Nginx代理仅代理一台服务器，而Nginx负载均衡则是将客户端请求代理转发至一组upstream虚拟服务池</em></p>
<p><img src="/2025/04/08/nginx高级/15378071410074.jpg" alt="img"></p>
<p><code>Nginx upstream</code>虚拟配置语法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span>: upstream name &#123; ... &#125;</span><br><span class="line"><span class="attribute">Default</span>: -</span><br><span class="line"><span class="attribute">Context</span>: http</span><br><span class="line"></span><br><span class="line">#upstream例</span><br><span class="line">upstream backend &#123;</span><br><span class="line">    server backend1.example.com       weight=5;</span><br><span class="line">    server backend2.example.com:8080;</span><br><span class="line">    server unix:/tmp/backend3;</span><br><span class="line">    server backup1.example.com:8080   backup;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>0.环境规划</em></p>
<table>
<thead>
<tr>
<th>角色</th>
<th>外网IP(NAT)</th>
<th>内网IP(LAN)</th>
<th>主机名</th>
</tr>
</thead>
<tbody>
<tr>
<td>LB01</td>
<td>eth0:10.0.0.5</td>
<td>eth1:172.16.1.5</td>
<td>lb01</td>
</tr>
<tr>
<td>web01</td>
<td>eth0:10.0.0.7</td>
<td>eth1:172.16.1.7</td>
<td>web01</td>
</tr>
<tr>
<td>web02</td>
<td>eth0:10.0.0.8</td>
<td>eth1:172.16.1.8</td>
<td>web02</td>
</tr>
</tbody>
</table>
<p><em>1.Web01服务器上配置nginx, 并创建对应html文件</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]<span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># cat node.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name <span class="keyword">node</span>.<span class="title">oldboy</span>.com;</span><br><span class="line">    <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">        root</span> /<span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">        index</span> index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 conf.d]<span class="comment"># mkdir /node</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># echo "Web01..." &gt; /node/index.html</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>2.Web02服务器上配置nginx, 并创建对应html文件</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 ~]<span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line">[root@web02 conf.d]<span class="comment"># cat node.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name <span class="keyword">node</span>.<span class="title">oldboy</span>.com;</span><br><span class="line">    <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">        root</span> /<span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">        index</span> index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web02 conf.d]<span class="comment"># mkdir /node</span></span><br><span class="line">[root@web02 conf.d]<span class="comment"># echo "Web02..." &gt; /node/index.html</span></span><br><span class="line">[root@web02 conf.d]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>3.配置Nginx负载均衡</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]<span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line">[root@lb01 conf.d]<span class="comment"># cat node_proxy.conf </span></span><br><span class="line">upstream <span class="keyword">node</span> <span class="title">&#123;</span></span><br><span class="line"><span class="title">    server</span> <span class="number">172.16</span>.<span class="number">1.7</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.8</span>:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name <span class="keyword">node</span>.<span class="title">oldboy</span>.com;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">        proxy_pass</span> http://<span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">        include</span> proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb01 conf.d]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>4.准备Nginx负载均衡调度使用的proxy_params</em></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# vim /etc/nginx/proxy_params</span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout <span class="number">30</span>;</span><br><span class="line">proxy_send_timeout <span class="number">60</span>;</span><br><span class="line">proxy_read_timeout <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffer_size <span class="number">32</span>k;</span><br><span class="line">proxy_buffers <span class="number">4</span> <span class="number">128</span>k;</span><br></pre></td></tr></table></figure>
<p><em>5.使用浏览器访问node.oldboy.com, 然后不断刷新测试</em></p>
<p><img src="/2025/04/08/nginx高级/15388917816881.jpg" alt="img"></p>
<p><img src="/2025/04/08/nginx高级/15388917904538.jpg" alt="img"></p>
<h2 id="3-Nginx负载均衡调度算法"><a href="#3-Nginx负载均衡调度算法" class="headerlink" title="3.Nginx负载均衡调度算法"></a>3.Nginx负载均衡调度算法</h2><table>
<thead>
<tr>
<th>调度算法</th>
<th>概述</th>
</tr>
</thead>
<tbody>
<tr>
<td>轮询</td>
<td>按时间顺序逐一分配到不同的后端服务器(默认)</td>
</tr>
<tr>
<td>weight</td>
<td>加权轮询,weight值越大,分配到的访问几率越高</td>
</tr>
<tr>
<td>ip_hash</td>
<td>每个请求按访问IP的hash结果分配,这样来自同一IP的固定访问一个后端服务器</td>
</tr>
<tr>
<td>url_hash</td>
<td>按照访问URL的hash结果来分配请求,是每个URL定向到同一个后端服务器</td>
</tr>
<tr>
<td>least_conn</td>
<td>最少链接数,那个机器链接数少就分发</td>
</tr>
</tbody>
</table>
<p><em>1.Nginx负载均衡[wrr]轮询具体配置</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.7:80;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.8:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.Nginx负载均衡[weight]权重轮询具体配置</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.7:80 <span class="attribute">weight</span>=5;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.8:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3.Nginx负载均衡ip_hash具体配置, 不能和weight一起使用。</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果客户端都走相同代理, 会导致某一台服务器连接过多</span></span><br><span class="line">upstream load_pass &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.7:80 <span class="attribute">weight</span>=5;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.8:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-Nginx负载均衡后端状态"><a href="#4-Nginx负载均衡后端状态" class="headerlink" title="4.Nginx负载均衡后端状态"></a>4.Nginx负载均衡后端状态</h2><p><em>后端Web服务器在前端Nginx负载均衡调度中的状态</em></p>
<table>
<thead>
<tr>
<th>状态</th>
<th>概述</th>
</tr>
</thead>
<tbody>
<tr>
<td>down</td>
<td>当前的server暂时不参与负载均衡</td>
</tr>
<tr>
<td>backup</td>
<td>预留的备份服务器</td>
</tr>
<tr>
<td>max_fails</td>
<td>允许请求失败的次数</td>
</tr>
<tr>
<td>fail_timeout</td>
<td>经过max_fails失败后, 服务暂停时间</td>
</tr>
<tr>
<td>max_conns</td>
<td>限制最大的接收连接数</td>
</tr>
</tbody>
</table>
<p><em>1.测试down状态, 测试该Server不参与负载均衡的调度</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">    #不参与任何调度, 一般用于停机维护</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.7:80 down;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.测试backup以及down状态</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> load_pass &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">10.0.0.7:80</span> down;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">10.0.0.8:80</span> backup;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">10.0.0.9:80</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">10s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span>  / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://load_pass;</span><br><span class="line">    <span class="attribute">include</span> proxy_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3.测试max_fails失败次数和fail_timeout多少时间内失败多少次则标记down</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.7:80;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.8:80 <span class="attribute">max_fails</span>=2 <span class="attribute">fail_timeout</span>=10s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>4.测试max_conns最大TCP连接数</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.7:80;</span><br><span class="line">   <span class="built_in"> server </span>10.0.0.8:80 <span class="attribute">max_conns</span>=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-Nginx负载均衡健康检查"><a href="#5-Nginx负载均衡健康检查" class="headerlink" title="5.Nginx负载均衡健康检查"></a>5.Nginx负载均衡健康检查</h2><p><em>在Nginx官方模块提供的模块中，没有对负载均衡后端节点的健康检查模块，但可以使用第三方模块nginx_upstream_check_module来检测后方服务的健康状态</em><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lhb3dlaWJpbi9uZ2lueF91cHN0cmVhbV9jaGVja19tb2R1bGUv" title="https://github.com/yaoweibin/nginx_upstream_check_module/">upstream_check_module项目地址<i class="fa fa-external-link"></i></span></p>
<p><em>1.安装依赖包</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@lb02</span> ~]<span class="meta"># yum install -y gcc glibc gcc-c++ prce-devel openssl-devel pcre-devel patch</span></span><br></pre></td></tr></table></figure>
<p><em>2.下载nginx源码包以及nginx_upstream_check模块第三方模块</em></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 <span class="symbol">~]# wget http</span>:<span class="comment">//nginx.org/download/nginx-1.14.2.tar.gz</span></span><br><span class="line">[root@lb02 <span class="symbol">~]# wget https</span>:<span class="comment">//github.com/yaoweibin/nginx_upstream_check_module/archive/master.zip</span></span><br></pre></td></tr></table></figure>
<p><em>3.解压nginx源码包以及第三方模块</em></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@lb02 ~]</span># <span class="selector-tag">tar</span> <span class="selector-tag">xf</span> <span class="selector-tag">nginx-1</span><span class="selector-class">.14</span><span class="selector-class">.2</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line"><span class="selector-attr">[root@lb02 ~]</span># <span class="selector-tag">unzip</span> <span class="selector-tag">master</span><span class="selector-class">.zip</span></span><br></pre></td></tr></table></figure>
<p><em>4.进入nginx目录，打补丁(nginx的版本是1.14补丁就选择1.14的,p1代表在nginx目录，p0是不在nginx目录)</em></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 ~]# cd nginx<span class="number">-1.14</span><span class="number">.2</span>/</span><br><span class="line">[root@lb02 nginx<span class="number">-1.14</span><span class="number">.2</span>]# patch -p1 &lt;../nginx_upstream_check_module-master/check_1<span class="number">.14</span><span class="number">.0</span>+.patch</span><br></pre></td></tr></table></figure>
<p><em>5.编译Nginx，需要添加upstream_check第三方模块</em></p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 nginx-<span class="number">1.14</span>.<span class="number">2</span>]# ./configure --<span class="keyword">prefix</span>=/etc/nginx --sbin-<span class="built_in">path</span>=/usr/sbin/nginx --modules-<span class="built_in">path</span>=/usr/lib64/nginx/modules --conf-<span class="built_in">path</span>=/etc/nginx/nginx.conf --error-<span class="built_in">log</span>-<span class="built_in">path</span>=/var/<span class="built_in">log</span>/nginx/error.<span class="built_in">log</span> --http-<span class="built_in">log</span>-<span class="built_in">path</span>=/var/<span class="built_in">log</span>/nginx/access.<span class="built_in">log</span> --pid-<span class="built_in">path</span>=/var/run/nginx.pid --lock-<span class="built_in">path</span>=/var/run/nginx.lock --http-client-body-temp-<span class="built_in">path</span>=/var/cache/nginx/client_temp --http-proxy-temp-<span class="built_in">path</span>=/var/cache/nginx/proxy_temp --http-fastcgi-temp-<span class="built_in">path</span>=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-<span class="built_in">path</span>=/var/cache/nginx/uwsgi_temp --http-scgi-temp-<span class="built_in">path</span>=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --<span class="keyword">with</span>-compat --<span class="keyword">with</span>-file-aio --<span class="keyword">with</span>-threads --<span class="keyword">with</span>-http_addition_module --<span class="keyword">with</span>-http_auth_request_module --<span class="keyword">with</span>-http_dav_module --<span class="keyword">with</span>-http_flv_module --<span class="keyword">with</span>-http_gunzip_module --<span class="keyword">with</span>-http_gzip_static_module --<span class="keyword">with</span>-http_mp4_module --<span class="keyword">with</span>-http_random_index_module --<span class="keyword">with</span>-http_realip_module --<span class="keyword">with</span>-http_secure_link_module --<span class="keyword">with</span>-http_slice_module --<span class="keyword">with</span>-http_ssl_module --<span class="keyword">with</span>-http_stub_status_module --<span class="keyword">with</span>-http_sub_module --<span class="keyword">with</span>-http_v2_module --<span class="keyword">with</span>-mail --<span class="keyword">with</span>-mail_ssl_module --<span class="keyword">with</span>-stream --<span class="keyword">with</span>-stream_realip_module --<span class="keyword">with</span>-stream_ssl_module --<span class="keyword">with</span>-stream_ssl_preread_module --add-module=/root/nginx_upstream_check_module-master --<span class="keyword">with</span>-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC'</span> --<span class="keyword">with</span>-ld-opt=<span class="string">'-Wl,-z,relro -Wl,-z,now -pie'</span></span><br><span class="line"></span><br><span class="line">[root@lb02 nginx-<span class="number">1.14</span>.<span class="number">2</span>]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p><em>6.配置nginx负载均衡，同时打开upstream健康检查功能</em></p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 conf.d]<span class="comment"># cat proxy.blog.bgx.com.conf</span></span><br><span class="line">upstream blog.bgx.<span class="keyword">com</span> &#123;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.7</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.8</span>:<span class="number">80</span>;</span><br><span class="line">    check interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">3</span> timeout=<span class="number">1000</span> <span class="built_in">type</span>=tcp;</span><br><span class="line">    <span class="comment">#interval检测间隔时间，单位为毫秒</span></span><br><span class="line">    <span class="comment">#rsie表示请求2次正常，标记此后端的状态为up</span></span><br><span class="line">    <span class="comment">#fall表示请求3次失败，标记此后端的状态为down</span></span><br><span class="line">    <span class="comment">#type  类型为tcp</span></span><br><span class="line">    <span class="comment">#timeout为超时时间，单位为毫秒</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name blog.bgx.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://blog.bgx.com;</span><br><span class="line">        proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">location</span> /<span class="keyword">upstream_status</span> &#123;</span><br><span class="line">        check_status;     <span class="comment">#开启upstream状态页面</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>7.通过访问域名/upstream_status则能打开状态页面</em></p>
<p><img src="/2025/04/08/nginx高级/15474556169486.jpg" alt="img"><br><em>8.尝试关闭一台后端的webserver，再次打开检查见面</em></p>
<p><img src="/2025/04/08/nginx高级/15474561465676.jpg" alt="img"></p>
<h2 id="6-Nginx负载均衡会话共享"><a href="#6-Nginx负载均衡会话共享" class="headerlink" title="6.Nginx负载均衡会话共享"></a>6.Nginx负载均衡会话共享</h2><p><em>在使用负载均衡的时候会遇到会话保持的问题，可通过如下方式进行解决1.使用nginx的ip_hash，根据客户端的来源IP，将请求分配到相同服务器上2.基于服务端的Session会话共享（mysql/memcache/redis/file）</em></p>
<p><em>在解决负载均衡会话问题我们需要了解session和cookie。1.用户第一次请求服务端网站时，服务端会生成对应的session_id，然后存储至客户端浏览器的cookie中。2.客户端尝试登陆服务端网站时，浏览器的请求头自动携带cookie信息，在cookie信息中保存的则是session_id。3.客户端登陆服务端网站后，服务端会将session_id存储在本地文件中, 当用户下次请求网站时会去查询用户提交的cookie作为key去存储里找对应的value(session)注意: 同一域名下的网站登陆后cookie都是一样的。所以无论负载后端有几台服务器,无论请求分配到哪一台服务器上同一用户的cookie是不会发生变化的。也就是说cookie对应的session也是唯一的。所以，这里只要保证多台业务服务器访问同一个共享服务器(memcache/redis/mysql/file)就行了。</em></p>
<p><em>1.首先在多台web上都安装并配置phpmyadmin</em></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#1.安装phpmyadmin（web01和web02上都装）</span></span><br><span class="line">[<span class="meta">root@web01 conf.d</span>]<span class="meta"># cd /code</span></span><br><span class="line">[<span class="meta">root@web01 code</span>]<span class="meta"># wget https://files.phpmyadmin.net/phpMyAdmin/4.8.4/phpMyAdmin-4.8.4-all-languages.zip</span></span><br><span class="line">[<span class="meta">root@web01 code</span>]<span class="meta"># unzip phpMyAdmin-4.8.4-all-languages.zip</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#2.配置phpmyadmin连接远程的数据库</span></span><br><span class="line">[<span class="meta">root@web01 code</span>]<span class="meta"># cd phpMyAdmin-4.8.4-all-languages/</span></span><br><span class="line">[<span class="meta">root@web01 phpMyAdmin-4.8.4-all-languages</span>]<span class="meta"># cp config.sample.inc.php config.inc.php</span></span><br><span class="line">[<span class="meta">root@web01 phpMyAdmin-4.8.4-all-languages</span>]<span class="meta"># vim config.inc.php</span></span><br><span class="line"><span class="comment">/* Server parameters */</span></span><br><span class="line">$cfg[<span class="string">'Servers'</span>][$i][<span class="string">'host'</span>] = <span class="string">'172.16.1.51'</span>;</span><br></pre></td></tr></table></figure>
<p><em>2.在多台web上准备phpmyadmin的nginx配置文件</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/php.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name php.oldboy.com;</span><br><span class="line">    root /code/phpMyAdmin-4.8.4-all-languages;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx服务</span></span><br><span class="line">[root@web01 ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p><em>3.配置负载均衡服务，调度到后端两台web节点</em></p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]<span class="meta"># cat /etc/nginx/conf.d/proxy_php.com.conf </span></span><br><span class="line">upstream php &#123;</span><br><span class="line">        <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">80</span>;</span><br><span class="line">        <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.8</span>:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name php.oldboy.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http:<span class="comment">//php;</span></span><br><span class="line">                include proxy_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#检查语法并重启nginx</span></span><br><span class="line">[root@lb01 conf.d]<span class="meta"># nginx -t</span></span><br><span class="line">[root@lb01 conf.d]<span class="meta"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>4.准备redis内存数据库存储session会话</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#1.安装redis内存数据库</span></span><br><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># yum install redis -y</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#2.配置redis监听在172.16.1.0网段上</span></span><br><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># sed  -i <span class="string">'/^bind/c bind 127.0.0.1 172.16.1.51'</span> /etc/redis.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#3.启动redis</span></span><br><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># systemctl start redis</span></span><br><span class="line">[root<span class="symbol">@db01</span> ~]<span class="meta"># systemctl enable redis</span></span><br></pre></td></tr></table></figure>
<p><em>5.配置php连接redis服务</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.修改/etc/php.ini文件</span></span><br><span class="line"><span class="section">[root@web ~]</span><span class="comment"># vim /etc/php.ini</span></span><br><span class="line"><span class="attr">session.save_handler</span> = redis</span><br><span class="line"><span class="attr">session.save_path</span> = <span class="string">"tcp://172.16.1.51:6379"</span></span><br><span class="line"><span class="comment">;session.save_path = "tcp://172.16.1.51:6379?auth=123" #如果redis存在密码，则使用该方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.注释php-fpm.d/www.conf里面的两条内容，否则session内容会一直写入/var/lib/php/session目录中</span></span><br><span class="line"><span class="comment">;php_value[session.save_handler] = files</span></span><br><span class="line"><span class="comment">;php_value[session.save_path]    = /var/lib/php/session</span></span><br></pre></td></tr></table></figure>
<p><em>6.使用浏览器登陆网站，获取对应的cookie信息</em><br><img src="/2025/04/08/nginx高级/15458176984471.jpg" alt="img"></p>
<p><em>7.检查redis中是否存在cookie对应的session</em></p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">172.16.1.51:6379</span>&gt; keys *</span><br><span class="line"><span class="number">1</span>) <span class="string">"PHPREDIS_SESSION:393ff522ed2a7e26ba44f6d925f991f2"</span></span><br><span class="line"><span class="number">172.16.1.51:6379</span>&gt;</span><br></pre></td></tr></table></figure>
<p><em>8.此时用户的cookie始终都不会发生任何变化，无论请求被负载调度到那一台后端web节点服务器都不会出现没有登陆情况。</em></p>
<p><img src="/2025/04/08/nginx高级/15458179007791.jpg" alt="img"></p>
<h1 id="08-Nginx四层负载均衡"><a href="#08-Nginx四层负载均衡" class="headerlink" title="08.Nginx四层负载均衡"></a>08.Nginx四层负载均衡</h1><h2 id="1-Nginx四层负载均衡基本概述"><a href="#1-Nginx四层负载均衡基本概述" class="headerlink" title="1.Nginx四层负载均衡基本概述"></a>1.Nginx四层负载均衡基本概述</h2><p><strong>1.什么是四层负载均衡</strong></p>
<p><em>四层负载均衡基于传输层协议包来封装的（如：TCP/IP），那我们前面使用到的七层是指的应用层，它的组装在四层基础之上，无论四层还是七层都是指的OSI网络模型。</em></p>
<p><strong>2.四层层负载均衡应用场景</strong></p>
<p><em>1.四层+七层来作负载均衡，4层可以保证7层的负载均衡的高可用性。如:nginx就无法保证自己的服务高可用，需要依赖lvs或者keepalive来作。2.，如:tcp协议的负载均衡，有些请求是TCP协议的(mysql、ssh)，或者说这些请求只需要使用4层进行端口的转发就可以了，所以使用4层负载均衡。</em></p>
<p><strong>3.四层+七层构建大规模集群架构使用场景</strong></p>
<p><img src="/2025/04/08/nginx高级/15432145274991.jpg" alt="img"></p>
<p><strong>四层负载均衡总结</strong></p>
<p><em>1.四层负载均衡仅能转发TCP/IP协议、UDP协议，通常用来转发端口，如: tcp/3306，tcp/22，udp/53。2.四层负载均衡可以用来解决七层负载均衡的端口限制问题。（七层负载均衡最大使用65535个端口号）3.可以用来解决七层负载均衡的高可用问题。（多台后端七层负载均衡能同时的使用）4.四层的转发效率比七层的高的多，但仅支持tcp/ip协议，不支持http或者https协议</em></p>
<h2 id="2-Nginx四层负载均衡场景实践"><a href="#2-Nginx四层负载均衡场景实践" class="headerlink" title="2.Nginx四层负载均衡场景实践"></a>2.Nginx四层负载均衡场景实践</h2><p><strong>Nginx如何配置四层负载均衡</strong></p>
<p><em>1.通过访问负载均衡的5555端口，实际是后端的web01的22端口在提供服务。2.通过访问负载均衡的6666端口，实际是后端的mysql的3306端口在提供服务。</em></p>
<p><em>1.Nginx四层负载均衡配置语法</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        hash <span class="variable">$remote_addr</span> consistent;</span><br><span class="line">       <span class="built_in"> server </span>backend1.example.com:12345 <span class="attribute">weight</span>=5;</span><br><span class="line">       <span class="built_in"> server </span>127.0.0.1:12345 <span class="attribute">max_fails</span>=3 <span class="attribute">fail_timeout</span>=30s;</span><br><span class="line">       <span class="built_in"> server </span>unix:/tmp/backend3;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="built_in"> server </span>&#123;</span><br><span class="line">        listen 12345;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_timeout 3s;</span><br><span class="line">        proxy_pass backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.Nginx四层负载均衡实战</em></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]<span class="comment"># mkdir -p /etc/nginx/conf.c</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># 在events层下面，http层上面配置include</span></span><br><span class="line">include  /etc/nginx/conf.c/*.conf;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写四层代理配置</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># cd /etc/nginx/conf.c/</span></span><br><span class="line">[root@lb01 conf.c]<span class="comment"># cat stream.conf </span></span><br><span class="line">stream &#123;</span><br><span class="line">    <span class="comment">#1.定义虚拟资源池</span></span><br><span class="line">    upstream ssh &#123;</span><br><span class="line">        server <span class="number">172.16</span>.<span class="number">1.7</span>:<span class="number">22</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    upstream mysql &#123;</span><br><span class="line">        server <span class="number">172.16</span>.<span class="number">1.51</span>:<span class="number">3306</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#2.调用虚拟资源池</span></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">5555</span>;</span><br><span class="line">        proxy_connect_timeout <span class="number">1</span><span class="keyword">s</span>;</span><br><span class="line">        proxy_timeout <span class="number">300</span><span class="keyword">s</span>;</span><br><span class="line">        proxy_pass ssh;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">6666</span>;</span><br><span class="line">        proxy_connect_timeout <span class="number">1</span><span class="keyword">s</span>;</span><br><span class="line">        proxy_timeout <span class="number">300</span><span class="keyword">s</span>;</span><br><span class="line">        proxy_pass mysql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb01 conf.c]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>3.如何记录四层负载均衡日志，四层负载均衡日志必须配置在stream模块</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# cat /etc/nginx/conf.c/tcp_proxy.conf</span><br><span class="line">stream &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义日志的格式</span></span><br><span class="line">log_format <span class="built_in"> proxy </span><span class="string">'$remote_addr -  [$time_local]  $status $protocol'</span></span><br><span class="line">                  <span class="string">'"$upstream_addr" "$upstream_bytes_sent" "$upstream_connect_time"'</span> ;</span><br><span class="line"></span><br><span class="line">    #调用日志，使用proxy格式</span><br><span class="line">    access_log /var/log/nginx/tcp_proxy.log proxy;</span><br><span class="line">    </span><br><span class="line">    upstream ssh &#123;</span><br><span class="line">       <span class="built_in"> server </span>172.16.1.7:22;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> server </span>&#123;</span><br><span class="line">        listen 5555;</span><br><span class="line">        proxy_pass proxy_node1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="09-Nginx动静分离实战"><a href="#09-Nginx动静分离实战" class="headerlink" title="09.Nginx动静分离实战"></a>09.Nginx动静分离实战</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQzNTY5MzUxNTgxMS5odG1sI3RvY18w" title="http://docs.etiantian.org/15435693515811.html#toc_0">1.Nginx动静分离基本概述<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQzNTY5MzUxNTgxMS5odG1sI3RvY18x" title="http://docs.etiantian.org/15435693515811.html#toc_1">2.Nginx动静分离场景实践<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQzNTY5MzUxNTgxMS5odG1sI3RvY18y" title="http://docs.etiantian.org/15435693515811.html#toc_2">3.Nginx资源分离场景实践<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-Nginx动静分离基本概述"><a href="#1-Nginx动静分离基本概述" class="headerlink" title="1.Nginx动静分离基本概述"></a>1.Nginx动静分离基本概述</h2><p><em>动静分离, 通过中间件将动静分离和静态请求进行分离。那为什么要通过中间件将动态请求和静态请求进行分离? 减少不必要的请求消耗, 同时能减少请求的延时。</em></p>
<p><strong>通过中间件将动态请求和静态请求分离，逻辑图如下</strong></p>
<p><img src="/2025/04/08/nginx高级/15388909626532.jpg" alt="img"></p>
<p><em>动静分离只有好处: 动静分离后, 即使动态服务不可用, 但静态资源不会受到影响</em></p>
<h2 id="2-Nginx动静分离场景实践"><a href="#2-Nginx动静分离场景实践" class="headerlink" title="2.Nginx动静分离场景实践"></a>2.Nginx动静分离场景实践</h2><p><img src="/2025/04/08/nginx高级/15388909196129.jpg" alt="img"></p>
<p>Nginx动静分离实践应用案例</p>
<p><em>0.环境准备</em></p>
<table>
<thead>
<tr>
<th>系统</th>
<th>服务</th>
<th>服务</th>
<th>地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS7.5</td>
<td>负载均衡</td>
<td>Nginx Proxy</td>
<td>10.0.0.5</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>静态资源</td>
<td>Nginx Static</td>
<td>10.0.0.7</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>动态资源</td>
<td>Tomcat Server</td>
<td>10.0.0.8</td>
</tr>
</tbody>
</table>
<p><em>1.在10.0.0.7服务器上配置静态资源</em></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]<span class="comment"># cat ds_oldboy.conf</span></span><br><span class="line">server&#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name ds.oldboy.com;</span><br><span class="line">        root /soft/code;</span><br><span class="line">        index index.html;</span><br><span class="line"></span><br><span class="line">        location ~* .*\.(png<span class="params">|jpg|</span>gif)$ &#123;</span><br><span class="line">                root /soft/code/images;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备目录, 以及静态相关图片</span></span><br><span class="line">[root@web01 ~]<span class="comment"># mkdir /soft/code/images -p</span></span><br><span class="line">[root@web01 ~]<span class="comment"># wget -O /soft/code/images/nginx.png http://nginx.org/nginx.png</span></span><br><span class="line">[root@web01 ~]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>2.在10.0.0.8服务器上配置动态资源</em></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@web01 ~</span>]<span class="meta"># yum install -y tomcat</span></span><br><span class="line">[<span class="meta">root@web01 ~</span>]<span class="meta"># mkdir /usr/share/tomcat/webapps/ROOT</span></span><br><span class="line">[<span class="meta">root@web01 ~</span>]<span class="meta"># vim /usr/share/tomcat/webapps/ROOT/java_test.jsp</span></span><br><span class="line">&lt;%@ page language=<span class="string">"java"</span> import=<span class="string">"java.util.*"</span> pageEncoding=<span class="string">"utf-8"</span>%&gt;</span><br><span class="line">&lt;HTML&gt;</span><br><span class="line">    &lt;HEAD&gt;</span><br><span class="line">        &lt;TITLE&gt;JSP Test Page&lt;/TITLE&gt;</span><br><span class="line">    &lt;/HEAD&gt;</span><br><span class="line">    &lt;BODY&gt;</span><br><span class="line">      &lt;%</span><br><span class="line">        Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">out</span>.println(<span class="string">"&lt;h1&gt;Random number:&lt;/h1&gt;"</span>);</span><br><span class="line">        <span class="keyword">out</span>.println(rand.nextInt(<span class="number">99</span>)+<span class="number">100</span>);</span><br><span class="line">      %&gt;</span><br><span class="line">    &lt;/BODY&gt;</span><br><span class="line">&lt;/HTML&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#重启tomcat服务</span></span><br><span class="line">[<span class="meta">root@web01 ~</span>]<span class="meta"># systemctl start tomcat</span></span><br></pre></td></tr></table></figure>
<p><em>3.在负载均衡10.0.0.5上配置调度, 实现访问jsp和png</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@lb01 conf.d]<span class="comment"># cat ds_proxy.conf </span></span><br><span class="line">upstream static &#123;</span><br><span class="line">        server <span class="number">10.0</span>.<span class="number">0.7</span>:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line">upstream java &#123;</span><br><span class="line">        server <span class="number">10.0</span>.<span class="number">0.8</span>:<span class="number">8080</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name ds.oldboy.com;</span><br><span class="line">        <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">                root</span> /soft/code;</span><br><span class="line">                index index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">location</span> <span class="title">~ .*\.(png</span>|jpg|gif)$ &#123;</span><br><span class="line">                proxy_pass http://static;</span><br><span class="line">                include proxy_params;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">location</span>  <span class="title">~ .*\.jsp</span>$ &#123;</span><br><span class="line">                proxy_pass http://java;</span><br><span class="line">                include proxy_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb01 conf.d]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>4.通过负载测试访问静态资源</em></p>
<p><img src="/2025/04/08/nginx高级/15380382983622.jpg" alt="img"></p>
<p><em>5.通过负载测试访问动态资源</em><br><img src="/2025/04/08/nginx高级/15380383555722.jpg" alt="img"></p>
<p><em>6.在负载均衡10.0.0.5上整合动态和静态资源的html文件</em></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# mkdir /soft/code -p</span><br><span class="line">[root@lb01 ~]# cat /soft/code/index.html</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试ajax和跨域访问<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.1.4/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">        type: <span class="string">"GET"</span>,</span></span><br><span class="line"><span class="actionscript">        url: <span class="string">"http://ds.oldboy.com/java_test.jsp"</span>,</span></span><br><span class="line"><span class="actionscript">        success: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                $(<span class="string">"#get_data"</span>).html(data)</span></span><br><span class="line">        &#125;,</span><br><span class="line"><span class="actionscript">        error: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                alert(<span class="string">"fail!!,请刷新再试!"</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试动静分离<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://ds.oldboy.com/nginx.png"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"get_data"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>7.测试动态和静态资源是否能正常加载在一个html文件中</em></p>
<p><img src="/2025/04/08/nginx高级/15380383842331.jpg" alt="img"></p>
<p><em>8.当使用systemctl stop nginx停止Nginx后, 会发现静态内容无法访问, 动态内容依旧运行正常</em><br><img src="/2025/04/08/nginx高级/15380384613416.jpg" alt="img"></p>
<p><em>9.当使用systemctl stop tomcat停止tomcat后, 静态内容依旧能正常访问, 动态内容将不会被请求到</em><br><img src="/2025/04/08/nginx高级/15380385494628.jpg" alt="img"></p>
<h2 id="3-Nginx资源分离场景实践"><a href="#3-Nginx资源分离场景实践" class="headerlink" title="3.Nginx资源分离场景实践"></a>3.Nginx资源分离场景实践</h2><p><strong>Nginx通过负载均衡实现手机与PC调度至不同的后端节点应用案例</strong></p>
<p><em>1.根据iphone、安卓、pc跳转不同的页面环境规划</em></p>
<table>
<thead>
<tr>
<th>系统版本</th>
<th>主机角色</th>
<th>外网IP</th>
<th>内网IP</th>
<th>提供端口</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS7.5</td>
<td>负载均衡</td>
<td>10.0.0.5</td>
<td>172.16.1.5</td>
<td>80</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>提供Android页面</td>
<td></td>
<td>172.16.1.7</td>
<td>9090</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>提供Iphone页面</td>
<td></td>
<td>172.16.1.7</td>
<td>9091</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>提供pc页面</td>
<td></td>
<td>172.16.1.7</td>
<td>9092</td>
</tr>
</tbody>
</table>
<p><em>2.配置后端WEB节点的Nginx配置</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat sj.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 9090;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/android;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 9091;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/iphone;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 9092;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/pc;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.为后端WEB节点配置对应的网站目录以及代码</em></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 <span class="keyword">conf</span>.d]# <span class="built_in">mkdir</span> -<span class="keyword">p</span> /code/&#123;android,iphone,<span class="keyword">pc</span>&#125;</span><br><span class="line">[root@web01 <span class="keyword">conf</span>.d]# <span class="keyword">echo</span> <span class="string">"PC"</span> &gt; /code/<span class="keyword">pc</span>/<span class="built_in">index</span>.html</span><br><span class="line">[root@web01 <span class="keyword">conf</span>.d]# <span class="keyword">echo</span> <span class="string">"Iphone"</span> &gt; /code/iphone/<span class="built_in">index</span>.html</span><br><span class="line">[root@web01 <span class="keyword">conf</span>.d]# <span class="keyword">echo</span> <span class="string">"Android"</span> &gt; /code/android/<span class="built_in">index</span>.html</span><br><span class="line"></span><br><span class="line">#检查语法并重载Nginx服务</span><br><span class="line">[root@web01 <span class="keyword">conf</span>.d]# nginx -t</span><br><span class="line">[root@web01 <span class="keyword">conf</span>.d]# systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p><em>2.配置负载均衡服务，根据不同的浏览器调度到不同的资源池</em></p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 conf.d]<span class="comment"># cat sj_proxy.conf </span></span><br><span class="line">upstream <span class="keyword">iphone</span> &#123;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.7</span>:<span class="number">9091</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">upstream</span> <span class="keyword">android</span> &#123;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.7</span>:<span class="number">9090</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">upstream</span> <span class="keyword">pc</span> &#123;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.7</span>:<span class="number">9092</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name sj.oldboy.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#默认跳转至pc站点</span></span><br><span class="line">    proxy_pass http://pc;</span><br><span class="line">    <span class="literal">include</span> proxy_params;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#如果客户端是Iphone则跳转到iphone的资源池</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">"Iphone"</span>) &#123;</span><br><span class="line">            proxy_pass http://iphone;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        #如果客户端是Android则跳转到android的资源池</span><br><span class="line">        if (<span class="variable">$http_user_agent</span> ~* <span class="string">"Android"</span>)&#123;</span><br><span class="line">            proxy_pass http://android;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#如果客户端是IE浏览器，则返回403错误。</span></span><br><span class="line">        if (<span class="variable">$http_user_agent</span> ~* <span class="string">"msie"</span>)&#123;</span><br><span class="line">            return 403;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3.直接使用浏览器访问，返回默认的结果</em><br><img src="/2025/04/08/nginx高级/15433176983763.jpg" alt="img"></p>
<p><em>4.如果通过android设备访问，效果如下。</em><br><img src="/2025/04/08/nginx高级/15433175379655.jpg" alt="img"></p>
<p><em>4.如果通过Iphone设备访问，效果如下。</em></p>
<p><img src="/2025/04/08/nginx高级/15433176717221.jpg" alt="img"></p>
<h1 id="11-Nginx-Rewrite重写"><a href="#11-Nginx-Rewrite重写" class="headerlink" title="11.Nginx Rewrite重写"></a>11.Nginx Rewrite重写</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzIyMjg0NC5odG1sI3RvY18w" title="http://docs.etiantian.org/15332923222844.html#toc_0">1.Rewrite基本概述<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzIyMjg0NC5odG1sI3RvY18x" title="http://docs.etiantian.org/15332923222844.html#toc_1">2.Rewrite标记Flag<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzIyMjg0NC5odG1sI3RvY18y" title="http://docs.etiantian.org/15332923222844.html#toc_2">3.Rewrite规则实践<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzIyMjg0NC5odG1sI3RvY18z" title="http://docs.etiantian.org/15332923222844.html#toc_3">4.Rewrite规则补充<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-Rewrite基本概述"><a href="#1-Rewrite基本概述" class="headerlink" title="1.Rewrite基本概述"></a>1.Rewrite基本概述</h2><p><strong>1.什么是rewrite</strong></p>
<p><em>Rewrite主要实现url地址重写, 以及地址重定向，就是将用户请求web服务器的地址重新定向到其他URL的过程。</em></p>
<p><strong>2.Rewrite使用场景</strong></p>
<p><em>1.地址跳转，用户访问<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS9jbGFzc+i/meS4qlVSTOaXtu+8jOWwhuWFtuWumuWQkeiHs+S4gOS4quaWsOeahOWfn+WQjWNsYXNzLnh1bGlhbmd3ZWkuY29tMi7ljY/orq7ot7PovazvvIznlKjmiLfpgJrov4dodHRw5Y2P6K6u6K+35rGC572R56uZ5pe277yM5bCG5YW26YeN5paw6Lez6L2s6IezaHR0cHPljY/orq7mlrnlvI8zLuS8qumdmeaAge+8jOWwhuWKqOaAgemhtemdouaYvuekuuS4uumdmeaAgemhtemdouaWueW8j+eahOS4gOenjeaKgOacrw==" title="http://www.xuliangwei.com/class这个URL时，将其定向至一个新的域名class.xuliangwei.com2.协议跳转，用户通过http协议请求网站时，将其重新跳转至https协议方式3.伪静态，将动态页面显示为静态页面方式的一种技术">www.xuliangwei.com/class这个URL时，将其定向至一个新的域名class.xuliangwei.com2.协议跳转，用户通过http协议请求网站时，将其重新跳转至https协议方式3.伪静态，将动态页面显示为静态页面方式的一种技术<i class="fa fa-external-link"></i></span>, 便于搜索引擎的录入, 同时减少动态URL地址对外暴露过多的参数, 提升更高的安全性。3.搜索引擎，SEO优化依赖于url路径, 好记的url便于支持搜索引擎录入</em></p>
<p><strong>3.Rewrite配置示例</strong></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#rewrite表达式可以应用在server,location, if标签下</span></span><br><span class="line"><span class="symbol">Syntax:</span> rewrite regex replacement [flag]<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> --</span><br><span class="line"><span class="symbol">Context:</span> server, location, if</span><br><span class="line"></span><br><span class="line"><span class="meta">#用于切换维护页面场景</span></span><br><span class="line"><span class="meta">#rewrite ^(.*)$ /page/wh.html break;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-Rewrite标记Flag"><a href="#2-Rewrite标记Flag" class="headerlink" title="2.Rewrite标记Flag"></a>2.Rewrite标记Flag</h2><p><em>rewrite指令根据表达式来重定向URI，或者修改URI字符串。每行rewrite指令最后跟一个flag标记，支持的flag标记有如下表格所示：</em></p>
<table>
<thead>
<tr>
<th>flag</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>last</td>
<td>本条规则匹配完成后，停止匹配，不在匹配后面的规则</td>
</tr>
<tr>
<td>break</td>
<td>本条规则匹配完成后，停止匹配，不在匹配后面的规则</td>
</tr>
<tr>
<td>redirect</td>
<td>返回302临时重定向, 地址栏会显示跳转后的地址</td>
</tr>
<tr>
<td>permanent</td>
<td>返回301永久重定向, 地址栏会显示跳转后的地址</td>
</tr>
</tbody>
</table>
<p><em>1.last与break区别对比示例</em></p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx conf.d]<span class="comment"># cat rewrite.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name rewrite.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line"></span><br><span class="line">    location ~ ^/<span class="keyword">break</span> &#123;</span><br><span class="line">        rewrite ^<span class="regexp">/break /test/</span> <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^/last &#123;</span><br><span class="line">        rewrite ^<span class="regexp">/last /test/</span> last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location  <span class="regexp">/test/</span> &#123;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">return</span> <span class="number">200</span> <span class="string">'ok'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx服务</span></span><br><span class="line">[root@bgx conf.d]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>2.使用浏览器访问/break测试</em><br><img src="/2025/04/08/nginx高级/15433256817089.jpg" alt="img"></p>
<p><em>3.使用浏览器访问/last测试</em><br><img src="/2025/04/08/nginx高级/15433246260118.jpg" alt="img"></p>
<p><strong>4.last和 break 都是一个作用，都是表示停止rewrite规则，那last和break区别在哪呢</strong><br><em>break匹配到规则，则会去本地路径中目录中寻找对应请求的文件。last匹配到规则，会对其所在的server{…}标签重新发起请求。所以，在访问/break和/last请求时，虽然对应的请求目录/test都是不存在了，理论上都应该返回404，但是实际请求/last的时候，是会有后面localtion所匹配到的结果返回的，如果last匹配不到location的结果则在返回错误。</em></p>
<p><em>5.redirect与permanent区别对比示例</em></p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]<span class="comment"># cat /etc/nginx/conf.d/rewrite.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen 80;</span></span><br><span class="line"><span class="attribute">    server_name rewrite.oldboy.com;</span></span><br><span class="line"><span class="attribute">    root /code;</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">    location ~ ^/bgx &#123;</span></span><br><span class="line"><span class="attribute">        rewrite ^(.*)$ https</span>://www<span class="variable">.xuliangwei</span><span class="variable">.com</span> redirect;</span><br><span class="line">        <span class="attribute">rewrite ^(.*)$ https</span>://www<span class="variable">.xuliangwei</span><span class="variable">.com</span> permanent;</span><br><span class="line">        <span class="comment">#return 301 http://kt.xuliangwei.com;</span></span><br><span class="line">        <span class="comment">#return 302 http://kt.xuliangwei.com;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>5.通过浏览器访问，redirect会进行302跳转</em></p>
<p><img src="http://cdn.xuliangwei.com/15433263413643.jpg" alt="img"></p>
<p><em>6.使用 systemctl stop nginx停止nginx，然后再次访问网站测试 redirect</em><br><img src="http://cdn.xuliangwei.com/15433266834755.jpg" alt="img"></p>
<p><em>7.通过浏览器访问，permanent会进行301跳转</em></p>
<p><img src="http://cdn.xuliangwei.com/15433268185373.jpg" alt="img"></p>
<p><em>8.使用 systemctl stop nginx停止nginx，然后再次访问网站测试 permanent</em></p>
<p><img src="http://cdn.xuliangwei.com/15433268889462.jpg" alt="img"></p>
<p><strong>9.redirect和permanent都是一个跳转，那redirect和permanent区别在哪呢</strong></p>
<h2 id="3-Rewrite规则实践"><a href="#3-Rewrite规则实践" class="headerlink" title="3.Rewrite规则实践"></a>3.Rewrite规则实践</h2><p><em>例1:用户访问/abc/1.html实际上真实访问是/ccc/bbb/2.html</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http://www.bgx.com/abc/1.html ==&gt; http://www.bgx.com/ccc/bbb/2.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1.准备真实的访问路径</span></span><br><span class="line">[root@web03 ~]<span class="comment"># mkdir /code/ccc/bbb -p</span></span><br><span class="line">[root@web03 ~]<span class="comment"># echo "ccc_bbb_2" &gt; /code/ccc/bbb/2.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.Nginx跳转配置</span></span><br><span class="line">[root@web03 conf.d]<span class="comment"># cat ccbb.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">        root</span> /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">location</span> <span class="title">/abc</span> &#123;</span><br><span class="line">        rewrite (.*) /ccc/bbb/<span class="number">2</span>.html redirect;</span><br><span class="line">        <span class="comment">#return 302 /ccc/bbb/2.html;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.重启Nginx服务</span></span><br><span class="line">[root@web03 ~]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>例2:用户访问/2018/ccc/bbb/2.html实际上真实访问是/2014/ccc/bbb/2.html</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http://www.bgx.com/2018/ccc/bbb/2.html ==&gt; http://www.bgx.com/2014/ccc/bbb/2.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1.准备真实的访问路径</span></span><br><span class="line">[root@web03 ~]# mkdir /code/2014/ccc/bbb -p</span><br><span class="line">[root@web03 ~]# echo <span class="string">"2014_ccc_bbb_2"</span> &gt; /code/2014/ccc/bbb/2.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.Nginx跳转配置</span></span><br><span class="line">[root@web03 conf.d]# cat ccbb.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    location /2018 &#123;</span><br><span class="line">        rewrite ^/2018/(.*)$ /2014/<span class="variable">$1</span> redirect;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.重启Nginx服务</span></span><br><span class="line">[root@web03 ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p><em>例3:用户访问/test目录下任何内容, 实际上真实访问是<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbQ==" title="http://www.xuliangwei.com">http://www.xuliangwei.com<i class="fa fa-external-link"></i></span></em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /test &#123;</span><br><span class="line">    <span class="attribute">rewrite</span> (.*) http://www.xuliangwei.com <span class="literal">redirect</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>例4:用户访问course-11-22-33.html实际上真实访问是/course/11/22/33/course_33.html</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#http://www.bgx.com/course-11-22-33.html ==&gt; http://www.bgx.com/course/11/22/33/course_33.html  </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#1.准备真实的访问路径</span></span><br><span class="line">[root<span class="symbol">@web03</span> ~]<span class="meta"># mkdir /code/course/11/22/33/ -p</span></span><br><span class="line">[root<span class="symbol">@web03</span> ~]<span class="meta"># echo <span class="string">"Curl docs.etiantian.org"</span> &gt; /code/course/11/22/33/course_33.html</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#2.Nginx跳转配置</span></span><br><span class="line">[root<span class="symbol">@web03</span> conf.d]<span class="meta"># cat ccbb.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">        listen <span class="number">80</span><span class="comment">;</span></span><br><span class="line">        root /code<span class="comment">;</span></span><br><span class="line">        index index.html<span class="comment">;</span></span><br><span class="line">        location / &#123;</span><br><span class="line">                <span class="meta">#灵活</span></span><br><span class="line">            rewrite ^/course-(.*)-(.*)-(.*).html$ /course/$1/$2/$3/course_$3.html redirect<span class="comment">;</span></span><br><span class="line">                <span class="meta">#固定</span></span><br><span class="line">            <span class="meta">#rewrite ^/course-(.*)  /course/11/22/33/course_33.html redirect<span class="comment">;</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">#3.重启Nginx服务</span></span><br><span class="line">[root<span class="symbol">@web03</span> ~]<span class="meta"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>例5:将http请求，跳转至https</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> bgx.com;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> https://<span class="variable">$server_name</span><span class="variable">$1</span> <span class="literal">redirect</span>;</span><br><span class="line">        <span class="comment">#return 302 https://$server_name$request_uri;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span> bgx.com;</span><br><span class="line">    <span class="attribute">ssl</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-Rewrite规则补充"><a href="#4-Rewrite规则补充" class="headerlink" title="4.Rewrite规则补充"></a>4.Rewrite规则补充</h2><p><strong>1.Rewrite优先级</strong><br><em>1.先执行server块的rewrite指令2.其次执行location匹配规则3.最后执行location中的rewrite</em></p>
<p><strong>2.Rewrite常用变量，在匹配过程中可以引用一些Nginx的全局变量</strong><br><em>$server_name 当前用户请求的域名$request_filename 当前请求的文件路径名（带网站的主目录/code/images/test.jpg）$request_uri 当前请求的文件路径名（不带网站的主目录/images/test.jpg）$scheme用的协议，比如http或者https</em></p>
<p><strong>3.如何优雅的书写Rewrite规则</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.oldboyedu.com oldboyedu.com;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$http_host</span> = oldboyedu.com)&#123;</span><br><span class="line">        <span class="attribute">rewrite</span> (.*) http://www.nginx.org<span class="variable">$1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#推荐的书写格式</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> oldboyedu.com;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^</span> http://www.oldboyedu.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.oldboyedu.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="12-Nginx-HTTPS-实践"><a href="#12-Nginx-HTTPS-实践" class="headerlink" title="12.Nginx HTTPS 实践"></a>12.Nginx HTTPS 实践</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzM1MDM3Ny5odG1sI3RvY18w" title="http://docs.etiantian.org/15332923350377.html#toc_0">1.HTTPS安全证书基本概述<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzM1MDM3Ny5odG1sI3RvY18x" title="http://docs.etiantian.org/15332923350377.html#toc_1">2.Nginx单台实现HTTPS实战<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzM1MDM3Ny5odG1sI3RvY18y" title="http://docs.etiantian.org/15332923350377.html#toc_2">3.Nginx集群实现HTTPS实践<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzM1MDM3Ny5odG1sI3RvY18z" title="http://docs.etiantian.org/15332923350377.html#toc_3">4.阿里云Nginx实现HTTPS实践<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzM1MDM3Ny5odG1sI3RvY180" title="http://docs.etiantian.org/15332923350377.html#toc_4">5.阿里云SLB负载实现HTTPS实践<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyMzM1MDM3Ny5odG1sI3RvY181" title="http://docs.etiantian.org/15332923350377.html#toc_5">6.Nginx4+7层负载实现HTTPS实战<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<p><em>实战构建一个满足苹果要求的HTTPS后台服务</em></p>
<h2 id="1-HTTPS安全证书基本概述"><a href="#1-HTTPS安全证书基本概述" class="headerlink" title="1.HTTPS安全证书基本概述"></a>1.HTTPS安全证书基本概述</h2><p><em>为什么需要使用HTTPS, 因为HTTP不安全。当我们使用http网站时，会遭到劫持和篡改，如果采用https协议，那么数据在传输过程中是加密的，所以黑客无法窃取或者篡改数据报文信息，同时也避免网站传输时信息泄露。</em></p>
<p><em>那么我们在实现https时，需要了解ssl协议，但我们现在使用的更多的是TLS加密协议。那么TLS是怎么保证明文消息被加密的呢？在OSI七层模型中，应用层是http协议，那么在应用层协议之下，我们的表示层，是ssl协议所发挥作用的一层，它通过（握手、交换秘钥、告警、加密）等方式，使应用层http协议没有感知的情况下做到了数据的安全加密</em><br><img src="http://cdn.xuliangwei.com/15483458976370.jpg" alt="img"></p>
<p><em>那么在数据进行加密与解密过程中，如何确定双方的身份，此时就需要有一个权威机构来验证双方省份。那么这个权威机构则是CA机构。那CA机构又是如何颁发证书</em></p>
<p><img src="http://cdn.xuliangwei.com/15483459635184.jpg" alt="img"></p>
<p><em>我们首先需要申请证书，需要进行登记，登记我是谁，我是什么组织，我想做什么，到了登记机构在通过CSR发给CA，CA中心通过后，CA中心会生成一对公钥和私钥，那么公钥会在CA证书链中保存，公钥和私钥证书订阅人拿到后，会将其部署在WEB服务器上1.当浏览器访问我们的https站点时，它会去请求我们的证书2.Nginx这样的web服务器会将我们的公钥证书发给浏览器3.浏览器会去验证我们的证书是否是合法和有效的。4.CA机构会将过期的证书放置在CRL服务器，那么CRL服务的验证效率是非常差的，所以CA又推出了OCSP响应程序，OCSP响应程序可以查询指定的一个证书是否过期，所以浏览器可以直接查询OCSP响应程序，但OCSP响应程序性能还不是很高。5.Nginx会有一个OCSP的开关，当我们开启后，Nginx会主动上OCSP上查询，这样大量的客户端直接从Nginx获取，证书是否有效。</em></p>
<p><strong>那么证书究竟是怎样组成的呢，接下来我们看一下证书有哪几种类型？</strong><br><img src="http://cdn.xuliangwei.com/15433209333857.jpg" alt="img"></p>
<p><strong>HTTPS证书购买选择</strong></p>
<p><em>保护1个域名 www保护5个域名 www images cdn test m通配符域名 \</em>.oldboy.com*</p>
<p><strong>HTTPS注意事项</strong></p>
<p><em>Https不支持续费,证书到期需重新申请新并进行替换.Https不支持三级域名解析, 如test.m.oldboy.comHttps显示绿色, 说明整个网站的url都是https的。Https显示黄色, 因为网站代码中包含http的不安全连接。Https显示红色, 要么证书是假的，要么证书过期。</em></p>
<h2 id="2-Nginx单台实现HTTPS实战"><a href="#2-Nginx单台实现HTTPS实战" class="headerlink" title="2.Nginx单台实现HTTPS实战"></a>2.Nginx单台实现HTTPS实战</h2><p><em>1.环境准备</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#nginx必须有ssl模块</span></span><br><span class="line">[root<span class="symbol">@Nginx</span> ~]<span class="meta"># nginx -V</span></span><br><span class="line"> --<span class="keyword">with</span>-http_ssl_module</span><br><span class="line"> </span><br><span class="line"><span class="meta">#创建存放ssl证书的路径</span></span><br><span class="line">[root<span class="symbol">@Nginx</span> ~]<span class="meta"># mkdir -p /etc/nginx/ssl_key</span></span><br><span class="line">[root<span class="symbol">@Nginx</span> ~]<span class="meta"># cd /etc/nginx/ssl_key</span></span><br></pre></td></tr></table></figure>
<p><em>2.使用openssl命令充当CA权威机构创建证书(生产不使用此方式生成证书，不被互联网认可的黑户证书)</em></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ssh_key]<span class="meta"># openssl genrsa -idea -out server.key 2048</span></span><br><span class="line">Generating RSA <span class="keyword">private</span> <span class="keyword">key</span>, <span class="number">2048</span> bit <span class="built_in">long</span> modulus</span><br><span class="line">.....+++</span><br><span class="line"><span class="meta">#记住配置密码, 我这里是1234</span></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> server.<span class="keyword">key</span>:</span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> server.<span class="keyword">key</span>:</span><br></pre></td></tr></table></figure>
<p><em>3.生成自签证书，同时去掉私钥的密码</em></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@Nginx ssl_key]</span># <span class="selector-tag">openssl</span> <span class="selector-tag">req</span> <span class="selector-tag">-days</span> <span class="selector-tag">36500</span> <span class="selector-tag">-x509</span> \</span><br><span class="line"><span class="selector-tag">-sha256</span> <span class="selector-tag">-nodes</span> <span class="selector-tag">-newkey</span> <span class="selector-tag">rsa</span><span class="selector-pseudo">:2048</span> <span class="selector-tag">-keyout</span> <span class="selector-tag">server</span><span class="selector-class">.key</span> <span class="selector-tag">-out</span> <span class="selector-tag">server</span><span class="selector-class">.crt</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">Country</span> <span class="selector-tag">Name</span> (<span class="number">2</span> letter code) <span class="selector-attr">[XX]</span><span class="selector-pseudo">:CN</span></span><br><span class="line"><span class="selector-tag">State</span> <span class="selector-tag">or</span> <span class="selector-tag">Province</span> <span class="selector-tag">Name</span> (full name) <span class="selector-attr">[]</span><span class="selector-pseudo">:WH</span></span><br><span class="line"><span class="selector-tag">Locality</span> <span class="selector-tag">Name</span> (eg, city) <span class="selector-attr">[Default City]</span><span class="selector-pseudo">:WH</span></span><br><span class="line"><span class="selector-tag">Organization</span> <span class="selector-tag">Name</span> (eg, company) <span class="selector-attr">[Default Company Ltd]</span><span class="selector-pseudo">:edu</span>    </span><br><span class="line"><span class="selector-tag">Organizational</span> <span class="selector-tag">Unit</span> <span class="selector-tag">Name</span> (eg, section) <span class="selector-attr">[]</span><span class="selector-pseudo">:SA</span></span><br><span class="line"><span class="selector-tag">Common</span> <span class="selector-tag">Name</span> (eg, your name or your servers hostname) <span class="selector-attr">[]</span><span class="selector-pseudo">:bgx</span></span><br><span class="line"><span class="selector-tag">Email</span> <span class="selector-tag">Address</span> <span class="selector-attr">[]</span><span class="selector-pseudo">:bgx</span>@<span class="selector-tag">foxmail</span><span class="selector-class">.com</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="selector-tag">req</span>  <span class="selector-tag">--</span>&gt;用于创建新的证书</span><br><span class="line"># <span class="selector-tag">new</span>  <span class="selector-tag">--</span>&gt;表示创建的是新证书</span><br><span class="line"># <span class="selector-tag">x509</span> <span class="selector-tag">--</span>&gt;表示定义证书的格式为标准格式</span><br><span class="line"># <span class="selector-tag">key</span>  <span class="selector-tag">--</span>&gt;表示调用的私钥文件信息</span><br><span class="line"># <span class="selector-tag">out</span>  <span class="selector-tag">--</span>&gt;表示输出证书文件信息</span><br><span class="line"># <span class="selector-tag">days</span> <span class="selector-tag">--</span>&gt;表示证书的有效期</span><br></pre></td></tr></table></figure>
<p><em>4.证书申请完成后需要了解Nginx如何配置Https</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动ssl功能</span></span><br><span class="line">Syntax: ssl on | off;</span><br><span class="line">Default: ssl off;</span><br><span class="line">Context: http, server</span><br><span class="line"></span><br><span class="line"><span class="comment">#证书文件</span></span><br><span class="line">Syntax: ssl_certificate file;</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server</span><br><span class="line"></span><br><span class="line"><span class="comment">#私钥文件</span></span><br><span class="line">Syntax: ssl_certificate_key file;</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server</span><br></pre></td></tr></table></figure>
<p><em>5.配置Nginx配置Https实例</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# cat /etc/nginx/conf.d/ssl.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name s.oldboy.com;</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate   ssl_key/server.crt;</span><br><span class="line">    ssl_certificate_key  ssl_key/server.key;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备对应的站点目录, 并重启Nginx服务</span></span><br><span class="line">[root@Nginx ~]# mkdir -p /code</span><br><span class="line">[root@Nginx ~]# echo <span class="string">"Https"</span> &gt; /code/index.html</span><br><span class="line">[root@Nginx ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p><em>6.浏览器输入<span class="exturl" data-url="aHR0cHM6Ly9zLm9sZGJveS5jb23orr/pl64=" title="https://s.oldboy.com访问">https://s.oldboy.com访问<i class="fa fa-external-link"></i></span>, 由于该证书非第三方权威机构颁发，而是我们自己签发的，所以浏览器会警告</em><br><img src="http://cdn.xuliangwei.com/15433221479695.jpg" alt="img"></p>
<p><em>7.以上配置如果用户忘记在浏览器地址栏输入 https:// 那么将不会跳转至https，建议配置将用户访问 http请求强制跳转https</em></p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]<span class="meta"># cat /etc/nginx/conf.d/ssl.conf </span></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    listen <span class="number">443</span>;</span><br><span class="line">    server_name s.oldboy.com;</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate   ssl_key/<span class="keyword">server</span>.crt;</span><br><span class="line">    ssl_certificate_key  ssl_key/<span class="keyword">server</span>.key;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        <span class="keyword">index</span> <span class="keyword">index</span>.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name s.oldboy.com;</span><br><span class="line">        rewrite ^(.*) https:<span class="comment">//$server_name$1 redirect;  #rewrite跳转方式</span></span><br><span class="line">        <span class="meta">#return 302 https://$server_name$request_uri;   #return跳转方式   </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-Nginx集群实现HTTPS实践"><a href="#3-Nginx集群实现HTTPS实践" class="headerlink" title="3.Nginx集群实现HTTPS实践"></a>3.Nginx集群实现HTTPS实践</h2><p><em>实战Nginx负载均衡+Nginx WEB配置HTTPS安全</em></p>
<p><img src="http://cdn.xuliangwei.com/15392608988224.jpg?imageView2/0/q/75%7Cwatermark/2/text/d3d3Lnh1bGlhbmd3ZWkuY29t/font/5qW35L2T/fontsize/400/fill/I0Y4MEEwQQ==/dissolve/100/gravity/SouthEast/dx/25/dy/25%7Cimageslim" alt="img"></p>
<p><em>1) 环境准备</em></p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>外网IP(NAT)</th>
<th>内网IP(LAN)</th>
<th>角色</th>
</tr>
</thead>
<tbody>
<tr>
<td>lb01</td>
<td>eth0:10.0.0.5</td>
<td>eth1:172.16.1.5</td>
<td>nginx-proxy</td>
</tr>
<tr>
<td>web01</td>
<td>eth0:10.0.0.7</td>
<td>eth1:172.16.1.7</td>
<td>nginx-web01</td>
</tr>
<tr>
<td>web02</td>
<td>eth0:10.0.0.8</td>
<td>eth1:172.16.1.8</td>
<td>nginx-web02</td>
</tr>
</tbody>
</table>
<p><em>2) 配置后端两台web节点监听80端口, 如已配置则无需修改</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat blog.oldboy.com.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name blog.oldboy.com;</span><br><span class="line">    root /code/wordpress;</span><br><span class="line">    index index.php index.html;</span><br><span class="line">   </span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root /code/wordpress;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3) 配置第二台web节点</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># yum install -y nginx</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># scp -rp /etc/nginx/ssl_key/ root@172.16.1.8:/etc/nginx/  </span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># scp -rp /etc/nginx/conf.d/ root@172.16.1.8:/etc/nginx/</span></span><br></pre></td></tr></table></figure>
<p><em>4) 重启两台后端web节点Nginx</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># systemctl restart nginx</span></span><br><span class="line">[root<span class="symbol">@web02</span> ~]<span class="meta"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>5) Nginx负载均衡先生成证书</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># mkdir /etc/nginx/ssl_key -p</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># cd /etc/nginx/ssl_key</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># openssl genrsa -idea -out server.key 2048</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># openssl req -days 36500 -x509 -sha256 -nodes -newkey rsa:2048 -keyout server.key -out server.crt</span></span><br></pre></td></tr></table></figure>
<p><em>6) Nginx负载均衡配置文件如下</em></p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]<span class="meta"># cat /etc/nginx/conf.d/proxy.conf </span></span><br><span class="line"><span class="meta"># 定义后端资源池</span></span><br><span class="line">upstream site &#123;</span><br><span class="line">    <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.7</span>:<span class="number">80</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10</span>s;</span><br><span class="line">    <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.8</span>:<span class="number">80</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10</span>s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"># https配置</span></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    listen <span class="number">443</span>;</span><br><span class="line">    server_name blog.oldboy.com;</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate  ssl_key/<span class="keyword">server</span>.crt;</span><br><span class="line">    ssl_certificate_key  ssl_key/<span class="keyword">server</span>.key;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//site;</span></span><br><span class="line">        include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"># 用户http请求跳转至https</span></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name blog.oldboy.com;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">302</span> https:<span class="comment">//$server_name$request_uri;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>7) 重启Nginx 负载均衡</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># nginx -t</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>
<p><em>8) wordpress早期安装如果是使用http方式, 那开启https后会导致, wordpress出现加载或无法登陆问题。</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#web节点增加此参数</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">~ \.php</span>$ &#123;</span><br><span class="line">    ...</span><br><span class="line">    fastcgi_param  HTTPS on;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-阿里云Nginx实现HTTPS实践"><a href="#4-阿里云Nginx实现HTTPS实践" class="headerlink" title="4.阿里云Nginx实现HTTPS实践"></a>4.阿里云Nginx实现HTTPS实践</h2><p><em>在云上签发各品牌数字证书，实现网站HTTPS化，使网站可信，防劫持、防篡改、防监听。并进行统一生命周期管理，简化证书部署，一键分发到云上产品</em></p>
<p><img src="http://cdn.xuliangwei.com/15241223412056.jpg" alt="img"></p>
<p><img src="http://cdn.xuliangwei.com/15241221586628.jpg" alt="img"></p>
<p><img src="http://cdn.xuliangwei.com/15241222179952.jpg" alt="img"></p>
<p><img src="http://cdn.xuliangwei.com/15241227477621.jpg" alt="img"></p>
<p><img src="http://cdn.xuliangwei.com/15241238662546.jpg" alt="img"></p>
<p><img src="http://cdn.xuliangwei.com/15241239372426.jpg" alt="img"></p>
<p><em>上传阿里云证书, 并解压</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@Nginx</span> <span class="string">ssl_key]#</span> <span class="string">rz</span> </span><br><span class="line"><span class="string">rz</span> <span class="string">waiting</span> <span class="string">to</span> <span class="string">receive.</span></span><br><span class="line"><span class="string">Starting</span> <span class="string">zmodem</span> <span class="string">transfer.</span>  <span class="string">Press</span> <span class="string">Ctrl+C</span> <span class="string">to</span> <span class="string">cancel.</span></span><br><span class="line"><span class="string">Transferring</span> <span class="number">1524377920931.</span><span class="string">zip...</span></span><br><span class="line">  <span class="number">100</span><span class="string">%</span>       <span class="number">3</span> <span class="string">KB</span>       <span class="number">3</span> <span class="string">KB/sec</span>    <span class="number">00</span><span class="string">:00:01</span>       <span class="number">0</span> <span class="string">Errors</span></span><br><span class="line"></span><br><span class="line"><span class="string">//解压</span></span><br><span class="line"><span class="string">[root@Nginx</span> <span class="string">ssl_key]#</span> <span class="string">unzip</span> <span class="number">1524377920931.</span><span class="string">zip</span></span><br></pre></td></tr></table></figure>
<p><em>配置nginx https</em></p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx conf.d]<span class="meta"># cat ssl.nginx.bjstack.com.conf</span></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">    listen <span class="number">443</span>;</span><br><span class="line">    server_name nginx.bjstack.com;</span><br><span class="line"></span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_session_timeout <span class="number">10</span>m;</span><br><span class="line">    ssl_certificate ssl_key/<span class="number">1524377920931.</span>pem;</span><br><span class="line">    ssl_certificate_key ssl_key/<span class="number">1524377920931.</span>key;</span><br><span class="line">    ssl_ciphers </span><br><span class="line">    ssl_protocols </span><br><span class="line"></span><br><span class="line">    ssl_session_cache shared:SSL:<span class="number">10</span>m; <span class="meta">#在建立完ssl握手后如果断开连接，在session_timeout时间内再次连接，是不需要在次建立握手，可以复用之前的连接</span></span><br><span class="line">    ssl_session_timeout <span class="number">1440</span>m;           <span class="meta">#ssl连接断开后的超时时间</span></span><br><span class="line">    ssl_protocols TLSv1 TLSv1<span class="number">.1</span> TLSv1<span class="number">.2</span>; <span class="meta">#使用的TLS版本协议</span></span><br><span class="line">    ssl_prefer_server_ciphers on;        <span class="meta">#Nginx决定使用哪些协议与浏览器进行通讯</span></span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4; <span class="meta">#配置加密套间</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /soft/code;</span><br><span class="line">        <span class="keyword">index</span> <span class="keyword">index</span>.html <span class="keyword">index</span>.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name nginx.bjstack.com;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">302</span> https:<span class="comment">//$server_name$request_uri;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>测试访问Https</em><br><img src="http://cdn.xuliangwei.com/15241249792088.jpg" alt="img"></p>
<p>使用腾讯云<code>ATS</code>检测工具检查是否满足苹果<code>IOS</code>要求<span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L3NzbD9mcm9tPXFjbG91ZEhwSGVhZGVyU3NsI3VzZXJEZWZpbmVkMTA=" title="https://cloud.tencent.com/product/ssl?from=qcloudHpHeaderSsl#userDefined10">苹果ATS测试传送门<i class="fa fa-external-link"></i></span></p>
<p><img src="http://cdn.xuliangwei.com/15241258755067.jpg" alt="img"></p>
<h2 id="5-阿里云SLB负载实现HTTPS实践"><a href="#5-阿里云SLB负载实现HTTPS实践" class="headerlink" title="5.阿里云SLB负载实现HTTPS实践"></a>5.阿里云SLB负载实现HTTPS实践</h2><p><img src="http://cdn.xuliangwei.com/15392608988224.jpg?imageView2/0/q/75%7Cwatermark/2/text/d3d3Lnh1bGlhbmd3ZWkuY29t/font/5qW35L2T/fontsize/400/fill/I0Y4MEEwQQ==/dissolve/100/gravity/SouthEast/dx/25/dy/25%7Cimageslim" alt="img"></p>
<p><em>1) 环境准备</em></p>
<table>
<thead>
<tr>
<th>角色</th>
<th>外网IP(NAT)</th>
<th>内网IP(LAN)</th>
<th>协议</th>
</tr>
</thead>
<tbody>
<tr>
<td>slb</td>
<td>eth0:10.0.0.5</td>
<td>eth1:172.16.1.5</td>
<td>https</td>
</tr>
<tr>
<td>ecs01</td>
<td>eth0:10.0.0.7</td>
<td>eth1:172.16.1.7</td>
<td>http</td>
</tr>
<tr>
<td>ecs02</td>
<td>eth0:10.0.0.8</td>
<td>eth1:172.16.1.8</td>
<td>http</td>
</tr>
</tbody>
</table>
<h2 id="6-Nginx4-7层负载实现HTTPS实战"><a href="#6-Nginx4-7层负载实现HTTPS实战" class="headerlink" title="6.Nginx4+7层负载实现HTTPS实战"></a>6.Nginx4+7层负载实现HTTPS实战</h2><p><em>配置1台nginx四层负载均衡，2台7层nginx负载，4台后端web节点实现全栈https</em></p>
<table>
<thead>
<tr>
<th>角色</th>
<th>弹性公网</th>
<th>内网网络</th>
<th>协议</th>
<th>端口</th>
</tr>
</thead>
<tbody>
<tr>
<td>tcp_proxy</td>
<td>47.104.29.64</td>
<td>172.16.1.164</td>
<td>https/http</td>
<td>80/443</td>
</tr>
<tr>
<td>http_proxy01</td>
<td></td>
<td>172.16.1.165</td>
<td>http/https</td>
<td>80/443</td>
</tr>
<tr>
<td>http_proxy02</td>
<td></td>
<td>172.16.1.166</td>
<td>http/https</td>
<td>80/443</td>
</tr>
<tr>
<td>http_web01</td>
<td></td>
<td>172.16.1.167</td>
<td>http</td>
<td>80</td>
</tr>
<tr>
<td>http_web02</td>
<td></td>
<td>172.16.1.168</td>
<td>http</td>
<td>80</td>
</tr>
<tr>
<td>http_web03</td>
<td></td>
<td>172.16.1.169</td>
<td>http</td>
<td>80</td>
</tr>
<tr>
<td>http_web04</td>
<td></td>
<td>172.16.1.170</td>
<td>http</td>
<td>80</td>
</tr>
</tbody>
</table>
<p><em>1.Nginx四层负载均衡配置如下</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@tcp_lb conf.c]# cat tcp_lb.bjstack.com.conf</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream proxy_lb_bjstack &#123;</span><br><span class="line">       <span class="built_in"> server </span>172.16.1.165:80;</span><br><span class="line">       <span class="built_in"> server </span>172.16.1.166:80;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    upstream proxy_lb_bjstack_443 &#123;</span><br><span class="line">       <span class="built_in"> server </span>172.16.1.165:443;</span><br><span class="line">       <span class="built_in"> server </span>172.16.1.166:443;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> server </span>&#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        proxy_pass proxy_lb_bjstack;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> server </span>&#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        proxy_pass proxy_lb_bjstack_443;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.lb01与lb02配置七层负载均，具体内容如下</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@lb-node1 ~]<span class="comment"># cat /etc/nginx/conf.d/proxy_lb.bjstack.com.conf</span></span><br><span class="line">upstream <span class="keyword">node</span> <span class="title">&#123;</span></span><br><span class="line"><span class="title">    server</span> <span class="number">172.16</span>.<span class="number">1.167</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.168</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.169</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">172.16</span>.<span class="number">1.170</span>:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name lb.bjstack.com;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">        return</span> <span class="number">302</span> https://$server_name$request_uri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">443</span>;</span><br><span class="line">    server_name lb.bjstack.com;</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate   ssl_key/server.crt;</span><br><span class="line">    ssl_certificate_key  ssl_key/server.key;</span><br><span class="line">    <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">        proxy_pass</span> http://<span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">        proxy_set_header</span> Host $http_host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.后端多台web节点配置如下</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 ~]# cat /etc/nginx/conf.d/web_lb.bjstack.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name lb.bjstack.com;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                root /code;</span><br><span class="line">                index index.html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="13-Nginx高可用架构"><a href="#13-Nginx高可用架构" class="headerlink" title="13.Nginx高可用架构"></a>13.Nginx高可用架构</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyNDEyMjk1My5odG1sI3RvY18w" title="http://docs.etiantian.org/15332924122953.html#toc_0">1.Keepalived高可用基本概述<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyNDEyMjk1My5odG1sI3RvY18x" title="http://docs.etiantian.org/15332924122953.html#toc_1">2.Keepalived高可用安装配置<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyNDEyMjk1My5odG1sI3RvY18y" title="http://docs.etiantian.org/15332924122953.html#toc_2">3.Keepalived高可用地址漂移<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyNDEyMjk1My5odG1sI3RvY18z" title="http://docs.etiantian.org/15332924122953.html#toc_3">4.Keepalived高可用非抢占式<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTMzMjkyNDEyMjk1My5odG1sI3RvY180" title="http://docs.etiantian.org/15332924122953.html#toc_4">5.keepalived高可用故障脑裂<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-Keepalived高可用基本概述"><a href="#1-Keepalived高可用基本概述" class="headerlink" title="1.Keepalived高可用基本概述"></a>1.Keepalived高可用基本概述</h2><p><strong>1.什么是高可用</strong><br><em>一般是指2台机器启动着相同的业务系统,当有一台机器down机了, 另外一台服务器能快速的接管, 对于访问的用户是无感知的。</em></p>
<p><strong>2.高可用通常使用什么软件?</strong><br><em>通常服务高可用我们选择使用keepalived软件实现</em></p>
<p><strong>3.keepalived是如何实现高可用的？</strong><br><em>keepalived软件是基于VRRP协议实现的。VRRP虚拟路由冗余协议，主要用于解决单点故障问题</em></p>
<p><strong>4.那VRRP是如何诞生的，VRRP的原理又是什么？</strong><br><em>比如公司的网络是通过网关转换进行上网的，那如果该路由器故障了，网关无法转发报文了，此时所有人都将无法上网，这么时候怎么办呢？</em><br><img src="http://cdn.xuliangwei.com/15486014538664.jpg" alt="img"></p>
<p><em>通常做法是给路由增加一台备节点，但问题来了?如果我们的主网关master故障了，用户是需要手动修改网关指向Backup，如果用户过多修改起来会非常的麻烦。第一个问题: 假设用户将指向都修改到Backup路由器，那么Master路由器如果修复好了又该怎么办？第二个问题: 假设Master网关故障，我们将Backup网关配置为Master网关IP行不行?其实上不行，因为PC第一次是通过ARP广播寻找到Master网关的Mac地址与IP地址，PC则会将Master网关的对应IP与MAC地址写入ARP缓存表中，那么PC第二次则会直接读取ARP缓存表中的MAC地址与IP地址，然后进行数据包的转发。此时PC转发的数据包还是会教给Master。(除非PC的ARP缓存表过期，在次发起ARP广播的时候才能正确获取Bakcup的Mac地址与对应的IP地址。)</em><br><img src="http://cdn.xuliangwei.com/15486015004226.jpg" alt="img"></p>
<p><em>如何才能做到出现故障自动转移，此时VRRP就应运而生，我们的VRRP其实是通过软件或硬件的形式在Master和Backup外面增加一个虚拟MAC地址(简称VMAC)与虚拟IP地址(简称VIP)。那么在这种情况下，PC请求VIP的时候，无论是Master处理还是Backup处理，PC仅会在ARP缓存表中记录VMAC与VIP的对应关系。</em><br><img src="http://cdn.xuliangwei.com/15486016099496.jpg" alt="img"></p>
<p><strong>5.高可用keepalived使用场景</strong><br><em>通常业务系统需要保证7x24小时不DOWN机, 比如公司内部OA系统，每天公司人员都需要使用，则不允许Down机。作为业务系统来说随时都可用</em><br><img src="http://cdn.xuliangwei.com/15343385261215.jpg" alt="img"></p>
<p><strong>6.高可用核心概念总结</strong><br><em>1.如何确定谁是主节点谁是备节点。(投票选举？优先级？)2.如果Master故障，Backup自动接管，那Master恢复后会夺权吗？(抢占式、非抢占式)3.如果两台服务器都认为自己是Master会出现什么问题？(脑裂)</em></p>
<h2 id="2-Keepalived高可用安装配置"><a href="#2-Keepalived高可用安装配置" class="headerlink" title="2.Keepalived高可用安装配置"></a>2.Keepalived高可用安装配置</h2><p><em>1.实践环境，配置实现虚IP转移</em></p>
<table>
<thead>
<tr>
<th>状态</th>
<th>IP</th>
<th>角色</th>
</tr>
</thead>
<tbody>
<tr>
<td>节点1</td>
<td>10.0.0.5</td>
<td>Master</td>
</tr>
<tr>
<td>节点2</td>
<td>10.0.0.6</td>
<td>Backup</td>
</tr>
<tr>
<td>VIP</td>
<td>10.0.0.3</td>
</tr>
</tbody>
</table>
<p><em>2.在master与backup上分别安装keepalived</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># yum install keepalived -y</span></span><br><span class="line">[root<span class="symbol">@lb02</span> ~]<span class="meta"># yum install keepalived -y</span></span><br></pre></td></tr></table></figure>
<p><em>3.配置节点1，Master</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;     </span><br><span class="line">    router_id lb01   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>4.配置节点2，Backup</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>5.对比keepalived的master与backup配置的区别</em></p>
<table>
<thead>
<tr>
<th>Keepalived配置区别</th>
<th>Master配置</th>
<th>Backup节配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>route_id(唯一标识)</td>
<td>lb01</td>
<td>lb02</td>
</tr>
<tr>
<td>state(角色状态)</td>
<td>MASTER</td>
<td>BACKUP</td>
</tr>
<tr>
<td>priority(优先级)</td>
<td>150</td>
<td>100</td>
</tr>
</tbody>
</table>
<p><em>6.启动Master与Backup节点的keepalived</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#lb01</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># systemctl enable keepalived</span></span><br><span class="line">[root<span class="symbol">@lb01</span> ~]<span class="meta"># systemctl start keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#lb02</span></span><br><span class="line">[root<span class="symbol">@lb02</span> ~]<span class="meta"># systemctl enable keepalived</span></span><br><span class="line">[root<span class="symbol">@lb02</span> ~]<span class="meta"># systemctl start keepalived</span></span><br></pre></td></tr></table></figure>
<h2 id="3-Keepalived高可用地址漂移"><a href="#3-Keepalived高可用地址漂移" class="headerlink" title="3.Keepalived高可用地址漂移"></a>3.Keepalived高可用地址漂移</h2><p><em>检查keepalived的虚拟VIP地址能否漂移</em></p>
<p><em>1.在Master上进行如下操作</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master存在vip地址</span></span><br><span class="line">[root@lb01 ~]#<span class="built_in"> ip </span>addr |grep 10.0.0.3</span><br><span class="line">    inet 10.0.0.3/24 scope global secondary eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止Master上的keepalived, 检测vip已不存在</span></span><br><span class="line">[root@lb01 ~]# systemctl stop keepalived</span><br><span class="line">[root@lb01 ~]#<span class="built_in"> ip </span>addr |grep 10.0.0.3</span><br></pre></td></tr></table></figure>
<p><em>2.在Backup上进行如下操作</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#发现地址已经漂移至Backup端</span></span><br><span class="line">[root@lb02 ~]#<span class="built_in"> ip </span>addr|grep 10.0.0.3</span><br><span class="line">    inet 10.0.0.3/24 scope global secondary eth0</span><br></pre></td></tr></table></figure>
<p><em>3.此时重新启动Master上的Keepalived,会发现VIP被强行抢占</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# systemctl start keepalived</span><br><span class="line">[root@lb01 ~]#<span class="built_in"> ip </span>addr |grep 10.0.0.3</span><br><span class="line">    inet 10.0.0.3/24 scope global secondary eth0</span><br></pre></td></tr></table></figure>
<p><em>4.通过windows查看arp缓存表，验证地址漂移后是否会自动更新MAC地址。</em></p>
<h2 id="4-Keepalived高可用非抢占式"><a href="#4-Keepalived高可用非抢占式" class="headerlink" title="4.Keepalived高可用非抢占式"></a>4.Keepalived高可用非抢占式</h2><p><em>通常master服务故障后backup会变成master，但是当master服务又恢复的时候，master会抢占VIP，这样就会发生两次切换对业务繁忙的网站来说并不是太友好，此时我们可以配置keepalived为非抢占式(前提两台主机的硬件配置信息一致)</em></p>
<p><strong>配置非抢占式步骤如下</strong><br><em>1、两个节点的state都必须配置为BACKUP(官方建议)2、两个节点都在vrrp_instance中添加nopreempt参数3、其中一个节点的优先级必须要高于另外一个节点的优先级。两台服务器都角色状态启用nopreempt后，必须修改角色状态统一为BACKUP，唯一的区分就是优先级。</em></p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Master</span></span><br><span class="line">    vrrp_instance VI_1 &#123;</span><br><span class="line">        <span class="keyword">state</span> BACKUP</span><br><span class="line">        priority <span class="number">150</span></span><br><span class="line">        nopreempt</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#Backup</span></span><br><span class="line">    vrrp_instance VI_1 &#123;</span><br><span class="line">        <span class="keyword">state</span> BACKUP</span><br><span class="line">        priority <span class="number">100</span></span><br><span class="line">        nopreempt</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-keepalived高可用故障脑裂"><a href="#5-keepalived高可用故障脑裂" class="headerlink" title="5.keepalived高可用故障脑裂"></a>5.keepalived高可用故障脑裂</h2><p><em>由于某些原因，导致两台keepalived高可用服务器在指定时间内，无法检测到对方的心跳消息，各自取得资源及服务的所有权，而此时的两台高可用服务器又都还活着。</em><br><em>1.服务器网线松动等网络故障2.服务器硬件故障发生损坏现象而崩溃3.主备都开启firewalld防火墙</em></p>
<p><em>1.在备上编写检测脚本, 测试如果能ping通主并且备节点还有VIP的话则认为产生了列脑</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 ~]# cat check_split_brain.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="attribute">vip</span>=10.0.0.3</span><br><span class="line"><span class="attribute">master_ip</span>=10.0.0.5</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">   <span class="built_in"> ping </span>-c 2 -W 3 <span class="variable">$master_ip</span> &amp;&gt;/dev/<span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 -a `ip add|grep <span class="string">"<span class="variable">$vip</span>"</span>|wc -l` -eq 1 ];then</span><br><span class="line">        echo <span class="string">"ha is split brain.warning."</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        echo <span class="string">"ha is ok"</span></span><br><span class="line">    fi</span><br><span class="line">sleep 5</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p><em>2.如果Nginx宕机, 会导致用户请求失败, 但Keepalived并不会进行切换, 所以需要编写一个脚本检测Nginx的存活状态, 如果不存活则kill nginx和keepalived</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]<span class="comment"># mkdir /server/scripts</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># vim /server/scripts/check_web.sh</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">nginxpid=$(ps -C nginx --no-header|wc -l)</span><br><span class="line"><span class="comment">#1.判断Nginx是否存活,如果不存活则尝试启动Nginx</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$nginxpid</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl start nginx</span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="comment">#2.等待3秒后再次获取一次Nginx状态</span></span><br><span class="line">    nginxpid=$(ps -C nginx --no-header|wc -l) </span><br><span class="line">    <span class="comment">#3.再次进行判断, 如Nginx还不存活则停止Keepalived,让地址进行漂移,并退出脚本  </span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$nginxpid</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        systemctl stop keepalived</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#给脚本增加执行权限</span></span><br><span class="line">[root@lb01 ~]<span class="comment"># chmod +x /server/scripts/check_web.sh</span></span><br></pre></td></tr></table></figure>
<p><em>3.在lb01主机的keepalived配置文件中调用此脚本</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">         router_id LVS_01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.每5秒执行一次脚本, 脚本执行内容不能超过5秒,否则会被中断再次重新运行脚本</span></span><br><span class="line">vrrp_script check_web &#123;</span><br><span class="line">  <span class="built_in"> script </span><span class="string">"/server/scripts/check_web.sh"</span></span><br><span class="line">   interval 5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    nopreempt</span><br><span class="line">    state MASTER</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    #2.调用并运行该脚本</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_web</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="14-Nginx使用常见问题"><a href="#14-Nginx使用常见问题" class="headerlink" title="14.Nginx使用常见问题"></a>14.Nginx使用常见问题</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTM3MjgyNjk4NzAwOS5odG1sI3RvY18w" title="http://docs.etiantian.org/15372826987009.html#toc_0">1.Nginx多Server优先级<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTM3MjgyNjk4NzAwOS5odG1sI3RvY18x" title="http://docs.etiantian.org/15372826987009.html#toc_1">2.Nginx禁止IP直接访问<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTM3MjgyNjk4NzAwOS5odG1sI3RvY18y" title="http://docs.etiantian.org/15372826987009.html#toc_2">3.Nginx包含文件Include<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTM3MjgyNjk4NzAwOS5odG1sI3RvY18z" title="http://docs.etiantian.org/15372826987009.html#toc_3">4.Nginx路径root与alias<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTM3MjgyNjk4NzAwOS5odG1sI3RvY180" title="http://docs.etiantian.org/15372826987009.html#toc_4">5.Nginx try_file路径匹配<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTM3MjgyNjk4NzAwOS5odG1sI3RvY181" title="http://docs.etiantian.org/15372826987009.html#toc_5">6.Nginx调整上传文件大小<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTM3MjgyNjk4NzAwOS5odG1sI3RvY182" title="http://docs.etiantian.org/15372826987009.html#toc_6">7.Nginx优雅显示错误页面<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-Nginx多Server优先级"><a href="#1-Nginx多Server优先级" class="headerlink" title="1.Nginx多Server优先级"></a>1.Nginx多Server优先级</h2><p><em>在开始处理一个http请求时，nginx会取出header头中的Host变量，与nginx.conf中每个server的server_name进行匹配，以此决定到底由哪一个server来处理这个请求。但nginx如配置多个相同的server_name，会导致server_name出现优先级访问冲突。</em></p>
<p><em>1.准备nginx对应的配置文件</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 conf.d]# cat code1.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost code1.bgx.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code1;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web02 conf.d]# cat code2.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost code2.bgx.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code2;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web02 conf.d]# cat code3.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost code3.bgx.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code3;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.准备站点目录</em></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 <span class="keyword">conf</span>.<span class="keyword">d</span>]# <span class="keyword">mkdir</span> /code&#123;1..3&#125; -p</span><br><span class="line">[root@web02 <span class="keyword">conf</span>.<span class="keyword">d</span>]# <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..3&#125;;<span class="keyword">do</span> echo <span class="string">"Code$i"</span> &gt; /code<span class="variable">$i</span>/index.html;done</span><br><span class="line">[root@web02 <span class="keyword">conf</span>.<span class="keyword">d</span>]# <span class="keyword">cat</span> /code1/index.html </span><br><span class="line">Code1</span><br><span class="line">[root@web02 <span class="keyword">conf</span>.<span class="keyword">d</span>]# <span class="keyword">cat</span> /code2/index.html </span><br><span class="line">Code2</span><br><span class="line">[root@web02 <span class="keyword">conf</span>.<span class="keyword">d</span>]# <span class="keyword">cat</span> /code3/index.html </span><br><span class="line">Code3</span><br></pre></td></tr></table></figure>
<p><em>3.检查语法, 并重新加载Nginx</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 conf.d]# nginx -t</span><br><span class="line">nginx: [warn] conflicting<span class="built_in"> server </span>name <span class="string">"localhost"</span> on 0.0.0.0:80, ignored</span><br><span class="line">nginx: [warn] conflicting<span class="built_in"> server </span>name <span class="string">"localhost"</span> on 0.0.0.0:80, ignored</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启Nginx</span></span><br><span class="line">[root@Nginx ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p><em>4.测试访问效果</em></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#1</span>.当用户第一次访问, 由<span class="selector-tag">code1</span><span class="selector-class">.conf</span>返回输出信息</span><br><span class="line"><span class="selector-attr">[root@Nginx ~]</span># <span class="selector-tag">curl</span> <span class="selector-tag">localhost</span></span><br><span class="line"><span class="selector-tag">Code</span> 1</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#2</span>.此时将<span class="selector-tag">code1</span><span class="selector-class">.conf</span>修改为<span class="selector-tag">code5</span><span class="selector-class">.conf</span>后进行重载<span class="selector-tag">Nginx</span></span><br><span class="line"><span class="selector-attr">[root@Nginx ~]</span># <span class="selector-tag">mv</span> <span class="selector-tag">code1</span><span class="selector-class">.conf</span> <span class="selector-tag">code5</span><span class="selector-class">.conf</span></span><br><span class="line"><span class="selector-attr">[root@Nginx ~]</span># <span class="selector-tag">systemctl</span> <span class="selector-tag">reload</span> <span class="selector-tag">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="selector-id">#3</span>.再次访问时, 由<span class="selector-tag">code2</span><span class="selector-class">.conf</span>返回输出信息</span><br><span class="line"><span class="selector-attr">[root@Nginx ~]</span># <span class="selector-tag">curl</span> <span class="selector-tag">localhost</span></span><br><span class="line"><span class="selector-tag">Code</span> 2</span><br></pre></td></tr></table></figure>
<p><em>5.多ServerName优先级总结, 在开始处理一个HTTP请求时，Nginx会读取 header(请求头)中的host，与每个server中的 server_name进行匹配，来决定用哪一个server标签来完成处理这个请求。有可能一个Host与多个server中的server_name都匹配，这个时候就会更具匹配优先级来选择实际处理的server块。优先级匹配结果如下：</em></p>
<blockquote>
<p>1.首先选择所有的字符串完全匹配的server_name。（完全匹配）<br>2.选择通配符在前面的server_name，如<em>.bgx.com<br>3.选择通配符在后面的server_name，如bgx.</em><br>4.最后选择使用正则表达式匹配的server_name<br>5.如果全部都没有匹配到，那么将选择在listen配置项后加入[default_server]的server块<br>6.如果没写，那么就找到匹配listen端口的第一个Server块的配置文件</p>
</blockquote>
<p><strong>注意：当出现多个相同的Server_Name情况下，配置文件排序优先使用则会先被调用，所以建议配置相同端口, 不同域名，这样则不会出现域名访问冲突。</strong></p>
<h2 id="2-Nginx禁止IP直接访问"><a href="#2-Nginx禁止IP直接访问" class="headerlink" title="2.Nginx禁止IP直接访问"></a>2.Nginx禁止IP直接访问</h2><p><em>当用户通过访问IP或者未知域名访问你的网站的时候，你希望禁止显示任何有效内容，可以给他返回500，目前国内很多机房都要求网站主关闭空主机头，防止未备案的域名指向过来造成麻烦</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.xuliangwei.com   <span class="comment"># 这里指定自己的域名</span></span><br><span class="line">&#125;</span><br><span class="line">server｛</span><br><span class="line">    listen <span class="number">80</span> default_server;       <span class="comment"># 默认优先返回</span></span><br><span class="line">    <span class="attribute">server_name</span> _;                  <span class="comment"># 空主机头或IP</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">500</span>;                     <span class="comment"># 返回500错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.也可以将流量集中导入自己的网站，只要做以下跳转设置就可以</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">302</span> https://www.xuliangwei.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-Nginx包含文件Include"><a href="#3-Nginx包含文件Include" class="headerlink" title="3.Nginx包含文件Include"></a>3.Nginx包含文件Include</h2><p><em>一台服务器配置多个server网站，如果配置都写在nginx.conf主配置文件中，会导致nginx.conf主配置文件变得非常庞大而且可读性非常的差。那么后期的维护就变得麻烦。假设现在希望快速的关闭一个站点，该怎么办？1.如果是写在nginx.conf中，则需要手动注释，比较麻烦2.如果是include的方式，那么仅需修改配置文件的扩展名，即可完成注释</em></p>
<p><strong>Include包含的作用是为了简化主配置文件，便于人类可读。</strong></p>
<h2 id="4-Nginx路径root与alias"><a href="#4-Nginx路径root与alias" class="headerlink" title="4.Nginx路径root与alias"></a>4.Nginx路径root与alias</h2><p><em>root与alias路径匹配主要区别在于nginx如何解释location后面的uri，这会使两者分别以不同的方式将请求映射到服务器文件上，alias是一个目录别名的定义，root则是最上层目录的定义。root的处理结果是：root路径＋location路径alias的处理结果是：使用alias路径替换location路径</em></p>
<p><em>1.root路径配置实例: 用户访问<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS9pbWFnZS90ZXN0LmdpZu+8jOWunumZheS4ik5naW545Lya5LiKL2NvZGUvaW1hZ2Uv55uu5b2V5LiL5om+5Y675om+dGVzdC5naWbmlofku7Y=" title="http://www.xuliangwei.com/image/test.gif，实际上Nginx会上/code/image/目录下找去找test.gif文件">www.xuliangwei.com/image/test.gif，实际上Nginx会上/code/image/目录下找去找test.gif文件<i class="fa fa-external-link"></i></span></em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.xuliangwei.com;</span><br><span class="line">        </span><br><span class="line">        <span class="attribute">location</span> /image/ &#123;</span><br><span class="line">                <span class="attribute">root</span> /code;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>2.alias配置实例: 用户访问<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS9pbWFnZS90ZXN0LmdpZu+8jOWunumZheS4ik5naW545Lya5LiKL2NvZGUv55uu5b2V5LiL5om+5Y675om+dGVzdC5naWbmlofku7bjgII=" title="http://www.xuliangwei.com/image/test.gif，实际上Nginx会上/code/目录下找去找test.gif文件。">www.xuliangwei.com/image/test.gif，实际上Nginx会上/code/目录下找去找test.gif文件。<i class="fa fa-external-link"></i></span></em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.xuliangwei.com;</span><br><span class="line">        <span class="attribute">location</span> /image/ &#123;</span><br><span class="line">                <span class="attribute">alias</span> /code/image/;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-Nginx-try-file路径匹配"><a href="#5-Nginx-try-file路径匹配" class="headerlink" title="5.Nginx try_file路径匹配"></a>5.Nginx try_file路径匹配</h2><p>nginx的try_file路径匹配，按顺序检查文件是否存在</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx ~]# cat /etc/nginx/conf.d/try_file.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name try.bgx.com;</span><br><span class="line">    root /code;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> /404.html /index.php;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.检查用户请求的uri内容是否存在本地,存在则解析</span></span><br><span class="line"><span class="comment">#2.如果请求的url不存在，则访问对应站点目录中的404.html文件 </span></span><br><span class="line"><span class="comment">#3.最后交给index.php处理</span></span><br></pre></td></tr></table></figure>
<p><em>1.演示环境准备</em></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@Nginx</span> ~]<span class="comment"># echo "Try-Page" &gt; /soft/code/index.html</span></span><br><span class="line">[root<span class="variable">@Nginx</span> ~]<span class="comment"># echo "Tomcat-Page" &gt; /soft/app/apache-tomcat-9.0.7/webapps/ROOT/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动tomcat</span></span><br><span class="line">[root<span class="variable">@Nginx</span> ~]<span class="comment"># sh /soft/app/apache-tomcat-9.0.7/bin/startup.sh</span></span><br><span class="line"><span class="comment">#检查tomcat端口</span></span><br><span class="line">[root<span class="variable">@Nginx</span> ~]<span class="comment"># netstat -lntp|grep 8080</span></span><br><span class="line">tcp6       0      0 ::<span class="symbol">:</span><span class="number">8080</span>                 ::<span class="symbol">:*</span>                    LISTEN      <span class="number">104952</span>/java</span><br></pre></td></tr></table></figure>
<p><em>2.配置Nginx的tryfiles</em></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]<span class="comment"># cat /etc/nginx/conf.d/try.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">        server_name try.bgx.com;</span><br><span class="line">        root /code;</span><br><span class="line">        <span class="keyword">index</span> index.html;</span><br><span class="line">        location / &#123;</span><br><span class="line">                try_files $uri @java_page;</span><br><span class="line">        &#125;</span><br><span class="line">        location @java_page &#123;</span><br><span class="line">                proxy_pass http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8080</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx</span></span><br><span class="line">[root@Nginx ~]<span class="comment"># nginx -s reload</span></span><br></pre></td></tr></table></figure>
<p>3.测试<code>tryfiles</code></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# curl http:<span class="comment">//try.bgx.com/index.html</span></span><br><span class="line">Try-Page</span><br><span class="line"></span><br><span class="line">#将/<span class="keyword">code</span>/index.html文件移走</span><br><span class="line">[root@Nginx ~]# mv /<span class="keyword">code</span>/&#123;index.html,index.html_bak&#125;</span><br><span class="line"></span><br><span class="line">#发现由Tomcat吐回了请求</span><br><span class="line">[root@Nginx ~]# curl http:<span class="comment">//try.bgx.com/index.html    </span></span><br><span class="line">Tomcat-Page</span><br></pre></td></tr></table></figure>
<h2 id="6-Nginx调整上传文件大小"><a href="#6-Nginx调整上传文件大小" class="headerlink" title="6.Nginx调整上传文件大小"></a>6.Nginx调整上传文件大小</h2><p><em>在nginx使用过程中，上传文件的过程中，通常需要设置nginx报文大小限制。避免出现413 Request Entity Too Large</em></p>
<p><em>nginx上传文件大小限制配置语法</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Syntax:</span> client_max_body_size size<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> client_max_body_size <span class="number">1</span>m<span class="comment">;</span></span><br><span class="line"><span class="symbol">Context:</span> http, server, location</span><br></pre></td></tr></table></figure>
<p><em>nginx上传文件大小限制配置示例</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#也可以放入http层，全局生效</span></span><br><span class="line">server &#123;</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">    client_max_body_size 200m;</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-Nginx优雅显示错误页面"><a href="#7-Nginx优雅显示错误页面" class="headerlink" title="7.Nginx优雅显示错误页面"></a>7.Nginx优雅显示错误页面</h2><p><em>error_page错误日志</em></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]<span class="comment"># cat code3.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name code.oldboy.com;</span><br><span class="line">    <span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">        root</span> /code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">location</span> <span class="title">~ \.php</span>$ &#123;</span><br><span class="line">        fastcgi_pass <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">900</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#如服务器返回如下错误状态码，则进行跳转，跳转至/404.html</span></span><br><span class="line">    error_page <span class="number">404</span> <span class="number">403</span> /<span class="number">40</span>x.html;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#如服务器返回如下错误状态码，则进行跳转，跳转至/50x.html</span></span><br><span class="line">    error_page <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /<span class="number">50</span>x.html;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#精准匹配访问</span></span><br><span class="line">    <span class="keyword">location</span> <span class="title">= /404</span>.html &#123;</span><br><span class="line">       root /code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">location</span> <span class="title">= /50x</span>.html &#123;</span><br><span class="line">       root /code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="15-Nginx性能优化实践"><a href="#15-Nginx性能优化实践" class="headerlink" title="15.Nginx性能优化实践"></a>15.Nginx性能优化实践</h1><h2 id="1-性能优化概述"><a href="#1-性能优化概述" class="headerlink" title="1.性能优化概述"></a>1.性能优化概述</h2><p><em>基于Nginx性能优化，那么在性能优化这一章，我们将分为如下几个方面做介绍1.首先我们需要了解性能优化要考虑哪些方面。2.然后我们需要了解性能优化必须要用到的压力测试工具ab。3.最后我们需要了解系统上有哪些注意和优化的点，以及Nginx配置文件。</em></p>
<p><strong>我们在做性能优化工作前，我们重点需要考虑哪些方面，和了解哪些方面。</strong><br><em>1.首先需要了解我们当前系统结构和瓶颈，了解当前使用的是什么，运行的是什么业务，都有哪些服务，了解每个服务最大能支撑多大并发。比如Nginx作为静态资源服务的并发是多少，最高瓶颈在哪里，能支持多少qps(每秒查询率)的访问请求，那我们怎么得出这组系统结构瓶颈呢，比如top查看系统的cpu负载、内存使用率、总的运行进程等，也可以通过日志去分析请求的情况，当然也可以通过我们前面介绍到的stub_status模块查看当前的连接情况，也可以对线上的业务进行压力测试(低峰期)，去了解当前这套系统能承担多少的请求和并发，已做好相应的评估。这个是我们做性能优化最先考虑的地方。</em></p>
<p><em>2.其次我们需要了解业务模式，虽然我们是做性能优化，但每一个性能的优化都是为业务所提供服务的，我们需要了解每个业务接口的类型，比如:电商网站中的抢购模式，这种情况下面，平时没什么流量，但到了抢购时间流量会突增。我们还需要了解系统层次化的结构，比如: 我们使用Nginx做的是代理、还是动静分离、还是后端直接服务用户，那么这个就需要我们对每一层做好相应的梳理。以便更好的服务业务。</em></p>
<p><em>3.最后我们需要考虑性能与安全，往往注重了性能，但是忽略了安全。往往过于注重安全，性能又会产生影响。比如:我们在设计防火墙功能时，检测过于严密，这样就会给性能带来影响。那么如果对于性能完全追求，却不顾服务的安全，这个也会造成很大的隐患，所以需要评估好两者的关系，把握好两者的孰重孰轻。以及整体的相关性，权衡好对应的点。</em></p>
<h2 id="2-压力测试工具"><a href="#2-压力测试工具" class="headerlink" title="2.压力测试工具"></a>2.压力测试工具</h2><p><em>在系统业务量没有增长之前，我们就要做好相应的准备工作，已防患业务量徒增带来的接口压力，所以对于接口压力测试就显得非常重要了。我们首先要评估好系统压力，然后使用工具检测当前系统情况，是否能满足对应压力的需求。</em></p>
<p><em>1.安装ab压力测试工具</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@nginx</span>-lua ~]<span class="meta"># yum install httpd-tools -y</span></span><br></pre></td></tr></table></figure>
<p><em>2.了解压测工具使用方式</em></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-lua ~]# ab -n <span class="number">200</span> -c <span class="number">2</span> http:<span class="comment">//127.0.0.1/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#-n总的请求次数</span></span><br><span class="line"><span class="meta">#-c并发请求数</span></span><br><span class="line"><span class="meta">#-k是否开启长连接</span></span><br></pre></td></tr></table></figure>
<p><em>3.配置Nginx静态网站与tomcat动态网站环境</em></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]<span class="comment"># cat jsp.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">        server_name ab.oldboy.com;</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">        location / &#123;</span><br><span class="line">                root /code;</span><br><span class="line">                try_files $uri @java_page;</span><br><span class="line">                <span class="keyword">index</span> index.jsp index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        location @java_page&#123;</span><br><span class="line">                proxy_pass http:<span class="regexp">//</span><span class="number">172.16</span>.<span class="number">1.7</span>:<span class="number">8080</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#分别给Nginx准备静态网站</span></span><br><span class="line">[root@web01 ~]<span class="comment"># cat /code/bgx.html </span></span><br><span class="line">Nginx Ab Load</span><br><span class="line"></span><br><span class="line"><span class="comment">#给Tomcat准备静态网站文件</span></span><br><span class="line">[root@web01 ROOT]<span class="comment"># cat /soft/tomcat-8080/webapps/ROOT/bgx.html </span></span><br><span class="line">Tomcat Ab Load</span><br></pre></td></tr></table></figure>
<p><em>4.使用ab工具进行压力测试</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#总请求2000，同时并发2</span></span><br><span class="line"><span class="string">[root@Nginx</span> <span class="string">conf.d]#</span> <span class="string">ab</span> <span class="string">-n2000</span> <span class="string">-c2</span>  <span class="string">http://127.0.0.1/bgx.html</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">Server Software:</span>        <span class="string">nginx/1.12.2</span></span><br><span class="line"><span class="attr">Server Hostname:</span>        <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">Server Port:</span>            <span class="number">80</span></span><br><span class="line"><span class="attr">Document Path:</span>          <span class="string">/bgx.html</span></span><br><span class="line"><span class="attr">Document Length:</span>        <span class="number">19</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">Concurrency Level:</span>      <span class="number">200</span></span><br><span class="line"><span class="attr">Time taken for tests:</span>   <span class="number">1.013</span> <span class="string">seconds</span>   <span class="comment"># 总花费总时长</span></span><br><span class="line"><span class="attr">Complete requests:</span>      <span class="number">2000</span>            <span class="comment"># 总请求数</span></span><br><span class="line"><span class="attr">Failed requests:</span>        <span class="number">0</span>               <span class="comment"># 请求失败数</span></span><br><span class="line"><span class="attr">Write errors:</span>           <span class="number">0</span></span><br><span class="line"><span class="attr">Total transferred:</span>      <span class="number">510000</span> <span class="string">bytes</span>    <span class="comment"># 总传输大小</span></span><br><span class="line"><span class="attr">HTML transferred:</span>       <span class="number">38000</span> <span class="string">bytes</span>     <span class="comment"># 页面传输大小</span></span><br><span class="line"><span class="attr">Requests per second:</span>    <span class="number">9333.23</span> <span class="string">[#/sec]</span> <span class="string">(mean)</span>  <span class="comment"># 每秒多少请求/s(总请求出/总共完成的时间)</span></span><br><span class="line"><span class="attr">Time per request:</span>       <span class="number">101.315</span> <span class="string">[ms]</span> <span class="string">(mean)</span> <span class="comment"># 客户端访问服务端, 单个请求所需花费的时间</span></span><br><span class="line"><span class="attr">Time per request:</span>       <span class="number">0.507</span> <span class="string">[ms]</span> <span class="string">(mean,</span> <span class="string">across</span> <span class="string">all</span> <span class="string">concurrent</span> <span class="string">requests)</span>   <span class="comment"># 服务端处理请求的时间</span></span><br><span class="line"><span class="attr">Transfer rate:</span>          <span class="number">491.58</span> <span class="string">[Kbytes/sec]</span> <span class="string">received</span>    <span class="comment"># 判断网络传输速率, 观察网络是否存在瓶颈</span></span><br></pre></td></tr></table></figure>
<p><em>5.将nginx下的bgx.html文件移走，再次压测会由tomcat服务进行解析返回</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Concurrency Level:</span>      <span class="number">200</span></span><br><span class="line"><span class="attr">Time taken for tests:</span>   <span class="number">1.028</span> <span class="string">seconds</span></span><br><span class="line"><span class="attr">Complete requests:</span>      <span class="number">2000</span></span><br><span class="line"><span class="attr">Failed requests:</span>        <span class="number">0</span></span><br><span class="line"><span class="attr">Write errors:</span>           <span class="number">0</span></span><br><span class="line"><span class="attr">Total transferred:</span>      <span class="number">510000</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">HTML transferred:</span>       <span class="number">38000</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">Requests per second:</span>    <span class="number">1945.09</span> <span class="string">[#/sec]</span> <span class="string">(mean)</span></span><br><span class="line"><span class="attr">Time per request:</span>       <span class="number">102.823</span> <span class="string">[ms]</span> <span class="string">(mean)</span></span><br><span class="line"><span class="attr">Time per request:</span>       <span class="number">0.514</span> <span class="string">[ms]</span> <span class="string">(mean,</span> <span class="string">across</span> <span class="string">all</span> <span class="string">concurrent</span> <span class="string">requests)</span></span><br><span class="line"><span class="attr">Transfer rate:</span>          <span class="number">484.37</span> <span class="string">[Kbytes/sec]</span> <span class="string">received</span></span><br></pre></td></tr></table></figure>
<h6 id="了解影响性能指标"><a href="#了解影响性能指标" class="headerlink" title="了解影响性能指标"></a><strong>了解影响性能指标</strong></h6><p><img src="/2025/04/08/nginx高级/1551715068138.png" alt="1551715068138"></p>
<p><em>每个服务与服务之间都或多或少有一些关联, 我们需要将整个架构进行分层, 找到对应系统或服务的短板, 然后进行优化</em> </p>
<h2 id="3-系统性能优化"><a href="#3-系统性能优化" class="headerlink" title="3.系统性能优化"></a>3.系统性能优化</h2><p><em>文件句柄, Linux一切皆文件，文件句柄可以理解为就是一个索引，文件句柄会随着我们进程的调用频繁增加，系统默认文件句柄是有限制的，不能让一个进程无限的调用，所以我们需要限制每个进程和每个服务使用多大的文件句柄，文件句柄也是必须要调整的优化参数。文件句柄的设置方式，1.系统全局性修改。2.用户局部性修改。3.进程局部性修改</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@nginx</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">/etc/security/limits.conf</span></span><br><span class="line"><span class="comment">#针对root用户，soft仅提醒，hard限制，nofile打开最大文件数</span></span><br><span class="line"><span class="string">root</span> <span class="string">soft</span> <span class="string">nofile</span> <span class="number">65535</span></span><br><span class="line"><span class="string">root</span> <span class="string">hard</span> <span class="string">nofile</span> <span class="number">65535</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># *代表所有用户</span></span><br><span class="line"><span class="string">*</span> <span class="string">soft</span> <span class="string">nofile</span> <span class="number">25535</span></span><br><span class="line"><span class="string">*</span> <span class="string">hard</span> <span class="string">nofile</span> <span class="number">25535</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#针对Nginx进程</span></span><br><span class="line"><span class="string">worker_rlimit_nofile</span> <span class="number">65535</span><span class="string">;</span></span><br></pre></td></tr></table></figure>
<h2 id="4-代理服务优化"><a href="#4-代理服务优化" class="headerlink" title="4.代理服务优化"></a>4.代理服务优化</h2><p><em>通常Nginx作为代理服务，负责转发用户的请求，那么在转发的过程中建议开启HTTP长连接，用于减少握手次数，降低服务器损耗。</em><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20va2FiaS9wLzcxMjMzNTQuaHRtbA==" title="https://www.cnblogs.com/kabi/p/7123354.html">upstream keepalive说明<i class="fa fa-external-link"></i></span></p>
<p><em>1.长连接语法示例,(应用层面优化)</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Syntax:</span> <span class="string">keepalive</span> <span class="string">connections;</span></span><br><span class="line"><span class="attr">Default:</span> <span class="string">—</span></span><br><span class="line"><span class="attr">Context:</span> <span class="string">upstream</span></span><br><span class="line"><span class="string">This</span> <span class="string">directive</span> <span class="string">appeared</span> <span class="string">in</span> <span class="string">version</span> <span class="number">1.1</span><span class="number">.4</span><span class="string">.</span></span><br></pre></td></tr></table></figure>
<p><em>2.配置Nginx代理服务使用长连接方式</em></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream http_backend &#123;</span><br><span class="line">    server 127.0.0.1<span class="function">:8080</span>;</span><br><span class="line">    keepalive 16;   <span class="comment">#长连接</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    location <span class="string">/http/</span> &#123;</span><br><span class="line">        proxy_pass http:<span class="string">//http_backend</span>;</span><br><span class="line">        proxy_http_<span class="keyword">version</span> 1.1;         <span class="comment">#对于http协议应该指定为1.1</span></span><br><span class="line">        proxy_<span class="keyword">set</span>_header Connection <span class="string">""</span>; <span class="comment">#清除“connection”头字段</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>3.对于fastcgi服务器，需要设置fastcgi_keep_conn以便保持长连接</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream fastcgi_backend &#123;</span><br><span class="line">   <span class="built_in"> server </span>127.0.0.1:9000;</span><br><span class="line">    keepalive 8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="built_in">..</span>.</span><br><span class="line">    location /fastcgi/ &#123;</span><br><span class="line">        fastcgi_pass fastcgi_backend;</span><br><span class="line">        fastcgi_keep_conn on;</span><br><span class="line">        <span class="built_in">..</span>.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>4.keepalive_requests设置通过一个keepalive连接提供的最大请求数。在发出最大请求数后，将关闭连接。</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span>: keepalive_requests number;</span><br><span class="line"><span class="attribute">Default</span>: keepalive_requests 100;</span><br><span class="line"><span class="attribute">Context</span>: upstream</span><br><span class="line"></span><br><span class="line">#该指令出现在1.15.3版中。</span><br></pre></td></tr></table></figure>
<p><em>5.keepalive_timeout设置超时，在此期间与代理服务器的空闲keepalive连接将保持打开状态。</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Syntax:</span> keepalive_timeout timeout<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> keepalive_timeout <span class="number">60</span>s<span class="comment">;</span></span><br><span class="line"><span class="symbol">Context:</span> upstream</span><br><span class="line"><span class="meta">#该指令出现在1.15.3版中。</span></span><br></pre></td></tr></table></figure>
<p><em>注意:1.scgi和uwsgi协议没有保持连接的概念。2.但无论是proxy、fastcgi、uwsgi协议都有cache缓存的功能，开启后可加速网站访问的效率。</em></p>
<h2 id="5-静态资源优化"><a href="#5-静态资源优化" class="headerlink" title="5.静态资源优化"></a>5.静态资源优化</h2><p><em>Nginx作为静态资源Web服务器，用于静态资源处理，传输非常的高效</em></p>
<p><img src="http://cdn.xuliangwei.com/15135014773236.jpg" alt="img"></p>
<p><em>静态资源指的是，非WEB服务器端运行处理而生成的文件</em></p>
<table>
<thead>
<tr>
<th>静态资源类型</th>
<th>种类</th>
</tr>
</thead>
<tbody>
<tr>
<td>浏览器渲染</td>
<td>HTML、CSS、JS</td>
</tr>
<tr>
<td>图片文件</td>
<td>JPEG、GIF、PNG</td>
</tr>
<tr>
<td>视频文件</td>
<td>FLV、Mp4、AVI</td>
</tr>
<tr>
<td>其他文件</td>
<td>TXT、DOC、PDF、…</td>
</tr>
</tbody>
</table>
<h3 id="5-1-静态资源缓存"><a href="#5-1-静态资源缓存" class="headerlink" title="5.1.静态资源缓存"></a>5.1.静态资源缓存</h3><p><em>浏览器缓存设置用于提高网站性能，尤其是新闻网站, 图片一旦发布，改动的可能是非常小的。所以我们希望能否用户访问一次后，图片缓存在用户的浏览器长时间缓存。浏览器是有自己的缓存机制，它是基于HTTP协议缓存机制来实现的，在HTTP协议中有很多头信息，那么实现浏览器的缓存就需要依赖特殊的头信息来与服务器进行特殊的验证，如: Expires (http/1.0) ； Cache-control (http/1.1)。</em><span class="exturl" data-url="aHR0cDovL3d3dy53ZWIzLnhpbi9jb2RlLzE3NjMuaHRtbA==" title="http://www.web3.xin/code/1763.html">Nginx静态资源缓存参考<i class="fa fa-external-link"></i></span></p>
<p><em>1.浏览器无缓存</em><br><img src="http://cdn.xuliangwei.com/15437571296661.jpg" alt="img"></p>
<p><em>2.浏览器有缓存</em><br><img src="http://cdn.xuliangwei.com/15437571977645.jpg" alt="img"></p>
<p><em>3.浏览器缓存过期校验检查机制，说明如下:</em><br><em>1.浏览器请求服务器会先进行Expires、Cache-Control的检查，检查缓存是否过期，如果没有过期则直接从缓存文件中读取。2.如果缓存过期，首先检查是否存在etag，如果存在则会客户端会向web服务器请求if-None-Match，与etag值进行比对，由服务器决策返回200还是304。3.如果etag不存在，则进行last-Modified检查，客户端会向web服务器请求If-Modified-Since，与last-Modified进行比对，由服务器决策返回200还是304。</em><br><img src="http://cdn.xuliangwei.com/15501103467175.jpg" alt="img"></p>
<p><em>4.如何配置静态资源缓存expires</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#作用: 添加Cache-Control Expires头</span></span><br><span class="line"><span class="symbol">Syntax:</span> expires [modified] time<span class="comment">;</span></span><br><span class="line">expires epoch | max | off<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> expires off<span class="comment">;</span></span><br><span class="line"><span class="symbol">Context:</span> http, server, location, if <span class="keyword">in</span> location</span><br></pre></td></tr></table></figure>
<p><em>5.配置静态资源缓存场景</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> static.bgx.com;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ .*\.(jpg|gif|png)$</span> &#123;</span><br><span class="line">        <span class="attribute">expires</span>      <span class="number">7d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>6.如果开发代码没有正式上线时, 希望静态文件不被缓存</em></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#取消js css html等静态文件缓存</span></span><br><span class="line">location ~ .<span class="symbol">*</span>\.(css|<span class="string">js</span>|<span class="string">swf</span>|<span class="string">json</span>|<span class="string">mp4</span>|<span class="string">htm</span>|<span class="string">html)$ &#123;</span></span><br><span class="line"><span class="string">    add_header Cache-Control no-store;</span></span><br><span class="line"><span class="string">    add_header Pragma no-cache;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-2-静态资源读取"><a href="#5-2-静态资源读取" class="headerlink" title="5.2.静态资源读取"></a>5.2.静态资源读取</h3><p><em>1.文件读取高效sendfile，如下图</em></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: sendfile <span class="keyword">on</span> | <span class="keyword">off</span>;</span><br><span class="line"><span class="keyword">Default</span>: sendfile <span class="keyword">off</span>;</span><br><span class="line">Context: http, server, location, <span class="keyword">if</span> <span class="keyword">in</span> location</span><br></pre></td></tr></table></figure>
<p><img src="http://cdn.xuliangwei.com/15501550306679.jpg" alt="img"><br><em>传统读取文件方式 VS sendfile读取文件方式</em></p>
<p><em>2.将多个包一次发送，用于提升网络传输效率，大文件推荐打开，需要开启sendfile才行</em></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: tcp_nopush <span class="keyword">on</span> | <span class="keyword">off</span>;</span><br><span class="line"><span class="keyword">Default</span>: tcp_nopush <span class="keyword">off</span>;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>
<p><em>3.提高网络传输实时性，需要开启keepalive</em></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: tcp_nodelay <span class="keyword">on</span> | <span class="title">off</span>;</span><br><span class="line">Default: tcp_nodelay <span class="keyword">on</span>;</span><br><span class="line">Context: <span class="keyword">http</span>, server, location</span><br></pre></td></tr></table></figure>
<h3 id="5-3-静态资源压缩"><a href="#5-3-静态资源压缩" class="headerlink" title="5.3.静态资源压缩"></a>5.3.静态资源压缩</h3><p><em>Nginx将响应报文发送至客户端之前启用压缩功能，然后进行传输，这能够有效地节约带宽，并提高响应至客户端的速度。</em><br><img src="http://cdn.xuliangwei.com/15239378783506.jpg" alt="img"></p>
<p><em>1.gzip传输压缩，传输前压缩，传输后解压</em></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: gzip <span class="keyword">on</span> | <span class="keyword">off</span>;</span><br><span class="line"><span class="keyword">Default</span>: gzip <span class="keyword">off</span>;</span><br><span class="line">Context: http, server, location, <span class="keyword">if</span> <span class="keyword">in</span> location</span><br></pre></td></tr></table></figure>
<p><em>2.gzip压缩哪些类型的文件</em></p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: gzip_types mime-<span class="keyword">type</span> ...;</span><br><span class="line"><span class="keyword">Default</span>: gzip_types <span class="literal">text</span>/html;</span><br><span class="line"><span class="keyword">Context</span>: http, server, location</span><br></pre></td></tr></table></figure>
<p><em>3.gzip压缩比率，加快传输，但压缩本身比较耗费服务端性能</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Syntax:</span> <span class="string">gzip_comp_level</span> <span class="string">level;</span></span><br><span class="line"><span class="attr">Default:</span> <span class="string">gzip_comp_level</span> <span class="number">1</span><span class="string">;</span></span><br><span class="line"><span class="attr">Context:</span> <span class="string">http,</span> <span class="string">server,</span> <span class="string">location</span></span><br></pre></td></tr></table></figure>
<p><em>4.gzip压缩协议版本，压缩使用在http哪个协议, 主流选择1.1版本</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Syntax:</span> <span class="string">gzip_http_version</span> <span class="number">1.0</span> <span class="string">|</span> <span class="number">1.1</span><span class="string">;</span></span><br><span class="line"><span class="attr">Default:</span> <span class="string">gzip_http_version</span> <span class="number">1.1</span><span class="string">;</span></span><br><span class="line"><span class="attr">Context:</span> <span class="string">http,</span> <span class="string">server,</span> <span class="string">location</span></span><br></pre></td></tr></table></figure>
<p><em>4.静态图片配置压缩案例</em></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx conf.d]<span class="comment"># mkdir -p /soft/code/images</span></span><br><span class="line">[root@Nginx conf.d]<span class="comment"># cat static_server.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name static.oldboy.com;</span><br><span class="line"></span><br><span class="line">    location ~*  .*\.(jpg|gif|png)$ &#123;</span><br><span class="line">        root /code/images;</span><br><span class="line">        gzip <span class="keyword">on</span>;</span><br><span class="line">        gzip_http_version <span class="number">1.1</span>;</span><br><span class="line">        gzip_comp_level <span class="number">2</span>;</span><br><span class="line">        gzip_types <span class="built_in">text</span>/plain <span class="built_in">application</span>/json <span class="built_in">application</span>/x-javascript <span class="built_in">application</span>/css <span class="built_in">application</span>/xml <span class="built_in">application</span>/xml+rss <span class="built_in">text</span>/javascript <span class="built_in">application</span>/x-httpd-php image/jpeg image/gif image/png;</span><br><span class="line">                </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>5.测试没有开启gzip图片压缩</em><br><img src="http://cdn.xuliangwei.com/15238172798743.jpg" alt="img"><br><em>6.启用gzip压缩图片后(由于图片之前压缩过, 所以压缩比率不太明显)</em><br><img src="http://cdn.xuliangwei.com/15238174255523.jpg" alt="img"></p>
<p><em>7.文件压缩案例</em></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx conf.d]<span class="comment"># mkdir -p /soft/code/doc</span></span><br><span class="line">[root@Nginx conf.d]<span class="comment"># cat static_server.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name static.oldboy.com;</span><br><span class="line">    sendfile <span class="keyword">on</span>;</span><br><span class="line">    location ~ .*\.(txt|xml)$ &#123;</span><br><span class="line">        gzip <span class="keyword">on</span>;</span><br><span class="line">        gzip_http_version <span class="number">1.1</span>;</span><br><span class="line">        gzip_comp_level <span class="number">1</span>;</span><br><span class="line">        gzip_types <span class="built_in">text</span>/plain <span class="built_in">application</span>/json <span class="built_in">application</span>/x-javascript <span class="built_in">application</span>/css <span class="built_in">application</span>/xml <span class="built_in">application</span>/xml+rss <span class="built_in">text</span>/javascript <span class="built_in">application</span>/x-httpd-php image/jpeg image/gif image/png;</span><br><span class="line">        root /code/doc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有启用<code>gzip</code>文件压缩<br><img src="http://cdn.xuliangwei.com/15238178566448.jpg" alt="img"><br>启用<code>gzip</code>压缩文件<br><img src="http://cdn.xuliangwei.com/15238178751169.jpg" alt="img"></p>
<h3 id="5-4-防止资源盗链"><a href="#5-4-防止资源盗链" class="headerlink" title="5.4.防止资源盗链"></a>5.4.防止资源盗链</h3><p><em>防盗链，指的是防止资源被其他网站恶意盗用，</em></p>
<p><em>基础防盗链设置思路: 主要是针对客户端请求过程中所携带的一些Header信息来验证请求的合法性，比如客户端在请求的过程中都会携带referer信息(referer会告诉服务器我是丛哪一个页面过来的)。优点是规则简单，配置和使用都很方便，缺点是防盗链所依赖的Referer验证信息是可以伪造的，所以通过Referer信息防盗链并非100%可靠， 但是它能够限制大部分的盗链情况。</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span>: valid_referers none | blocked | server_names | string ...;</span><br><span class="line"><span class="attribute">Default</span>: —</span><br><span class="line"><span class="attribute">Context</span>: server, location</span><br><span class="line"></span><br><span class="line">#none: Referer来源头部为空的情况</span><br><span class="line">#blocked: Referer来源头部不为空，这些值都不以http://或者https://开头</span><br><span class="line">#server_names: 来源头部包含当前的域名,可以正则匹配</span><br></pre></td></tr></table></figure>
<p><em>1.在盗链服务器上准备html文件,偷取fj.xuliangwei.com网站上的图片</em></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# cat /code/referer_test.html</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>oldboyedu.com<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"background-color:red;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://fj.xuliangwei.com/public/tt.jpeg"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>2.使用浏览器能正常访问到偷链的资源</em><br><img src="http://cdn.xuliangwei.com/15501375442639.jpg" alt="img"><br><em>3.在kt.xuliangwei.com服务器上启动基于防盗链</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ .*\.(jpg||jpeg|gif|png)$</span> &#123;</span><br><span class="line">    <span class="comment">##指定合法的来源referer，这个变量被设置为0，否则设置为1</span></span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> www.xuliangwei.com;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>以上配置含义表示: 所有来自xuliangwei.com都可以访问到当前站点的图片，如果来源域名不在这个列表中，那么$invalid_referer等于1，在if语句中返回一个403给用户， 这样用户便会看到一个403的页面</em></p>
<p><em>4.使用浏览器验证会发现恶意的来源网站已经无法正常盗链</em><br><img src="http://cdn.xuliangwei.com/15501377714379.jpg" alt="img"></p>
<p><em>5.如果不使用return 403而使用rewrite，那么盗链图片会返回一个ks.jpeg给用户</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ .*\.(jpg||jpeg|gif|png)$</span> &#123;</span><br><span class="line">        <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> <span class="regexp">*.xuliangwei.com</span>;</span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">                <span class="attribute">rewrite</span><span class="regexp"> ^(.*)$</span> /public/ks.jpeg <span class="literal">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>6.验证rewrite的效果</em><br><img src="http://cdn.xuliangwei.com/15501389407353.jpg" alt="img"></p>
<p><em>7.如果希望某些网站能够使用（盗链）资源</em></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~* \.(gif|jpg|png|bmp)$</span> &#123;</span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> <span class="regexp">*.xuliangwei.com</span> server_names ~\.google\. ~\.baidu\.;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>8.当然这种防护并不能百分百保证资源被盗链，因为我们可以通过命令修改来源的refrer信息。</em></p>
<h3 id="5-5-允许跨域访问"><a href="#5-5-允许跨域访问" class="headerlink" title="5.5.允许跨域访问"></a>5.5.允许跨域访问</h3><p><em>什么是跨站访问，当我们通过浏览器访问a网站时，同时会利用到ajax或其他方式，同时也请求b网站，这样的话就出现了请求一个页面，使用了2个域名，这种方式对浏览器来说默认是禁止。</em><br><img src="http://cdn.xuliangwei.com/15238200686278.jpg" alt="img"></p>
<p><em>那Nginx允许跨站访问与浏览器有什么关系呢，因为浏览器会读取Access-Control-Allow-Origin的头信息，如果服务端允许，则浏览器不会进行拦截。</em></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Syntax:</span> add_header name value [always]<span class="comment">;</span></span><br><span class="line"><span class="symbol">Default:</span> —</span><br><span class="line"><span class="symbol">Context:</span> http, server, location, if <span class="keyword">in</span> location</span><br></pre></td></tr></table></figure>
<p><em>1.在down.xuliangwei.com网站上准备跨站访问的文件</em></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# cat /code/http_origin.html </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试ajax和跨域访问<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.1.4/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">        type: <span class="string">"GET"</span>,</span></span><br><span class="line"><span class="actionscript">        url: <span class="string">"http://fj.xuliangwei.com/public/tt.html"</span>,</span></span><br><span class="line"><span class="actionscript">        success: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                alert(<span class="string">"sucess!!!"</span>);</span></span><br><span class="line">        &#125;,</span><br><span class="line"><span class="actionscript">        error: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                alert(<span class="string">"fail!!,请刷新再试!"</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试跨域访问<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>2.通过浏览器测试，该跨站操作一定会被拒绝</em><br><img src="http://cdn.xuliangwei.com/15501542901544.jpg" alt="img"></p>
<p><em>3.我们在fj.xuliangwei.com的Nginx上配置允许跨域访问</em></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx <span class="keyword">conf</span>.<span class="keyword">d</span>]# <span class="keyword">cat</span> fj.xuliangwei.com.<span class="keyword">conf</span> </span><br><span class="line">location ~ .*\.(html|htm)$ &#123;</span><br><span class="line">    add_header Access-Control-Allow-Origin http:<span class="comment">//down.xuliangwei.com;</span></span><br><span class="line">    add_header Access-Control-Allow-Methods GET,<span class="keyword">POST</span>,PUT,DELETE,OPTIONS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>4.再次通过浏览器访问，已经能实现跨域访问请求</em><br><img src="http://cdn.xuliangwei.com/15501544412616.jpg" alt="img"></p>
<h3 id="5-6-CPU亲和配置"><a href="#5-6-CPU亲和配置" class="headerlink" title="5.6.CPU亲和配置"></a>5.6.CPU亲和配置</h3><p><em>CPU亲和(affinity)减少进程之间不断频繁切换，减少性能损耗，其实现原理是将CPU核心和Nginx工作进程绑定方式，把每个worker进程固定对应的cpu上执行，减少切换cpu的cache miss，获得更好的性能。</em></p>
<p><img src="http://cdn.xuliangwei.com/15134382581864.jpg" alt="img"></p>
<p><em>1.查看当前CPU物理状态</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@nginx</span> <span class="string">~]#</span> <span class="string">lscpu</span> <span class="string">|grep</span> <span class="string">"CPU(s)"</span></span><br><span class="line"><span class="string">CPU(s):</span>                <span class="number">24</span></span><br><span class="line"><span class="string">On-line</span> <span class="string">CPU(s)</span> <span class="attr">list:</span>   <span class="number">0</span><span class="number">-23</span></span><br><span class="line"><span class="string">NUMA</span> <span class="string">node0</span> <span class="string">CPU(s):</span>     <span class="number">0</span><span class="string">,2,4,6,8,10,12,14,16,18,20,22</span></span><br><span class="line"><span class="string">NUMA</span> <span class="string">node1</span> <span class="string">CPU(s):</span>     <span class="number">1</span><span class="string">,3,5,7,9,11,13,15,17,19,21,23</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#本次演示服务器为两颗物理cpu，每颗物理CPU12个核心, 总共有24个核心</span></span><br></pre></td></tr></table></figure>
<p><em>2.将Nginx worker进程绑至不同的核心上，官方建议与cpu的核心保持一致</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一种绑定组合方式</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="number">24</span><span class="string">;</span></span><br><span class="line"><span class="string">worker_cpu_affinity</span> <span class="number">000000000001</span> <span class="number">000000000010</span> <span class="number">000000000100</span> <span class="number">000000001000</span> <span class="number">000000010000</span> <span class="number">000000100000</span> <span class="number">000001000000</span> <span class="number">000010000000</span> <span class="number">000100000000</span> <span class="number">001000000000</span> <span class="number">010000000000</span> <span class="number">10000000000</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种方式(使用较少)</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="number">2</span><span class="string">;</span></span><br><span class="line"><span class="string">worker_cpu_affinity</span> <span class="number">101010101010</span> <span class="number">010101010101</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最佳方式绑定方式</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="string">auto;</span></span><br><span class="line"><span class="string">worker_cpu_affinity</span> <span class="string">auto;</span></span><br></pre></td></tr></table></figure>
<p>3.查看<code>nginx worker</code>进程绑定至对应<code>cpu</code></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -eo pid,<span class="keyword">args</span>,psr|<span class="keyword">grep</span> [n]ginx</span><br></pre></td></tr></table></figure>
<h3 id="5-7-通用优化配置"><a href="#5-7-通用优化配置" class="headerlink" title="5.7.通用优化配置"></a>5.7.通用优化配置</h3><p><em>Nginx优化总结，Nginx通用优化配置文件</em></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># cat nginx.conf</span></span><br><span class="line">user www;                   <span class="comment"># nginx进程启动用户</span></span><br><span class="line">worker_processes auto;      <span class="comment">#与cpu核心一致即可</span></span><br><span class="line">worker_cpu_affinity auto;   <span class="comment"># cpu亲和</span></span><br><span class="line">error_log /var/<span class="built_in">log</span>/nginx/<span class="keyword">error</span>.<span class="built_in">log</span> warn;    <span class="comment"># 错误日志</span></span><br><span class="line">pid /<span class="built_in">run</span>/nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile <span class="number">35535</span>;     <span class="comment">#每个work能打开的文件描述符，调整至1w以上,负荷较高建议2-3w</span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;                  <span class="comment"># 使用epoll高效网络模型</span></span><br><span class="line">    worker_connections <span class="number">10240</span>;   <span class="comment"># 限制每个进程能处理多少个连接，10240x[cpu核心]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include             mime.types;</span><br><span class="line">    default_type        <span class="built_in">application</span>/octet-stream;</span><br><span class="line">    charset utf<span class="number">-8</span>;      <span class="comment"># 统一使用utf-8字符集</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义日志格式</span></span><br><span class="line">    log_format  main  '$remote_addr - $remote_user [$time_local] <span class="string">"$request"</span> '</span><br><span class="line">                      '$status $body_bytes_sent <span class="string">"$http_referer"</span> '</span><br><span class="line">                      '<span class="string">"$http_user_agent"</span> <span class="string">"$http_x_forwarded_for"</span>';</span><br><span class="line">    </span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.<span class="built_in">log</span>  main;    <span class="comment"># 访问日志</span></span><br><span class="line">    </span><br><span class="line">    server_tokens off;  <span class="comment"># 禁止浏览器显示nginx版本号</span></span><br><span class="line">    client_max_body_size <span class="number">200</span>m;  <span class="comment"># 文件上传大小限制调整</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 文件高效传输，静态资源服务器建议打开</span></span><br><span class="line">    sendfile            <span class="keyword">on</span>;</span><br><span class="line">    tcp_nopush          <span class="keyword">on</span>;</span><br><span class="line">    <span class="comment"># 文件实时传输，动态资源服务建议打开,需要打开keepalived</span></span><br><span class="line">    tcp_nodelay         <span class="keyword">on</span>;</span><br><span class="line">    keepalive_timeout   <span class="number">65</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Gzip 压缩</span></span><br><span class="line">    gzip <span class="keyword">on</span>;</span><br><span class="line">    gzip_disable <span class="string">"MSIE [1-6]\."</span>;</span><br><span class="line">    gzip_http_version <span class="number">1.1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 虚拟主机</span></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Nginx安全与优化总结</strong><br><em>1.cpu亲和、worker进程数、调整每个worker进程打开的文件数2.使用epool网络模型、调整每个worker进程的最大连接数3.文件的高效读取sendfile、nopush、4.文件的传输实时性、nodealy5.开启tcp长链接、以及长链接超时时间keepalived6.开启文件传输压缩gzip7.开启静态文件expires缓存8.隐藏Nginx的版本号9.禁止通过IP地址访问,禁止恶意域名解析,只允许域名访问10.配置放盗链、以及跨域访问11.防DDOS、cc攻击, 限制单IP并发连接，以及http请求12.优雅限制nginx错误页面13.nginx加密传输https优化14.nginx proxy_cache、fastcgi_cache、uwsgi_cache缓存</em></p>
<h2 id="6-PHP服务优化"><a href="#6-PHP服务优化" class="headerlink" title="6.PHP服务优化"></a>6.PHP服务优化</h2><p><em>1.php程序配置管理文件/etc/php.ini，主要调整日志、文件上传、禁止危险函数、关闭版本号显示、等</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#;;;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment"># Error  logging ;  #错误日志设置</span></span><br><span class="line"><span class="comment">#;;;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="attr">expose_php</span> = <span class="literal">Off</span>                        <span class="comment"># 关闭php版本信息</span></span><br><span class="line"><span class="attr">display_error</span> = <span class="literal">Off</span>                     <span class="comment"># 屏幕不显示错误日志</span></span><br><span class="line"><span class="attr">error_reporting</span> = E_ALL                 <span class="comment"># 记录PHP的每个错误</span></span><br><span class="line"><span class="attr">log_errors</span> = <span class="literal">On</span>                         <span class="comment"># 开启错误日志</span></span><br><span class="line"><span class="attr">error_log</span> = /var/log/php_error.log      <span class="comment"># 错误日志写入的位置</span></span><br><span class="line"><span class="attr">date.timezone</span> = Asia/Shanghai           <span class="comment"># 调整时区,默认PRC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment"># File Uploads ;    #文件上传设置</span></span><br><span class="line"><span class="comment">#;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="attr">file_uploads</span> = <span class="literal">On</span>           <span class="comment"># 允许文件上传</span></span><br><span class="line"><span class="attr">upload_max_filesize</span> = <span class="number">300</span>M  <span class="comment"># 允许上传文件的最大大小</span></span><br><span class="line"><span class="attr">post_max_size</span> = <span class="number">300</span>M        <span class="comment"># 允许客户端单个POST请求发送的最大数据</span></span><br><span class="line"><span class="attr">max_file_uploads</span> = <span class="number">20</span>       <span class="comment"># 允许同时上传的文件的最大数量</span></span><br><span class="line"><span class="attr">memory_limit</span> = <span class="number">128</span>M         <span class="comment"># 每个脚本执行最大内存</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php禁止危险函数执行</span></span><br><span class="line"><span class="attr">disable_functions</span> = chown,chmod,pfsockopen,phpinfo</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3VuaXh0ZWNoL2FydGljbGUvZGV0YWlscy81Mzc2MTgzMg==" title="https://blog.csdn.net/unixtech/article/details/53761832">php危险函数禁用参考列表<i class="fa fa-external-link"></i></span></p>
<p><em>2.php-fpm进程管理配置文件/etc/php-fpm.conf</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一部分，fpm配置</span></span><br><span class="line"><span class="comment">;include=etc/fpm.d/*.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#第二部分，全局配置</span></span><br><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="comment">;pid = /var/log/php-fpm/php-fpm.pid     #pid文件存放的位置</span></span><br><span class="line"><span class="comment">;error_log = /var/log/php-fpm/php-fpm.log   #错误日志存放的位置</span></span><br><span class="line"><span class="comment">;log_level = error  #日志级别, alert, error, warning, notice, debug</span></span><br><span class="line"><span class="attr">rlimit_files</span> = <span class="number">65535</span>     <span class="comment">#php-fpm进程能打开的文件数</span></span><br><span class="line"><span class="attr">events.mechanism</span> = epoll <span class="comment">#使用epoll事件模型处理请求</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#第三部分，进程池定义</span></span><br><span class="line"><span class="section">[www]</span>       <span class="comment">#池名称</span></span><br><span class="line"><span class="attr">user</span> = www  <span class="comment">#进程运行的用户</span></span><br><span class="line"><span class="attr">group</span> = www <span class="comment">#进程运行的组</span></span><br><span class="line"><span class="comment">;listen = /dev/shm/php-fpm.sock #监听在本地socket文件</span></span><br><span class="line"><span class="attr">listen</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>         <span class="comment">#监听在本地tcp的9000端口</span></span><br><span class="line"><span class="comment">;listen.allowed_clients = 127.0.0.1 #允许访问FastCGI进程的IP，any不限制 </span></span><br><span class="line"></span><br><span class="line"><span class="attr">pm</span> = dynamic                    <span class="comment">#动态调节php-fpm的进程数</span></span><br><span class="line"><span class="attr">pm.max_children</span> = <span class="number">512</span>           <span class="comment">#最大启动的php-fpm进程数</span></span><br><span class="line"><span class="attr">pm.start_servers</span> = <span class="number">32</span>           <span class="comment">#初始启动的php-fpm进程数</span></span><br><span class="line"><span class="attr">pm.min_spare_servers</span> = <span class="number">32</span>       <span class="comment">#最少的空闲php-fpm进程数</span></span><br><span class="line"><span class="attr">pm.max_spare_servers</span> = <span class="number">64</span>       <span class="comment">#最大的空闲php-fpm进程数</span></span><br><span class="line"><span class="attr">pm.max_requests</span> = <span class="number">1500</span>          <span class="comment">#每一个进程能响应的请求数</span></span><br><span class="line"><span class="attr">pm.process_idle_timeout</span> = <span class="number">15</span>s<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#第四部分，日志相关</span></span><br><span class="line"><span class="attr">php_flag[display_errors]</span> = <span class="literal">off</span></span><br><span class="line"><span class="attr">php_admin_value[error_log]</span> = /var/log/phpfpm_error.log</span><br><span class="line"><span class="attr">php_admin_flag[log_errors]</span> = <span class="literal">on</span></span><br><span class="line"><span class="comment">#慢日志</span></span><br><span class="line"><span class="attr">request_slowlog_timeout</span> = <span class="number">5</span>s    <span class="comment">#php脚本执行超过5s的文件</span></span><br><span class="line"><span class="attr">slowlog</span> = /var/log/php_slow.log <span class="comment">#记录至该文件中</span></span><br></pre></td></tr></table></figure>
<p><em>3.php-fpm监控模块，用于监控php-fpm状态使用</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# vim /etc/php-fpm.d/www.conf</span><br><span class="line">pm.status_path = /phpfpm_status #开启php的状态页面</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改nginx配置</span></span><br><span class="line">[root@nginx conf.d]# cat /etc/nginx/conf.d/fpm.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name php.bgx.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.php;</span><br><span class="line">    &#125;</span><br><span class="line">    #新增如下配置</span><br><span class="line">    location /phpfpm_status &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>4.访问测试phpfpm_status状态页面</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@nginx</span> <span class="string">~]#</span> <span class="string">curl</span> <span class="string">http://127.0.0.1/phpfpm_status</span></span><br><span class="line"><span class="attr">pool:</span>                 <span class="string">www</span>           <span class="comment">#fpm池名称,大多数为www</span></span><br><span class="line"><span class="attr">process manager:</span>      <span class="string">dynamic</span>       <span class="comment">#动态管理phpfpm进程</span></span><br><span class="line"><span class="attr">start time:</span>           <span class="number">05</span><span class="string">/Jul/2016</span>   <span class="comment">#启动时间，如果重启会发生变化</span></span><br><span class="line"><span class="attr">start since:</span>          <span class="number">409</span>           <span class="comment">#php-fpm运行时间</span></span><br><span class="line"><span class="attr">accepted conn:</span>        <span class="number">22</span>            <span class="comment">#当前池接受的连接数</span></span><br><span class="line"><span class="attr">listen queue:</span>         <span class="number">0</span>     <span class="comment">#请求等待队列,如果这个值不为0,那么需要增加FPM的进程数量</span></span><br><span class="line"><span class="attr">max listen queue:</span>     <span class="number">0</span>     <span class="comment">#请求等待队列最高的数量</span></span><br><span class="line"><span class="attr">listen queue len:</span>     <span class="number">128</span>   <span class="comment">#请求等待队列的长度</span></span><br><span class="line"><span class="attr">idle processes:</span>       <span class="number">4</span>     <span class="comment">#php-fpm空闲的进程数量</span></span><br><span class="line"><span class="attr">active processes:</span>     <span class="number">1</span>     <span class="comment">#php-fpm活跃的进程数量</span></span><br><span class="line"><span class="attr">total processes:</span>      <span class="number">5</span>     <span class="comment">#php-fpm总的进程数量</span></span><br><span class="line"><span class="attr">max active processes:</span> <span class="number">2</span>     <span class="comment">#php-fpm最大活跃的进程数量(FPM启动开始计算)</span></span><br><span class="line"><span class="attr">max children reached:</span> <span class="number">0</span>     <span class="comment">#进程最大数量限制的次数，如果数量不为0，则说明phpfpm最大进程数量过小,可以适当调整。</span></span><br></pre></td></tr></table></figure>
<p><em>5.PHP-FPM配置文件 4核16G、4核32G</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@nginx ~]</span><span class="comment"># cat /etc/php-fpm.d/www.conf</span></span><br><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">pid</span> = /var/run/php-fpm.pid</span><br><span class="line"></span><br><span class="line"><span class="attr">error_log</span> = /var/log/php-fpm.log</span><br><span class="line"><span class="attr">log_level</span> = warning</span><br><span class="line"><span class="attr">rlimit_files</span> = <span class="number">655350</span></span><br><span class="line"><span class="attr">events.mechanism</span> = epoll</span><br><span class="line"></span><br><span class="line"><span class="section">[www]</span></span><br><span class="line"><span class="attr">user</span> = nginx</span><br><span class="line"><span class="attr">group</span> = nginx</span><br><span class="line"><span class="attr">listen</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span></span><br><span class="line"><span class="attr">listen.owner</span> = www</span><br><span class="line"><span class="attr">listen.group</span> = www</span><br><span class="line"><span class="attr">listen.mode</span> = <span class="number">0660</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">listen.allowed_clients</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">pm</span> = dynamic</span><br><span class="line"><span class="attr">pm.max_children</span> = <span class="number">512</span></span><br><span class="line"><span class="attr">pm.start_servers</span> = <span class="number">32</span></span><br><span class="line"><span class="attr">pm.min_spare_servers</span> = <span class="number">32</span></span><br><span class="line"><span class="attr">pm.max_spare_servers</span> = <span class="number">64</span></span><br><span class="line"><span class="attr">pm.process_idle_timeout</span> = <span class="number">15</span>s<span class="comment">;</span></span><br><span class="line"><span class="attr">pm.max_requests</span> = <span class="number">2048</span></span><br><span class="line"><span class="attr">pm.status_path</span> = /phpfpm_status</span><br><span class="line"></span><br><span class="line"><span class="comment">#php-www模块错误日志</span></span><br><span class="line"><span class="attr">php_flag[display_errors]</span> = <span class="literal">off</span></span><br><span class="line"><span class="attr">php_admin_value[error_log]</span> = /var/log/php/php-www.log</span><br><span class="line"><span class="attr">php_admin_flag[log_errors]</span> = <span class="literal">on</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#php慢查询日志</span></span><br><span class="line"><span class="attr">request_slowlog_timeout</span> = <span class="number">5</span>s</span><br><span class="line"><span class="attr">slowlog</span> = /var/log/php-slow.log</span><br></pre></td></tr></table></figure>
<h1 id="16-Nginx架构课程总结"><a href="#16-Nginx架构课程总结" class="headerlink" title="16.Nginx架构课程总结"></a>16.Nginx架构课程总结</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQ4NzE0Nzk5NDYyMS5odG1sI3RvY18w" title="http://docs.etiantian.org/15487147994621.html#toc_0">1.架构总结<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQ4NzE0Nzk5NDYyMS5odG1sI3RvY18x" title="http://docs.etiantian.org/15487147994621.html#toc_1">2.了解需求<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQ4NzE0Nzk5NDYyMS5odG1sI3RvY18y" title="http://docs.etiantian.org/15487147994621.html#toc_2">3.设计评估<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQ4NzE0Nzk5NDYyMS5odG1sI3RvY18z" title="http://docs.etiantian.org/15487147994621.html#toc_3">4.配置事项<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-架构总结"><a href="#1-架构总结" class="headerlink" title="1.架构总结"></a>1.架构总结</h2><p>当我们接手一套新的业务，需要去设计或配置中间件服务的时候，我们应该丛哪些地方去考虑。</p>
<h2 id="2-了解需求"><a href="#2-了解需求" class="headerlink" title="2.了解需求"></a>2.了解需求</h2><p><em>1.了解需求，了解对应好的需求，才能设计好合理的Nginx架构。2.设计评估，评估现有的资源、评估使用什么样的方式，评估后期的扩展3.配置注意事项。</em></p>
<h1 id="16-Nginx架构课程总结-1"><a href="#16-Nginx架构课程总结-1" class="headerlink" title="16.Nginx架构课程总结"></a>16.Nginx架构课程总结</h1><h2 id="1-架构总结-1"><a href="#1-架构总结-1" class="headerlink" title="1.架构总结"></a>1.架构总结</h2><p>当我们接手一套新的业务，需要去设计或配置中间件服务的时候，我们应该丛哪些地方去考虑。</p>
<h2 id="2-了解需求-1"><a href="#2-了解需求-1" class="headerlink" title="2.了解需求"></a>2.了解需求</h2><p><em>1.了解需求，了解对应好的需求，才能设计好合理的Nginx架构。2.设计评估，评估现有的资源、评估使用什么样的方式，评估后期的扩展3.配置注意事项。</em></p>
<p><img src="/2025/04/08/nginx高级/1551715154946.png" alt="1551715154946"></p>
<h2 id="3-设计评估"><a href="#3-设计评估" class="headerlink" title="3.设计评估"></a>3.设计评估</h2><p><img src="/2025/04/08/nginx高级/1551715186038.png" alt="1551715186038"></p>
<h2 id="4-配置事项"><a href="#4-配置事项" class="headerlink" title="4.配置事项"></a>4.配置事项</h2><p><img src="/2025/04/08/nginx高级/1551715198534.png" alt="1551715198534"></p>
<h1 id="17-Nginx-Uwsgi代理"><a href="#17-Nginx-Uwsgi代理" class="headerlink" title="17.Nginx Uwsgi代理"></a>17.Nginx Uwsgi代理</h1><ul>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQ3NDU0NDM0MjYzNy5odG1sI3RvY18w" title="http://docs.etiantian.org/15474544342637.html#toc_0">1.Uwsgi代理基本概述<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQ3NDU0NDM0MjYzNy5odG1sI3RvY18x" title="http://docs.etiantian.org/15474544342637.html#toc_1">2.Uwsgi代理使用优势<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3MuZXRpYW50aWFuLm9yZy8xNTQ3NDU0NDM0MjYzNy5odG1sI3RvY18y" title="http://docs.etiantian.org/15474544342637.html#toc_2">3.Uwsgi代理配置实践<i class="fa fa-external-link"></i></span></li>
</ul>
<blockquote>
<p>徐亮伟, 江湖人称标杆徐。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型电商运维工作。<br>个人博客”<span class="exturl" data-url="aHR0cDovL3d3dy54dWxpYW5nd2VpLmNvbS8=" title="http://www.xuliangwei.com/">徐亮伟架构师之路<i class="fa fa-external-link"></i></span>“累计受益数万人。</p>
<p>老男孩Linux云计算运维QQ交流群: 384467551 226199307<br><span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">老男孩教育官网<i class="fa fa-external-link"></i></span> <span class="exturl" data-url="aHR0cDovL3d3dy5vbGRib3llZHUuY29tLw==" title="http://www.oldboyedu.com/">http://www.oldboyedu.com<i class="fa fa-external-link"></i></span></p>
</blockquote>
<h2 id="1-Uwsgi代理基本概述"><a href="#1-Uwsgi代理基本概述" class="headerlink" title="1.Uwsgi代理基本概述"></a>1.Uwsgi代理基本概述</h2><p><em>cgi、fastcgi、wsgi、uwsgi</em></p>
<p><img src="http://docs.etiantian.org/media/15474544342637/15487157044671.jpg" alt="img"></p>
<p><em>python框架Django是一个开放源代码的web的框架Flask是一个使用python编写的轻量级web应用框架</em></p>
<h2 id="2-Uwsgi代理使用优势"><a href="#2-Uwsgi代理使用优势" class="headerlink" title="2.Uwsgi代理使用优势"></a>2.Uwsgi代理使用优势</h2><p><em>框架为什么使用uwsgi，而不是proxy1.安全（nginx可以实现访问控制），直接后端对外是无法控制2.效率（实现动静分离）</em><br><img src="http://docs.etiantian.org/media/15474544342637/15487159641102.jpg" alt="img"></p>
<h2 id="3-Uwsgi代理配置实践"><a href="#3-Uwsgi代理配置实践" class="headerlink" title="3.Uwsgi代理配置实践"></a>3.Uwsgi代理配置实践</h2><p><em>步骤一、安装python3的环境步骤二、安装Django框架、uwsgi步骤三、单独测试Django与uwsgi是否正常步骤四、配置项目，使项目以uwsgi方式启动步骤五、配置Nginx反向代理uwsgi</em></p>
<p><em>0.安装依赖软件包</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># yum install openssl-devel bzip2-devel expat-devel gdbm-devel readline-devel sqlite-devel gcc gcc-c++  openssl-devel zlib zlib-devel -y</span></span><br></pre></td></tr></table></figure>
<p><em>1.安装python3环境</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># wget https://www.python.org/ftp/python/3.7.2/Python-3.7.2.tgz</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># tar xf Python-3.6.2.tgz</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># cd Python-3.6.2/</span></span><br><span class="line">[root<span class="symbol">@web01</span> Python<span class="number">-3.6</span><span class="number">.2</span>]<span class="meta"># ./configure --prefix=/usr/local/</span></span><br><span class="line">[root<span class="symbol">@web01</span> Python<span class="number">-3.6</span><span class="number">.2</span>]<span class="meta"># make &amp;&amp; make install</span></span><br><span class="line">[root<span class="symbol">@web01</span> Python<span class="number">-3.6</span><span class="number">.2</span>]<span class="meta"># ./configure &amp;&amp; make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<p><em>2.安装Django框架和uwsgi</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># pip3 install --upgrade pip</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># pip3 install uwsgi</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># pip3 install django</span></span><br></pre></td></tr></table></figure>
<p><em>3.测试uwsgi是否正常，新建test.py文件，内容如下</em></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]<span class="comment"># vim test.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(env, start_response)</span></span><span class="symbol">:</span></span><br><span class="line">    start_response(<span class="string">'200 OK'</span>, [(<span class="string">'Content-Type'</span>,<span class="string">'text/html'</span>)])</span><br><span class="line">    <span class="keyword">return</span> [b<span class="string">"Hello Django"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#然后在终端运行： </span></span><br><span class="line">[root@web01 ~]<span class="comment"># uwsgi --http :8001 --wsgi-file test.py</span></span><br></pre></td></tr></table></figure>
<p><em>4.测试django是否正常，运行如下指令</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># django-admin.py startproject demosite</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># cd demosite</span></span><br><span class="line">[root<span class="symbol">@web01</span> demosite]<span class="meta"># python3 manage.py runserver 0.0.0.0:8002</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#在浏览器内输入：http://127.0.0.1:8002，检查django是否运行正常。</span></span><br></pre></td></tr></table></figure>
<p><em>5.配置uwsgi</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@web01 ~]</span><span class="comment"># cat /root/demosite/uwsgi.ini</span></span><br><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">socket</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9999</span>         <span class="comment">#uwsgi监听的端口</span></span><br><span class="line"><span class="attr">workers</span> = <span class="number">2</span>                     <span class="comment">#uwsgi启动多少个进程数</span></span><br><span class="line"><span class="attr">max-requests</span> = <span class="number">1000</span>             <span class="comment">#最大接收多少请求数</span></span><br><span class="line"><span class="attr">buffer-size</span> = <span class="number">30000</span></span><br><span class="line"><span class="attr">pidfile</span> = /run/uwsgi.pid        <span class="comment">#进程pid存放位置</span></span><br><span class="line"><span class="attr">daemonize</span> = /var/log/uwsgi.log  <span class="comment">#日志位置</span></span><br></pre></td></tr></table></figure>
<p><em>6.启动uwsgi</em></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#1.先停止之前测试的uwsgi</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># pkill $(ps aux|grep uwsgi)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#2.启动uwsgi</span></span><br><span class="line">[root<span class="symbol">@web01</span> ~]<span class="meta"># uwsgi --ini /root/demosite/uwsgi.ini</span></span><br></pre></td></tr></table></figure>
<p><em>7.配置Nginx代理至uwsgi协议</em></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 demosite]# cat /etc/nginx/conf.d/py.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name py.test.com;</span><br><span class="line">    client_max_body_size 100M;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html;</span><br><span class="line">        include uwsgi_params;</span><br><span class="line">        uwsgi_pass 127.0.0.1:9999;</span><br><span class="line">        uwsgi_param UWSGI_SCRIPT demosite.wsgi;   #demosite/wsgi</span><br><span class="line">        uwsgi_param UWSGI_CHDIR /root/demosite;   #工程所在的目录位置</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>7.使用UWSGI代理方式部署Python项目</em></p>

      
    </div>

    

    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
  <img id="wechat_subscriber_qcode" src="/images/gongzhonghao.jpg" alt="李江洋 wechat" style="width: 200px; max-width: 100%;">
  <div>添加微信，实地看房</div>
</div>

      </div>
    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>欢迎联系我，带您实地看房</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById(&quot;QR&quot;); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="李江洋 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="李江洋 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/代理服务/" rel="tag"># 代理服务</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2025/04/08/jQuery基础/" rel="next" title>
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2025/04/08/前端css/" rel="prev" title="前端css">
                前端css <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="李江洋">
            
              <p class="site-author-name" itemprop="name">李江洋</p>
              <p class="site-description motion-element" itemprop="description">记录学习的技能和遇到的问题</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">180</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">41</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lvdXJuYW1l" title="GitHub &rarr; https://github.com/yourname"><i class="fa fa-fw fa-github"></i>GitHub</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="bWFpbHRvOjEzMjgwNDQzOTJAcXEuY29t" title="E-Mail &rarr; mailto:1328044392@qq.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</span>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cDovL2V4YW1wbGUuY29t" title="http://example.com">Title</span>
                  </li>
                
              </ul>
            </div>
          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#01-Nginx基础Http原理"><span class="nav-number">1.</span> <span class="nav-text">01.Nginx基础Http原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Http协议概述"><span class="nav-number">1.1.</span> <span class="nav-text">1.Http协议概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Http工作原理"><span class="nav-number">1.2.</span> <span class="nav-text">2.Http工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Http协议版本"><span class="nav-number">1.3.</span> <span class="nav-text">3.Http协议版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Http请求响应"><span class="nav-number">1.4.</span> <span class="nav-text">3.Http请求响应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Http访问流程"><span class="nav-number">1.5.</span> <span class="nav-text">6.Http访问流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#02-Nginx-Web快速入门"><span class="nav-number">2.</span> <span class="nav-text">02.Nginx Web快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nginx基本简述"><span class="nav-number">2.1.</span> <span class="nav-text">1.Nginx基本简述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx快速安装"><span class="nav-number">2.2.</span> <span class="nav-text">2.Nginx快速安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Nginx默认配置"><span class="nav-number">2.3.</span> <span class="nav-text">3.Nginx默认配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Nginx网站配置"><span class="nav-number">2.4.</span> <span class="nav-text">4.Nginx网站配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Nginx虚拟主机"><span class="nav-number">2.5.</span> <span class="nav-text">5.Nginx虚拟主机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Nginx日志管理"><span class="nav-number">2.6.</span> <span class="nav-text">6.Nginx日志管理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#03-Nginx常用基础模块"><span class="nav-number">3.</span> <span class="nav-text">03.Nginx常用基础模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nginx目录索引"><span class="nav-number">3.1.</span> <span class="nav-text">1.Nginx目录索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx状态监控"><span class="nav-number">3.2.</span> <span class="nav-text">2.Nginx状态监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Nginx访问控制"><span class="nav-number">3.3.</span> <span class="nav-text">3.Nginx访问控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Nginx资源限制"><span class="nav-number">3.4.</span> <span class="nav-text">4.Nginx资源限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Nginx访问限制"><span class="nav-number">3.5.</span> <span class="nav-text">4.Nginx访问限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Nginx-Location"><span class="nav-number">3.6.</span> <span class="nav-text">6.Nginx Location</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#04-Nginx搭建流行架构"><span class="nav-number">4.</span> <span class="nav-text">04.Nginx搭建流行架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-LNMP架构概述"><span class="nav-number">4.1.</span> <span class="nav-text">1.LNMP架构概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-LNMP架构环境部署"><span class="nav-number">4.2.</span> <span class="nav-text">2.LNMP架构环境部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-LNMP架构环境配置"><span class="nav-number">4.3.</span> <span class="nav-text">2.LNMP架构环境配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-部署博客产品Wordpress"><span class="nav-number">4.4.</span> <span class="nav-text">4.部署博客产品Wordpress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-部署知乎产品Wecenter"><span class="nav-number">4.5.</span> <span class="nav-text">5.部署知乎产品Wecenter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-拆分数据库至至独立服务器"><span class="nav-number">4.6.</span> <span class="nav-text">7.拆分数据库至至独立服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-扩展多台相同的Web服务器"><span class="nav-number">4.7.</span> <span class="nav-text">8.扩展多台相同的Web服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-拆分静态资源至独立服务器"><span class="nav-number">4.8.</span> <span class="nav-text">9.拆分静态资源至独立服务器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#05-Nginx反向代理服务"><span class="nav-number">5.</span> <span class="nav-text">05.Nginx反向代理服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nginx代理服务基本概述"><span class="nav-number">5.1.</span> <span class="nav-text">1.Nginx代理服务基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx代理服务常见模式"><span class="nav-number">5.2.</span> <span class="nav-text">2.Nginx代理服务常见模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Nginx代理服务支持协议"><span class="nav-number">5.3.</span> <span class="nav-text">3.Nginx代理服务支持协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Nginx反向代理配置语法"><span class="nav-number">5.4.</span> <span class="nav-text">4.Nginx反向代理配置语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Nginx反向代理场景实践"><span class="nav-number">5.5.</span> <span class="nav-text">5.Nginx反向代理场景实践</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#06-Nginx代理缓存服务"><span class="nav-number">6.</span> <span class="nav-text">06.Nginx代理缓存服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-缓存常见类型"><span class="nav-number">6.1.</span> <span class="nav-text">1.缓存常见类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-缓存配置语法"><span class="nav-number">6.2.</span> <span class="nav-text">2.缓存配置语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-缓存配置实践"><span class="nav-number">6.3.</span> <span class="nav-text">3.缓存配置实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-缓存如何清理"><span class="nav-number">6.4.</span> <span class="nav-text">4.缓存如何清理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-指定页面不缓存"><span class="nav-number">6.5.</span> <span class="nav-text">5.指定页面不缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-缓存日志记录"><span class="nav-number">6.6.</span> <span class="nav-text">6.缓存日志记录</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#07-Nginx七层负载均衡"><span class="nav-number">7.</span> <span class="nav-text">07.Nginx七层负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nginx负载均衡基本概述"><span class="nav-number">7.1.</span> <span class="nav-text">1.Nginx负载均衡基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx负载均衡配置场景"><span class="nav-number">7.2.</span> <span class="nav-text">2.Nginx负载均衡配置场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Nginx负载均衡调度算法"><span class="nav-number">7.3.</span> <span class="nav-text">3.Nginx负载均衡调度算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Nginx负载均衡后端状态"><span class="nav-number">7.4.</span> <span class="nav-text">4.Nginx负载均衡后端状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Nginx负载均衡健康检查"><span class="nav-number">7.5.</span> <span class="nav-text">5.Nginx负载均衡健康检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Nginx负载均衡会话共享"><span class="nav-number">7.6.</span> <span class="nav-text">6.Nginx负载均衡会话共享</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#08-Nginx四层负载均衡"><span class="nav-number">8.</span> <span class="nav-text">08.Nginx四层负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nginx四层负载均衡基本概述"><span class="nav-number">8.1.</span> <span class="nav-text">1.Nginx四层负载均衡基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx四层负载均衡场景实践"><span class="nav-number">8.2.</span> <span class="nav-text">2.Nginx四层负载均衡场景实践</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#09-Nginx动静分离实战"><span class="nav-number">9.</span> <span class="nav-text">09.Nginx动静分离实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nginx动静分离基本概述"><span class="nav-number">9.1.</span> <span class="nav-text">1.Nginx动静分离基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx动静分离场景实践"><span class="nav-number">9.2.</span> <span class="nav-text">2.Nginx动静分离场景实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Nginx资源分离场景实践"><span class="nav-number">9.3.</span> <span class="nav-text">3.Nginx资源分离场景实践</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-Nginx-Rewrite重写"><span class="nav-number">10.</span> <span class="nav-text">11.Nginx Rewrite重写</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Rewrite基本概述"><span class="nav-number">10.1.</span> <span class="nav-text">1.Rewrite基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Rewrite标记Flag"><span class="nav-number">10.2.</span> <span class="nav-text">2.Rewrite标记Flag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Rewrite规则实践"><span class="nav-number">10.3.</span> <span class="nav-text">3.Rewrite规则实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Rewrite规则补充"><span class="nav-number">10.4.</span> <span class="nav-text">4.Rewrite规则补充</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12-Nginx-HTTPS-实践"><span class="nav-number">11.</span> <span class="nav-text">12.Nginx HTTPS 实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-HTTPS安全证书基本概述"><span class="nav-number">11.1.</span> <span class="nav-text">1.HTTPS安全证书基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx单台实现HTTPS实战"><span class="nav-number">11.2.</span> <span class="nav-text">2.Nginx单台实现HTTPS实战</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Nginx集群实现HTTPS实践"><span class="nav-number">11.3.</span> <span class="nav-text">3.Nginx集群实现HTTPS实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-阿里云Nginx实现HTTPS实践"><span class="nav-number">11.4.</span> <span class="nav-text">4.阿里云Nginx实现HTTPS实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-阿里云SLB负载实现HTTPS实践"><span class="nav-number">11.5.</span> <span class="nav-text">5.阿里云SLB负载实现HTTPS实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Nginx4-7层负载实现HTTPS实战"><span class="nav-number">11.6.</span> <span class="nav-text">6.Nginx4+7层负载实现HTTPS实战</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#13-Nginx高可用架构"><span class="nav-number">12.</span> <span class="nav-text">13.Nginx高可用架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Keepalived高可用基本概述"><span class="nav-number">12.1.</span> <span class="nav-text">1.Keepalived高可用基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Keepalived高可用安装配置"><span class="nav-number">12.2.</span> <span class="nav-text">2.Keepalived高可用安装配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Keepalived高可用地址漂移"><span class="nav-number">12.3.</span> <span class="nav-text">3.Keepalived高可用地址漂移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Keepalived高可用非抢占式"><span class="nav-number">12.4.</span> <span class="nav-text">4.Keepalived高可用非抢占式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-keepalived高可用故障脑裂"><span class="nav-number">12.5.</span> <span class="nav-text">5.keepalived高可用故障脑裂</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#14-Nginx使用常见问题"><span class="nav-number">13.</span> <span class="nav-text">14.Nginx使用常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nginx多Server优先级"><span class="nav-number">13.1.</span> <span class="nav-text">1.Nginx多Server优先级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx禁止IP直接访问"><span class="nav-number">13.2.</span> <span class="nav-text">2.Nginx禁止IP直接访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Nginx包含文件Include"><span class="nav-number">13.3.</span> <span class="nav-text">3.Nginx包含文件Include</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Nginx路径root与alias"><span class="nav-number">13.4.</span> <span class="nav-text">4.Nginx路径root与alias</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Nginx-try-file路径匹配"><span class="nav-number">13.5.</span> <span class="nav-text">5.Nginx try_file路径匹配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Nginx调整上传文件大小"><span class="nav-number">13.6.</span> <span class="nav-text">6.Nginx调整上传文件大小</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Nginx优雅显示错误页面"><span class="nav-number">13.7.</span> <span class="nav-text">7.Nginx优雅显示错误页面</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#15-Nginx性能优化实践"><span class="nav-number">14.</span> <span class="nav-text">15.Nginx性能优化实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-性能优化概述"><span class="nav-number">14.1.</span> <span class="nav-text">1.性能优化概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-压力测试工具"><span class="nav-number">14.2.</span> <span class="nav-text">2.压力测试工具</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#了解影响性能指标"><span class="nav-number">14.2.0.0.0.1.</span> <span class="nav-text">了解影响性能指标</span></a></li></ol></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#3-系统性能优化"><span class="nav-number">14.3.</span> <span class="nav-text">3.系统性能优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-代理服务优化"><span class="nav-number">14.4.</span> <span class="nav-text">4.代理服务优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-静态资源优化"><span class="nav-number">14.5.</span> <span class="nav-text">5.静态资源优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-静态资源缓存"><span class="nav-number">14.5.1.</span> <span class="nav-text">5.1.静态资源缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-静态资源读取"><span class="nav-number">14.5.2.</span> <span class="nav-text">5.2.静态资源读取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-静态资源压缩"><span class="nav-number">14.5.3.</span> <span class="nav-text">5.3.静态资源压缩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-防止资源盗链"><span class="nav-number">14.5.4.</span> <span class="nav-text">5.4.防止资源盗链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-允许跨域访问"><span class="nav-number">14.5.5.</span> <span class="nav-text">5.5.允许跨域访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-CPU亲和配置"><span class="nav-number">14.5.6.</span> <span class="nav-text">5.6.CPU亲和配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-通用优化配置"><span class="nav-number">14.5.7.</span> <span class="nav-text">5.7.通用优化配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-PHP服务优化"><span class="nav-number">14.6.</span> <span class="nav-text">6.PHP服务优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#16-Nginx架构课程总结"><span class="nav-number">15.</span> <span class="nav-text">16.Nginx架构课程总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-架构总结"><span class="nav-number">15.1.</span> <span class="nav-text">1.架构总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-了解需求"><span class="nav-number">15.2.</span> <span class="nav-text">2.了解需求</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#16-Nginx架构课程总结-1"><span class="nav-number">16.</span> <span class="nav-text">16.Nginx架构课程总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-架构总结-1"><span class="nav-number">16.1.</span> <span class="nav-text">1.架构总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-了解需求-1"><span class="nav-number">16.2.</span> <span class="nav-text">2.了解需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-设计评估"><span class="nav-number">16.3.</span> <span class="nav-text">3.设计评估</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-配置事项"><span class="nav-number">16.4.</span> <span class="nav-text">4.配置事项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#17-Nginx-Uwsgi代理"><span class="nav-number">17.</span> <span class="nav-text">17.Nginx Uwsgi代理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Uwsgi代理基本概述"><span class="nav-number">17.1.</span> <span class="nav-text">1.Uwsgi代理基本概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Uwsgi代理使用优势"><span class="nav-number">17.2.</span> <span class="nav-text">2.Uwsgi代理使用优势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Uwsgi代理配置实践"><span class="nav-number">17.3.</span> <span class="nav-text">3.Uwsgi代理配置实践</span></a></li></ol></li></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李江洋</span>

  

  
</div>


  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Pisces</span> v7.0.1</div>






  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/7.1.2/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>






















  
  
  <script id="ribbon" size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>





  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.1"></script>


  
  
  
  <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://ljyabc.github.io/2025/04/08/nginx高级/";
    this.page.identifier = "2025/04/08/nginx高级/";
    this.page.title = 'nginx高级';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  

   <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
</body>
</html>
