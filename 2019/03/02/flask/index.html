<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Flask框架STEP-1一.flask简介 1234567&quot;&quot;&quot;1. Flask是一个基于Python开发并且依赖jinja2模板和Werkzeug  WSGI服务的一个微型框架，对于Werkzeug本质是Socket服务端，其用于接收http请求并对请求进行预处理，然后触发Flask框架，开发人员基于Flask框架提供的功能对请求进行相应的处理，并返回给用户，如果要返回给用户复杂的内容时，需要">
<meta name="keywords" content="python框架">
<meta property="og:type" content="article">
<meta property="og:title" content="flask">
<meta property="og:url" content="https://ljyabc.github.io/2019/03/02/flask/index.html">
<meta property="og:site_name" content="择墅居:李江洋">
<meta property="og:description" content="Flask框架STEP-1一.flask简介 1234567&quot;&quot;&quot;1. Flask是一个基于Python开发并且依赖jinja2模板和Werkzeug  WSGI服务的一个微型框架，对于Werkzeug本质是Socket服务端，其用于接收http请求并对请求进行预处理，然后触发Flask框架，开发人员基于Flask框架提供的功能对请求进行相应的处理，并返回给用户，如果要返回给用户复杂的内容时，需要">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2025-04-08T14:37:34.835Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flask">
<meta name="twitter:description" content="Flask框架STEP-1一.flask简介 1234567&quot;&quot;&quot;1. Flask是一个基于Python开发并且依赖jinja2模板和Werkzeug  WSGI服务的一个微型框架，对于Werkzeug本质是Socket服务端，其用于接收http请求并对请求进行预处理，然后触发Flask框架，开发人员基于Flask框架提供的功能对请求进行相应的处理，并返回给用户，如果要返回给用户复杂的内容时，需要">






  <link rel="canonical" href="https://ljyabc.github.io/2019/03/02/flask/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>flask | 择墅居:李江洋</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">择墅居:李江洋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">争做长沙别墅豪装第一品牌</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-schedule">

    
    
    
      
    

    

    <a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>日程表</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-book">

    
    
    
      
    

    

    <a href="/book" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>book</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ljyabc.github.io/2019/03/02/flask/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李江洋">
      <meta itemprop="description" content="记录学习的技能和遇到的问题">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="择墅居:李江洋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">flask

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-02 21:01:43" itemprop="dateCreated datePublished" datetime="2019-03-02T21:01:43+08:00">2019-03-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2025-04-08 22:37:34" itemprop="dateModified" datetime="2025-04-08T22:37:34+08:00">2025-04-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python入门到放弃系列/" itemprop="url" rel="index"><span itemprop="name">python入门到放弃系列</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2019/03/02/flask/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/02/flask/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Flask框架"><a href="#Flask框架" class="headerlink" title="Flask框架"></a>Flask框架</h2><h3 id="STEP-1"><a href="#STEP-1" class="headerlink" title="STEP-1"></a>STEP-1</h3><h4 id="一-flask简介"><a href="#一-flask简介" class="headerlink" title="一.flask简介"></a>一.flask简介</h4><hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. Flask是一个基于Python开发并且依赖jinja2模板和Werkzeug  WSGI服务的一个微型框架，对于Werkzeug本质是Socket服务端，其用于接收http请求并对请求进行预处理，然后触发Flask框架，开发人员基于Flask框架提供的功能对请求进行相应的处理，并返回给用户，如果要返回给用户复杂的内容时，需要借助jinja2模板来实现对模板的处理，即：将模板和数据进行渲染，将渲染后的字符串返回给用户浏览器。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. “微”(micro) 并不表示你需要把整个 Web 应用塞进单个 Python 文件（虽然确实可以 ），也不意味着 Flask  在功能上有所欠缺。微框架中的“微”意味着 Flask 旨在保持核心简单而易于扩展。Flask 不会替你做出太多决策——比如使用何种数据库。而那些  Flask 所选择的——比如使用何种模板引擎——则很容易替换。除此之外的一切都由可由你掌握。如此，Flask 可以与您珠联璧合。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 默认情况下，Flask 不包含数据库抽象层、表单验证，或是其它任何已有多种库可以胜任的功能。然而，Flask  支持用扩展来给应用添加这些功能，如同是 Flask  本身实现的一样。众多的扩展提供了数据库集成、表单验证、上传处理、各种各样的开放认证技术等功能。Flask  也许是“微小”的，但它已准备好在需求繁杂的生产环境中投入使用。</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="二-flask安装"><a href="#二-flask安装" class="headerlink" title="二.flask安装"></a>二.flask安装</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 <span class="keyword">install</span> flask</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="三-werkzeug"><a href="#三-werkzeug" class="headerlink" title="三.werkzeug"></a>三.werkzeug</h4><h5 id="3-1-简介"><a href="#3-1-简介" class="headerlink" title="3.1 简介"></a>3.1 简介</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. Werkzeug是一个WSGI工具包，他可以作为一个Web框架的底层库。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. werkzeug 不是一个web服务器，也不是一个web框架，而是一个工具包，官方的介绍说是一个 WSGI 工具包，它可以作为一个 Web 框架的底层库，因为它封装好了很多 Web 框架的东西，例如 Request，Response 等等</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="3-2-示例"><a href="#3-2-示例" class="headerlink" title="3.2 示例"></a>3.2 示例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug.wrappers <span class="keyword">import</span> Request, Response</span><br><span class="line"></span><br><span class="line"><span class="meta">@Request.application</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Response(<span class="string">'Hello World!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line">    run_simple(<span class="string">'localhost'</span>, <span class="number">4000</span>, hello)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">1. run_simple方法，需要传入一个可调用的对象，函数，类对象均可，会一直监听指定的端口，一旦有请求来时，会执行可调用的对象。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 如果是方法：就会直接加括号执行里面的方法。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 如果是对象：就会加括号执行，类对象加括号，会执行类中的__call__方法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4. 所以，Flask的__call__方法，是所有请求的入口</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="四-flask的快速使用"><a href="#四-flask的快速使用" class="headerlink" title="四.flask的快速使用"></a>四.flask的快速使用</h4><h5 id="4-1-首先导入Flask这个类"><a href="#4-1-首先导入Flask这个类" class="headerlink" title="4.1 首先导入Flask这个类"></a>4.1 首先导入Flask这个类</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br></pre></td></tr></table></figure>
<h5 id="4-2-实例化产生一个Flask的对象"><a href="#4-2-实例化产生一个Flask的对象" class="headerlink" title="4.2 实例化产生一个Flask的对象"></a>4.2 实例化产生一个Flask的对象</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>
<h5 id="4-3-设置成调试模式，自动刷新重启"><a href="#4-3-设置成调试模式，自动刷新重启" class="headerlink" title="4.3 设置成调试模式，自动刷新重启"></a>4.3 设置成调试模式，自动刷新重启</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.debug = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h5 id="4-4-写视图函数并配置路由"><a href="#4-4-写视图函数并配置路由" class="headerlink" title="4.4 写视图函数并配置路由"></a>4.4 写视图函数并配置路由</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route("/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello world"</span></span><br></pre></td></tr></table></figure>
<h5 id="4-5-启动flask项目"><a href="#4-5-启动flask项目" class="headerlink" title="4.5 启动flask项目"></a>4.5 启动flask项目</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="4-6-示例"><a href="#4-6-示例" class="headerlink" title="4.6 示例"></a>4.6 示例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个Flask的对象</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="comment"># 设置成调试模式，自动刷新重启</span></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"HELLO WORLD"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 项目启动最先执行的方法，会监听请求，当请求进来时，会触发Flask类中的__call__方法</span></span><br><span class="line">    <span class="comment"># __call__方法是所有请求来时的入口</span></span><br><span class="line">    app.run(host=<span class="string">"127.0.0.1"</span>, port=<span class="number">5001</span>)</span><br></pre></td></tr></table></figure>
<h4 id="五-基于Flask写一个项目具备：登录，显示用户信息"><a href="#五-基于Flask写一个项目具备：登录，显示用户信息" class="headerlink" title="五. 基于Flask写一个项目具备：登录，显示用户信息"></a>五. 基于Flask写一个项目具备：登录，显示用户信息</h4><h5 id="5-1-目录结构"><a href="#5-1-目录结构" class="headerlink" title="5.1 目录结构"></a>5.1 目录结构</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">D:.</span></span><br><span class="line"><span class="string">│  flask_damon.py</span></span><br><span class="line"><span class="string">│</span></span><br><span class="line"><span class="string">└─templates</span></span><br><span class="line"><span class="string">        login.html</span></span><br><span class="line"><span class="string">        user_detail.html</span></span><br><span class="line"><span class="string">        user_list.html</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="5-2-flask-damon-py"><a href="#5-2-flask-damon-py" class="headerlink" title="5.2 flask_damon.py"></a>5.2 flask_damon.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, redirect, session, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="comment"># 一旦用了session,一定要记住，要写secret_key,不然会出错</span></span><br><span class="line"><span class="comment"># The session is unavailable because no secret key was set.  Set the secret_key on the application to something unique and secret.</span></span><br><span class="line">app.secret_key = <span class="string">"zhang"</span></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line">USER_LIST = &#123;</span><br><span class="line">    <span class="number">1</span>: &#123;<span class="string">'name'</span>: <span class="string">'张三'</span>, <span class="string">'age'</span>: <span class="number">18</span>, <span class="string">'text'</span>: <span class="string">'道路千万条'</span>&#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;<span class="string">'name'</span>: <span class="string">'李四'</span>, <span class="string">'age'</span>: <span class="number">48</span>, <span class="string">'text'</span>: <span class="string">'安全第一条'</span>&#125;,</span><br><span class="line">    <span class="number">3</span>: &#123;<span class="string">'name'</span>: <span class="string">'王五'</span>, <span class="string">'age'</span>: <span class="number">68</span>, <span class="string">'text'</span>: <span class="string">'亲人两行泪'</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># methods = ["GET", "POST"] 配置能够响应的请求方式</span></span><br><span class="line"><span class="meta">@app.route("/login", methods=["GET", "POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    django三件套类比于Flask</span></span><br><span class="line"><span class="string">    HttpResponse --- ""</span></span><br><span class="line"><span class="string">    render --- render_template</span></span><br><span class="line"><span class="string">    redirect --- redirect</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        name = request.form.get(<span class="string">"name"</span>)</span><br><span class="line">        pwd = request.form.get(<span class="string">"pwd"</span>)</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">"zcg"</span> <span class="keyword">and</span> pwd == <span class="string">"123"</span>:</span><br><span class="line">            <span class="comment"># 登录成功，跳转到用户列表的页面</span></span><br><span class="line">            <span class="comment"># 写入session中</span></span><br><span class="line">            session[<span class="string">"user"</span>] = name</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"/user_list"</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>, error=<span class="string">"用户名或密码错误"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/user_list", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_list</span><span class="params">()</span>:</span></span><br><span class="line">    user = session.get(<span class="string">"user"</span>)</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"user_list.html"</span>, user_list=USER_LIST)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"/login"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/user_detail/&lt;int:nid&gt;", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_detail</span><span class="params">(nid)</span>:</span></span><br><span class="line">    print(nid)</span><br><span class="line">    user = USER_LIST.get(nid)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"user_detail.html"</span>, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5002</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="5-3-login-html"><a href="#5-3-login-html" class="headerlink" title="5.3 login.html"></a>5.3 login.html</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"pwd"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;error&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">注释：</span></span><br><span class="line"><span class="string">1. &#123;&#123;error&#125;&#125;</span></span><br><span class="line"><span class="string">用户输入错误的时候返回的错误信息</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="5-4-user-list-html"><a href="#5-4-user-list-html" class="headerlink" title="5.4 user_list.html"></a>5.4 user_list.html</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户列表<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"1px"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>id<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>详情页面<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">    &#123;% for k,v in user_list.items() %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;k&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;v.name&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/user_detail/&#123;&#123;k&#125;&#125;"</span>&gt;</span>查看详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">注意：Flask中的items一定要和python一样，必须加括号执行，但是django中一定不能加括号</span></span><br><span class="line"><span class="string">&#123;% for k,v in user_list.items() %&#125;</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="5-5-user-detail-html"><a href="#5-5-user-detail-html" class="headerlink" title="5.5 user_detail.html"></a>5.5 user_detail.html</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户详情<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;user.name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;user["age"]&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;user.get("text")&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 字典在模板中取值可以完全按照python中字典的取值方式</span></span><br><span class="line"><span class="string">方式一：</span></span><br><span class="line"><span class="string">&#123;&#123;user.name&#125;&#125;</span></span><br><span class="line"><span class="string">方式一：</span></span><br><span class="line"><span class="string">&#123;&#123;user["age"]&#125;&#125;</span></span><br><span class="line"><span class="string">方式一：</span></span><br><span class="line"><span class="string">&#123;&#123;user.get("text")&#125;&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h4 id="六-基于flask的登录认证装饰器"><a href="#六-基于flask的登录认证装饰器" class="headerlink" title="六. 基于flask的登录认证装饰器"></a>六. 基于flask的登录认证装饰器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, redirect, session, request, url_for</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="comment"># 一旦用了session,一定要记住，要写secret_key,不然会出错</span></span><br><span class="line"><span class="comment"># The session is unavailable because no secret key was set.  Set the secret_key on the application to something unique and secret.</span></span><br><span class="line">app.secret_key = <span class="string">"zhang"</span></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line">USER_LIST = &#123;</span><br><span class="line">    <span class="number">1</span>: &#123;<span class="string">'name'</span>: <span class="string">'张三'</span>, <span class="string">'age'</span>: <span class="number">18</span>, <span class="string">'text'</span>: <span class="string">'道路千万条'</span>&#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;<span class="string">'name'</span>: <span class="string">'李四'</span>, <span class="string">'age'</span>: <span class="number">48</span>, <span class="string">'text'</span>: <span class="string">'安全第一条'</span>&#125;,</span><br><span class="line">    <span class="number">3</span>: &#123;<span class="string">'name'</span>: <span class="string">'王五'</span>, <span class="string">'age'</span>: <span class="number">68</span>, <span class="string">'text'</span>: <span class="string">'亲人两行泪'</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录认证装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        url = request.path</span><br><span class="line">        print(url, <span class="string">"hello"</span>)</span><br><span class="line">        <span class="keyword">if</span> session.get(<span class="string">'user'</span>):</span><br><span class="line">            ret = func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"/login?next=%s"</span> % url)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># methods = ["GET", "POST"] 配置能够响应的请求方式</span></span><br><span class="line"><span class="meta">@app.route("/login", methods=["GET", "POST"], endpoint="login")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    HttpResponse --- ""</span></span><br><span class="line"><span class="string">    render --- render_template</span></span><br><span class="line"><span class="string">    redirect --- redirect</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print(request.args.get(<span class="string">"next"</span>))</span><br><span class="line">    origin_url = request.args.get(<span class="string">"next"</span>)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        name = request.form.get(<span class="string">"name"</span>)</span><br><span class="line">        pwd = request.form.get(<span class="string">"pwd"</span>)</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">"zcg"</span> <span class="keyword">and</span> pwd == <span class="string">"123"</span>:</span><br><span class="line">            <span class="comment"># 登录成功，跳转到用户列表的页面</span></span><br><span class="line">            <span class="comment"># 写入session中</span></span><br><span class="line">            session[<span class="string">"user"</span>] = name</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"%s"</span> % origin_url)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>, error=<span class="string">"用户名或密码错误"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># with app.test_request_context():</span></span><br><span class="line"><span class="comment">#     print(url_for('login', ))</span></span><br><span class="line"><span class="comment">#     print(url_for('login', next='/'))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/user_list", methods=["GET"], endpoint="user_list")</span></span><br><span class="line"><span class="meta">@auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_list</span><span class="params">()</span>:</span></span><br><span class="line">    url = url_for(<span class="string">'user_detail'</span>, nid=<span class="number">1</span>)</span><br><span class="line">    print(url)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"user_list.html"</span>, user_list=USER_LIST, url=url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/user_detail/&lt;int:nid&gt;", methods=["GET"], endpoint="user_detail")</span></span><br><span class="line"><span class="meta">@auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_detail</span><span class="params">(nid)</span>:</span></span><br><span class="line">    print(nid)</span><br><span class="line">    user = USER_LIST.get(nid)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"user_detail.html"</span>, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># with app.test_request_context():</span></span><br><span class="line"><span class="comment">#     print(url_for('login', ))</span></span><br><span class="line"><span class="comment">#     print(url_for('login', next='/'))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5002</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">1. 视图重命名问题</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.route本质执行了decorator=app.route() ---&gt;decorator(func)----&gt;add_url_rule</span></span><br><span class="line"><span class="string">---&gt;_endpoint_from_view_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果不指定endpoint，则使用函数名decorator作为endpoint的值，就会导致冲突，抛出异常</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">解决方式一：将装饰器中内层函数通过wraps伪装成和原视图函数名字一样的新的视图函数</span></span><br><span class="line"><span class="string">from functools import wraps</span></span><br><span class="line"><span class="string">@wraps(func)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">解决方式二：给视图函数指定endpoint</span></span><br><span class="line"><span class="string">@app.route("/user_list", methods=["GET"], endpoint="user_list")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 视图叠加自定义的装饰器</span></span><br><span class="line"><span class="string">@app.route("/user_list", methods=["GET"], endpoint="user_list")</span></span><br><span class="line"><span class="string">@auth</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">需要包在app.route内</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果叠加多个装饰器：view_func.__name__ = 自定义装饰器的内层函数名，所以需要做处理，同视图重命名问题</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span><span class="params">(self, rule, endpoint=None, view_func=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 provide_automatic_options=None, **options)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">	.....</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">	<span class="title">if</span> <span class="title">view_func</span> <span class="title">is</span> <span class="title">not</span> <span class="title">None</span>:</span></span><br><span class="line">        <span class="comment"># self.view_functions是一个字典，如果里面有值，就取出值，和现有的视图名字进行比较</span></span><br><span class="line">        <span class="comment"># 从字典中取出endpoint对应的视图函数的内存地址</span></span><br><span class="line">        old_func = self.view_functions.get(endpoint)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果取出的视图函数存在，且取出的视图的内存地址和当前的视图的内存地址不一样</span></span><br><span class="line">        <span class="comment"># 则表示当前的视图函数的endpoint已经和一个已存在的视图的endpoint重名，抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> old_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> old_func != view_func:</span><br><span class="line">            <span class="keyword">raise</span> AssertionError(<span class="string">'View function mapping is overwriting an '</span></span><br><span class="line">                                 <span class="string">'existing endpoint function: %s'</span> % endpoint)</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 其他情况，则在view_functions字典中新增一个endpoint，以当前被装饰的视图函数的endpoint作为key</span></span><br><span class="line">        <span class="comment"># 以当前视图函数的被装饰后的函数的内存地址作为value</span></span><br><span class="line">        self.view_functions[endpoint] = view_func</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="STEP-2"><a href="#STEP-2" class="headerlink" title="STEP-2"></a>STEP-2</h3><h4 id="一-Flask的配置文件"><a href="#一-Flask的配置文件" class="headerlink" title="一. Flask的配置文件"></a>一. Flask的配置文件</h4><h5 id="1-1-默认的配置文件是一个flask-config-Config对象（继承字典"><a href="#1-1-默认的配置文件是一个flask-config-Config对象（继承字典" class="headerlink" title="1.1 默认的配置文件是一个flask.config.Config对象（继承字典)"></a>1.1 默认的配置文件是一个flask.config.Config对象（继承字典)</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">'ENV': None,</span></span><br><span class="line"><span class="string">'DEBUG': None,</span></span><br><span class="line"><span class="string">'TESTING': False,</span></span><br><span class="line"><span class="string">'PROPAGATE_EXCEPTIONS': None,</span></span><br><span class="line"><span class="string">'PRESERVE_CONTEXT_ON_EXCEPTION': None,</span></span><br><span class="line"><span class="string">'SECRET_KEY': None,</span></span><br><span class="line"><span class="string">'PERMANENT_SESSION_LIFETIME': timedelta(days=31),</span></span><br><span class="line"><span class="string">'USE_X_SENDFILE': False,</span></span><br><span class="line"><span class="string">'SERVER_NAME': None,</span></span><br><span class="line"><span class="string">'APPLICATION_ROOT': '/',</span></span><br><span class="line"><span class="string">'SESSION_COOKIE_NAME': 'session',</span></span><br><span class="line"><span class="string">'SESSION_COOKIE_DOMAIN': None,</span></span><br><span class="line"><span class="string">'SESSION_COOKIE_PATH': None,</span></span><br><span class="line"><span class="string">'SESSION_COOKIE_HTTPONLY': True,</span></span><br><span class="line"><span class="string">'SESSION_COOKIE_SECURE': False,</span></span><br><span class="line"><span class="string">'SESSION_COOKIE_SAMESITE': None,</span></span><br><span class="line"><span class="string">'SESSION_REFRESH_EACH_REQUEST': True,</span></span><br><span class="line"><span class="string">'MAX_CONTENT_LENGTH': None,</span></span><br><span class="line"><span class="string">'SEND_FILE_MAX_AGE_DEFAULT': timedelta(hours=12),</span></span><br><span class="line"><span class="string">'TRAP_BAD_REQUEST_ERRORS': None,</span></span><br><span class="line"><span class="string">'TRAP_HTTP_EXCEPTIONS': False,</span></span><br><span class="line"><span class="string">'EXPLAIN_TEMPLATE_LOADING': False,</span></span><br><span class="line"><span class="string">'PREFERRED_URL_SCHEME': 'http',</span></span><br><span class="line"><span class="string">'JSON_AS_ASCII': True,</span></span><br><span class="line"><span class="string">'JSON_SORT_KEYS': True,</span></span><br><span class="line"><span class="string">'JSONIFY_PRETTYPRINT_REGULAR': False,</span></span><br><span class="line"><span class="string">'JSONIFY_MIMETYPE': 'application/json',</span></span><br><span class="line"><span class="string">'TEMPLATES_AUTO_RELOAD': None,</span></span><br><span class="line"><span class="string">'MAX_COOKIE_SIZE': 4093,</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>源码</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>‘DEBUG’: None</td>
<td>启用/禁止调试模式</td>
</tr>
<tr>
<td>‘TESTING’: False</td>
<td>启用/禁止测试模式</td>
</tr>
<tr>
<td>‘PROPAGATE_EXCEPTIONS’: None</td>
<td>显式地启用或者禁止异常的传播。如果没有设置或显式设置为None，当TESTING或DEBUG为真时，隐式为真</td>
</tr>
<tr>
<td>‘PRESERVE_CONTEXT_ON_EXCEPTION’: None</td>
<td>默认情况下，如果应用工作在调试模式， 请求上下文不会在异常时出栈来允许调试器内省。 这可以通过这个键来禁用。 你同样可以用这个设定来强制启用它， 即使没有调试执行，这对调试生产应用很有用 (但风险也很大)</td>
</tr>
<tr>
<td>‘SECRET_KEY’: None</td>
<td>密钥，使用session时需要使用</td>
</tr>
<tr>
<td>‘PERMANENT_SESSION_LIFETIME’: timedelta(days=31)</td>
<td>一个持久化的会话的生存时间，作为一个<span class="exturl" data-url="aHR0cDovL2RvY3MucHl0aG9uLm9yZy9kZXYvbGlicmFyeS9kYXRldGltZS5odG1sI2RhdGV0aW1lLnRpbWVkZWx0YQ==" title="http://docs.python.org/dev/library/datetime.html#datetime.timedelta"><code>datetime.timedelta</code><i class="fa fa-external-link"></i></span> 对象。从 Flask0.8 开始 也可以用一个整数来表示秒。</td>
</tr>
<tr>
<td>‘USE_X_SENDFILE’: False</td>
<td>启用/禁止x-sendfile</td>
</tr>
<tr>
<td>‘SERVER_NAME’: None</td>
<td>服务器的名称以及端口，需要它为了支持子域名 (如: <code>&#39;myapp.dev:5000&#39;</code>)。注意 localhost 是 不支持子域名的因此设置成 “localhost” 是无意义的。 设置 <code>SERVER_NAME</code> 默认会允许在没有请求上下文 而仅有应用上下文时生成 URL。</td>
</tr>
<tr>
<td>‘APPLICATION_ROOT’: ‘/‘</td>
<td>如果应用不占用完整的域名或子域名， 这个选项可以被设置为应用所在的路径。 这个路径也会用于会话 cookie 的路径值。 如果直接使用域名，则留作 <code>None</code>。</td>
</tr>
<tr>
<td>‘SESSION_COOKIE_NAME’: ‘session’</td>
<td>会话cookie的名称</td>
</tr>
<tr>
<td>‘SESSION_COOKIE_DOMAIN’: None</td>
<td>会话cookie的域，如果没有设置的话，cookie将会对SERVER_NAME所有的子域有效。</td>
</tr>
<tr>
<td>‘SESSION_COOKIE_PATH’: None</td>
<td>会话cookie的路径。如果没有设置或者没有为’/‘设置，cookie将会对所有的APPLICATION_ROOT有效.</td>
</tr>
<tr>
<td>‘SESSION_COOKIE_HTTPONLY’: True</td>
<td>控制cookie是否应被设置httponly的标志，默认为True。</td>
</tr>
<tr>
<td>‘SESSION_COOKIE_SECURE’: False</td>
<td>控制cookie是否应被设置安全标志，默认为False。</td>
</tr>
<tr>
<td>‘MAX_CONTENT_LENGTH’: None</td>
<td>如果设置为字节数，Flask会拒绝内容长度大于此值的请求进入，并返回一个413的状态码。</td>
</tr>
<tr>
<td>‘SEND_FILE_MAX_AGE_DEFAULT’: timedelta(hours=12)</td>
<td>默认缓存控制的最大期限，以秒计， 在 <span class="exturl" data-url="aHR0cDovL3d3dy5weXRob25kb2MuY29tL2ZsYXNrL2FwaS5odG1sI2ZsYXNrLkZsYXNrLnNlbmRfc3RhdGljX2ZpbGU=" title="http://www.pythondoc.com/flask/api.html#flask.Flask.send_static_file"><code>send_static_file()</code><i class="fa fa-external-link"></i></span> (默认的静态文件处理器)和 <span class="exturl" data-url="aHR0cDovL3d3dy5weXRob25kb2MuY29tL2ZsYXNrL2FwaS5odG1sI2ZsYXNrLnNlbmRfZmlsZQ==" title="http://www.pythondoc.com/flask/api.html#flask.send_file"><code>send_file()</code><i class="fa fa-external-link"></i></span> 中使用。 对于单个文件，覆盖这个值，使用 <span class="exturl" data-url="aHR0cDovL3d3dy5weXRob25kb2MuY29tL2ZsYXNrL2FwaS5odG1sI2ZsYXNrLkZsYXNrLmdldF9zZW5kX2ZpbGVfbWF4X2FnZQ==" title="http://www.pythondoc.com/flask/api.html#flask.Flask.get_send_file_max_age"><code>get_send_file_max_age()</code><i class="fa fa-external-link"></i></span> 勾住<span class="exturl" data-url="aHR0cDovL3d3dy5weXRob25kb2MuY29tL2ZsYXNrL2FwaS5odG1sI2ZsYXNrLkZsYXNr" title="http://www.pythondoc.com/flask/api.html#flask.Flask"><code>Flask</code><i class="fa fa-external-link"></i></span> 或者 <span class="exturl" data-url="aHR0cDovL3d3dy5weXRob25kb2MuY29tL2ZsYXNrL2FwaS5odG1sI2ZsYXNrLkJsdWVwcmludA==" title="http://www.pythondoc.com/flask/api.html#flask.Blueprint"><code>Blueprint</code><i class="fa fa-external-link"></i></span>。 默认为 43200（12小时）。</td>
</tr>
<tr>
<td>‘TRAP_BAD_REQUEST_ERRORS’: None</td>
<td>Werkzeug 处理请求中的特定数据的内部数据结构会 抛出同样也是“错误的请求”异常的特殊的 key errors 。 同样地，为了保持一致，许多操作可以 显式地抛出 BadRequest 异常。因为在调试中， 你希望准确地找出异常的原因， 这个设置用于在这些情形下调试。 如果这个值被设置为 <code>True</code> ， 你只会得到常规的回溯。</td>
</tr>
<tr>
<td>‘TRAP_HTTP_EXCEPTIONS’: False</td>
<td>如果这个值被设置为 <code>True</code> ， Flask 不会执行 HTTP 异常的错误处理， 而是像对待其它异常一样，通过异常栈让它冒泡。 这对于需要找出 HTTP 异常源头的可怕调试情形是有用的。</td>
</tr>
<tr>
<td>‘PREFERRED_URL_SCHEME’: ‘http’</td>
<td>url模式用于url生成。如果没有设置url模式，默认将为http。</td>
</tr>
<tr>
<td>‘JSON_AS_ASCII’: True</td>
<td>默认情况下 Flask 序列化对象成 ascii 编码的 JSON。 如果不对该配置项就行设置的话，Flask 将不会编码成 ASCII 保持字符串原样，并且返回 unicode 字符串。<code>jsonfiy</code> 会自动按照 <code>utf-8</code> 进行编码并且传输。</td>
</tr>
<tr>
<td>‘JSON_SORT_KEYS’: True</td>
<td>默认情况下 Flask 将会依键值顺序的方式序列化 JSON。 这样做是为了确保字典哈希种子的独立性，返回值将会一致不会造成 额外的 HTTP 缓存。通过改变这个变量可以重载默认行为。 这是不推荐也许会带来缓存消耗的性能问题。</td>
</tr>
<tr>
<td>‘JSONIFY_PRETTYPRINT_REGULAR’: False</td>
<td>如果设置成 <code>True</code> (默认下)，jsonify 响应将会完美地打印。</td>
</tr>
</tbody>
</table>
<hr>
<h5 id="1-2-配置文件的方式一：通过config对象字典特性"><a href="#1-2-配置文件的方式一：通过config对象字典特性" class="headerlink" title="1.2 配置文件的方式一：通过config对象字典特性"></a>1.2 配置文件的方式一：通过config对象字典特性</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">"DEBUG"</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">ps:</span><br><span class="line">由于Config对象本质上是字典，所以还可以使用app.config.update(...)</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="1-3-配置文件方式二：通过py文件配置"><a href="#1-3-配置文件方式二：通过py文件配置" class="headerlink" title="1.3 配置文件方式二：通过py文件配置"></a>1.3 配置文件方式二：通过py文件配置</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.config.from_pyfile(<span class="string">"python文件名称"</span>)</span><br><span class="line"></span><br><span class="line">eg：</span><br><span class="line">settings.py</span><br><span class="line">DEBUG = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="1-4-配置文件方式三：通过环境变量配置"><a href="#1-4-配置文件方式三：通过环境变量配置" class="headerlink" title="1.4 配置文件方式三：通过环境变量配置"></a>1.4 配置文件方式三：通过环境变量配置</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.config.from_ecvvar(<span class="string">"环境变量名称"</span>)</span><br><span class="line"></span><br><span class="line">eg：</span><br><span class="line">app.config.from_pyfile(os.environ[<span class="string">"YOURAPPLICATION_SETTINGS"</span>])</span><br><span class="line"></span><br><span class="line">环境变量的值为python文件名称，内部调用from_pyfile方法</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="1-5-配置文件方式四：通过json文件"><a href="#1-5-配置文件方式四：通过json文件" class="headerlink" title="1.5 配置文件方式四：通过json文件"></a>1.5 配置文件方式四：通过json文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.config.from_json(<span class="string">"json文件名称"</span>)</span><br><span class="line"></span><br><span class="line">json文件名称，必须是json格式，因为内部会执行json.loads</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="1-6-配置文件方式五：通过字典映射"><a href="#1-6-配置文件方式五：通过字典映射" class="headerlink" title="1.6 配置文件方式五：通过字典映射"></a>1.6 配置文件方式五：通过字典映射</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config.from_mapping(&#123;<span class="string">"DEBUG"</span>:<span class="literal">True</span>&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="1-7-配置文件方式六：通过对象的方式"><a href="#1-7-配置文件方式六：通过对象的方式" class="headerlink" title="1.7 配置文件方式六：通过对象的方式"></a>1.7 配置文件方式六：通过对象的方式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.config.from_object(<span class="string">"python类或类的路径"</span>)</span><br><span class="line"></span><br><span class="line">app.config.from_object(<span class="string">"pro_flask.settings.TestingConfig"</span>)</span><br><span class="line"></span><br><span class="line">内部会调用importlib模块</span><br></pre></td></tr></table></figure>
<h6 id="1-7-1-实例"><a href="#1-7-1-实例" class="headerlink" title="1.7.1 实例"></a>1.7.1 实例</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py文件中</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span><span class="params">(object)</span>:</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    TESTING = <span class="literal">False</span></span><br><span class="line">    DATABASE_URL = <span class="string">"sqlite://:memory:"</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductionConfig</span><span class="params">(Config)</span>:</span></span><br><span class="line">    DATABASE_URL = <span class="string">"mysql://user@localhost/foo"</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DevelopmentConfig</span><span class="params">(Config)</span>:</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestingConfig</span><span class="params">(Config)</span>:</span></span><br><span class="line">    TESTING = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">好处：</span></span><br><span class="line"><span class="string">在项目测试阶段，使用测试阶段对应的类对象</span></span><br><span class="line"><span class="string">在项目上线阶段，使用上线阶段对应的类对象</span></span><br><span class="line"><span class="string">只需要修改from_object里面的类对象即可，不需要修改配置文件中的配置</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="1-8-配置文件的路径问题"><a href="#1-8-配置文件的路径问题" class="headerlink" title="1.8 配置文件的路径问题"></a>1.8 配置文件的路径问题</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 从sys.path中已经存在的路径开始写</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. settings.py文件默认路径要放在程序的root_path目录，如果instance_relative_config为True，则就是instance_path目录（Flask对象init方法的参数）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3.例如</span></span><br><span class="line"><span class="string">instance_path=路径,</span></span><br><span class="line"><span class="string">instance_relative_config=True,</span></span><br><span class="line"><span class="string">以后settings.py文件放在这个路径下</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="二-Flask的路由系统"><a href="#二-Flask的路由系统" class="headerlink" title="二. Flask的路由系统"></a>二. Flask的路由系统</h4><h5 id="2-1-路由的典型写法"><a href="#2-1-路由的典型写法" class="headerlink" title="2.1 路由的典型写法"></a>2.1 路由的典型写法</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/index',methods=['GET'],endpoint='index')</span></span><br></pre></td></tr></table></figure>
<h5 id="2-2-默认的内置转换器"><a href="#2-2-默认的内置转换器" class="headerlink" title="2.2 默认的内置转换器"></a>2.2 默认的内置转换器</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#源码所在 from werkzeug.routing import BaseConverter</span></span><br><span class="line">DEFAULT_CONVERTERS = &#123;</span><br><span class="line">    <span class="string">'default'</span>:          UnicodeConverter,</span><br><span class="line">    <span class="string">'string'</span>:           UnicodeConverter,</span><br><span class="line">    <span class="string">'any'</span>:              AnyConverter,</span><br><span class="line">    <span class="string">'path'</span>:             PathConverter,</span><br><span class="line">    <span class="string">'int'</span>:              IntegerConverter,</span><br><span class="line">    <span class="string">'float'</span>:            FloatConverter,</span><br><span class="line">    <span class="string">'uuid'</span>:             UUIDConverter,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-自定义正则转换器"><a href="#2-3-自定义正则转换器" class="headerlink" title="2.3 自定义正则转换器"></a>2.3 自定义正则转换器</h5><h6 id="2-3-1-写一个类继承BaseConverter"><a href="#2-3-1-写一个类继承BaseConverter" class="headerlink" title="2.3.1 写一个类继承BaseConverter"></a>2.3.1 写一个类继承BaseConverter</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义转换器，支持正则</span></span><br><span class="line"><span class="comment"># 1. 写一个类继承BaseCoverter</span></span><br><span class="line"><span class="comment"># 2. 注册：app.url_map.converters['regex'] = RegexConverter</span></span><br><span class="line"><span class="comment"># 3 使用：@app.route('/index/&lt;regex("\d+"):nid&gt;')  正则表达式会当作第二个参数传递到类中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> werkzeug.routing <span class="keyword">import</span> BaseConverter</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegexConverter</span><span class="params">(BaseConverter)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    自定义URL匹配正则表达式</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># regex正则表达式</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, map, regex)</span>:</span></span><br><span class="line">        super(RegexConverter, self).__init__(map)</span><br><span class="line">        self.regex = regex</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_python</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        路由匹配时，匹配成功后传递给视图函数中参数的值</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_url</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        使用url_for反向生成URL时，传递的参数经过该方法处理，返回的值用于生成URL中的参数</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        val = super(RegexConverter, self).to_url(value)</span><br><span class="line">        <span class="keyword">return</span> val</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加到flask的转换器中</span></span><br><span class="line">app.url_map.converters[<span class="string">'regex'</span>] = RegexConverter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/index/&lt;regex('\d+'):nid&gt;")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(nid)</span>:</span></span><br><span class="line">    print(nid)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"index"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5100</span>)</span><br></pre></td></tr></table></figure>
<h6 id="2-3-2-注册转换器"><a href="#2-3-2-注册转换器" class="headerlink" title="2.3.2 注册转换器"></a>2.3.2 注册转换器</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.url_map.converters[<span class="string">"regex"</span>] = RegexConverter</span><br></pre></td></tr></table></figure>
<h6 id="2-3-3-使用转换器"><a href="#2-3-3-使用转换器" class="headerlink" title="2.3.3 使用转换器"></a>2.3.3 使用转换器</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/index/&lt;regex("\d+"):nid&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(nid)</span>:</span></span><br><span class="line">    print(url_for(<span class="string">'index'</span>, nid=<span class="string">'888'</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<h6 id="2-3-4-注意"><a href="#2-3-4-注意" class="headerlink" title="2.3.4 注意"></a>2.3.4 注意</h6><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2<span class="selector-class">.3</span><span class="selector-class">.2</span>和2<span class="selector-class">.3</span><span class="selector-class">.3</span>中的<span class="selector-tag">regex</span>名字必须一致</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="2-4-路由的本质"><a href="#2-4-路由的本质" class="headerlink" title="2.4 路由的本质"></a>2.4 路由的本质</h5><h6 id="2-4-0-执行流程"><a href="#2-4-0-执行流程" class="headerlink" title="2.4.0 执行流程"></a>2.4.0 执行流程</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">--- app.route()装饰器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">　　获取URL, 视图对象，其他options方法，并调用app实例的add_url_rule方法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--- add_url_rule方法:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    1. 获取app.route的methods关键字参数，视图模块里定义的methods参数等Http 请求方法这里视图可以是一个函数，也可以是一个python模块</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    2. 把URL，视图对象，Http请求方法，绑定到一个Rule实例（app实例的），通过app实例的url_rule_class方法。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">　　　　Rule的__init__方法的其他参数来自app.route的关键字传参，可以控制一些URL的匹配规则</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">　　　　build_only参数可以让URL不绑定任何视图，实现static文件夹等。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">---- url_map.add</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">　　把Rule实例和app实例保存的map实例绑定</span></span><br><span class="line"><span class="string">　　</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="2-4-1-例子代码"><a href="#2-4-1-例子代码" class="headerlink" title="2.4.1 例子代码"></a>2.4.1 例子代码</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route("/user_list", methods=["GET"], endpoint="user_list")</span></span><br><span class="line"><span class="meta">@auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_list</span><span class="params">()</span>:</span></span><br><span class="line">    url = url_for(<span class="string">'user_detail'</span>, nid=<span class="number">1</span>)</span><br><span class="line">    print(url)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"user_list.html"</span>, user_list=USER_LIST, url=url)</span><br></pre></td></tr></table></figure>
<h6 id="2-4-2-源码分析：route"><a href="#2-4-2-源码分析：route" class="headerlink" title="2.4.2 源码分析：route"></a>2.4.2 源码分析：route</h6><blockquote>
<p><strong>route方法的分析</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, **options)</span>:</span></span><br><span class="line">	<span class="comment"># self是Flask这个类对象app</span></span><br><span class="line">    <span class="comment"># rule是传入的路由的路径</span></span><br><span class="line">    <span class="comment"># options是一个字典，接受methods，endpoint等其它参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></span><br><span class="line">        endpoint = options.pop(<span class="string">'endpoint'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 本质是执行了add_url_rule</span></span><br><span class="line">        <span class="comment"># 第一个参数是一个路径</span></span><br><span class="line">        <span class="comment"># 第二个参数是视图函数的别名</span></span><br><span class="line">        <span class="comment"># 第三个参数是视图函数的内存地址</span></span><br><span class="line">        self.add_url_rule(rule, endpoint, f, **options)</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure>
<h6 id="2-4-3-源码分析：add-url-rule"><a href="#2-4-3-源码分析：add-url-rule" class="headerlink" title="2.4.3 源码分析：add_url_rule"></a>2.4.3 源码分析：add_url_rule</h6><blockquote>
<p><strong>add_url_rule方法的分析</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span><span class="params">(self, rule, endpoint=None, view_func=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 provide_automatic_options=None, **options)</span>:</span></span><br><span class="line">    <span class="comment"># 如果没有指定endpoint，则会执行_endpoint_from_view_func方法，该方法的就是将被装饰的函数的名字赋给endpoint</span></span><br><span class="line">    <span class="keyword">if</span> endpoint <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        endpoint = _endpoint_from_view_func(view_func)</span><br><span class="line">    <span class="comment"># 如果指定endpoint，则会直接使用传入的endpoint</span></span><br><span class="line">    <span class="comment"># 将endpoint的值赋给options这个字典</span></span><br><span class="line">    options[<span class="string">'endpoint'</span>] = endpoint</span><br><span class="line">    <span class="comment"># 从options中取出请求的methods</span></span><br><span class="line">    methods = options.pop(<span class="string">'methods'</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the methods are not given and the view_func object knows its</span></span><br><span class="line">    <span class="comment"># methods we can use that instead.  If neither exists, we go with</span></span><br><span class="line">    <span class="comment"># a tuple of only ``GET`` as default.</span></span><br><span class="line">    <span class="comment"># 如果methods是空，CBV会传入view函数，因为view函数进过as_view，将其类属性赋给了view</span></span><br><span class="line">    <span class="comment"># 所以如果是CBV的情况下，可以从view中取出methods的属性</span></span><br><span class="line">    <span class="comment"># 如果传入的view_func没有methods属性，则会使用methods=('GET',)</span></span><br><span class="line">    <span class="keyword">if</span> methods <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        methods = getattr(view_func, <span class="string">'methods'</span>, <span class="literal">None</span>) <span class="keyword">or</span> (<span class="string">'GET'</span>,)</span><br><span class="line">    <span class="comment"># 如果methods是字符串的类型，直接抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(methods, string_types):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'Allowed methods have to be iterables of strings, '</span></span><br><span class="line">                        <span class="string">'for example: @app.route(..., methods=["POST"])'</span>)</span><br><span class="line">    <span class="comment"># 循环methods，将methods中的元素，大写后，放入集合中</span></span><br><span class="line">    methods = set(item.upper() <span class="keyword">for</span> item <span class="keyword">in</span> methods)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Methods that should always be added</span></span><br><span class="line">    <span class="comment"># 从视图函数中取required_methods属性，如果没有去的取到，则生成一个空的集合</span></span><br><span class="line">    required_methods = set(getattr(view_func, <span class="string">'required_methods'</span>, ()))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># starting with Flask 0.8 the view_func object can disable and</span></span><br><span class="line">    <span class="comment"># force-enable the automatic options handling.</span></span><br><span class="line">    <span class="comment"># 自动选项管理</span></span><br><span class="line">    <span class="comment"># 如果provide_automatic_options属性时None</span></span><br><span class="line">    <span class="keyword">if</span> provide_automatic_options <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 会先尝试从视图函数中取出provide_automatic_options，如果取到就用取到的结果，没取到就为None</span></span><br><span class="line">        provide_automatic_options = getattr(view_func,</span><br><span class="line">                                            <span class="string">'provide_automtic_options'</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> provide_automatic_options <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 如果OPTIONS不在methods列表中，开启自动选项管理，并将OPTIONS添加到required_methods的集合中</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'OPTIONS'</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:</span><br><span class="line">            provide_automatic_options = <span class="literal">True</span></span><br><span class="line">            required_methods.add(<span class="string">'OPTIONS'</span>)</span><br><span class="line">        <span class="comment"># 如果OPTIONS在methods列表中，将关闭自动选项管理</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            provide_automatic_options = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add the required methods now.</span></span><br><span class="line">    <span class="comment"># 将methods和required_methods进行并集处理，都添加到methods中</span></span><br><span class="line">    <span class="comment"># methods = methods | required_methods</span></span><br><span class="line">    methods |= required_methods</span><br><span class="line"></span><br><span class="line">    <span class="comment"># self.url_rule_class的是是Rule这个类的内存地址，加括号执行产生一个rule的对象</span></span><br><span class="line">    rule = self.url_rule_class(rule, methods=methods, **options)</span><br><span class="line">    <span class="comment"># 为rule这个对象添加一个属性provide_automatic_options</span></span><br><span class="line">    rule.provide_automatic_options = provide_automatic_options</span><br><span class="line">    <span class="comment"># self.url_map=Map() 是一个Map实例，Map实例调用其add方法，将rule对象传入，进行绑定</span></span><br><span class="line">    self.url_map.add(rule)</span><br><span class="line">    <span class="keyword">if</span> view_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># self.view_functions是一个字典，如果里面有值，就取出值，和现有的视图名字进行比较</span></span><br><span class="line">        <span class="comment"># 从字典中取出endpoint对应的视图函数的内存地址</span></span><br><span class="line">        old_func = self.view_functions.get(endpoint)</span><br><span class="line">        <span class="comment"># 如果取出的视图函数存在，且取出的视图的内存地址和当前的视图的内存地址不一样</span></span><br><span class="line">        <span class="comment"># 则表示当前的视图函数的endpoint已经和一个已存在的视图的endpoint重名，抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> old_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> old_func != view_func:</span><br><span class="line">            <span class="keyword">raise</span> AssertionError(<span class="string">'View function mapping is overwriting an '</span></span><br><span class="line">                                 <span class="string">'existing endpoint function: %s'</span> % endpoint)</span><br><span class="line">        <span class="comment"># 其他情况，则在view_functions字典中新增一个endpoint，以当前被装饰的视图函数的endpoint作为key</span></span><br><span class="line">        <span class="comment"># 以当前视图函数的被装饰后的函数的内存地址作为value</span></span><br><span class="line">        self.view_functions[endpoint] = view_func</span><br></pre></td></tr></table></figure>
<h6 id="2-4-4-源码分析：-endpoint-from-view-func"><a href="#2-4-4-源码分析：-endpoint-from-view-func" class="headerlink" title="2.4.4 源码分析：_endpoint_from_view_func"></a>2.4.4 源码分析：_endpoint_from_view_func</h6><blockquote>
<p><strong>_endpoint_from_view_func</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_endpoint_from_view_func</span><span class="params">(view_func)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">assert</span> view_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, <span class="string">'expected view func if endpoint '</span> \</span><br><span class="line">                                  <span class="string">'is not provided.'</span></span><br><span class="line">    <span class="comment"># 返回传入的视图函数的名字</span></span><br><span class="line">    <span class="keyword">return</span> view_func.__name__</span><br></pre></td></tr></table></figure>
<h6 id="2-4-5-源码分析：url-rule-class"><a href="#2-4-5-源码分析：url-rule-class" class="headerlink" title="2.4.5 源码分析：url_rule_class"></a>2.4.5 源码分析：url_rule_class</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 本质就是Rule这个类实例化，产生一个rule对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. flask里把路由相关的：URL，host，适用的HTTP请求方法，endpoint视图都保存到了Rule这个类的实例中</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rule</span><span class="params">(RuleFactory)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, string, defaults=None, subdomain=None, methods=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 build_only=False, endpoint=None, strict_slashes=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 redirect_to=None, alias=False, host=None)</span>:</span></span><br><span class="line">        <span class="comment"># 首先判断app.route传入的URL不是一个以'/'开头的字符串</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> string.startswith(<span class="string">'/'</span>):</span><br><span class="line">            <span class="comment"># 抛出异常</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'urls must start with a leading slash'</span>)</span><br><span class="line">        <span class="comment"># 将app.route传入的URL赋值给rule这个对象</span></span><br><span class="line">        self.rule = string</span><br><span class="line">        <span class="comment"># 记录url是否没有以/结尾</span></span><br><span class="line">        self.is_leaf = <span class="keyword">not</span> string.endswith(<span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line">        self.map = <span class="literal">None</span></span><br><span class="line">        self.strict_slashes = strict_slashes</span><br><span class="line">        self.subdomain = subdomain</span><br><span class="line">        self.host = host</span><br><span class="line">        self.defaults = defaults</span><br><span class="line">        self.build_only = build_only</span><br><span class="line">        self.alias = alias</span><br><span class="line">        <span class="keyword">if</span> methods <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.methods = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(methods, str):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">'param `methods` should be `Iterable[str]`, not `str`'</span>)</span><br><span class="line">            self.methods = set([x.upper() <span class="keyword">for</span> x <span class="keyword">in</span> methods])</span><br><span class="line">            <span class="comment"># 如果methods里面没有head方法，有get方法，则会将head方法添加到methods中</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'HEAD'</span> <span class="keyword">not</span> <span class="keyword">in</span> self.methods <span class="keyword">and</span> <span class="string">'GET'</span> <span class="keyword">in</span> self.methods:</span><br><span class="line">                self.methods.add(<span class="string">'HEAD'</span>)</span><br><span class="line">        <span class="comment"># 将endpoint赋给rule对象</span></span><br><span class="line">        self.endpoint = endpoint</span><br><span class="line">        self.redirect_to = redirect_to</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> defaults:</span><br><span class="line">            self.arguments = set(map(str, defaults))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.arguments = set()</span><br><span class="line">        self._trace = self._converters = self._regex = self._argument_weights = <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<h6 id="2-4-6-源码分析：self-url-map-add-rule"><a href="#2-4-6-源码分析：self-url-map-add-rule" class="headerlink" title="2.4.6 源码分析：self.url_map.add(rule)"></a>2.4.6 源码分析：self.url_map.add(rule)</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 这里url_map是Map类的一个实例，是在app实例化的时候绑定到app实例的</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, rulefactory)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">	将rule实例或RuleFactory实例添加到Map实例并绑定它。要求rule实例未绑定到其他Map实例</span></span><br><span class="line"><span class="string">    :param rulefactory: a :class:`Rule` or :class:`RuleFactory`</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># rulefactory其实就是rule对象，调用rule对象的get_rules方法（本质是一个生成器），并将map这个对象传入</span></span><br><span class="line">    <span class="keyword">for</span> rule <span class="keyword">in</span> rulefactory.get_rules(self):</span><br><span class="line">        <span class="comment"># rule对象调用bind方法，并将map对象传入</span></span><br><span class="line">        <span class="comment"># 这里就控制了一个rule实例只能跟一个map实例进行绑定</span></span><br><span class="line">        rule.bind(self)</span><br><span class="line">        <span class="comment"># 把rule实例append到这个map实例的self._rules列表中</span></span><br><span class="line">        self._rules.append(rule)</span><br><span class="line">        <span class="comment"># 这个map实例的_rules_by_endpoint（是一个控制点）属性的会添加这样一个键值对：rule.endpoint: [rule]</span></span><br><span class="line">        <span class="comment"># 也就是视图对象：[rule实例]</span></span><br><span class="line">        self._rules_by_endpoint.setdefault(rule.endpoint, []).append(rule)</span><br><span class="line">    self._remap = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rules</span><span class="params">(self, map)</span>:</span></span><br><span class="line">    <span class="comment"># 直接返回rule实例</span></span><br><span class="line">    <span class="keyword">yield</span> self</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bind</span><span class="params">(self, map, rebind=False)</span>:</span></span><br><span class="line">    <span class="string">"""Bind the url to a map and create a regular expression based on</span></span><br><span class="line"><span class="string">    the information from the rule itself and the defaults from the map.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :internal:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 如果rule实例自身的map不是None，且</span></span><br><span class="line">    <span class="comment"># 就会抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> self.map <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> rebind:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'url rule %r already bound to map %r'</span> %</span><br><span class="line">                           (self, self.map))</span><br><span class="line">    <span class="comment"># 如果rule实例自身的map是None，就将map实例绑定给rule实例的map属性</span></span><br><span class="line">    self.map = map</span><br><span class="line">    <span class="keyword">if</span> self.strict_slashes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 将map实例的strict_slashes属性值赋给rule实例的strict_slashes</span></span><br><span class="line">        self.strict_slashes = map.strict_slashes</span><br><span class="line">    <span class="keyword">if</span> self.subdomain <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.subdomain = map.default_subdomain</span><br><span class="line">    <span class="comment"># 调用rule实例的compile方法，就要是编译正则表达式并存储它</span></span><br><span class="line">    self.compile()</span><br></pre></td></tr></table></figure>
<h6 id="2-4-7-装饰器执行流程"><a href="#2-4-7-装饰器执行流程" class="headerlink" title="2.4.7 装饰器执行流程"></a>2.4.7 装饰器执行流程</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 第一步：返回内层函数内存地址</span></span><br><span class="line"><span class="string">decorator = @app.route("/user_list", methods=["GET"], endpoint="user_list")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 第二步：将内层函数的内存地址加括号，并将视图函数的内存地址传入</span></span><br><span class="line"><span class="string">decorator(user_list)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="2-4-8-例子代码改写"><a href="#2-4-8-例子代码改写" class="headerlink" title="2.4.8 例子代码改写"></a>2.4.8 例子代码改写</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_list</span><span class="params">()</span>:</span></span><br><span class="line">    url = url_for(<span class="string">'user_detail'</span>, nid=<span class="number">1</span>)</span><br><span class="line">    print(url)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"user_list.html"</span>, user_list=USER_LIST, url=url)</span><br><span class="line"></span><br><span class="line">app.add_url_rule(<span class="string">"/user_list"</span>,<span class="string">"user_list"</span>,user_list)</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="2-5-CBV源码解析"><a href="#2-5-CBV源码解析" class="headerlink" title="2.5 CBV源码解析"></a>2.5 CBV源码解析</h5><h6 id="2-5-1-例子代码"><a href="#2-5-1-例子代码" class="headerlink" title="2.5.1 例子代码"></a>2.5.1 例子代码</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, views, session, redirect</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_auth</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        user = session.get(<span class="string">'user'</span>)</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            res = func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'http://www.baidu.com'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CBVTest</span><span class="params">(views.MethodView)</span>:</span></span><br><span class="line">    <span class="comment"># 可写可不写</span></span><br><span class="line">    methods = [<span class="string">"GET"</span>, <span class="string">"POST"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># decorators = [login_auth, ]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方式一</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"cbv_get"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方式二</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">posttest</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"cbv_post"</span></span><br><span class="line"></span><br><span class="line">    post = posttest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.add_url_rule(<span class="string">"/cbvtest"</span>, view_func=CBVTest.as_view(name=<span class="string">"cbvtest"</span>))</span><br><span class="line"><span class="comment"># name 就是endpoint</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<h6 id="2-5-1-as-view"><a href="#2-5-1-as-view" class="headerlink" title="2.5.1 as_view"></a>2.5.1 as_view</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 由于CBVTest没有重写as_view方法，所以肯定是在其基类（View）里面实现了这个方法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 基类通过as_view方法最终返回一个view函数的内存地址，同时在as_view方法里面将传入name的值赋给了view的__name__属性，将类的__doc__属性赋值给view.__doc__,将类的__module__属性赋给view的__module__,</span></span><br><span class="line"><span class="string">将类中的methods属性赋给了view</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 将view函数加括号执行</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, name, *class_args, **class_kwargs)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    name: 传入的endpoint，就是CBV的别名</span></span><br><span class="line"><span class="string">    class_args: 接受传入的位置参数</span></span><br><span class="line"><span class="string">    class_kwargs：接受传入的关键字参数</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 先实例产生一个自定义类视图的对象，本例中就是CBVTest对象</span></span><br><span class="line">        self = view.view_class(*class_args, **class_kwargs)</span><br><span class="line">        <span class="comment"># 调用对象的dispatch_request进行分发，本质先调用MethodView类中的dispatch_request</span></span><br><span class="line">        <span class="keyword">return</span> self.dispatch_request(*args, **kwargs)</span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 如果类中定义了decorators，先循环decorators用装饰器将view函数进行包裹</span></span><br><span class="line">    <span class="keyword">if</span> cls.decorators:</span><br><span class="line">        view.__name__ = name</span><br><span class="line">        view.__module__ = cls.__module__</span><br><span class="line">        <span class="keyword">for</span> decorator <span class="keyword">in</span> cls.decorators:</span><br><span class="line">            view = decorator(view)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 主要将视图类属性附加给view</span></span><br><span class="line">    view.view_class = cls</span><br><span class="line">    view.__name__ = name</span><br><span class="line">    view.__doc__ = cls.__doc__</span><br><span class="line">    view.__module__ = cls.__module__</span><br><span class="line">    view.methods = cls.methods</span><br><span class="line">    <span class="comment"># 将是否开启自动选项处理的信息赋给view</span></span><br><span class="line">    view.provide_automatic_options = cls.provide_automatic_options</span><br><span class="line">    <span class="keyword">return</span> view</span><br></pre></td></tr></table></figure>
<h6 id="2-5-2-dispatch-request"><a href="#2-5-2-dispatch-request" class="headerlink" title="2.5.2 dispatch_request"></a>2.5.2 dispatch_request</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 使用的是自定义类的基类MethodView类中的dispatch_request方法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 该方法主要是做请求方式与视图函数映射。</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">    <span class="comment"># 其本质就是从视图类中取出对应请求的视图方法</span></span><br><span class="line">    <span class="comment"># 先从自定义类对象中获取请求的方式，如果请求的方式，对象中没有，则meth值为None</span></span><br><span class="line">    meth = getattr(self, request.method.lower(), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If the request method is HEAD and we don't have a handler for it</span></span><br><span class="line">    <span class="comment"># retry with GET.</span></span><br><span class="line">    <span class="comment"># 如果meth值为None，且请求方式为HEAD</span></span><br><span class="line">    <span class="comment"># 尝试去从对象中取出get的属性</span></span><br><span class="line">    <span class="keyword">if</span> meth <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> request.method == <span class="string">'HEAD'</span>:</span><br><span class="line">        meth = getattr(self, <span class="string">'get'</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 断言meth的值不是None，如果没有，则抛出异常</span></span><br><span class="line">    <span class="keyword">assert</span> meth <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, <span class="string">'Unimplemented method %r'</span> % request.method</span><br><span class="line">    <span class="comment"># 返回meth()，就是调用视图类中对应的视图方法</span></span><br><span class="line">    <span class="keyword">return</span> meth(*args, **kwargs)</span><br></pre></td></tr></table></figure>
<h6 id="2-5-3-MethodViewType元类的作用"><a href="#2-5-3-MethodViewType元类的作用" class="headerlink" title="2.5.3 MethodViewType元类的作用"></a>2.5.3 MethodViewType元类的作用</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">主要作用：</span></span><br><span class="line"><span class="string">保证给自定义的视图类，添加methods属性，只要视图类写了，视图函数，且视图函数的名字在</span></span><br><span class="line"><span class="string">['get', 'post', 'head', 'options','delete', 'put', 'trace', 'patch'] </span></span><br><span class="line"><span class="string">就会通过该类给methods添加大写的以上方式</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MethodViewType</span><span class="params">(type)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(cls, name, bases, d)</span>:</span></span><br><span class="line">        super(MethodViewType, cls).__init__(name, bases, d)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果视图类中没有methods属性，则新建一个集合methods</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'methods'</span> <span class="keyword">not</span> <span class="keyword">in</span> d:</span><br><span class="line">            methods = set()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># http_method_funcs ['get', 'post', 'head', 'options','delete', 'put', 'trace', 'patch']                              </span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> http_method_funcs:</span><br><span class="line">                <span class="comment"># 判断类中是否有以上请求方式，如果有，methods里面添加这个请求方式</span></span><br><span class="line">                <span class="keyword">if</span> hasattr(cls, key):</span><br><span class="line">                    methods.add(key.upper())</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> methods:</span><br><span class="line">                <span class="comment"># 将新的methods重新赋给类添加属性methods</span></span><br><span class="line">                cls.methods = methods</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="2-6-add-url-rule参数"><a href="#2-6-add-url-rule参数" class="headerlink" title="2.6 add_url_rule参数"></a>2.6 add_url_rule参数</h5><h6 id="2-6-1-rule"><a href="#2-6-1-rule" class="headerlink" title="2.6.1 rule"></a>2.6.1 rule</h6><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">URL</span>规则,如<span class="string">"/"</span></span><br></pre></td></tr></table></figure>
<h6 id="2-6-2-view-func"><a href="#2-6-2-view-func" class="headerlink" title="2.6.2 view_func"></a>2.6.2 view_func</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">视图函数名称</span><br></pre></td></tr></table></figure>
<h6 id="2-6-3-defaults"><a href="#2-6-3-defaults" class="headerlink" title="2.6.3 defaults"></a>2.6.3 defaults</h6><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">defaults</span> = None, 默认值, 当URL中无参数，函数需要参数时，使用defaults = &#123;<span class="string">'k'</span>: <span class="string">'v'</span>&#125;为函数提供参数</span><br></pre></td></tr></table></figure>
<h6 id="2-6-4-endpoint"><a href="#2-6-4-endpoint" class="headerlink" title="2.6.4 endpoint"></a>2.6.4 endpoint</h6><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">endpoint</span> = None, 名称，用于反向生成URL，即： url_for(<span class="string">'名称'</span>)</span><br></pre></td></tr></table></figure>
<h6 id="2-6-5-methods"><a href="#2-6-5-methods" class="headerlink" title="2.6.5 methods"></a>2.6.5 methods</h6><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">methods</span> = None, 允许的请求方式，如：[<span class="string">"GET"</span>, <span class="string">"POST"</span>]</span><br></pre></td></tr></table></figure>
<h6 id="2-6-6-strict-slashes"><a href="#2-6-6-strict-slashes" class="headerlink" title="2.6.6 strict_slashes"></a>2.6.6 strict_slashes</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">对URL最后的 / 符号是否严格要求</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@app.route('/index', strict_slashes=False)</span></span><br><span class="line"><span class="string">#访问http://www.xx.com/index/ 或http://www.xx.com/index均可</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.route('/index', strict_slashes=True)</span></span><br><span class="line"><span class="string">#仅访问http://www.xx.com/index</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<h6 id="2-6-7-redirect-to"><a href="#2-6-7-redirect-to" class="headerlink" title="2.6.7 redirect_to"></a>2.6.7 redirect_to</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">重定向到指定地址</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@app.route('/index/&lt;int:nid&gt;', redirect_to='/home/&lt;nid&gt;')</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<h6 id="2-6-8-subdomain"><a href="#2-6-8-subdomain" class="headerlink" title="2.6.8 subdomain"></a>2.6.8 subdomain</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">子域名访问</span><br><span class="line">subdomain = <span class="literal">None</span>, </span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">#C:\Windows\System32\drivers\etc\hosts</span></span><br><span class="line"><span class="string">127.0.0.1       www.liuqingzheng.com</span></span><br><span class="line"><span class="string">127.0.0.1       admin.liuqingzheng.com</span></span><br><span class="line"><span class="string">127.0.0.1       buy.liuqingzheng.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">from flask import Flask, views, url_for</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app = Flask(import_name=__name__)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app.config['SERVER_NAME'] = 'liuqingzheng.com:5000'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.route("/", subdomain="admin")</span></span><br><span class="line"><span class="string">def static_index():</span></span><br><span class="line"><span class="string">    """Flask supports static subdomains</span></span><br><span class="line"><span class="string">    This is available at static.your-domain.tld"""</span></span><br><span class="line"><span class="string">    return "static.your-domain.tld"</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">#可以传入任意的字符串，如传入的字符串为aa，显示为 aa.liuqingzheng.com</span></span><br><span class="line"><span class="string">@app.route("/dynamic", subdomain="&lt;username&gt;")</span></span><br><span class="line"><span class="string">def username_index(username):</span></span><br><span class="line"><span class="string">    """Dynamic subdomains are also supported</span></span><br><span class="line"><span class="string">    Try going to user1.your-domain.tld/dynamic"""</span></span><br><span class="line"><span class="string">    return username + ".your-domain.tld"</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">if __name__ == '__main__':</span></span><br><span class="line"><span class="string">	app.run()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">访问：</span></span><br><span class="line"><span class="string">http://www.liuqingzheng.com:5000/dynamic</span></span><br><span class="line"><span class="string">http://admin.liuqingzheng.com:5000/dynamic</span></span><br><span class="line"><span class="string">http://buy.liuqingzheng.com:5000/dynamic</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="三-Flask的模板语言-依赖于jinjia2"><a href="#三-Flask的模板语言-依赖于jinjia2" class="headerlink" title="三.Flask的模板语言(依赖于jinjia2)"></a>三.Flask的模板语言(依赖于jinjia2)</h4><h5 id="3-1-和django模板的不同"><a href="#3-1-和django模板的不同" class="headerlink" title="3.1 和django模板的不同"></a>3.1 和django模板的不同</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">比django中多可以加括号，执行函数，传参数</span><br></pre></td></tr></table></figure>
<h5 id="3-2-实例"><a href="#3-2-实例" class="headerlink" title="3.2 实例"></a>3.2 实例</h5><h6 id="3-2-1-视图"><a href="#3-2-1-视图" class="headerlink" title="3.2.1 视图"></a>3.2.1 视图</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, Markup, jsonify, make_response</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(arg)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Markup(<span class="string">"&lt;input type='text' value='%s' /&gt;"</span> % (arg,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span><span class="params">(arg)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&lt;input type='text' value='%s' /&gt;"</span> % (arg,)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, f1=func1, f2=func2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8001</span>)</span><br></pre></td></tr></table></figure>
<h6 id="3-2-2-模板"><a href="#3-2-2-模板" class="headerlink" title="3.2.2 模板"></a>3.2.2 模板</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">&#123;&#123;f1&#125;&#125;</span><br><span class="line">&#123;&#123;f1("zhang")&#125;&#125;</span><br><span class="line">&#123;&#123;f2("zhang")&#125;&#125;</span><br><span class="line">&#123;&#123;f2("zhang")|safe&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-3-flask处理了xss攻击-如果想显示原生html"><a href="#3-3-flask处理了xss攻击-如果想显示原生html" class="headerlink" title="3.3 flask处理了xss攻击,如果想显示原生html"></a>3.3 flask处理了xss攻击,如果想显示原生html</h5><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">safe:</span>模板中</span><br><span class="line"><span class="symbol">Markup:</span>后台处理</span><br></pre></td></tr></table></figure>
<h5 id="3-4-注意"><a href="#3-4-注意" class="headerlink" title="3.4 注意"></a>3.4 注意</h5><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>Markup等价django的mark_safe</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span><span class="keyword">extends</span>,<span class="meta"><span class="meta-keyword">include</span>一模一样</span></span><br></pre></td></tr></table></figure>
<h5 id="3-5-标签：template-global"><a href="#3-5-标签：template-global" class="headerlink" title="3.5 标签：template_global"></a>3.5 标签：template_global</h5><h6 id="3-5-1-使用"><a href="#3-5-1-使用" class="headerlink" title="3.5.1 使用"></a>3.5.1 使用</h6><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">通过template_global装饰后，可以直接在模板html文件中通过&#123;&#123;标签名(参数,参数)&#125;&#125;使用</span><br><span class="line"><span class="symbol">eg:</span></span><br><span class="line">&#123;&#123;<span class="keyword">add</span>(<span class="number">1</span>,<span class="number">2</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.template_global()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> a+b</span><br></pre></td></tr></table></figure>
<h6 id="3-5-2-实例"><a href="#3-5-2-实例" class="headerlink" title="3.5.2 实例"></a>3.5.2 实例</h6><blockquote>
<p>html</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">&#123;&#123; add(1,2) &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>view</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.template_global()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/index", methods=["GET"], endpoint="index")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5033</span>)</span><br></pre></td></tr></table></figure>
<h5 id="3-6-过滤器：template-filter"><a href="#3-6-过滤器：template-filter" class="headerlink" title="3.6 过滤器：template_filter"></a>3.6 过滤器：template_filter</h5><h6 id="3-6-1-使用"><a href="#3-6-1-使用" class="headerlink" title="3.6.1 使用"></a>3.6.1 使用</h6><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">通过template_filter装饰后，可以直接在模板html文件中通过&#123;&#123; 参数<span class="number">1</span> | 标签名(参数<span class="number">2</span>,参数<span class="number">3</span>)&#125;&#125;使用</span><br><span class="line">eg：</span><br><span class="line">&#123;&#123; <span class="number">1</span>|add(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>) &#125;&#125;</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">django中过滤器最多传<span class="number">2</span>个参数，但是flask可以传任意个参数</span><br></pre></td></tr></table></figure>
<h6 id="3-6-2-实例"><a href="#3-6-2-实例" class="headerlink" title="3.6.2 实例"></a>3.6.2 实例</h6><blockquote>
<p>html</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">&#123;&#123; 1|add(2,3) &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>view</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.template_filter()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a, b, c, d)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> a + b + c + d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/index", methods=["GET"], endpoint="index")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5033</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="四-Flask的请求与响应"><a href="#四-Flask的请求与响应" class="headerlink" title="四. Flask的请求与响应"></a>四. Flask的请求与响应</h4><h5 id="4-1-request"><a href="#4-1-request" class="headerlink" title="4.1 request"></a>4.1 request</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 请求相关信息</span></span><br><span class="line"><span class="comment"># request.method         请求方式</span></span><br><span class="line"><span class="comment"># request.args           GET传入的数据</span></span><br><span class="line"><span class="comment"># request.form           接受非json格式外的post传入的数据</span></span><br><span class="line"><span class="comment"># request.json           接受json的数据格式</span></span><br><span class="line"><span class="comment"># request.values         接受所有的非json传入的数据</span></span><br><span class="line"><span class="comment"># request.cookies        传入的cookie</span></span><br><span class="line"><span class="comment"># request.headers        请求头</span></span><br><span class="line"><span class="comment"># request.path           传入的路径，不包含get方式传入的数据</span></span><br><span class="line"><span class="comment"># request.full_path      传入的完全路径，包含get方式传入的数据</span></span><br><span class="line"><span class="comment"># request.script_root    </span></span><br><span class="line"><span class="comment"># request.url            传入的包含主机和端口的完整路径               </span></span><br><span class="line"><span class="comment"># request.base_url       传入包含主机和端口的路径，不包含get方式传入的数据</span></span><br><span class="line"><span class="comment"># request.url_root       传入的包含主机和端口的根路径</span></span><br><span class="line"><span class="comment"># request.host_url       传入包含主机和端口的主机路径</span></span><br><span class="line"><span class="comment"># request.host           传入的主机地址</span></span><br><span class="line"><span class="comment"># request.files          传入的文件</span></span><br><span class="line"><span class="comment"># obj = request.files['the_file_name']</span></span><br><span class="line"><span class="comment"># obj.save('/var/www/uploads/' + secure_filename(f.filename))</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">    请求方式：post</span></span><br><span class="line"><span class="string">    127.0.0.1:5000/login.html?name=zcg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    传入数据为：json</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        "sex":"male",</span></span><br><span class="line"><span class="string">        "age":18</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    传入数据为：formdata</span></span><br><span class="line"><span class="string">    ('name', 'wangjinshu')</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="comment"># 请求相关信息http://127.0.0.1:5000/login.html?name=zcg</span></span><br><span class="line">print(request.method)</span><br><span class="line"><span class="comment"># GET/POST</span></span><br><span class="line">print(request.args)</span><br><span class="line"><span class="comment"># ImmutableMultiDict([('name', 'zcg')])</span></span><br><span class="line">print(request.form)</span><br><span class="line"><span class="comment"># ImmutableMultiDict([('name', 'wangjinshu')])</span></span><br><span class="line">print(request.json)  <span class="comment"># 取出ajax传入的json的数据</span></span><br><span class="line"><span class="comment"># &#123;'sex': 'male', 'age': 18&#125;</span></span><br><span class="line">print(request.values)</span><br><span class="line"><span class="comment"># CombinedMultiDict([ImmutableMultiDict([('name', 'zcg')]), ImmutableMultiDict([('name', 'wangjinshu')])])</span></span><br><span class="line">print(request.cookies)</span><br><span class="line"><span class="comment"># &#123;&#125;</span></span><br><span class="line">print(request.headers)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">    Host: 127.0.0.1:5000</span></span><br><span class="line"><span class="string">    Connection: keep-alive</span></span><br><span class="line"><span class="string">    Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string">    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36</span></span><br><span class="line"><span class="string">    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span></span><br><span class="line"><span class="string">    Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="string">    Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">print(request.path)</span><br><span class="line"><span class="comment"># /login.html</span></span><br><span class="line">print(request.full_path)</span><br><span class="line"><span class="comment"># /login.html?name=zcg</span></span><br><span class="line">print(request.script_root, <span class="string">"1"</span>)</span><br><span class="line">print(request.url, <span class="string">"2"</span>)</span><br><span class="line"><span class="comment"># http://127.0.0.1:5000/login.html?name=zcg</span></span><br><span class="line">print(request.base_url, <span class="string">"3"</span>)</span><br><span class="line"><span class="comment"># http://127.0.0.1:5000/login.html</span></span><br><span class="line">print(request.url_root, <span class="string">"4"</span>)</span><br><span class="line"><span class="comment"># http://127.0.0.1:5000/</span></span><br><span class="line">print(request.host_url, <span class="string">"5"</span>)</span><br><span class="line"><span class="comment"># http://127.0.0.1:5000/</span></span><br><span class="line">print(request.host, <span class="string">"6"</span>)</span><br><span class="line"><span class="comment"># 127.0.0.1:5000</span></span><br><span class="line">print(request.files, <span class="string">"7"</span>)</span><br><span class="line"><span class="comment"># ImmutableMultiDict([])</span></span><br></pre></td></tr></table></figure>
<h5 id="4-2-response"><a href="#4-2-response" class="headerlink" title="4.2 response"></a>4.2 response</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># return "字符串"</span></span><br><span class="line"><span class="comment"># return render_template('html模板路径',**&#123;&#125;)</span></span><br><span class="line"><span class="comment"># return redirect('/index.html')</span></span><br><span class="line"><span class="comment"># return jsonify(&#123;'k1':'v1'&#125;)</span></span><br></pre></td></tr></table></figure>
<h5 id="4-3-往响应头里面加东西"><a href="#4-3-往响应头里面加东西" class="headerlink" title="4.3 往响应头里面加东西"></a>4.3 往响应头里面加东西</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from flask import make_response</span></span><br><span class="line"><span class="comment"># response = make_response(render_template('index.html'))</span></span><br><span class="line"><span class="comment"># response是flask.wrappers.Response类型</span></span><br><span class="line"><span class="comment"># response.delete_cookie('key')</span></span><br><span class="line"><span class="comment"># response.set_cookie('key', 'value')</span></span><br><span class="line"><span class="comment"># response.headers['X-Something'] = 'A value'</span></span><br><span class="line"><span class="comment"># return response</span></span><br></pre></td></tr></table></figure>
<h5 id="4-4-参考实例"><a href="#4-4-参考实例" class="headerlink" title="4.4 参考实例"></a>4.4 参考实例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login.html', methods=['GET', "POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    请求方式：post</span></span><br><span class="line"><span class="string">    127.0.0.1:5000/login.html?name=zcg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    传入数据为：json</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        "sex":"male",</span></span><br><span class="line"><span class="string">        "age":18</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    传入数据为：formdata</span></span><br><span class="line"><span class="string">    ('name', 'wangjinshu')</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 请求相关信息http://127.0.0.1:5000/login.html?name=zcg</span></span><br><span class="line">    print(request.method)</span><br><span class="line">    <span class="comment"># GET</span></span><br><span class="line">    print(request.args)</span><br><span class="line">    <span class="comment"># ImmutableMultiDict([('name', 'zcg')])</span></span><br><span class="line">    print(request.form)</span><br><span class="line">    <span class="comment"># ImmutableMultiDict([('name', 'wangjinshu')])</span></span><br><span class="line">    print(request.json)  <span class="comment"># 取出ajax传入的json的数据</span></span><br><span class="line">    <span class="comment"># &#123;'sex': 'male', 'age': 18&#125;</span></span><br><span class="line">    print(request.values)</span><br><span class="line">    <span class="comment"># CombinedMultiDict([ImmutableMultiDict([('name', 'zcg')]), ImmutableMultiDict([('name', 'wangjinshu')])])</span></span><br><span class="line">    print(request.cookies)</span><br><span class="line">    <span class="comment"># &#123;&#125;</span></span><br><span class="line">    print(request.headers)</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Host: 127.0.0.1:5000</span></span><br><span class="line"><span class="string">    Connection: keep-alive</span></span><br><span class="line"><span class="string">    Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string">    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36</span></span><br><span class="line"><span class="string">    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span></span><br><span class="line"><span class="string">    Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="string">    Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    print(request.path)</span><br><span class="line">    <span class="comment"># /login.html</span></span><br><span class="line">    print(request.full_path)</span><br><span class="line">    <span class="comment"># /login.html?name=zcg</span></span><br><span class="line">    print(request.script_root, <span class="string">"1"</span>)</span><br><span class="line">    print(request.url, <span class="string">"2"</span>)</span><br><span class="line">    <span class="comment"># http://127.0.0.1:5000/login.html?name=zcg</span></span><br><span class="line">    print(request.base_url, <span class="string">"3"</span>)</span><br><span class="line">    <span class="comment"># http://127.0.0.1:5000/login.html</span></span><br><span class="line">    print(request.url_root, <span class="string">"4"</span>)</span><br><span class="line">    <span class="comment"># http://127.0.0.1:5000/</span></span><br><span class="line">    print(request.host_url, <span class="string">"5"</span>)</span><br><span class="line">    <span class="comment"># http://127.0.0.1:5000/</span></span><br><span class="line">    print(request.host, <span class="string">"6"</span>)</span><br><span class="line">    <span class="comment"># 127.0.0.1:5000</span></span><br><span class="line">    print(request.files, <span class="string">"7"</span>)</span><br><span class="line">    <span class="comment"># ImmutableMultiDict([])</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># obj = request.files['the_file_name']</span></span><br><span class="line">    <span class="comment"># obj.save('/var/www/uploads/' + secure_filename(f.filename))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 响应相关信息</span></span><br><span class="line">    <span class="comment"># return "字符串"</span></span><br><span class="line">    <span class="comment"># return render_template('html模板路径',**&#123;&#125;)</span></span><br><span class="line">    <span class="comment"># return redirect('/index.html')</span></span><br><span class="line">    <span class="comment"># return jsonify(&#123;'k1': 'v1'&#125;)</span></span><br><span class="line"></span><br><span class="line">    response = make_response(jsonify(&#123;<span class="string">'k1'</span>: <span class="string">'v1'</span>&#125;))</span><br><span class="line">    <span class="comment"># response是flask.wrappers.Response类型</span></span><br><span class="line">    <span class="comment"># response.delete_cookie('key')</span></span><br><span class="line">    response.set_cookie(<span class="string">'key'</span>, <span class="string">'value'</span>)</span><br><span class="line">    response.headers[<span class="string">'X-Something'</span>] = <span class="string">'A value'</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line">    <span class="comment"># return "内容"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="五-session"><a href="#五-session" class="headerlink" title="五.session"></a>五.session</h4><h5 id="5-1-使用-一定要加盐"><a href="#5-1-使用-一定要加盐" class="headerlink" title="5.1 使用:一定要加盐"></a>5.1 使用:一定要加盐</h5><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">设置值:session[<span class="string">'user'</span>]=<span class="string">'lqz'</span></span><br><span class="line">删除值:</span><br><span class="line">    session.pop(<span class="string">'username'</span>, <span class="symbol">None</span>)</span><br><span class="line">    del session[<span class="string">'user'</span>]</span><br><span class="line">取值:session[<span class="string">'user'</span>]</span><br></pre></td></tr></table></figure>
<h5 id="5-2-实例"><a href="#5-2-实例" class="headerlink" title="5.2 实例"></a>5.2 实例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, redirect, session, request, url_for</span><br><span class="line">.....</span><br><span class="line">app.secret_key = <span class="string">"zhang"</span></span><br><span class="line"></span><br><span class="line">session[<span class="string">'username'</span>] ＝ <span class="string">'xxx'</span></span><br><span class="line"></span><br><span class="line">session[<span class="string">'username'</span>]</span><br><span class="line">session.get(<span class="string">"username"</span>)</span><br><span class="line"></span><br><span class="line">session.pop(<span class="string">'username'</span>, <span class="literal">None</span>)</span><br><span class="line"><span class="keyword">del</span> session[<span class="string">'username'</span>]</span><br></pre></td></tr></table></figure>
<h5 id="5-3-session源码分析之wsgi-app"><a href="#5-3-session源码分析之wsgi-app" class="headerlink" title="5.3 session源码分析之wsgi_app"></a>5.3 session源码分析之wsgi_app</h5><h6 id="1-流程分析"><a href="#1-流程分析" class="headerlink" title="1. 流程分析"></a>1. 流程分析</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">wsgi_app</span><br><span class="line">请求过来的时候，flask 会根据 cookie 信息创建出 session 变量（如果 cookie 不存在，这个变量有可能为空），保存在该请求的上下文中</span><br><span class="line"></span><br><span class="line">视图函数可以获取 session 中的信息，实现自己的逻辑处理</span><br><span class="line"></span><br><span class="line">flask 会在发送 response 的时候，根据 session 的值，把它写回到 cookie 中</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctx.push()</span></span><br><span class="line">请求过来的时候，flask 会根据 cookie 信息创建出 session 变量（如果 cookie 不存在，这个变量有可能为空），保存在该请求的上下文中</span><br><span class="line"></span><br><span class="line"><span class="comment"># response = self.full_dispatch_request()</span></span><br><span class="line">flask 会在发送 response 的时候，根据 session 的值，把它写回到 cookie 中</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctx.auto_pop(error)</span></span><br></pre></td></tr></table></figure>
<h6 id="2-wsgi-app"><a href="#2-wsgi-app" class="headerlink" title="2.  wsgi_app"></a>2.  wsgi_app</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">    <span class="comment"># 返回RequestContext(self, environ)对象，初始化的时候做了好多事情</span></span><br><span class="line">    <span class="comment"># 最主要生成一个request对象和一个session对象，并赋给了对象ctx</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 执行RequestContext对象的push方法</span></span><br><span class="line">            ctx.push()</span><br><span class="line">            </span><br><span class="line">            response = self.full_dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error = e</span><br><span class="line">            response = self.handle_exception(e)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            error = sys.exc_info()[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">            error = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 删除请求的ctx和app_ctx</span></span><br><span class="line">        ctx.auto_pop(error)</span><br></pre></td></tr></table></figure>
<h5 id="5-4-session源码分析之：ctx-self-request-context-environ"><a href="#5-4-session源码分析之：ctx-self-request-context-environ" class="headerlink" title="5.4 session源码分析之：ctx = self.request_context(environ)"></a>5.4 session源码分析之：ctx = self.request_context(environ)</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">self.session = None</span></span><br><span class="line"><span class="string">会产生一个空session赋给RequestContext类对象ctx</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app, environ, request=None)</span>:</span></span><br><span class="line">        <span class="comment"># app就是Flask的对象，environ就是传入的http协议相关请求参数（字典）</span></span><br><span class="line">        <span class="comment"># 将Flask的对象赋给RequestContext类对象的app属性</span></span><br><span class="line">        self.app = app</span><br><span class="line">        <span class="keyword">if</span> request <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># app.request_class就是Request类，Request(environ)实例化产生一个request对象</span></span><br><span class="line">            <span class="comment"># from flask.wrappers import RequestBase</span></span><br><span class="line">            request = app.request_class(environ)</span><br><span class="line">        <span class="comment"># 将产生的request对象赋给RequestContext类对象的request属性</span></span><br><span class="line">        self.request = request</span><br><span class="line">        <span class="comment"># 将MapAdapter的对象，就是将map对象的属性映射到MapAdapter对象的属性上</span></span><br><span class="line">        <span class="comment"># 将ctx的属性url_adapter赋值为MapAdapter的对象</span></span><br><span class="line">        self.url_adapter = app.create_url_adapter(self.request)</span><br><span class="line">        self.flashes = <span class="literal">None</span></span><br><span class="line">        self.session = <span class="literal">None</span></span><br><span class="line">		.......</span><br><span class="line">        <span class="comment"># 将请求路径和请求的endpoint以及参数和request做个关联</span></span><br><span class="line">        self.match_request()</span><br></pre></td></tr></table></figure>
<h5 id="5-5-session源码分析之：ctx-push"><a href="#5-5-session源码分析之：ctx-push" class="headerlink" title="5.5 session源码分析之：ctx.push()"></a>5.5 session源码分析之：ctx.push()</h5><h6 id="1-ctx-push"><a href="#1-ctx-push" class="headerlink" title="1. ctx.push()"></a>1. ctx.push()</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">self.session = session_interface.open_session(</span></span><br><span class="line"><span class="string">            self.app, self.request</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">会将接受一个字典里面包含cookie反解过后的数据，放入</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">	.......</span><br><span class="line">    <span class="comment"># 由于每次请求都会初始化创建ctx，因此session都为None</span></span><br><span class="line">    <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># # session_interface = SecureCookieSessionInterface(),</span></span><br><span class="line">        <span class="comment"># 即session_interface就是一个SecureCookieSessionInterface类的实例对象</span></span><br><span class="line">        <span class="comment"># 在 Flask 中，所有和 session 有关的调用，都是转发到 self.session_interface 的方法调用上（这样用户就能用自定义的 session_interface 来控制 session 的使用）</span></span><br><span class="line">        </span><br><span class="line">        session_interface = self.app.session_interface</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 第一次访问：生成一个 字典(容器) 返回至 self.session，如果没有加盐返回一个None</span></span><br><span class="line">        self.session = session_interface.open_session(</span><br><span class="line">            self.app, self.request</span><br><span class="line">        )</span><br><span class="line">		<span class="comment"># make_null_session 来生成一个空的 session，这个特殊的 session 不能进行任何读写操作，不然会报异常给用户。</span></span><br><span class="line">        <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.session = session_interface.make_null_session(self.app)</span><br></pre></td></tr></table></figure>
<h6 id="2-open-session"><a href="#2-open-session" class="headerlink" title="2. open_session"></a>2. open_session</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">本质就是返回一个SecureCookieSession类的实例对象，其实可以当做就是一个特殊的字典</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">第一次访问时：就返回一个空字典</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">第二次访问时：通过解密算法，反解出cookie包含色session信息</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_session</span><span class="params">(self, app, request)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取加解密对象，就是加的盐</span></span><br><span class="line">    s = self.get_signing_serializer(app)</span><br><span class="line">    <span class="keyword">if</span> s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 如果没有盐，则返回None</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 从 cookie 中获取 session 的value</span></span><br><span class="line">    val = request.cookies.get(app.session_cookie_name)</span><br><span class="line">    <span class="comment"># 如果cookie没有值</span></span><br><span class="line">    <span class="comment"># 第一次访问为空执行</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> val:</span><br><span class="line">        <span class="comment"># 生成一个 SecureCookieSession类的实例对象，用于保存用户的session数据。</span></span><br><span class="line">        <span class="comment">#  SecureCookieSession类其实就是一个特殊的字典</span></span><br><span class="line">        <span class="comment"># 返回&#123;&#125;</span></span><br><span class="line">        <span class="keyword">return</span> self.session_class()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第二次访问</span></span><br><span class="line">    max_age = total_seconds(app.permanent_session_lifetime)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 解密返回原始数据</span></span><br><span class="line">        data = s.loads(val, max_age=max_age)</span><br><span class="line">        <span class="comment"># 返回一个含有cookie信息的 SecureCookieSession 类实例</span></span><br><span class="line">        <span class="keyword">return</span> self.session_class(data)</span><br><span class="line">    <span class="keyword">except</span> BadSignature:</span><br><span class="line">        <span class="keyword">return</span> self.session_class()</span><br></pre></td></tr></table></figure>
<h5 id="5-6-session源码分析之：response-self-full-dispatch-request"><a href="#5-6-session源码分析之：response-self-full-dispatch-request" class="headerlink" title="5.6 session源码分析之：response = self.full_dispatch_request()"></a>5.6 session源码分析之：response = self.full_dispatch_request()</h5><h6 id="1-full-dispatch-request"><a href="#1-full-dispatch-request" class="headerlink" title="1. full_dispatch_request"></a>1. full_dispatch_request</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">主要是处理视图，以及请求拓展，信号钩子函数，最后返回一个response对象</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">full_dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line">	.......</span><br><span class="line">    <span class="comment"># 视图函数的返回值当做参数传入，返回一个response并触发后续处理函数,完成request请求。</span></span><br><span class="line">    <span class="keyword">return</span> self.finalize_request(rv)</span><br></pre></td></tr></table></figure>
<h6 id="2-self-finalize-request-rv"><a href="#2-self-finalize-request-rv" class="headerlink" title="2. self.finalize_request(rv)"></a>2. self.finalize_request(rv)</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">产生一个response对象，并为其执行请求过后的一些操作</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finalize_request</span><span class="params">(self, rv, from_error_handler=False)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 包装一个response的对象</span></span><br><span class="line">    response = self.make_response(rv)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = self.process_response(response)</span><br><span class="line">        <span class="comment"># 触发 request_finished 信号</span></span><br><span class="line">        request_finished.send(self, response=response)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        ....</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h6 id="3-response-self-process-response-response"><a href="#3-response-self-process-response-response" class="headerlink" title="3. response = self.process_response(response)"></a>3. response = self.process_response(response)</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">执行SecureCookieSessionInterface类对象的save_session方法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">将 self.session 这个字典序列化，并返回，写入到客户端浏览器的cookie中</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, response)</span>:</span></span><br><span class="line">.......</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> self.session_interface.is_null_session(ctx.session):</span><br><span class="line">          <span class="comment">#  将 self.session 这个字典序列化，并返回，写入到客户端浏览器的cookie中</span></span><br><span class="line">          self.session_interface.save_session(self, ctx.session, response)</span><br><span class="line">      <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h6 id="4-save-session-self-ctx-session-response"><a href="#4-save-session-self-ctx-session-response" class="headerlink" title="4. save_session(self, ctx.session, response)"></a>4. save_session(self, ctx.session, response)</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">判断session是否为空，如果为空，则不设置cookie</span></span><br><span class="line"><span class="string">如果session发生变化，就需要修改session，并返回新的session对象</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_session</span><span class="params">(self, app, session, response)</span>:</span></span><br><span class="line">    domain = self.get_cookie_domain(app)</span><br><span class="line">    path = self.get_cookie_path(app)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If the session is modified to be empty, remove the cookie.</span></span><br><span class="line">    <span class="comment"># If the session is empty, return without setting the cookie.</span></span><br><span class="line">    <span class="comment"># 如果 session 变成了空字典，flask 会直接删除对应的 cookie</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session:</span><br><span class="line">        <span class="keyword">if</span> session.modified:</span><br><span class="line">            response.delete_cookie(</span><br><span class="line">                app.session_cookie_name,</span><br><span class="line">                domain=domain,</span><br><span class="line">                path=path</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add a "Vary: Cookie" header if the session was accessed at all.</span></span><br><span class="line">    <span class="comment"># 是否需要设置 cookie。如果 session 发生了变化，就一定要更新 cookie，</span></span><br><span class="line">    <span class="comment"># 否则用户可以 `SESSION_REFRESH_EACH_REQUEST` 变量控制是否要设置 cookie</span></span><br><span class="line">    <span class="keyword">if</span> session.accessed:</span><br><span class="line">        response.vary.add(<span class="string">'Cookie'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.should_set_cookie(app, session):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    httponly = self.get_cookie_httponly(app)</span><br><span class="line">    secure = self.get_cookie_secure(app)</span><br><span class="line">    samesite = self.get_cookie_samesite(app)</span><br><span class="line">    expires = self.get_expiration_time(app, session)</span><br><span class="line">    <span class="comment"># 将session通过加密算法生成加密字符串</span></span><br><span class="line">    val = self.get_signing_serializer(app).dumps(dict(session))</span><br><span class="line">    <span class="comment"># 为响应头添加cookie信息</span></span><br><span class="line">    response.set_cookie(</span><br><span class="line">        app.session_cookie_name,</span><br><span class="line">        val,</span><br><span class="line">        expires=expires,</span><br><span class="line">        httponly=httponly,</span><br><span class="line">        domain=domain,</span><br><span class="line">        path=path,</span><br><span class="line">        secure=secure,</span><br><span class="line">        samesite=samesite</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="六-闪现-message"><a href="#六-闪现-message" class="headerlink" title="六. 闪现(message)"></a>六. 闪现(message)</h4><h5 id="6-1-作用"><a href="#6-1-作用" class="headerlink" title="6.1 作用"></a>6.1 作用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">假设在a页面操作出错，跳转到b页面，在b页面显示a页面的错误信息</span><br><span class="line">本质是基于session现将设置的值，存起来，当get_flashed_messages取出值后，会自动删除值，所以在不同的浏览器访问，不会出现错乱。</span><br></pre></td></tr></table></figure>
<h5 id="6-2-设置值"><a href="#6-2-设置值" class="headerlink" title="6.2 设置值"></a>6.2 设置值</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 普通设置</span><br><span class="line">flash(<span class="string">'aaa'</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 分类设置</span><br><span class="line">flash(<span class="string">'你的名字不是lqz是%s'</span>,category=<span class="string">'aa'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="6-3-取值"><a href="#6-3-取值" class="headerlink" title="6.3 取值"></a>6.3 取值</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 普通取值</span><br><span class="line">get_flashed_message()</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 分类取值</span><br><span class="line">get_flashed_messages(category_filter=[<span class="string">'aa'</span>,])</span><br></pre></td></tr></table></figure>
<h5 id="6-4-实例"><a href="#6-4-实例" class="headerlink" title="6.4 实例"></a>6.4 实例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, url_for, flash, get_flashed_messages</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.secret_key = <span class="string">"zhang"</span></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/index", endpoint="index", methods=["GET", "POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 设置闪现的值</span></span><br><span class="line">    flash(<span class="string">"hello"</span>, category=<span class="string">"test"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ok"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/test", endpoint="test", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 取出闪现的值</span></span><br><span class="line">    res = get_flashed_messages(category_filter=[<span class="string">"test"</span>])</span><br><span class="line">    <span class="keyword">return</span> res[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="七-请求拓展（类似于django中的中间件）"><a href="#七-请求拓展（类似于django中的中间件）" class="headerlink" title="七. 请求拓展（类似于django中的中间件）"></a>七. 请求拓展（类似于django中的中间件）</h4><h5 id="7-1-before-request"><a href="#7-1-before-request" class="headerlink" title="7.1 before_request"></a>7.1 before_request</h5><h6 id="7-1-1-作用"><a href="#7-1-1-作用" class="headerlink" title="7.1.1 作用"></a>7.1.1 作用</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">类比django中间件中的process_request,在请求收到之前绑定一个函数做一些事情</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于它做用户登录认证</span></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.path == <span class="string">"/login"</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    user = session.get(<span class="string">"user_info"</span>)</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">"/login"</span>)</span><br></pre></td></tr></table></figure>
<h5 id="7-2-after-request"><a href="#7-2-after-request" class="headerlink" title="7.2 after_request"></a>7.2 after_request</h5><h6 id="7-2-1-作用"><a href="#7-2-1-作用" class="headerlink" title="7.2.1 作用"></a>7.2.1 作用</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">类比于django中间件中的process_response,每一个请求的之后绑定一个函数，如果请求没有异常。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.after_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(response)</span>:</span></span><br><span class="line">    print(<span class="string">"process_response 走了"</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h5 id="7-3-before-first-request"><a href="#7-3-before-first-request" class="headerlink" title="7.3 before_first_request"></a>7.3 before_first_request</h5><h6 id="7-3-1-作用"><a href="#7-3-1-作用" class="headerlink" title="7.3.1 作用"></a>7.3.1 作用</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">第一次请求时，和浏览器无关</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">first</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h5 id="7-4-teardown-request"><a href="#7-4-teardown-request" class="headerlink" title="7.4 teardown_request"></a>7.4 teardown_request</h5><h6 id="7-4-1-作用"><a href="#7-4-1-作用" class="headerlink" title="7.4.1 作用"></a>7.4.1 作用</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每一个请求之后绑定一个函数，即使遇到了异常</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.teardown_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ter</span><span class="params">(e)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h6 id="7-4-2-实例"><a href="#7-4-2-实例" class="headerlink" title="7.4.2 实例"></a>7.4.2 实例</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, flash, get_flashed_messages</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="comment"># app.debug = True</span></span><br><span class="line">app.secret_key = <span class="string">'ssss'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问index页面传参数name=lqz,如果不是lqz,出错,跳转到order页面,显示错误信息</span></span><br><span class="line"><span class="meta">@app.route('/index')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    m</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello_index"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问路径不存在时的处理函数</span></span><br><span class="line"><span class="meta">@app.errorhandler(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">(e)</span>:</span></span><br><span class="line">    print(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"404请求的页面不存在"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务器内部错误时响应的方法</span></span><br><span class="line"><span class="meta">@app.errorhandler(500)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error_500</span><span class="params">(e)</span>:</span></span><br><span class="line">    print(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"服务器内部错误"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 即使遇到异常都会走到此函数</span></span><br><span class="line"><span class="meta">@app.teardown_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evedone</span><span class="params">(f)</span>:</span></span><br><span class="line">    print(<span class="string">"teardown_request执行了"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8008</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">执行结果：</span></span><br><span class="line"><span class="string">name 'm' is not defined</span></span><br><span class="line"><span class="string">teardown_request执行了</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="7-5-errorhandler"><a href="#7-5-errorhandler" class="headerlink" title="7.5 errorhandler"></a>7.5 errorhandler</h5><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">路径不存在时<span class="number">404</span>，服务器内部错误<span class="number">500</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error_404</span><span class="params">(arg)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">"404错误了"</span></span><br></pre></td></tr></table></figure>
<h6 id="7-5-1-实例"><a href="#7-5-1-实例" class="headerlink" title="7.5.1 实例"></a>7.5.1 实例</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line">app.secret_key = <span class="string">'ssss'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问index页面传参数name=lqz,如果不是lqz,出错,跳转到order页面,显示错误信息</span></span><br><span class="line"><span class="meta">@app.route('/index')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    m</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello_index"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问路径不存在时的处理函数</span></span><br><span class="line"><span class="meta">@app.errorhandler(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">(e)</span>:</span></span><br><span class="line">    print(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"404请求的页面不存在"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务器内部错误时响应的方法</span></span><br><span class="line"><span class="meta">@app.errorhandler(500)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error_500</span><span class="params">(e)</span>:</span></span><br><span class="line">    print(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"服务器内部错误"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8008</span>)</span><br></pre></td></tr></table></figure>
<h5 id="7-6-总结"><a href="#7-6-总结" class="headerlink" title="7.6 总结"></a>7.6 总结</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 重点掌握before_request和after_request</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 注意有多个的情况，执行顺序</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. before_request请求拦截后（也就是有return值），response所有都执行</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="7-7-实例"><a href="#7-7-实例" class="headerlink" title="7.7 实例"></a>7.7 实例</h5><h6 id="7-7-1-实例一：before-request返回None"><a href="#7-7-1-实例一：before-request返回None" class="headerlink" title="7.7.1 实例一：before_request返回None"></a>7.7.1 实例一：before_request返回None</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, flash, get_flashed_messages</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line">app.secret_key = <span class="string">'ssss'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问index页面传参数name=lqz,如果不是lqz,出错,跳转到order页面,显示错误信息</span></span><br><span class="line"><span class="meta">@app.route('/index')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello_index"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'来了'</span>)</span><br><span class="line">    <span class="comment"># return 'xxx'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(response)</span>:</span></span><br><span class="line">    print(response)</span><br><span class="line">    print(<span class="string">'走了'</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_request1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'来了1'</span>)</span><br><span class="line">    <span class="comment"># return 'xxx'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response1</span><span class="params">(response)</span>:</span></span><br><span class="line">    print(response)</span><br><span class="line">    print(<span class="string">'走了1'</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">first</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'我的第一次'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8002</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">结果：</span></span><br><span class="line"><span class="string">    我的第一次</span></span><br><span class="line"><span class="string">    来了</span></span><br><span class="line"><span class="string">    来了1</span></span><br><span class="line"><span class="string">    &lt;Response 11 bytes [200 OK]&gt;</span></span><br><span class="line"><span class="string">    走了1</span></span><br><span class="line"><span class="string">    &lt;Response 11 bytes [200 OK]&gt;</span></span><br><span class="line"><span class="string">    走了</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h6 id="7-7-2-实例二：before-request返回非None"><a href="#7-7-2-实例二：before-request返回非None" class="headerlink" title="7.7.2 实例二：before_request返回非None"></a>7.7.2 实例二：before_request返回非None</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># print('来了')</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'xxx'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">结果：</span></span><br><span class="line"><span class="string">    我的第一次</span></span><br><span class="line"><span class="string">    来了</span></span><br><span class="line"><span class="string">    &lt;Response 3 bytes [200 OK]&gt;</span></span><br><span class="line"><span class="string">    走了1</span></span><br><span class="line"><span class="string">    &lt;Response 3 bytes [200 OK]&gt;</span></span><br><span class="line"><span class="string">    走了</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="八-中间件"><a href="#八-中间件" class="headerlink" title="八. 中间件"></a>八. 中间件</h4><h5 id="8-1-作用"><a href="#8-1-作用" class="headerlink" title="8.1 作用"></a>8.1 作用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 请求之前，或者请求之后，做些自定义的处理</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="8-2-源码分析"><a href="#8-2-源码分析" class="headerlink" title="8.2 源码分析"></a>8.2 源码分析</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 程序监听端口，并等待请求，主要执行下面的方法</span></span><br><span class="line"><span class="string">run -- run_simple(host, port, self, **options) </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 当程序监听的端口有请求进入，首先会执行Flask类中的__call__方法，接着执行wsgi_app（请求的总入口）</span></span><br><span class="line"><span class="string">__call__ -- wsgi_app(environ, start_response)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 因此需要中间件起作用，需要在程序执行wsgi_app之前和之后做些处理</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="8-3-如何自定义中间件"><a href="#8-3-如何自定义中间件" class="headerlink" title="8.3 如何自定义中间件"></a>8.3 如何自定义中间件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/index", methods=["GET"], endpoint="index")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"index"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Middleware</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, wsgi_app)</span>:</span></span><br><span class="line">        self.wsgi_app = wsgi_app</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line">        print(<span class="string">"我是请求之前"</span>)</span><br><span class="line">        print(environ)</span><br><span class="line">        res = self.wsgi_app(environ, start_response)</span><br><span class="line">        print(<span class="string">"我是请求之后"</span>)</span><br><span class="line">        print(environ)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 将app的wsgi_app属性重新赋值为Middleware对象，将原来的wsgi_app传入，并保存为Middleware对象</span></span><br><span class="line">    <span class="comment"># 的wsgi_app属性，当程序一旦执行self.wsgi_app(environ, start_response)，本质是执行			# Middleware对象的__call__方法，将原wsgi_app执行的结果返回。</span></span><br><span class="line">    app.wsgi_app = Middleware(app.wsgi_app)</span><br><span class="line">    app.run(port=<span class="number">8888</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="STEP-3"><a href="#STEP-3" class="headerlink" title="STEP-3"></a>STEP-3</h3><h4 id="一-蓝图（Blueprint）"><a href="#一-蓝图（Blueprint）" class="headerlink" title="一. 蓝图（Blueprint）"></a>一. 蓝图（Blueprint）</h4><h5 id="1-蓝图的作用"><a href="#1-蓝图的作用" class="headerlink" title="1. 蓝图的作用"></a>1. 蓝图的作用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 对程序进行目录结构的划分</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 有点类似于django中的路由分发include</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 可以实现不同的蓝图对象管理不同的视图函数</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="2-不使用蓝图自己分文件"><a href="#2-不使用蓝图自己分文件" class="headerlink" title="2. 不使用蓝图自己分文件"></a>2. 不使用蓝图自己分文件</h5><h6 id="2-1-目录结构"><a href="#2-1-目录结构" class="headerlink" title="2.1 目录结构"></a>2.1 目录结构</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">D:.</span><br><span class="line">│  manage.py</span><br><span class="line">│</span><br><span class="line">└─flask_test</span><br><span class="line">    │  __init__.py</span><br><span class="line">    │</span><br><span class="line">    ├─static</span><br><span class="line">    ├─templates</span><br><span class="line">    ├─views</span><br><span class="line">      │  order.py</span><br><span class="line">      │  user.py</span><br><span class="line">      └─  __init__.py</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">manage.py:项目的启动文件</span></span><br><span class="line"><span class="string">flask_test：项目文件的目录</span></span><br><span class="line"><span class="string">flask_test下面的__init__.py：是实例产生Flask对象，以及请求拓展，中间件，url和视图映射的地方</span></span><br><span class="line"><span class="string">static：静态文件夹</span></span><br><span class="line"><span class="string">templates：模板文件夹</span></span><br><span class="line"><span class="string">views：视图文件夹</span></span><br><span class="line"><span class="string">order.py：order相关的视图函数</span></span><br><span class="line"><span class="string">user.py：用户相关的视图函数</span></span><br><span class="line"><span class="string">__init__.py：将视图函数导入此文件，方便导入</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="2-2-manage-py"><a href="#2-2-manage-py" class="headerlink" title="2.2 manage.py"></a>2.2 manage.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_test <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8200</span>)</span><br></pre></td></tr></table></figure>
<h6 id="2-3-flask-test下的init-py"><a href="#2-3-flask-test下的init-py" class="headerlink" title="2.3 flask_test下的init.py"></a>2.3 flask_test下的<strong>init</strong>.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app.add_url_rule(<span class="string">"/order"</span>, <span class="string">"order"</span>, order)</span><br><span class="line">app.add_url_rule(<span class="string">"/login"</span>, <span class="string">"login"</span>, login)</span><br><span class="line">app.add_url_rule(<span class="string">"/logout"</span>, <span class="string">"logout"</span>, logout)</span><br></pre></td></tr></table></figure>
<h6 id="2-4-order-py"><a href="#2-4-order-py" class="headerlink" title="2.4 order.py"></a>2.4 order.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"order"</span></span><br></pre></td></tr></table></figure>
<h6 id="2-5-user-py"><a href="#2-5-user-py" class="headerlink" title="2.5 user.py"></a>2.5 user.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"login"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"logour"</span></span><br></pre></td></tr></table></figure>
<h6 id="2-6-views下面的init"><a href="#2-6-views下面的init" class="headerlink" title="2.6 views下面的init"></a>2.6 views下面的<strong>init</strong></h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .user <span class="keyword">import</span> logout, login</span><br><span class="line"><span class="keyword">from</span> .order <span class="keyword">import</span> order</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="3-使用蓝图之中小型项目"><a href="#3-使用蓝图之中小型项目" class="headerlink" title="3. 使用蓝图之中小型项目"></a>3. 使用蓝图之中小型项目</h5><h6 id="3-1-目录结构"><a href="#3-1-目录结构" class="headerlink" title="3.1 目录结构"></a>3.1 目录结构</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">D:.</span><br><span class="line">│  manage.py</span><br><span class="line">│</span><br><span class="line">└─flask_test</span><br><span class="line">    │  __init__.py</span><br><span class="line">    │</span><br><span class="line">    ├─static</span><br><span class="line">    ├─templates</span><br><span class="line">    ├─views</span><br><span class="line">      │  order.py</span><br><span class="line">      │  user.py</span><br><span class="line">      │  __init__.py</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">和自定义非蓝图版文件目录的区别</span></span><br><span class="line"><span class="string">1. flask_test文件下的__init__.py，主要是注册蓝图</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. order.py和user.py主要是生成一个蓝图对象，接着装饰到视图函数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. views下的__init__.py主要是将视图函数实例的蓝图对象，更方便的导入</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="3-2-manage-py"><a href="#3-2-manage-py" class="headerlink" title="3.2 manage.py"></a>3.2 manage.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_test <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8201</span>)</span><br></pre></td></tr></table></figure>
<h6 id="3-3-flask-test下的init-py"><a href="#3-3-flask-test下的init-py" class="headerlink" title="3.3 flask_test下的init.py"></a>3.3 flask_test下的<strong>init</strong>.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> order_blue, user_blue</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app.register_blueprint(order_blue)</span><br><span class="line">app.register_blueprint(user_blue)</span><br></pre></td></tr></table></figure>
<h6 id="3-4-order-py"><a href="#3-4-order-py" class="headerlink" title="3.4 order.py"></a>3.4 order.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">order_blue = Blueprint(<span class="string">"order"</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@order_blue.route("/order", endpoint="order")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"order"</span></span><br></pre></td></tr></table></figure>
<h6 id="3-5-user-py"><a href="#3-5-user-py" class="headerlink" title="3.5 user.py"></a>3.5 user.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">user_blue = Blueprint(<span class="string">"user"</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_blue.route("/login", endpoint="login")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"login"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_blue.route("/logout", endpoint="logout")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"logour"</span></span><br></pre></td></tr></table></figure>
<h6 id="3-6-views下面的init"><a href="#3-6-views下面的init" class="headerlink" title="3.6 views下面的init"></a>3.6 views下面的init</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .user <span class="keyword">import</span> user_blue</span><br><span class="line"><span class="keyword">from</span> .order <span class="keyword">import</span> order_blue</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="4-使用蓝图之大型项目"><a href="#4-使用蓝图之大型项目" class="headerlink" title="4. 使用蓝图之大型项目"></a>4. 使用蓝图之大型项目</h5><h6 id="4-1-项目目录"><a href="#4-1-项目目录" class="headerlink" title="4.1 项目目录"></a>4.1 项目目录</h6><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">D:.</span><br><span class="line">│  manage.<span class="keyword">py</span></span><br><span class="line">│</span><br><span class="line">|</span><br><span class="line">└─flask_app</span><br><span class="line">    │  __init__.<span class="keyword">py</span></span><br><span class="line">    │</span><br><span class="line">    ├─flask_admin</span><br><span class="line">    │  │  __init__.<span class="keyword">py</span></span><br><span class="line">    │  │</span><br><span class="line">    │  ├─static</span><br><span class="line">    │  ├─templates</span><br><span class="line">    │  ├─views</span><br><span class="line">    │    │  order.<span class="keyword">py</span></span><br><span class="line">    │    │  user.<span class="keyword">py</span></span><br><span class="line">    │    │  __init__.<span class="keyword">py</span></span><br><span class="line">    │</span><br><span class="line">    ├─flask_user</span><br><span class="line">      │  __init__.<span class="keyword">py</span></span><br><span class="line">      │</span><br><span class="line">      ├─static</span><br><span class="line">      ├─templates</span><br><span class="line">      ├─views</span><br><span class="line">        │  order.<span class="keyword">py</span></span><br><span class="line">        │  user.<span class="keyword">py</span></span><br><span class="line">        │  __init__.<span class="keyword">py</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">目录解释：</span></span><br><span class="line"><span class="string">manage.py：项目启动入口</span></span><br><span class="line"><span class="string">flask_app：项目所有app的目录，如user和admin</span></span><br><span class="line"><span class="string">flask_app下面的init.py:主要是产生Flask实例app，并注册蓝图</span></span><br><span class="line"><span class="string">flask_admin/flask_user：flask_user类似django中的app</span></span><br><span class="line"><span class="string">flask_admin/flask_user下面的__init__.py：主要是产生蓝图实例，以及蓝图所控制的视图函数</span></span><br><span class="line"><span class="string">其他同上</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="4-2-manage-py"><a href="#4-2-manage-py" class="headerlink" title="4.2 manage.py"></a>4.2 manage.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_app <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8202</span>)</span><br></pre></td></tr></table></figure>
<h6 id="4-3-flask-app下面的init-py"><a href="#4-3-flask-app下面的init-py" class="headerlink" title="4.3 flask_app下面的init.py"></a>4.3 flask_app下面的init.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> .flask_admin <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .flask_user <span class="keyword">import</span> user_blue</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 127.0.0.1:8202/admin/..访问</span></span><br><span class="line">app.register_blueprint(admin, url_prefix=<span class="string">"/admin"</span>)</span><br><span class="line">app.register_blueprint(user_blue, url_prefix=<span class="string">"/user"</span>)</span><br></pre></td></tr></table></figure>
<h6 id="4-4-flask-admin-flask-user下面的init-py"><a href="#4-4-flask-admin-flask-user下面的init-py" class="headerlink" title="4.4 flask_admin/flask_user下面的init.py"></a>4.4 flask_admin/flask_user下面的init.py</h6><blockquote>
<p>flask_admin</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">admin = Blueprint(<span class="string">"admin"</span>, __name__, static_folder=<span class="string">"static"</span>, template_folder=<span class="string">"templates"</span>)</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<blockquote>
<p>flask_user</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"><span class="comment"># user_blue一定不能和管理视图函数的文件名重复</span></span><br><span class="line">user_blue = Blueprint(<span class="string">"user"</span>, __name__, static_folder=<span class="string">"static"</span>, template_folder=<span class="string">"templates"</span>)</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<h6 id="4-5-views下面的init-py"><a href="#4-5-views下面的init-py" class="headerlink" title="4.5 views下面的init.py"></a>4.5 views下面的<strong>init</strong>.py</h6><blockquote>
<p>flask_admin</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .order <span class="keyword">import</span> order</span><br><span class="line"><span class="keyword">from</span> .user <span class="keyword">import</span> login, logout</span><br></pre></td></tr></table></figure>
<blockquote>
<p>flask_user</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .order <span class="keyword">import</span> order</span><br><span class="line"><span class="keyword">from</span> .user <span class="keyword">import</span> login, logout</span><br></pre></td></tr></table></figure>
<h6 id="4-6-views下面的order-py"><a href="#4-6-views下面的order-py" class="headerlink" title="4.6 views下面的order.py"></a>4.6 views下面的order.py</h6><blockquote>
<p>flask_admin</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ...flask_admin <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.route("/order", endpoint="admin_order")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"admin_order"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>flask_user</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ...flask_user <span class="keyword">import</span> user_blue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_blue.route("/order", endpoint="order")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"user_order"</span></span><br></pre></td></tr></table></figure>
<h6 id="4-7-views下面的user-py"><a href="#4-7-views下面的user-py" class="headerlink" title="4.7 views下面的user.py"></a>4.7 views下面的user.py</h6><blockquote>
<p>flask_admin</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ...flask_admin <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.route("/login", endpoint="admin_login")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"admin_login"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.route("/logout", endpoint="admin_logour")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"admin_logour"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>flask_user</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_app.flask_user <span class="keyword">import</span> user_blue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_blue.route("/login", endpoint="user_login")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"user_login"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_blue.route("/logout", endpoint="user_logour")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"user_logour"</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="5-使用蓝图注意事项"><a href="#5-使用蓝图注意事项" class="headerlink" title="5. 使用蓝图注意事项"></a>5. 使用蓝图注意事项</h5><h6 id="5-1-当为templates目录添加目录解耦时"><a href="#5-1-当为templates目录添加目录解耦时" class="headerlink" title="5.1 当为templates目录添加目录解耦时"></a>5.1 当为templates目录添加目录解耦时</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">render_template(<span class="string">'user/login.html'</span>)</span><br><span class="line"><span class="comment"># user为templates里面的文件目录，login.html为user目录下的文件</span></span><br><span class="line"><span class="comment"># 可以同过template_folder创建蓝图是指定模板文件的目录</span></span><br></pre></td></tr></table></figure>
<h5 id="6-蓝图总结"><a href="#6-蓝图总结" class="headerlink" title="6. 蓝图总结"></a>6. 蓝图总结</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">总结：</span><br><span class="line"></span><br><span class="line">1 xxx = Blueprint(<span class="string">'account'</span>, __name__,<span class="attribute">url_prefix</span>=<span class="string">'/xxx'</span>) ：蓝图URL前缀，表示url的前缀，在该蓝图下所有url都加前缀</span><br><span class="line"></span><br><span class="line">2 xxx = Blueprint(<span class="string">'account'</span>, name,<span class="attribute">url_prefix</span>=<span class="string">'/xxx'</span>,template_folder='tpls')：给当前蓝图单独使用templates，向上查找，当前找不到，会找总templates</span><br><span class="line"></span><br><span class="line">3 蓝图的befort_request，对当前蓝图有效</span><br><span class="line"></span><br><span class="line">4 大型项目，可以模拟出类似于django中app的概念</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="二-请求上下文源码分析"><a href="#二-请求上下文源码分析" class="headerlink" title="二. 请求上下文源码分析"></a>二. 请求上下文源码分析</h4><h5 id="1-Flask上下文的种类"><a href="#1-Flask上下文的种类" class="headerlink" title="1. Flask上下文的种类"></a>1. Flask上下文的种类</h5><h6 id="1-1-应用上下文"><a href="#1-1-应用上下文" class="headerlink" title="1.1 应用上下文"></a>1.1 应用上下文</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">current_app（当前激活程序实例）</span></span><br><span class="line"><span class="string">g（处理请求时临时存储的对象）</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="1-2-请求上下文"><a href="#1-2-请求上下文" class="headerlink" title="1.2 请求上下文"></a>1.2 请求上下文</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">request（请求对象，封装了http请求内容）</span></span><br><span class="line"><span class="string">session（用户会话，用于存储请求之间需要‘记住’的字典值）</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="2-上下文的作用"><a href="#2-上下文的作用" class="headerlink" title="2. 上下文的作用"></a>2. 上下文的作用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">flask从客户端获取到请求时，要让视图函数能访问一些对象，这样才能处理请求。例如请求对象就是一个很好的例子。要让视图函数访问请求对象，一个显而易见的方法就是将其作为参数传入视图函数，不过这回导致程序中的每个视图函数都增加一个参数，为了避免大量可有可无才参数把视图函数弄得一团糟，flask使用上下文临时把某些对象变为全局可访问（只是当前线程的全局可访问）。</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="3-上下文的生命周期"><a href="#3-上下文的生命周期" class="headerlink" title="3. 上下文的生命周期"></a>3. 上下文的生命周期</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. request对象只有在请求上下文的生命周期内才可以访问。离开了请求的生命周期，其上下文环境也就不存在了，自然也无法获取request对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 一般就是在视图函数里，或者请求钩子中，才能使用请求上下文request。flask在接收到来自客户端的请求时，会帮我们构造请求上下文的使用环境，当flask根据url跳到相应的视图函数的时候，自然而然就可以直接使用请求上下文，请求钩子也是同理。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 在不同http请求之间得到的request必然也是不一样的，它只包含当前http请求的一些信息，是线程隔离的。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4. session不一样，session是可以跨请求的，在不同的http请求之间，session都是同一个，因此，可以借session来存储一些请求之间需要‘记住’的字典值。</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="4-请求上下文环境构造"><a href="#4-请求上下文环境构造" class="headerlink" title="4. 请求上下文环境构造"></a>4. 请求上下文环境构造</h5><h6 id="4-1-wsgi-app"><a href="#4-1-wsgi-app" class="headerlink" title="4.1 wsgi_app"></a>4.1 <strong>wsgi_app</strong></h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 首先通过request_context(environ)产生一个RequestContext上下文对象ctx，并将重要的request对象，和session赋给了ctx对象。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 通过push（）方法，产生2个LocalStack的对象，分别将请求上下文和应用上下文通过push方法压入LocalStack的对象。并通过open_session方法将session获取到。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 通过full_dispatch_request()执行请求拓展，信号，视图函数，并将视图函数返回的结果封装成一个response对象,并通过save_session方法将session转化成cookie赋给response对象。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4. 通过auto_pop方法将请求上下文对象和应用上下文对象从LocalStack的栈中删除。</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span><span class="params">(self, environ, start_response)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回RequestContext(self, environ)对象，初始化的时候做了好多事情</span></span><br><span class="line">    </span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 执行RequestContext对象的push方法</span></span><br><span class="line">            ctx.push()</span><br><span class="line">            response = self.full_dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error = e</span><br><span class="line">            response = self.handle_exception(e)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            error = sys.exc_info()[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">            error = <span class="literal">None</span></span><br><span class="line">        ctx.auto_pop(error)</span><br></pre></td></tr></table></figure>
<h6 id="4-2-request-context"><a href="#4-2-request-context" class="headerlink" title="4.2 request_context"></a>4.2 request_context</h6><blockquote>
<p><strong>1.RequestContext的init方法</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app, environ, request=None)</span>:</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># app就是Flask的对象，environ就是传入的http协议相关请求参数（字典）</span></span><br><span class="line">        <span class="comment"># 将Flask的对象赋给RequestContext类对象的app属性</span></span><br><span class="line">        self.app = app</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> request <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># app.request_class就是Request类，Request(environ)实例化产生一个request对象</span></span><br><span class="line">            <span class="comment"># from flask.wrappers import RequestBase</span></span><br><span class="line">            request = app.request_class(environ)</span><br><span class="line">        <span class="comment"># 将产生的request对象赋给RequestContext类对象的request属性</span></span><br><span class="line">        self.request = request</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将MapAdapter的对象，就是将map对象的属性映射到MapAdapter对象的属性上</span></span><br><span class="line">        <span class="comment"># 将ctx的属性url_adapter赋值为MapAdapter的对象</span></span><br><span class="line">        self.url_adapter = app.create_url_adapter(self.request)</span><br><span class="line">        </span><br><span class="line">        self.flashes = <span class="literal">None</span></span><br><span class="line">        self.session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self._implicit_app_ctx_stack = []</span><br><span class="line"></span><br><span class="line">        self.preserved = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        self._preserved_exc = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self._after_request_functions = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将请求路径和请求的endpoint以及参数和request做个关联</span></span><br><span class="line">        self.match_request()</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>2. BaseRequest的init方法</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseRequest</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, environ, populate_request=True, shallow=False)</span>:</span></span><br><span class="line">        <span class="comment"># 给request对象设置属性environ并将传入environ赋给它</span></span><br><span class="line">        self.environ = environ</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> populate_request <span class="keyword">and</span> <span class="keyword">not</span> shallow:</span><br><span class="line">            <span class="comment"># 给request对象的environ添加新值werkzeug.request=self, self就是request对象</span></span><br><span class="line">            self.environ[<span class="string">'werkzeug.request'</span>] = self</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 给request对象设置属性shallow，此时shallow为False</span></span><br><span class="line">        self.shallow = shallow</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="4-3-ctx-push"><a href="#4-3-ctx-push" class="headerlink" title="4.3  ctx.push"></a>4.3  ctx.push</h6><blockquote>
<p><strong>1.ctx.push</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""Binds the request context to the current context."""</span></span><br><span class="line">    <span class="comment"># 将请求上下文绑定到当前上下文</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># _request_ctx_stack.top，top是一个静态方法</span></span><br><span class="line">    <span class="comment"># _request_ctx_stack是LocalStack对象</span></span><br><span class="line">    <span class="comment"># 调用LocalStack对象的top方法，返回None或者栈顶元素ctx对象，</span></span><br><span class="line">    <span class="comment"># from .globals import _request_ctx_stack</span></span><br><span class="line">    top = _request_ctx_stack.top</span><br><span class="line">    <span class="comment"># 如果top不是None且top.preserved值为True，ctx就执行自己的pop方法RequestContext的top方法</span></span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> top.preserved:</span><br><span class="line">        top.pop(top._preserved_exc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># _app_ctx_stack是LocalStack对象</span></span><br><span class="line">    app_ctx = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> app_ctx.app != self.app:</span><br><span class="line">        <span class="comment"># self.app == Fask()</span></span><br><span class="line">        <span class="comment">#  得到一个 AppContext类的实例对象，得到一个 应用上下文对象 app_ctx，此时 app_ctx拥有以下属性</span></span><br><span class="line">        <span class="comment">#  app_ctx.app = app, app_ctx.g = app.app_ctx_globals_class()</span></span><br><span class="line">        app_ctx = self.app.app_context()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将 app_ctx 入栈,应用上下文入栈</span></span><br><span class="line">        app_ctx.push()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># _implicit_app_ctx_stack是一个[],将app_ctx添加到列表中</span></span><br><span class="line">        self._implicit_app_ctx_stack.append(app_ctx)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self._implicit_app_ctx_stack.append(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> hasattr(sys, <span class="string">'exc_clear'</span>):</span><br><span class="line">        sys.exc_clear()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># self 指的是 ctx，即将ctx入栈，即 _request_ctx_stack._local.stack = [ctx]。请求上下文入栈</span></span><br><span class="line">    <span class="comment"># 执行的是LocalStack的push</span></span><br><span class="line">    _request_ctx_stack.push(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 由于每次请求都会初始化创建ctx，因此session都为None</span></span><br><span class="line">    <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># session_interface = SecureCookieSessionInterface(),</span></span><br><span class="line">        <span class="comment"># 即session_interface就是一个SecureCookieSessionInterface类的实例对象</span></span><br><span class="line">        session_interface = self.app.session_interface</span><br><span class="line">        <span class="comment"># 第一次访问：生成一个 字典(容器) 返回至 self.session</span></span><br><span class="line">        self.session = session_interface.open_session(</span><br><span class="line">            self.app, self.request</span><br><span class="line">        )</span><br><span class="line">		<span class="comment"># 如果没有自定义盐，返回None，生成一个特殊的session对象，不能对session进行修改和读取</span></span><br><span class="line">        <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.session = session_interface.make_null_session(self.app)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>2. LocalStack的top方法</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">top</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># 堆栈上最顶层的项。如果堆栈为空，则返回“none”。</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># self._local就是Local()，从stack的列表中取出最新的一个上下文对象</span></span><br><span class="line">        <span class="keyword">return</span> self._local.stack[<span class="number">-1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> (AttributeError, IndexError):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>3.LocalStack的push方法 </strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">    <span class="comment"># 从Local类对象中取stack的值，如果没有就是None</span></span><br><span class="line">    rv = getattr(self._local, <span class="string">'stack'</span>, <span class="literal">None</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果rv是None</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 给Local类添加一个属性stack=rv = []</span></span><br><span class="line">        self._local.stack = rv = []</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 请求进来将请求上下文RequestContext加入到列表中:</span></span><br><span class="line">    rv.append(obj)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回有ctx的的列表rv</span></span><br><span class="line">    <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>4. Flask对象的app_context</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app_context</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="comment"># 返回一个AppContext对象</span></span><br><span class="line">    <span class="keyword">return</span> AppContext(self)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>5.AppContext的init方法 </strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppContext</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app)</span>:</span></span><br><span class="line">        <span class="comment"># app就是Flask对象</span></span><br><span class="line">        self.app = app</span><br><span class="line">        self.url_adapter = app.create_url_adapter(<span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 为AppContext添加g属性</span></span><br><span class="line">        self.g = app.app_ctx_globals_class()</span><br><span class="line">        self._refcnt = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>6. open_session</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_session</span><span class="params">(self, app, request)</span>:</span></span><br><span class="line">    <span class="comment"># 获取 app的 secret_key,并解密</span></span><br><span class="line">    s = self.get_signing_serializer(app)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果没有定义secret_key，则返回None</span></span><br><span class="line">    <span class="keyword">if</span> s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 从 cookie 中获取 session 的value，session_cookie_name值为session</span></span><br><span class="line">    val = request.cookies.get(app.session_cookie_name)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果cookie没有值</span></span><br><span class="line">    <span class="comment"># 第一次访问为空执行</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> val:</span><br><span class="line">        <span class="comment"># 生成一个 SecureCookieSession类的实例对象，用于保存用户的session数据。</span></span><br><span class="line">        <span class="comment">#  SecureCookieSession类其实就是一个特殊的字典</span></span><br><span class="line">        <span class="comment"># 返回&#123;&#125;</span></span><br><span class="line">        <span class="keyword">return</span> self.session_class()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第二次访问</span></span><br><span class="line">    max_age = total_seconds(app.permanent_session_lifetime)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 将获取到的cookie进行反解</span></span><br><span class="line">        data = s.loads(val, max_age=max_age)</span><br><span class="line">        <span class="comment"># 返回一个含有cookie信息的 SecureCookieSession 类实例</span></span><br><span class="line">        <span class="keyword">return</span> self.session_class(data)</span><br><span class="line">    <span class="keyword">except</span> BadSignature:</span><br><span class="line">        <span class="keyword">return</span> self.session_class()</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="4-4-full-dispatch-request"><a href="#4-4-full-dispatch-request" class="headerlink" title="4.4 full_dispatch_request"></a>4.4 full_dispatch_request</h6><blockquote>
<p><strong>1. full_dispatch_request</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">full_dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment">#  将 _got_first_request =  True，依次执行定义的 before_first_request 函数</span></span><br><span class="line">    self.try_trigger_before_first_request_functions()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 触发 request_started 信号</span></span><br><span class="line">        request_started.send(self)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#  执行钩子函数：before_request</span></span><br><span class="line">        rv = self.preprocess_request()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果执行的before_request,before_first_request函数没有返回值，则继续执行视图函数。若有返回值，否则不执行视图函数</span></span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 执行此url对应的别名的视图函数并执行该函数，返回视图函数的返回值，得到相应信息</span></span><br><span class="line">            rv = self.dispatch_request()</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果发生错误，则将异常信息作为返回值进行返回</span></span><br><span class="line">        rv = self.handle_user_exception(e)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 视图函数的返回值当做参数传入，返回一个response并触发后续处理函数,完成request请求。</span></span><br><span class="line">    <span class="keyword">return</span> self.finalize_request(rv)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>2. try_trigger_before_first_request_functions</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">try_trigger_before_first_request_functions</span><span class="params">(self)</span>:</span></span><br><span class="line">	....</span><br><span class="line">    <span class="keyword">with</span> self._before_request_lock:</span><br><span class="line">  		....</span><br><span class="line">        <span class="comment"># 循环before_first_request_funcs的列表，并执行里面的before_first_request的函数</span></span><br><span class="line">        <span class="keyword">for</span> func <span class="keyword">in</span> self.before_first_request_funcs:</span><br><span class="line">            func()</span><br><span class="line">        self._got_first_request = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>3.preprocess_request </strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">preprocess_request</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">	....</span><br><span class="line">    funcs = self.url_value_preprocessors.get(<span class="literal">None</span>, ())</span><br><span class="line">	....</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> funcs:</span><br><span class="line">        func(request.endpoint, request.view_args)</span><br><span class="line">	.....</span><br><span class="line">    <span class="comment"># 取出before_request的请求拓展的函数列表</span></span><br><span class="line">    funcs = self.before_request_funcs.get(<span class="literal">None</span>, ())</span><br><span class="line">	....</span><br><span class="line">    <span class="comment"># 循环函数列表，并返回非空的的结果</span></span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> funcs:</span><br><span class="line">        rv = func()</span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>4. dispatch_request</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">    req = _request_ctx_stack.top.request</span><br><span class="line">    <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.raise_routing_exception(req)</span><br><span class="line">    rule = req.url_rule</span><br><span class="line">    <span class="comment"># if we provide automatic options for this URL and the</span></span><br><span class="line">    <span class="comment"># request came with the OPTIONS method, reply automatically</span></span><br><span class="line">    <span class="keyword">if</span> getattr(rule, <span class="string">'provide_automatic_options'</span>, <span class="literal">False</span>) \</span><br><span class="line">            <span class="keyword">and</span> req.method == <span class="string">'OPTIONS'</span>:</span><br><span class="line">        <span class="keyword">return</span> self.make_default_options_response()</span><br><span class="line">    <span class="comment"># otherwise dispatch to the handler for that endpoint</span></span><br><span class="line">    <span class="comment"># 执行对应的视图函数，并返回视图函数的结果</span></span><br><span class="line">    <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>5. finalize_request</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finalize_request</span><span class="params">(self, rv, from_error_handler=False)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 包装一个response的对象</span></span><br><span class="line">    response = self.make_response(rv)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = self.process_response(response)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 触发 request_finished 信号</span></span><br><span class="line">        request_finished.send(self, response=response)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> from_error_handler:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        self.logger.exception(<span class="string">'Request finalizing failed with an '</span></span><br><span class="line">                              <span class="string">'error while handling an error'</span>)</span><br><span class="line">    <span class="comment"># 返回response对象</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>6. process_response</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, response)</span>:</span></span><br><span class="line">	<span class="comment"># 从栈顶取出当前的ctx对象</span></span><br><span class="line">    ctx = _request_ctx_stack.top</span><br><span class="line">    bp = ctx.request.blueprint</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 取出after_request的请求拓展的方法的列表</span></span><br><span class="line">    funcs = ctx._after_request_functions</span><br><span class="line">    <span class="keyword">if</span> bp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> bp <span class="keyword">in</span> self.after_request_funcs:</span><br><span class="line">        funcs = chain(funcs, reversed(self.after_request_funcs[bp]))</span><br><span class="line">    <span class="keyword">if</span> <span class="literal">None</span> <span class="keyword">in</span> self.after_request_funcs:</span><br><span class="line">        funcs = chain(funcs, reversed(self.after_request_funcs[<span class="literal">None</span>]))</span><br><span class="line">    <span class="comment">#循环这个列表，执行列表的方法</span></span><br><span class="line">    <span class="keyword">for</span> handler <span class="keyword">in</span> funcs:</span><br><span class="line">        <span class="comment"># 因为会将response对象传入after_request的方法中，所以after_request修饰的方法，必须要接受参数response</span></span><br><span class="line">        <span class="comment"># 将执行过后最新的response赋给response</span></span><br><span class="line">        response = handler(response)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.session_interface.is_null_session(ctx.session):</span><br><span class="line">        <span class="comment">#  将 self.session 这个字典序列化，并返回，写入到客户端浏览器的cookie中</span></span><br><span class="line">        self.session_interface.save_session(self, ctx.session, response)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>7. save_session</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_session</span><span class="params">(self, app, session, response)</span>:</span></span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If the session is modified to be empty, remove the cookie.</span></span><br><span class="line">    <span class="comment"># 如果session修改成空的字典，则移除cookie</span></span><br><span class="line">    <span class="comment"># If the session is empty, return without setting the cookie.</span></span><br><span class="line">    <span class="comment"># 如果session是空的，则不返回cookie</span></span><br><span class="line">    <span class="comment"># 如果 session 变成了空字典，flask 会直接删除对应的 cookie</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session:</span><br><span class="line">        <span class="keyword">if</span> session.modified:</span><br><span class="line">            response.delete_cookie(</span><br><span class="line">                app.session_cookie_name,</span><br><span class="line">                domain=domain,</span><br><span class="line">                path=path</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add a "Vary: Cookie" header if the session was accessed at all.</span></span><br><span class="line">    <span class="comment"># 是否需要设置 cookie。如果 session 发生了变化，就一定要更新 cookie，</span></span><br><span class="line">    <span class="comment"># 否则用户可以 `SESSION_REFRESH_EACH_REQUEST` 变量控制是否要设置 cookie</span></span><br><span class="line">    <span class="keyword">if</span> session.accessed:</span><br><span class="line">        response.vary.add(<span class="string">'Cookie'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.should_set_cookie(app, session):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">   	.....</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 对session进行加密</span></span><br><span class="line">    val = self.get_signing_serializer(app).dumps(dict(session))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 为响应头添加cookie信息</span></span><br><span class="line">    response.set_cookie(</span><br><span class="line">        app.session_cookie_name,</span><br><span class="line">        val,</span><br><span class="line">        expires=expires,</span><br><span class="line">        httponly=httponly,</span><br><span class="line">        domain=domain,</span><br><span class="line">        path=path,</span><br><span class="line">        secure=secure,</span><br><span class="line">        samesite=samesite</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="4-5-RequestCentext类auto-pop"><a href="#4-5-RequestCentext类auto-pop" class="headerlink" title="4.5 RequestCentext类auto_pop"></a>4.5 RequestCentext类auto_pop</h6><blockquote>
<p><strong>1. auto_pop</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auto_pop</span><span class="params">(self, exc)</span>:</span></span><br><span class="line">    .....</span><br><span class="line">    <span class="comment"># 执行RequestCentext的pop方法</span></span><br><span class="line">    <span class="comment"># exc=None</span></span><br><span class="line">    self.pop(exc)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>2.RequestCentext类的pop方法 </strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self, exc=_sentinel)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取出应用上下文</span></span><br><span class="line">    app_ctx = self._implicit_app_ctx_stack.pop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        clear_request = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._implicit_app_ctx_stack:</span><br><span class="line">            self.preserved = <span class="literal">False</span></span><br><span class="line">            self._preserved_exc = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> exc <span class="keyword">is</span> _sentinel:</span><br><span class="line">                exc = sys.exc_info()[<span class="number">1</span>]</span><br><span class="line">            <span class="comment"># 执行teardown_request的请求拓展</span></span><br><span class="line">            self.app.do_teardown_request(exc)</span><br><span class="line"></span><br><span class="line">            ....</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 删除请求上下文</span></span><br><span class="line">        rv = _request_ctx_stack.pop()</span><br><span class="line">		....</span><br><span class="line">        <span class="comment"># 如果应用上下文不是空</span></span><br><span class="line">        <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 删除应用上下文</span></span><br><span class="line">           app_ctx.pop(exc)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>3. AppContext的pop</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self, exc=_sentinel)</span>:</span></span><br><span class="line">	<span class="comment"># 删除应用上下文</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        .....</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 从栈中删除应用上下文</span></span><br><span class="line">        rv = _app_ctx_stack.pop()</span><br><span class="line">        .....</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="5-LocalStack"><a href="#5-LocalStack" class="headerlink" title="5. LocalStack"></a>5. <strong>LocalStack</strong></h5><h6 id="5-1-作用"><a href="#5-1-作用" class="headerlink" title="5.1 作用"></a>5.1 作用</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 请求上下文和应用上下文是LocalStack数据结构的实例</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. _request_ctx_stack和_app_ctx_stack的push、pop、top操作都是针对自己self._local.stack属性进行的。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="5-2-源码"><a href="#5-2-源码" class="headerlink" title="5.2 源码"></a>5.2 源码</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStack</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._local = Local()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__release_local__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._local.__release_local__()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get__ident_func__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._local.__ident_func__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set__ident_func__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        object.__setattr__(self._local, <span class="string">'__ident_func__'</span>, value)</span><br><span class="line"></span><br><span class="line">    __ident_func__ = property(_get__ident_func__, _set__ident_func__)</span><br><span class="line">    <span class="keyword">del</span> _get__ident_func__, _set__ident_func__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_lookup</span><span class="params">()</span>:</span></span><br><span class="line">            rv = self.top</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">'object unbound'</span>)</span><br><span class="line">            <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> LocalProxy(_lookup)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="string">"""Pushes a new item to the stack"""</span></span><br><span class="line">        <span class="comment"># 从Local类对象中取stack的值，如果没有就是None</span></span><br><span class="line">        rv = getattr(self._local, <span class="string">'stack'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 如果rv是None</span></span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 给Local类添加一个属性stack=rv = []</span></span><br><span class="line">            <span class="comment"># 会触发Local对象__setattr__，&#123;"id":&#123;"stack":[]&#125;&#125;</span></span><br><span class="line">            self._local.stack = rv = []</span><br><span class="line">        <span class="comment"># 请求进来将请求上下文RequestContext加入到列表中:</span></span><br><span class="line">        rv.append(obj)</span><br><span class="line">        <span class="comment"># 返回有ctx的的列表rv</span></span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Removes the topmost item from the stack, will return the</span></span><br><span class="line"><span class="string">        old value or `None` if the stack was already empty.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 移除栈顶上的元素，可能返回ctx，也可能返回空</span></span><br><span class="line">        <span class="comment"># stack是一个列表</span></span><br><span class="line">        stack = getattr(self._local, <span class="string">'stack'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> stack <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">elif</span> len(stack) == <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># 传入一个local对象，执行local对象的__release_local__</span></span><br><span class="line">            <span class="comment"># 就是删除__storage__=&#123;&#125;里面的&#123;id:&#123;&#125;&#125;</span></span><br><span class="line">            release_local(self._local)</span><br><span class="line">            <span class="comment"># 返回ctx对象</span></span><br><span class="line">            <span class="keyword">return</span> stack[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> stack.pop()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""The topmost item on the stack.  If the stack is empty,</span></span><br><span class="line"><span class="string">        `None` is returned.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 堆栈上最顶层的项。如果堆栈为空，则返回“none”。</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># self._local就是Local()，从stack的列表中取出最新的一个上下文对象</span></span><br><span class="line">            <span class="keyword">return</span> self._local.stack[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">except</span> (AttributeError, IndexError):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<h5 id="6-Local"><a href="#6-Local" class="headerlink" title="6. Local"></a>6. Local</h5><h6 id="6-1-作用-1"><a href="#6-1-作用-1" class="headerlink" title="6.1 作用"></a>6.1 作用</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 真正的将ctx存储的栈是Local对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="6-2-源码"><a href="#6-2-源码" class="headerlink" title="6.2 源码"></a>6.2 源码</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> greenlet <span class="keyword">import</span> getcurrent <span class="keyword">as</span> get_ident</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">from</span> thread <span class="keyword">import</span> get_ident</span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">from</span> _thread <span class="keyword">import</span> get_ident</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span><span class="params">(object)</span>:</span></span><br><span class="line">    __slots__ = (<span class="string">'__storage__'</span>, <span class="string">'__ident_func__'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 给每个线程对象设置一个__storage__=&#123;&#125;，__ident_func__=get_ident</span></span><br><span class="line">        <span class="comment"># get_ident是线程id或者协程id</span></span><br><span class="line">        object.__setattr__(self, <span class="string">'__storage__'</span>, &#123;&#125;)</span><br><span class="line">        object.__setattr__(self, <span class="string">'__ident_func__'</span>, get_ident)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> iter(self.__storage__.items())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, proxy)</span>:</span></span><br><span class="line">        <span class="string">"""Create a proxy for a name."""</span></span><br><span class="line">        <span class="keyword">return</span> LocalProxy(self, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__release_local__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 从字典中删除当前线程的对应的value的值</span></span><br><span class="line">        self.__storage__.pop(self.__ident_func__(), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.__storage__[self.__ident_func__()][name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        <span class="comment"># get_ident()获取线程或者协程的id</span></span><br><span class="line">        ident = self.__ident_func__()</span><br><span class="line">        <span class="comment"># 获取__storage__=&#123;&#125;的字典</span></span><br><span class="line">        storage = self.__storage__</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            storage[ident][name] = value</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            storage[ident] = &#123;name: value&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">del</span> self.__storage__[self.__ident_func__()][name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="7-LocalProxy"><a href="#7-LocalProxy" class="headerlink" title="7. LocalProxy"></a>7. LocalProxy</h5><h6 id="7-1-作用"><a href="#7-1-作用" class="headerlink" title="7.1 作用"></a>7.1 作用</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">视图函数导入：request/session </span></span><br><span class="line"><span class="string">执行request.method等其他操作时，会执行该类的方法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_req_object</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="comment"># 取出ctx</span></span><br><span class="line">    top = _request_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_request_ctx_err_msg)</span><br><span class="line">    <span class="comment"># ctx.request/ctx.session</span></span><br><span class="line">    <span class="keyword">return</span> getattr(top, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_app_object</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="comment"># 取出app_ctx</span></span><br><span class="line">    top = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br><span class="line">    <span class="comment"># app_ctx.g</span></span><br><span class="line">    <span class="keyword">return</span> getattr(top, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_app</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 取出app_ctx</span></span><br><span class="line">    top = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br><span class="line">    <span class="comment"># app_ctx.app取出的就是Flask的对象</span></span><br><span class="line">    <span class="keyword">return</span> top.app</span><br><span class="line"></span><br><span class="line">current_app = LocalProxy(_find_app)</span><br><span class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">'request'</span>))</span><br><span class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">'session'</span>))</span><br><span class="line">g = LocalProxy(partial(_lookup_app_object, <span class="string">'g'</span>))</span><br></pre></td></tr></table></figure>
<h6 id="7-2-源码"><a href="#7-2-源码" class="headerlink" title="7.2 源码"></a>7.2 源码</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@implements_bool</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalProxy</span><span class="params">(object)</span>:</span></span><br><span class="line">   </span><br><span class="line">    __slots__ = (<span class="string">'__local'</span>, <span class="string">'__dict__'</span>, <span class="string">'__name__'</span>, <span class="string">'__wrapped__'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, local, name=None)</span>:</span></span><br><span class="line">        object.__setattr__(self, <span class="string">'_LocalProxy__local'</span>, local)</span><br><span class="line">        object.__setattr__(self, <span class="string">'__name__'</span>, name)</span><br><span class="line">        <span class="keyword">if</span> callable(local) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(local, <span class="string">'__release_local__'</span>):</span><br><span class="line">            <span class="comment"># "local" is a callable that is not an instance of Local or</span></span><br><span class="line">            <span class="comment"># LocalManager: mark it as a wrapped function.</span></span><br><span class="line">            object.__setattr__(self, <span class="string">'__wrapped__'</span>, local)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_current_object</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return the current object.  This is useful if you want the real</span></span><br><span class="line"><span class="string">        object behind the proxy at a time for performance reasons or because</span></span><br><span class="line"><span class="string">        you want to pass the object into a different context.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self.__local, <span class="string">'__release_local__'</span>):</span><br><span class="line">            <span class="keyword">return</span> self.__local()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> getattr(self.__local, self.__name__)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'no object bound to %s'</span> % self.__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dict__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._get_current_object().__dict__</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">'__dict__'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            obj = self._get_current_object()</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'&lt;%s unbound&gt;'</span> % self.__class__.__name__</span><br><span class="line">        <span class="keyword">return</span> repr(obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bool__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> bool(self._get_current_object())</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> unicode(self._get_current_object())  <span class="comment"># noqa</span></span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">return</span> repr(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dir__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> dir(self._get_current_object())</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'__members__'</span>:</span><br><span class="line">            <span class="keyword">return</span> dir(self._get_current_object())</span><br><span class="line">        <span class="keyword">return</span> getattr(self._get_current_object(), name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self._get_current_object()[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> self._get_current_object()[key]</span><br></pre></td></tr></table></figure>
<h5 id="8-g对象"><a href="#8-g对象" class="headerlink" title="8. g对象"></a>8. g对象</h5><h6 id="8-1-作用-1"><a href="#8-1-作用-1" class="headerlink" title="8.1 作用"></a>8.1 作用</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 专门用来存储用户信息的g对象，g的全称的为global </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. g对象在一次请求中的所有的代码的地方，都是可以使用的 </span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="8-2-g对象和session的区别"><a href="#8-2-g对象和session的区别" class="headerlink" title="8.2 g对象和session的区别"></a>8.2 g对象和session的区别</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">session对象是可以跨request的，只要session还未失效，不同的request的请求会获取到同一个session，但是g对象不是，g对象不需要管过期时间，请求一次就g对象就改变了一次，或者重新赋值了一次</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="8-3-实例"><a href="#8-3-实例" class="headerlink" title="8.3 实例"></a>8.3 实例</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">first</span><span class="params">()</span>:</span></span><br><span class="line">    g.name = <span class="string">'lqz'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    print(g.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8009</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="三-flask-session插件"><a href="#三-flask-session插件" class="headerlink" title="三. flask_session插件"></a>三. flask_session插件</h4><h5 id="1-作用"><a href="#1-作用" class="headerlink" title="1 作用"></a>1 作用</h5><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">作用：将默认保存的签名cookie中的值 保存到 redis<span class="regexp">/memcached/</span><span class="keyword">file</span><span class="regexp">/Mongodb/</span>SQLAlchemy</span><br></pre></td></tr></table></figure>
<h5 id="2-安装"><a href="#2-安装" class="headerlink" title="2 安装"></a>2 安装</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">安装：pip3 <span class="keyword">install</span> flask-<span class="keyword">session</span></span><br></pre></td></tr></table></figure>
<h5 id="3-使用方式一"><a href="#3-使用方式一" class="headerlink" title="3 使用方式一"></a>3 使用方式一</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session, g</span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> RedisSessionInterface</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">conn = redis.Redis(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">6379</span>)</span><br><span class="line">app.session_interface = RedisSessionInterface(conn, key_prefix=<span class="string">'flask_'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    session[<span class="string">'name'</span>] = <span class="string">'zhang'</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/n1')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">n1</span><span class="params">()</span>:</span></span><br><span class="line">    print(session.get(<span class="string">'name'</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'n1'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8009</span>)</span><br></pre></td></tr></table></figure>
<h5 id="4-使用方式二"><a href="#4-使用方式二" class="headerlink" title="4 使用方式二"></a>4 使用方式二</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> g, Flask, session</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SESSION_TYPE'</span>] = <span class="string">'redis'</span></span><br><span class="line">app.config[<span class="string">'SESSION_REDIS'</span>] = Redis(host=<span class="string">'127.0.0.1'</span>, port=<span class="string">'6379'</span>)</span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/login")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    session[<span class="string">"user"</span>] = <span class="string">"zhang"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"login"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/index")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    user = session.get(<span class="string">"user"</span>)</span><br><span class="line">    print(user)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"index"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8734</span>)</span><br></pre></td></tr></table></figure>
<h4 id="四-flask-script插件"><a href="#四-flask-script插件" class="headerlink" title="四. flask_script插件"></a>四. flask_script插件</h4><h5 id="1-作用-1"><a href="#1-作用-1" class="headerlink" title="1. 作用"></a>1. 作用</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">用于实现类似于django中 <span class="keyword">python3</span> manage.<span class="keyword">py</span> runserver  ...类似的命令</span><br><span class="line"></span><br><span class="line">应用场景：</span><br><span class="line">把excel的数据导入数据库，定制个命令，去执行等</span><br></pre></td></tr></table></figure>
<h5 id="2-安装-1"><a href="#2-安装-1" class="headerlink" title="2. 安装"></a>2. 安装</h5><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install flask-<span class="keyword">script</span></span><br></pre></td></tr></table></figure>
<h5 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> g, Flask, session</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SESSION_TYPE'</span>] = <span class="string">'redis'</span></span><br><span class="line">app.config[<span class="string">'SESSION_REDIS'</span>] = Redis(host=<span class="string">'127.0.0.1'</span>, port=<span class="string">'6379'</span>)</span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line">manager = Manager(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义命令</span></span><br><span class="line"><span class="meta">@manager.command</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">custom</span><span class="params">(arg)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    自定义命令</span></span><br><span class="line"><span class="string">    python manage.py custom 123</span></span><br><span class="line"><span class="string">    :param arg:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">D:\AAA\Flask\day04&gt;python flask_script插件.py custom 100</span></span><br><span class="line"><span class="string">100</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@manager.option('-n', '--name', dest='name')</span></span><br><span class="line"><span class="meta">@manager.option('-u', '--url', dest='url')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(name, url)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    自定义命令（-n也可以写成--name）</span></span><br><span class="line"><span class="string">    执行： python manage.py  cmd -n lqz -u http://www.oldboyedu.com</span></span><br><span class="line"><span class="string">    执行： python manage.py  cmd --name lqz --url http://www.oldboyedu.com</span></span><br><span class="line"><span class="string">    :param name:</span></span><br><span class="line"><span class="string">    :param url:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print(name, url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">D:\AAA\Flask\day04&gt;python flask_script插件.py cmd -n zhang -u www.baidu.com</span></span><br><span class="line"><span class="string">zhang www.baidu.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/login")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    session[<span class="string">"user"</span>] = <span class="string">"zhang"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"login"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/index")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    user = session.get(<span class="string">"user"</span>)</span><br><span class="line">    print(user)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"index"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">以后在执行，直接：<span class="keyword">python3</span> 文件名.<span class="keyword">py</span> runserver</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="五-多app应用"><a href="#五-多app应用" class="headerlink" title="五. 多app应用"></a>五. 多app应用</h4><h5 id="1-作用-2"><a href="#1-作用-2" class="headerlink" title="1. 作用"></a>1. 作用</h5><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用来分文件管理，管理不同的视图函数，蓝图就可以实现</span><br><span class="line">本质：是根据不同的<span class="built_in">url</span>路径，分发到不同的app中执行</span><br></pre></td></tr></table></figure>
<h5 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug.wsgi <span class="keyword">import</span> DispatcherMiddleware</span><br><span class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, current_app</span><br><span class="line"></span><br><span class="line">app1 = Flask(<span class="string">'app01'</span>)</span><br><span class="line">app2 = Flask(<span class="string">'app02'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app1.route('/index')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"app01"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app2.route('/index2')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"app2"</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># http://www.oldboyedu.com/index</span></span><br><span class="line"><span class="comment"># http://www.oldboyedu.com/sec/index2</span></span><br><span class="line">dm = DispatcherMiddleware(app1, &#123;</span><br><span class="line">    <span class="string">'/sec'</span>: app2,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    run_simple(<span class="string">'localhost'</span>, <span class="number">5000</span>, dm)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="六-信号"><a href="#六-信号" class="headerlink" title="六. 信号"></a>六. 信号</h4><h5 id="1-作用-3"><a href="#1-作用-3" class="headerlink" title="1. 作用"></a>1. 作用</h5><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Flask</span>框架中的信号基于<span class="keyword">blinker，其主要就是让开发者可是在flask请求过程中定制一些用户行为 </span>。</span><br></pre></td></tr></table></figure>
<h5 id="2-内置信号"><a href="#2-内置信号" class="headerlink" title="2. 内置信号"></a>2. 内置信号</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">request_started = _signals.signal(<span class="string">'request-started'</span>)                <span class="comment"># 请求到来前执行</span></span><br><span class="line">request_finished = _signals.signal(<span class="string">'request-finished'</span>)              <span class="comment"># 请求结束后执行</span></span><br><span class="line"> </span><br><span class="line">before_render_template = _signals.signal(<span class="string">'before-render-template'</span>)  <span class="comment"># 模板渲染前执行</span></span><br><span class="line">template_rendered = _signals.signal(<span class="string">'template-rendered'</span>)            <span class="comment"># 模板渲染后执行</span></span><br><span class="line"> </span><br><span class="line">got_request_exception = _signals.signal(<span class="string">'got-request-exception'</span>)    <span class="comment"># 请求执行出现异常时执行</span></span><br><span class="line"> </span><br><span class="line">request_tearing_down = _signals.signal(<span class="string">'request-tearing-down'</span>)      <span class="comment"># 请求执行完毕后自动执行（无论成功与否）</span></span><br><span class="line">appcontext_tearing_down = _signals.signal(<span class="string">'appcontext-tearing-down'</span>)<span class="comment"># 应用上下文执行完毕后自动执行（无论成功与否）</span></span><br><span class="line"> </span><br><span class="line">appcontext_pushed = _signals.signal(<span class="string">'appcontext-pushed'</span>)            <span class="comment"># 应用上下文push时执行</span></span><br><span class="line">appcontext_popped = _signals.signal(<span class="string">'appcontext-popped'</span>)            <span class="comment"># 应用上下文pop时执行</span></span><br><span class="line">message_flashed = _signals.signal(<span class="string">'message-flashed'</span>)                <span class="comment"># 调用flask在其中添加数据时，自动触发</span></span><br></pre></td></tr></table></figure>
<h5 id="3-使用信号"><a href="#3-使用信号" class="headerlink" title="3. 使用信号"></a>3. 使用信号</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, signals, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 往信号中注册函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    print(<span class="string">'触发信号'</span>, args, kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">signals.request_started.connect(func)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 触发信号： signals.request_started.send()</span></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_first1</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    print(<span class="string">"before_first1"</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_first2</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    print(<span class="string">"before_first2"</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_first3</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    print(<span class="string">"before_request1"</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET', "POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'视图'</span>)</span><br><span class="line">    <span class="comment"># return render_template('index.html')</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello world"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8677</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">执行结果</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">before_first1</span></span><br><span class="line"><span class="string">before_first2</span></span><br><span class="line"><span class="string">触发信号 (&lt;Flask '信号'&gt;,) &#123;&#125;</span></span><br><span class="line"><span class="string">before_request1</span></span><br><span class="line"><span class="string">视图</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="4-Flask中信号的触发点"><a href="#4-Flask中信号的触发点" class="headerlink" title="4. Flask中信号的触发点"></a>4. Flask中信号的触发点</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. before_first_request</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 触发 request_started 信号</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. before_request</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4. 模板渲染</span></span><br><span class="line"><span class="string">	渲染前的信号 before_render_template.send(app, template=template, context=context)</span></span><br><span class="line"><span class="string">		rv = template.render(context) # 模板渲染</span></span><br><span class="line"><span class="string">	渲染后的信号 template_rendered.send(app, template=template, context=context)</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">5. after_request</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6. session.save_session()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7. 触发 request_finished信号		</span></span><br><span class="line"><span class="string">	如果上述过程出错：</span></span><br><span class="line"><span class="string">		触发错误处理信号 got_request_exception.send(self, exception=e)</span></span><br><span class="line"><span class="string">			</span></span><br><span class="line"><span class="string">9. 触发信号 request_tearing_down</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="5-自定义信号-了解"><a href="#5-自定义信号-了解" class="headerlink" title="5. 自定义信号(了解)"></a>5. 自定义信号(了解)</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask.signals <span class="keyword">import</span> _signals</span><br><span class="line"></span><br><span class="line">app = Flask(import_name=__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义信号</span></span><br><span class="line">my_signal = _signals.signal(<span class="string">'xxxxx'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(sender, *args, **kwargs)</span>:</span></span><br><span class="line">    print(sender)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义信号中注册函数</span></span><br><span class="line">my_signal.connect(func)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/index")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 触发信号</span></span><br><span class="line">    print(<span class="string">"信号触发前"</span>)</span><br><span class="line">    my_signal.send(<span class="string">'123123'</span>, k1=<span class="string">'v1'</span>)</span><br><span class="line">    print(<span class="string">"信号触发后"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Index'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8555</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">信号触发前</span></span><br><span class="line"><span class="string">123123</span></span><br><span class="line"><span class="string">信号触发后</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="STEP-4"><a href="#STEP-4" class="headerlink" title="STEP-4"></a>STEP-4</h3><h4 id="一-wtforms组件"><a href="#一-wtforms组件" class="headerlink" title="一. wtforms组件"></a>一. wtforms组件</h4><h5 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">pip3 install wtforms</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="2-作用"><a href="#2-作用" class="headerlink" title="2. 作用"></a>2. 作用</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>和django中的forms组件基本类似，可以参考django使用</span><br><span class="line"><span class="bullet">2. </span>主要作用：校验数据，渲染表单，错误信息</span><br></pre></td></tr></table></figure>
<h5 id="3-使用-1"><a href="#3-使用-1" class="headerlink" title="3. 使用"></a>3. 使用</h5><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>前端传过来的数据，通过post或者get，或者body里面取出来，生成字典类型</span><br><span class="line"><span class="number">2.</span>将自定义的UserForms类实例化，同时将字典传入该类中，生成一个form的对象</span><br><span class="line"><span class="number">3.</span>执行form.validate()进行字段的校验</span><br></pre></td></tr></table></figure>
<h5 id="4-简单使用"><a href="#4-简单使用" class="headerlink" title="4. 简单使用"></a>4. 简单使用</h5><h6 id="4-0-使用步骤"><a href="#4-0-使用步骤" class="headerlink" title="4.0 使用步骤"></a>4.0 使用步骤</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 首先定义一个Form类，继承Form</span></span><br><span class="line"><span class="string">2. 定义需要校验的字段的验证规则</span></span><br><span class="line"><span class="string">3. 在视图中如果是GET请求直接生成一个空的Form类的对象，如果是Post请求，先将传入的formdata数据传入到Form类中并实例化产生form对象，执行校验规则form.validate()</span></span><br><span class="line"><span class="string">4. 如果校验通过，可以通过form.data中取出验证通过的数据</span></span><br><span class="line"><span class="string">5. 如果没有通过，可以在form.errors中取出验证错误的信息</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="4-1-视图"><a href="#4-1-视图" class="headerlink" title="4.1 视图"></a>4.1 视图</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> Form</span><br><span class="line"><span class="keyword">from</span> wtforms.fields <span class="keyword">import</span> simple</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> validators</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> widgets</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">"templates"</span>)</span><br><span class="line"></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span><span class="params">(Form)</span>:</span></span><br><span class="line">    <span class="comment"># 字段</span></span><br><span class="line">    name = simple.StringField(</span><br><span class="line">        label=<span class="string">"用户名"</span>,</span><br><span class="line">        <span class="comment"># validators放所有的校验规则</span></span><br><span class="line"></span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">"用户名不能为空"</span>),</span><br><span class="line">            validators.Length(min=<span class="number">6</span>, max=<span class="number">10</span>, message=<span class="string">"用户名长度必须大于%(min)d且小于%(max)d"</span>)</span><br><span class="line"></span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 页面中显示的插件，render_kw给TextInput渲染样式</span></span><br><span class="line">        widget=widgets.TextInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">"class"</span>: <span class="string">"form-control"</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    pwd = simple.PasswordField(</span><br><span class="line">        label=<span class="string">"密码"</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">"密码不能为空"</span>),</span><br><span class="line">            validators.Length(min=<span class="number">6</span>, message=<span class="string">"密码长度必须大于%(min)d"</span>),</span><br><span class="line">            <span class="comment"># validators.Regexp(</span></span><br><span class="line">            <span class="comment">#     regex="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&amp;])[A-Za-z\d$@$!%*?&amp;]&#123;8,&#125;",</span></span><br><span class="line">            <span class="comment">#     message="密码至少8个字符，至少1个大写字母，1个小写字母，1个数字和1个特殊字符"</span></span><br><span class="line">            <span class="comment"># )</span></span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.PasswordInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">"class"</span>: <span class="string">"form-control"</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/login", methods=["GET", "POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        form = LoginForm()</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>, form=form)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># request.form 前端post提交的数据</span></span><br><span class="line">        form = LoginForm(formdata=request.form)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># form.validate()是True代表验证通过</span></span><br><span class="line">        <span class="keyword">if</span> form.validate():</span><br><span class="line">            print(<span class="string">"用户提交校验通过的数据："</span>, form.data)</span><br><span class="line">            <span class="comment"># &#123;'name': 'sadfasdfa', 'pwd': 'sdafas'&#125;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(form.errors)</span><br><span class="line">            <span class="comment"># &#123;'name': ['用户名不能为空'], 'pwd': ['密码不能为空']&#125;</span></span><br><span class="line"></span><br><span class="line">            print(form.name.errors)</span><br><span class="line">            <span class="comment"># ['用户名不能为空']</span></span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"login.html"</span>, form=form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8999</span>)</span><br></pre></td></tr></table></figure>
<h6 id="4-2-模板"><a href="#4-2-模板" class="headerlink" title="4.2 模板"></a>4.2 模板</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;form.name.label&#125;&#125; &#123;&#123;form.name&#125;&#125; &#123;&#123;form.name.errors[0] &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;form.pwd.label&#125;&#125; &#123;&#123;form.pwd&#125;&#125; &#123;&#123;form.pwd.errors[0] &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="4-3-关闭html的form验证功能"><a href="#4-3-关闭html的form验证功能" class="headerlink" title="4.3 关闭html的form验证功能"></a>4.3 关闭html的form验证功能</h6><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form <span class="function"><span class="keyword">method</span>="<span class="title">post</span>" <span class="title">novalidate</span>="<span class="title">false</span>"&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="5-复杂使用"><a href="#5-复杂使用" class="headerlink" title="5. 复杂使用"></a>5. 复杂使用</h5><h6 id="5-1-视图"><a href="#5-1-视图" class="headerlink" title="5.1 视图"></a>5.1 视图</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> Form</span><br><span class="line"><span class="keyword">from</span> wtforms.fields <span class="keyword">import</span> core</span><br><span class="line"><span class="keyword">from</span> wtforms.fields <span class="keyword">import</span> html5</span><br><span class="line"><span class="keyword">from</span> wtforms.fields <span class="keyword">import</span> simple</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> validators</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> widgets</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">"templates"</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span><span class="params">(Form)</span>:</span></span><br><span class="line">    name = simple.StringField(</span><br><span class="line">        label=<span class="string">"用户名"</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">"用户名不能为空"</span>),</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.TextInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">"class"</span>: <span class="string">"form-control"</span>&#125;,</span><br><span class="line">        default=<span class="string">"zhang"</span></span><br><span class="line"></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    pwd = simple.PasswordField(</span><br><span class="line">        label=<span class="string">"密码"</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">"密码不能为空"</span>),</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.PasswordInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">"class"</span>: <span class="string">"form-control"</span>&#125;</span><br><span class="line"></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    pwd_confirm = simple.PasswordField(</span><br><span class="line">        label=<span class="string">"请再次输入密码"</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">"重复密码不能为空"</span>),</span><br><span class="line">            <span class="comment"># 代替了之前的全局钩子</span></span><br><span class="line">            validators.EqualTo(<span class="string">"pwd"</span>, message=<span class="string">"两次密码输入不一致"</span>)</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.PasswordInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">"class"</span>: <span class="string">"form-control"</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    email = html5.EmailField(</span><br><span class="line">        label=<span class="string">"邮箱"</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">"邮箱不能为空"</span>),</span><br><span class="line">            validators.Email(message=<span class="string">"邮箱格式错误"</span>)</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.TextInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">"class"</span>: <span class="string">"form-control"</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    gender = core.RadioField(</span><br><span class="line">        label=<span class="string">"性别"</span>,</span><br><span class="line">        choices=(</span><br><span class="line">            (<span class="number">1</span>, <span class="string">"男"</span>),</span><br><span class="line">            (<span class="number">2</span>, <span class="string">"女"</span>),</span><br><span class="line">        ),</span><br><span class="line">        coerce=int</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    city = core.SelectField(</span><br><span class="line">        label=<span class="string">"城市"</span>,</span><br><span class="line">        choices=(</span><br><span class="line">            (<span class="string">"bj"</span>, <span class="string">"北京"</span>),</span><br><span class="line">            (<span class="string">"sh"</span>, <span class="string">"上海"</span>),</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    hobby = core.SelectMultipleField(</span><br><span class="line">        label=<span class="string">"爱好"</span>,</span><br><span class="line">        choices=(</span><br><span class="line">            (<span class="number">1</span>, <span class="string">"篮球"</span>),</span><br><span class="line">            (<span class="number">2</span>, <span class="string">"足球"</span>),</span><br><span class="line">        ),</span><br><span class="line">        coerce=int</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    favor = core.SelectMultipleField(</span><br><span class="line">        label=<span class="string">"喜好"</span>,</span><br><span class="line">        choices=(</span><br><span class="line">            (<span class="number">1</span>, <span class="string">"篮球"</span>),</span><br><span class="line">            (<span class="number">2</span>, <span class="string">"足球"</span>),</span><br><span class="line">        ),</span><br><span class="line">        widget=widgets.ListWidget(prefix_label=<span class="literal">False</span>),</span><br><span class="line">        option_widget=widgets.CheckboxInput(),</span><br><span class="line">        coerce=int,</span><br><span class="line">        default=[<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        super(RegisterForm, self).__init__(*args, **kwargs)</span><br><span class="line">        <span class="comment"># 保证数据实时更新</span></span><br><span class="line">        self.favor.choices = ((<span class="number">1</span>, <span class="string">'篮球'</span>), (<span class="number">2</span>, <span class="string">'足球'</span>), (<span class="number">3</span>, <span class="string">'羽毛球'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 局部钩子</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_pwd_confirm</span><span class="params">(self, field)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义pwd_confirm字段规则，例如：与pwd字段是否一致</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 最开始初始化时，self.data中已经有所有的值</span></span><br><span class="line">        <span class="comment"># field不是字符串的值，field.data取出字符串的值</span></span><br><span class="line">        <span class="keyword">if</span> field.data != self.data[<span class="string">"pwd"</span>]:</span><br><span class="line">            aa = self.data[<span class="string">"data_confirm"</span>]</span><br><span class="line">            <span class="comment"># 继续后续验证</span></span><br><span class="line">            <span class="comment"># raise validators.ValidationError("密码不一致")</span></span><br><span class="line">            <span class="comment"># 不在继续后续的验证</span></span><br><span class="line">            <span class="keyword">raise</span> validators.StopValidation(<span class="string">"密码不一致"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/register", methods=["GET", "POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        form = RegisterForm(data=&#123;<span class="string">"gender"</span>: <span class="number">2</span>, <span class="string">"hobby"</span>: [<span class="number">1</span>, ]&#125;)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"register.html"</span>, form=form)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = RegisterForm(formdata=request.form)</span><br><span class="line">        <span class="keyword">if</span> form.validate():</span><br><span class="line">            print(<span class="string">'用户提交数据通过格式验证，提交的值为：'</span>, form.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(form.errors)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'register.html'</span>, form=form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8435</span>)</span><br></pre></td></tr></table></figure>
<h6 id="5-2-模板"><a href="#5-2-模板" class="headerlink" title="5.2 模板"></a>5.2 模板</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span> <span class="attr">style</span>=<span class="string">"padding:0  50px"</span>&gt;</span></span><br><span class="line">    &#123;% for field in form %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;field.label&#125;&#125;: &#123;&#123;field&#125;&#125; &#123;&#123;field.errors[0] &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="二-Python中的数据库连接池DBUtils"><a href="#二-Python中的数据库连接池DBUtils" class="headerlink" title="二. Python中的数据库连接池DBUtils"></a>二. Python中的数据库连接池DBUtils</h4><h5 id="1-为什么要用数据库连接池"><a href="#1-为什么要用数据库连接池" class="headerlink" title="1. 为什么要用数据库连接池"></a>1. 为什么要用数据库连接池</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 所有请求用同一个连接，会造成数据不安全</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 所有请求用同一个连接，加锁，串行，保证数据安全，但是不能并发</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 用请求连接池，每个请求独享一个线程，保证数据安全，也能支持并发</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 如果每个请求过来，都需要创建一个数据库连接，如果同时并发了非常多的请求，则会对数据库造成压力</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 如果全局使用一个数据库连接，通过加锁，保证了数据安全，但是导致无法支持并发。</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="1-1-每个请求开个连接"><a href="#1-1-每个请求开个连接" class="headerlink" title="1.1 每个请求开个连接"></a>1.1 每个请求开个连接</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">缺点：会对数据库造成压力，且无法保证数据安全。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">'templates'</span>)</span><br><span class="line"></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line">conn = pymysql.connect(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">3306</span>, user=<span class="string">'root'</span>, passwd=<span class="string">'123'</span>, db=<span class="string">'pymysql'</span>)</span><br><span class="line">cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    cursor.execute(<span class="string">"select id,name from user where name=%s and pwd=%s"</span>, [<span class="string">'章成刚'</span>, <span class="string">'123'</span>, ])</span><br><span class="line">    <span class="comment"># cursor.execute("select id,name from users where name=%(user)s and pwd=%(pwd)s", &#123;'user': 'lqz', 'pwd': '123'&#125;)</span></span><br><span class="line">    obj = cursor.fetchone()</span><br><span class="line">    conn.commit()</span><br><span class="line">    cursor.close()</span><br><span class="line">    conn.close()</span><br><span class="line">    print(obj)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'ok'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">8211</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">&#123;'id': 1, 'name': '章成刚'&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="1-2-加锁使用单个数据库连接对象"><a href="#1-2-加锁使用单个数据库连接对象" class="headerlink" title="1.2 加锁使用单个数据库连接对象"></a>1.2 加锁使用单个数据库连接对象</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">缺点：无法支持并发</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第二步：缺点，不能支持并发</span></span><br><span class="line">    <span class="comment"># pymysql.threadsafety</span></span><br><span class="line">    <span class="comment"># with LOCK:</span></span><br><span class="line">    <span class="comment">#     cursor = CONN.cursor()</span></span><br><span class="line">    <span class="comment">#     cursor.execute('select * from tb where id &gt; %s', [5, ])</span></span><br><span class="line">    <span class="comment">#     result = cursor.fetchall()</span></span><br><span class="line">    <span class="comment">#     cursor.close()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#     print(result)</span></span><br></pre></td></tr></table></figure>
<h6 id="1-3-结论"><a href="#1-3-结论" class="headerlink" title="1.3 结论"></a>1.3 结论</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于上述原因，所以使用数据库连接池。每来一个请求从池中	取个连接，当连接取完过后，其他的请求在排队等待，当一个请求执行完毕后，将连接放回池中，供排队的请求使用</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="2-什么是DBUtils"><a href="#2-什么是DBUtils" class="headerlink" title="2. 什么是DBUtils"></a>2. 什么是DBUtils</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DBUtils是Python的一个用于实现数据库连接池的模块</span><br></pre></td></tr></table></figure>
<h5 id="3-DBUtils的2种模式"><a href="#3-DBUtils的2种模式" class="headerlink" title="3. DBUtils的2种模式"></a>3. DBUtils的2种模式</h5><h6 id="3-1-模式一：PersistentDB"><a href="#3-1-模式一：PersistentDB" class="headerlink" title="3.1 模式一：PersistentDB"></a>3.1 模式一：PersistentDB</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>提供线程专用的数据库连接，并自动管理连接。</span><br><span class="line"><span class="bullet">2. </span>为每个线程创建一个连接，线程即使调用了close方法，也不会关闭，只是把连接重新放到连接池，供自己线程再次使用。当线程终止时，连接自动关闭</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> DBUtils.PersistentDB <span class="keyword">import</span> PersistentDB</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">POOL = PersistentDB(</span><br><span class="line">    creator=pymysql,  <span class="comment"># 使用链接数据库的模块</span></span><br><span class="line">    maxusage=<span class="literal">None</span>,  <span class="comment"># 一个链接最多被重复使用的次数，None表示无限制</span></span><br><span class="line">    setsession=[],  <span class="comment"># 开始会话前执行的命令列表。</span></span><br><span class="line">    ping=<span class="number">0</span>,</span><br><span class="line">    <span class="comment"># ping MySQL服务端，检查是否服务可用。</span></span><br><span class="line">    closeable=<span class="literal">False</span>,</span><br><span class="line">    <span class="comment"># 如果为False时， conn.close() 实际上被忽略，供下次使用，再线程关闭时，才会自动关闭链接。如果为True时， conn.close()则关闭链接，那么再次调用pool.connection时就会报错，因为已经真的关闭了连接（pool.steady_connection()可以获取一个新的链接）</span></span><br><span class="line">    threadlocal=<span class="literal">None</span>,  <span class="comment"># 本线程独享值得对象，用于保存链接对象，如果链接对象被重置</span></span><br><span class="line">    host=<span class="string">'127.0.0.1'</span>,</span><br><span class="line">    port=<span class="number">3306</span>,</span><br><span class="line">    user=<span class="string">'root'</span>,</span><br><span class="line">    password=<span class="string">'123'</span>,</span><br><span class="line">    database=<span class="string">'pymysql'</span>,</span><br><span class="line">    charset=<span class="string">'utf8'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    conn = POOL.connection(shareable=<span class="literal">False</span>)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">'select * from user'</span>)</span><br><span class="line">    result = cursor.fetchall()</span><br><span class="line">    print(result)</span><br><span class="line">    cursor.close()</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    func()</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h6 id="3-2-模式二：PooledDB"><a href="#3-2-模式二：PooledDB" class="headerlink" title="3.2 模式二：PooledDB"></a>3.2 模式二：PooledDB</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>提供线程间可共享的数据库连接，并自动管理连接。</span><br><span class="line"><span class="bullet">2. </span>创建一批连接到连接池，供所有线程共享使用。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> DBUtils.PooledDB <span class="keyword">import</span> PooledDB</span><br><span class="line"></span><br><span class="line">POOL = PooledDB(</span><br><span class="line">    creator=pymysql,  <span class="comment"># 使用链接数据库的模块</span></span><br><span class="line">    maxconnections=<span class="number">6</span>,  <span class="comment"># 连接池允许的最大连接数，0和None表示不限制连接数</span></span><br><span class="line">    mincached=<span class="number">2</span>,  <span class="comment"># 初始化时，链接池中至少创建的空闲的链接，0表示不创建</span></span><br><span class="line">    maxcached=<span class="number">5</span>,  <span class="comment"># 链接池中最多闲置的链接，0和None不限制</span></span><br><span class="line">    maxshared=<span class="number">3</span>,</span><br><span class="line">    <span class="comment"># 链接池中最多共享的链接数量，0和None表示全部共享。PS: 无用，因为pymysql和MySQLdb等模块的 threadsafety都为1，所有值无论设置为多少，_maxcached永远为0，所以永远是所有链接都共享。</span></span><br><span class="line">    blocking=<span class="literal">True</span>,  <span class="comment"># 连接池中如果没有可用连接后，是否阻塞等待。True，等待；False，不等待然后报错</span></span><br><span class="line">    maxusage=<span class="literal">None</span>,  <span class="comment"># 一个链接最多被重复使用的次数，None表示无限制</span></span><br><span class="line">    setsession=[],  <span class="comment"># 开始会话前执行的命令列表。</span></span><br><span class="line">    ping=<span class="number">0</span>,</span><br><span class="line">    <span class="comment"># ping MySQL服务端，检查是否服务可用。</span></span><br><span class="line">    host=<span class="string">'127.0.0.1'</span>,</span><br><span class="line">    port=<span class="number">3306</span>,</span><br><span class="line">    user=<span class="string">'root'</span>,</span><br><span class="line">    password=<span class="string">'123'</span>,</span><br><span class="line">    database=<span class="string">'pymysql'</span>,</span><br><span class="line">    charset=<span class="string">'utf8'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 检测当前正在运行连接数的是否小于最大链接数，如果不小于则：等待或报raise TooManyConnections异常</span></span><br><span class="line">    <span class="comment"># 否则</span></span><br><span class="line">    <span class="comment"># 则优先去初始化时创建的链接中获取链接 SteadyDBConnection。</span></span><br><span class="line">    <span class="comment"># 然后将SteadyDBConnection对象封装到PooledDedicatedDBConnection中并返回。</span></span><br><span class="line">    <span class="comment"># 如果最开始创建的链接没有链接，则去创建一个SteadyDBConnection对象，再封装到PooledDedicatedDBConnection中并返回。</span></span><br><span class="line">    <span class="comment"># 一旦关闭链接后，连接就返回到连接池让后续线程继续使用。</span></span><br><span class="line">    conn = POOL.connection()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(th, '链接被拿走了', conn1._con)</span></span><br><span class="line">    <span class="comment"># print(th, '池子里目前有', pool._idle_cache, '\r\n')</span></span><br><span class="line"></span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">'select * from user'</span>)</span><br><span class="line">    result = cursor.fetchall()</span><br><span class="line">    print(result)</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    func()</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="三-SQLAlchemy模块"><a href="#三-SQLAlchemy模块" class="headerlink" title="三. SQLAlchemy模块"></a>三. SQLAlchemy模块</h4><h5 id="1-什么是SQLAlchemy"><a href="#1-什么是SQLAlchemy" class="headerlink" title="1. 什么是SQLAlchemy"></a>1. 什么是SQLAlchemy</h5><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQLAlchemy是一个基于Python实现的ORM框架。该框架建立在 <span class="built_in">DB</span> API之上，使用关系对象映射进行数据库操作，</span><br><span class="line"></span><br><span class="line">简言之便是：将类和对象转换成SQL，然后使用数据API执行SQL并获取执行结果。</span><br></pre></td></tr></table></figure>
<h5 id="2-安装-2"><a href="#2-安装-2" class="headerlink" title="2. 安装"></a>2. 安装</h5><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 <span class="keyword">install</span> sqlalchemy</span><br></pre></td></tr></table></figure>
<h5 id="3-组成"><a href="#3-组成" class="headerlink" title="3. 组成"></a>3. 组成</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. Engine，框架的引擎</span></span><br><span class="line"><span class="string">2. Connection Pooling ，数据库连接池</span></span><br><span class="line"><span class="string">3. Dialect，选择连接数据库的DB API种类</span></span><br><span class="line"><span class="string">4. Schema/Types，架构和类型</span></span><br><span class="line"><span class="string">5. SQL Exprression Language，SQL表达式语言</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h5 id="4-注意"><a href="#4-注意" class="headerlink" title="4. 注意"></a>4. 注意</h5><h6 id="4-1-SQLAlchemy本身无法操作数据库，其必须以来pymsql等第三方插件"><a href="#4-1-SQLAlchemy本身无法操作数据库，其必须以来pymsql等第三方插件" class="headerlink" title="4.1 SQLAlchemy本身无法操作数据库，其必须以来pymsql等第三方插件"></a>4.1 SQLAlchemy本身无法操作数据库，其必须以来pymsql等第三方插件</h6><h6 id="4-2-Dialect用于和数据API进行交流，根据配置文件的不同调用不同的数据库API，从而实现对数据库的操作"><a href="#4-2-Dialect用于和数据API进行交流，根据配置文件的不同调用不同的数据库API，从而实现对数据库的操作" class="headerlink" title="4.2 Dialect用于和数据API进行交流，根据配置文件的不同调用不同的数据库API，从而实现对数据库的操作"></a>4.2 Dialect用于和数据API进行交流，根据配置文件的不同调用不同的数据库API，从而实现对数据库的操作</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">MySQL-Python</span></span><br><span class="line"><span class="string">    mysql+mysqldb://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;[:&lt;port&gt;]/&lt;dbname&gt;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">pymysql</span></span><br><span class="line"><span class="string">    mysql+pymysql://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;/&lt;dbname&gt;[?&lt;options&gt;]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">MySQL-Connector</span></span><br><span class="line"><span class="string">    mysql+mysqlconnector://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;[:&lt;port&gt;]/&lt;dbname&gt;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">cx_Oracle</span></span><br><span class="line"><span class="string">    oracle+cx_oracle://user:pass@host:port/dbname[?key=value&amp;key=value...]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">更多：http://docs.sqlalchemy.org/en/latest/dialects/index.html</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="5-简单使用"><a href="#5-简单使用" class="headerlink" title="5. 简单使用"></a>5. 简单使用</h5><h6 id="5-1-注意事项"><a href="#5-1-注意事项" class="headerlink" title="5.1 注意事项"></a>5.1 注意事项</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>不能创建数据库</span><br><span class="line"></span><br><span class="line"><span class="bullet">2. </span>不能修改字段(去数据库改,在类中对应上)</span><br><span class="line"></span><br><span class="line"><span class="bullet">3. </span>只能创建表,删除表</span><br><span class="line"></span><br><span class="line"><span class="bullet">4. </span>增,删,改一定要记住commit()</span><br></pre></td></tr></table></figure>
<h6 id="5-2-执行原生sql（不常用）"><a href="#5-2-执行原生sql（不常用）" class="headerlink" title="5.2 执行原生sql（不常用）"></a>5.2 执行原生sql（不常用）</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.engine.base <span class="keyword">import</span> Engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 引擎对象,它是负责调度</span></span><br><span class="line">engine = create_engine(</span><br><span class="line">    <span class="comment"># 用pymysql模块链接数据库,用户,密码,地址,端口,数据库名,字符编码</span></span><br><span class="line">    <span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/pymysql?charset=utf8"</span>,</span><br><span class="line">    max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">    pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">    pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">    pool_recycle=<span class="number">-1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task</span><span class="params">(arg)</span>:</span></span><br><span class="line">    <span class="comment"># 从引擎对象中取出链接</span></span><br><span class="line">    conn = engine.raw_connection()</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(</span><br><span class="line">        <span class="string">"select * from user"</span></span><br><span class="line">    )</span><br><span class="line">    result = cursor.fetchall()</span><br><span class="line">    print(result)</span><br><span class="line">    cursor.close()</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">    t = threading.Thread(target=task, args=(i,))</span><br><span class="line">    t.start()</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">((1, '章成刚', '123'),)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h6 id="5-3-orm使用"><a href="#5-3-orm使用" class="headerlink" title="5.3 orm使用"></a>5.3 orm使用</h6><blockquote>
<p>models.py</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Text, ForeignKey, DateTime, UniqueConstraint, Index</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类似于django中model.Models,所有的类都要继承它</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Users</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'users'</span>  <span class="comment"># 数据库表名称</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="literal">True</span>)  <span class="comment"># id 主键</span></span><br><span class="line">    name = Column(String(<span class="number">32</span>), index=<span class="literal">True</span>, nullable=<span class="literal">False</span>)  <span class="comment"># name列，索引，不可为空</span></span><br><span class="line">    <span class="comment"># email = Column(String(32), unique=True)</span></span><br><span class="line">    <span class="comment"># datetime.datetime.now不能加括号，加了括号，以后永远是当前时间</span></span><br><span class="line">    <span class="comment"># ctime = Column(DateTime, default=datetime.datetime.now)</span></span><br><span class="line">    <span class="comment"># extra = Column(Text, nullable=True)</span></span><br><span class="line"></span><br><span class="line">    __table_args__ = (</span><br><span class="line">        <span class="comment"># UniqueConstraint('id', 'name', name='uix_id_name'), #联合唯一</span></span><br><span class="line">        <span class="comment"># Index('ix_id_name', 'name', 'email'), #索引</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据类创建数据库表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    engine = create_engine(</span><br><span class="line">        <span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/pymysql?charset=utf8"</span>,</span><br><span class="line">        max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">        pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">        pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">        pool_recycle=<span class="number">-1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 继承自base所有表的创建</span></span><br><span class="line">    Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drop_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据类删除数据库表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    engine = create_engine(</span><br><span class="line">        <span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/aaa?charset=utf8"</span>,</span><br><span class="line">        max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">        pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">        pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">        pool_recycle=<span class="number">-1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 删除所有继承自base的表</span></span><br><span class="line">    Base.metadata.drop_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># drop_db()</span></span><br><span class="line">    init_db()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>app.py</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="comment"># from models import Users</span></span><br><span class="line"><span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/pymysql?charset=utf8"</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每次执行数据库操作时，都需要创建一个session</span></span><br><span class="line"><span class="comment"># 区别于原生sql的操作</span></span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ############# 执行ORM操作 新增#############</span></span><br><span class="line"><span class="comment"># 生成一个对象</span></span><br><span class="line">obj1 = models.Users(name=<span class="string">"lqz"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增一条记录</span></span><br><span class="line">session.add(obj1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交事务</span></span><br><span class="line">session.commit()</span><br><span class="line"><span class="comment"># 关闭session</span></span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="6-单表操作"><a href="#6-单表操作" class="headerlink" title="6. 单表操作"></a>6. 单表操作</h5><blockquote>
<p>models.py</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Text, ForeignKey, DateTime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类似于django中model.Models,所有的类都要继承它</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Users</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'users'</span>  <span class="comment"># 数据库表名称</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="literal">True</span>)  <span class="comment"># id 主键</span></span><br><span class="line">    name = Column(String(<span class="number">32</span>), index=<span class="literal">True</span>, nullable=<span class="literal">False</span>)  <span class="comment"># name列，索引，不可为空</span></span><br><span class="line">    age = Column(String(<span class="number">32</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    __table_args__ = (</span><br><span class="line">        <span class="comment"># UniqueConstraint('id', 'name', name='uix_id_name'), #联合唯一</span></span><br><span class="line">        <span class="comment"># Index('ix_id_name', 'name', 'email'), #索引</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据类创建数据库表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    engine = create_engine(</span><br><span class="line">        <span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/single_form?charset=utf8"</span>,</span><br><span class="line">        max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">        pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">        pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">        pool_recycle=<span class="number">-1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 继承自base所有表的创建</span></span><br><span class="line">    Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drop_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据类删除数据库表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    engine = create_engine(</span><br><span class="line">        <span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/single_form?charset=utf8"</span>,</span><br><span class="line">        max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">        pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">        pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">        pool_recycle=<span class="number">-1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 删除所有继承自base的表</span></span><br><span class="line">    Base.metadata.drop_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># drop_db()</span></span><br><span class="line">    init_db()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>app.py</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="comment"># from models import Users</span></span><br><span class="line"><span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/single_form?charset=utf8"</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每次执行数据库操作时，都需要创建一个session</span></span><br><span class="line"><span class="comment"># 区别于原生sql的操作</span></span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.....写增删改查逻辑</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交事务</span></span><br><span class="line">session.commit()</span><br><span class="line"><span class="comment"># 关闭session</span></span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>
<h6 id="6-1-增"><a href="#6-1-增" class="headerlink" title="6.1 增"></a>6.1 增</h6><blockquote>
<p><strong>1.新增单条记录：add</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">obj1 = models.Users(name="lqz", age="18")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">session.add(obj1)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>2. 新增多条记录：add_all</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">obj1 = models.Users(name="lqz", age="18")</span></span><br><span class="line"><span class="string">obj2 = models.Users(name="zcg", age="19")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">session.add_all([obj1, obj2])</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="6-2-改"><a href="#6-2-改" class="headerlink" title="6.2 改"></a>6.2 改</h6><blockquote>
<p><strong>1. 传字典：update</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 将age是19的人的名字改成zhang</span></span><br><span class="line"><span class="string">session.query(models.Users).filter_by(age="19").update(&#123;"name": "zhang"&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 将id大于0的所有user的名字改成lqz</span></span><br><span class="line"><span class="string">session.query(models.Users).filter(models.Users.id &gt; 0).update(&#123;"name": "lqz"&#125;)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>2. 类似于django的F查询：update</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 将user的名字是zhang的人的名字改成名字+chenggang</span></span><br><span class="line"><span class="string">session.query(models.Users).filter(models.Users.name == "zhang").update(&#123;models.Users.name: models.Users.name+"chenggang"&#125;,synchronize_session=False)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="6-3-删"><a href="#6-3-删" class="headerlink" title="6.3 删"></a>6.3 删</h6><blockquote>
<p><strong>1. delete</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 删除user的id是3的人</span></span><br><span class="line"><span class="string">session.query(models.Users).filter(models.Users.id == 3).delete()</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h6 id="6-4-查"><a href="#6-4-查" class="headerlink" title="6.4 查"></a>6.4 查</h6><blockquote>
<p><strong>1.查所有-all</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 查询User表中所有的记录</span></span><br><span class="line"><span class="string">r1 = session.query(models.Users).all()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[&lt;models.Users object at 0x000002BC3634AA20&gt;, &lt;models.Users object at 0x000002BC363835C0&gt;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 只取name列，把name重命名为xx</span></span><br><span class="line"><span class="string">r2 = session.query(models.Users.name.label('xx')).all()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[('lqz',), ('zhangchenggang',)]</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>2. filter过滤查询-all</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 查询User名字是lqz的所有人</span></span><br><span class="line"><span class="string">r3 = session.query(Users).filter(Users.name == "lqz").all()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[&lt;models.Users object at 0x0000024AC9495AC8&gt;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>3. filter_by过滤查询-all</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 查询所有名字是lqz且id是1的人</span></span><br><span class="line"><span class="string">r4 = session.query(Users).filter_by(name='lqz', id=1).all()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[&lt;models.Users object at 0x000001C886B45B38&gt;]</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>4. filter和filter_by的区别</strong></p>
</blockquote>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter传的是表达式，filter<span class="number">_</span><span class="meta">by</span>传的是参数</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p><strong>5. first查询</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 查出名字lqz的第一个记录</span></span><br><span class="line"><span class="string">r5 = session.query(Users).filter_by(name='lqz').first()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;models.Users object at 0x000001947DD55BE0&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>6. params查询</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from sqlalchemy.sql import text</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">:value 和:name 相当于占位符，用params传参数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1.查询id小于3且name=lqz的所有的人，并按照id进行排序</span></span><br><span class="line"><span class="string">r6 = session.query(Users).filter(text("id&lt;:value and name=:name")).params(value=3, name='lqz').order_by(Users.id).all()</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>7. 自定义查询sql</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 查询名字是zhangchenggang的所有人</span></span><br><span class="line"><span class="string">r7 = session.query(Users).from_statement(text("SELECT * FROM users where name=:name")).params(name='zhangchenggang').all()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[&lt;models.Users object at 0x0000027DEA943898&gt;]</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="7-orm一对多关系"><a href="#7-orm一对多关系" class="headerlink" title="7. orm一对多关系"></a>7. orm一对多关系</h5><h6 id="7-1-关联字段写在多的地方"><a href="#7-1-关联字段写在多的地方" class="headerlink" title="7.1 关联字段写在多的地方"></a>7.1 关联字段写在多的地方</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Text, ForeignKey, DateTime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类似于django中model.Models,所有的类都要继承它</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hobby</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'hobby'</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    caption = Column(String(<span class="number">50</span>), default=<span class="string">'篮球'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'person'</span></span><br><span class="line">    nid = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">32</span>), index=<span class="literal">True</span>, nullable=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># hobby指的是tablename而不是类名</span></span><br><span class="line">    hobby_id = Column(Integer, ForeignKey(<span class="string">"hobby.id"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 跟数据库无关，不会新增字段，只用于快速链表操作</span></span><br><span class="line">    <span class="comment"># 类名，backref用于反向查询</span></span><br><span class="line">    hobby = relationship(<span class="string">'Hobby'</span>, backref=<span class="string">'person'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据类创建数据库表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    engine = create_engine(</span><br><span class="line">        <span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/single_form?charset=utf8"</span>,</span><br><span class="line">        max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">        pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">        pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">        pool_recycle=<span class="number">-1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 继承自base所有表的创建</span></span><br><span class="line">    Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drop_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据类删除数据库表</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    engine = create_engine(</span><br><span class="line">        <span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/single_form?charset=utf8"</span>,</span><br><span class="line">        max_overflow=<span class="number">0</span>,  <span class="comment"># 超过连接池大小外最多创建的连接</span></span><br><span class="line">        pool_size=<span class="number">5</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">        pool_timeout=<span class="number">30</span>,  <span class="comment"># 池中没有线程最多等待的时间，否则报错</span></span><br><span class="line">        pool_recycle=<span class="number">-1</span>  <span class="comment"># 多久之后对线程池中的线程进行一次连接的回收（重置）</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 删除所有继承自base的表</span></span><br><span class="line">    Base.metadata.drop_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># drop_db()</span></span><br><span class="line">    init_db()</span><br></pre></td></tr></table></figure>
<h5 id="8-多对多关系"><a href="#8-多对多关系" class="headerlink" title="8. 多对多关系"></a>8. 多对多关系</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="9-单表查询"><a href="#9-单表查询" class="headerlink" title="9. 单表查询"></a>9. 单表查询</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">查询：********非常重要**********</span><br><span class="line"><span class="number">1.</span>all()取到表中所有记录放入列表中</span><br><span class="line">r1 = session.query(models.Users).all()</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>filter() 相当于sql中的where，后面以表达式形式跟过滤条件</span><br><span class="line">r3 = session.query(Users).filter(Users.name == <span class="string">"lqz"</span>).all()</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>first() 从查出的结果中取第一个记录</span><br><span class="line">r5 = session.query(Users).filter_by(name=<span class="string">'lqz'</span>).first()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ret = models.Book.objects.filter(name=<span class="string">"水浒传"</span>, id=<span class="number">11</span>)</span><br><span class="line">print(ret) --取到名字是水浒传且id是<span class="number">1</span>的queryset对象</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>get() 有且只有一个结果，返回的是表中的一条记录，不是queryset对象</span><br><span class="line">r8 = session.query(models.Users).get(ident=<span class="number">1</span>) --返回唯一的对象</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>order_by() 按指定字段排序，默认是asc，-号是desc</span><br><span class="line">r9 = session.query(models.Users).order_by(<span class="string">"age"</span>).all()</span><br><span class="line"></span><br><span class="line">r9 = session.query(models.Users).order_by(<span class="string">"-age"</span>).all()</span><br><span class="line"></span><br><span class="line">r9 = session.query(models.Users).order_by(<span class="string">"age"</span>,<span class="string">"name"</span>).all() --可以传多个值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>count() 查询结果的个数，是int类型</span><br><span class="line">r9 = session.query(models.Users).count()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>values(*field) 返回生成器对象</span><br><span class="line"></span><br><span class="line">r9 = session.query(models.Users).filter_by(name=<span class="string">"lqz"</span>).values(<span class="string">"name"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>distinct() 必须完全一样,才能去重   只要带了id,去重就没有意义了</span><br><span class="line"></span><br><span class="line">r9 = session.query(models.Users.age).filter_by(name=<span class="string">"lqz"</span>).distinct()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">查询：基于双下划线的模糊查询</span><br><span class="line"><span class="number">1.</span>大于gt &gt;</span><br><span class="line">ret = session.query(models.Users).filter(models.Users.id &gt; <span class="number">1</span>).all()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>小于lt &lt;</span><br><span class="line">ret = session.query(models.Users).filter(models.Users.age &lt; <span class="number">19</span>).all()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>大于等于gte &gt;=</span><br><span class="line">ret = session.query(models.Users).filter(models.Users.age &gt;= <span class="number">19</span>).all()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>小于等于lte &lt;=</span><br><span class="line">ret = session.query(models.Users).filter(models.Users.age &lt;= <span class="number">18</span>).all()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>在什么之中 <span class="keyword">in</span></span><br><span class="line">ret = session.query(models.Users).filter(models.Users.age.in_([<span class="number">19</span>,])).all()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>在什么范围中 range = between <span class="keyword">and</span></span><br><span class="line">ret = session.query(models.Users).filter(models.Users.age.between(<span class="number">19</span>,<span class="number">20</span>)).all()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>查询在字段中是否包含某个字contains 首尾中全符合</span><br><span class="line">ret = session.query(models.Users).filter(models.Users.name.contains(<span class="string">"c"</span>)).all()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>以什么开头startswith </span><br><span class="line">ret = session.query(models.Users).filter(models.Users.name.startswith(<span class="string">"z"</span>)).all()</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="number">9.</span>以什么结尾endswith 不能查询价格之类的字段</span><br><span class="line">ret = session.query(models.Users).filter(models.Users.name.endswith(<span class="string">"z"</span>)).all())</span><br><span class="line">print(ret)</span><br><span class="line"></span><br><span class="line"><span class="number">10.</span>按年查询：year | month | day</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> extract, and_</span><br><span class="line"></span><br><span class="line">historys = History.query.filter(_and(</span><br><span class="line">    extract(<span class="string">'year'</span>, History.date) == <span class="number">2016</span>,</span><br><span class="line">    extract(<span class="string">'month'</span>, History.date) == <span class="number">12</span></span><br><span class="line">).all()</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="10-常用操作-增删改"><a href="#10-常用操作-增删改" class="headerlink" title="10.常用操作:增删改"></a>10.常用操作:增删改</h5><h6 id="10-1-插入数据"><a href="#10-1-插入数据" class="headerlink" title="10.1 插入数据"></a>10.1 插入数据</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Session = sessionmaker(bind=engine)  <span class="comment"># 获取 Session类</span></span><br><span class="line">ses = Session()  <span class="comment"># 获取session对象</span></span><br><span class="line"></span><br><span class="line">zhangsan = Student(name=<span class="string">"zhangsan"</span>, gender=<span class="number">1</span>, std_id=<span class="string">'XS331'</span>, teacher=<span class="string">'hanmeimei'</span>, math=<span class="number">90</span>)</span><br><span class="line">lisi = Student(name=<span class="string">"lisi"</span>, gender=<span class="number">1</span>, std_id=<span class="string">'XS332'</span>, teacher=<span class="string">'hanmeimei'</span>, math=<span class="number">10</span>)</span><br><span class="line">wangwu = Student(name=<span class="string">"wangwu"</span>, gender=<span class="number">0</span>, std_id=<span class="string">'XS333'</span>, teacher=<span class="string">'lilei'</span>, math=<span class="number">60</span>)</span><br><span class="line">zhaoliu = Student(name=<span class="string">"zhaoliu"</span>, gender=<span class="number">0</span>, std_id=<span class="string">'XS337'</span>, teacher=<span class="string">'lilei'</span>, math=<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line">ses.add(zhangsan)  <span class="comment"># 单条添加</span></span><br><span class="line">ses.add_all([lisi, wangwu, zhaoliu])  <span class="comment"># 批量添加</span></span><br><span class="line">ses.commit()</span><br></pre></td></tr></table></figure>
<h6 id="10-2-修改数据"><a href="#10-2-修改数据" class="headerlink" title="10.2 修改数据"></a>10.2 修改数据</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zhangsan = ses.query(Student).filter_by(name=<span class="string">'zhangsan'</span>).first()  <span class="comment">#先获取对象</span></span><br><span class="line">zhangsan.math = <span class="number">91</span>  <span class="comment">#更改对象的属性</span></span><br><span class="line">ses.commit()   <span class="comment">#提交</span></span><br></pre></td></tr></table></figure>
<p>也可以在还创建数据的时候修改，就是在提交之前进行修改：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">liqi = Student(name=<span class="string">"liqi"</span>, gender=<span class="number">1</span>, std_id=<span class="string">'XS335'</span>, teacher=<span class="string">'xiadonghai'</span>, math=<span class="number">100</span>)   <span class="comment">#实例化一个对象</span></span><br><span class="line">ses.add(liqi)  <span class="comment">#添加对象，也可以视作添加一条数据</span></span><br><span class="line">liqi = ses.query(Student).filter_by(name=<span class="string">'liqi'</span>).first()</span><br><span class="line">liqi.gender = <span class="number">0</span></span><br><span class="line">ses.commit()</span><br></pre></td></tr></table></figure>
<p>在创建一个对象之后，未添加之前直接改变其属性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">liqi = Student(name=<span class="string">"liqi"</span>, gender=<span class="number">1</span>, std_id=<span class="string">'XS335'</span>, teacher=<span class="string">'xiadonghai'</span>, math=<span class="number">100</span>)</span><br><span class="line">liqi.gender = <span class="number">0</span></span><br><span class="line">ses.add(liqi)</span><br><span class="line">ses.commit()</span><br></pre></td></tr></table></figure>
<p>除此之外还可以使用update。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sess.query(Student).filter_by(name=<span class="string">'liming'</span>).update(&#123;<span class="string">'gender'</span>:<span class="number">0</span>&#125;)</span><br><span class="line">sess.commit()</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="10-3-删除数据"><a href="#10-3-删除数据" class="headerlink" title="10.3 删除数据"></a>10.3 删除数据</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">result = sess.query(Student).filter(Student.id == <span class="number">1</span> ).delete()</span><br><span class="line">sess.commit()</span><br><span class="line">result = sess.query(Student).filter(Student.id == <span class="number">2</span> ).first()</span><br><span class="line">sess.delete(result)</span><br><span class="line">sess.commit()</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="11-常用操作：查"><a href="#11-常用操作：查" class="headerlink" title="11. 常用操作：查"></a>11. 常用操作：查</h5><h6 id="11-1-算术操作符"><a href="#11-1-算术操作符" class="headerlink" title="11.1 算术操作符"></a>11.1 算术操作符</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">= 操作符</span><br><span class="line">students_99 = sess.query(Student).filter_by(name =<span class="string">'zhangsan'</span>).all()</span><br><span class="line">students_100 = sess.query(Student).filter(Student.name == <span class="string">'zhangsan'</span>).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> students_100:</span><br><span class="line">   print(i.name)</span><br><span class="line"></span><br><span class="line">！= 操作符</span><br><span class="line">student_101 = sess.query(Student).filter_by(name != <span class="string">'liming'</span>).all()  <span class="comment"># error</span></span><br><span class="line">student_98 = sess.query(Student).filter(Student.name != <span class="string">'liming'</span>).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_98:</span><br><span class="line">  print(i.name)</span><br><span class="line"></span><br><span class="line"> &gt; ,&lt;, &lt;=, &gt;=, 操作符</span><br><span class="line">student_60 = sess.query(Student).filter(Student.math &gt; <span class="number">10</span>).all()</span><br><span class="line">student_61= sess.query(Student).filter_by(math&gt;<span class="number">10</span>).all()  <span class="comment"># error</span></span><br><span class="line">student_62 = sess.query(Student).filter(Student.math &lt; <span class="number">100</span>).all()</span><br><span class="line">student_63 = sess.query(Student).filter(Student.math &lt;= <span class="number">90</span>).all()</span><br><span class="line">student_64 = sess.query(Student).filter(Student.math &gt;= <span class="number">90</span>).all()</span><br><span class="line">student_64 = sess.query(Student).filter(Student.math &lt;&gt; <span class="number">90</span>).all()  <span class="comment"># error</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_60:</span><br><span class="line">    print(i.math)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_62:</span><br><span class="line">    print(i.math)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_63:</span><br><span class="line">    print(i.math)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_64:</span><br><span class="line">    print(i.math)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-2-模糊查询"><a href="#11-2-模糊查询" class="headerlink" title="11.2 模糊查询"></a>11.2 模糊查询</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">like 操作符  % 代表任意多个字符  _ 代表一个字符</span><br><span class="line">student_17 = sess.query(Student).filter(Student.name.like(<span class="string">"%i%"</span>)).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_17:</span><br><span class="line">    print(i.name)</span><br><span class="line">student_17_2 = sess.query(Student).filter(Student.name.like(<span class="string">"%i_i"</span>)).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_17_2:</span><br><span class="line">    print(i.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">not</span> like</span><br><span class="line">student_70 = sess.query(Student).filter(~Student.name.like(<span class="string">"%i_i"</span>)).all()</span><br><span class="line">student_71 = sess.query(Student).filter(Student.name.notlike(<span class="string">"%i_i"</span>)).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_70:</span><br><span class="line">    print(i.name)</span><br><span class="line">print(student_70 == student_71)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-3-区间选取"><a href="#11-3-区间选取" class="headerlink" title="11.3 区间选取"></a>11.3 区间选取</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">in</span> 操作符</span><br><span class="line">student_18 = sess.query(Student).filter(Student.name.in_([<span class="string">'zhangsan'</span>,<span class="string">'lisi'</span>,<span class="string">'wangwu'</span>])).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_18:</span><br><span class="line">    print(i.name)</span><br><span class="line"><span class="keyword">not</span> <span class="keyword">in</span></span><br><span class="line">student_19 = sess.query(Student).filter(~Student.name.in_([<span class="string">'lisi'</span>])).all()</span><br><span class="line">student_19_2 = sess.query(Student).filter(Student.name.notin_([<span class="string">'lisi'</span>])).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_19:</span><br><span class="line">    print(i.name)</span><br><span class="line">print(student_19 == student_19_2)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-4-分页"><a href="#11-4-分页" class="headerlink" title="11.4 分页"></a>11.4 分页</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">student_10 = sess.query(Student).limit(<span class="number">2</span>).offset(<span class="number">1</span>).all()  <span class="comment">#从第几条开始选取几条</span></span><br><span class="line">student_11 = sess.query(Student).offset(<span class="number">1</span>).limit(<span class="number">2</span>).all()</span><br><span class="line">student_12 = sess.query(Student)[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_10:</span><br><span class="line">    print(i.id)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_11:</span><br><span class="line">    print(i.id)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_12:</span><br><span class="line">    print(i.id)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-5-排序"><a href="#11-5-排序" class="headerlink" title="11.5 排序"></a>11.5 排序</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">order_by 排序</span><br><span class="line">student_33 = sess.query(Student).filter(text(<span class="string">"math &gt;= 10"</span>)).order_by(~text(<span class="string">"math"</span>)).all()  <span class="comment"># 逆序</span></span><br><span class="line">student_33_2 = sess.query(Student).filter(text(<span class="string">"math &gt;= 10"</span>)).order_by(text(<span class="string">"math"</span>)).all()  <span class="comment"># 顺序</span></span><br><span class="line">student_33_2_1 = sess.query(Student).filter(text(<span class="string">"math &gt;= 10"</span>)).order_by(desc(text(<span class="string">"math"</span>))).all()  <span class="comment"># 逆序</span></span><br><span class="line">student_33_3 = sess.query(Student).order_by(desc(Student.math)).all()  <span class="comment"># 逆序</span></span><br><span class="line">student_33_4 = sess.query(Student).order_by(Student.math.desc()).all()  <span class="comment"># 逆序</span></span><br><span class="line">student_33_5 = sess.query(Student).order_by(~Student.math).all()  <span class="comment"># 逆序</span></span><br><span class="line">student_33_6 = sess.query(Student).order_by(Student.math).all()  <span class="comment"># 顺序</span></span><br><span class="line"></span><br><span class="line">print(student_31)</span><br><span class="line">print(student_32)</span><br><span class="line">print(<span class="string">"___"</span>* <span class="number">30</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_33:</span><br><span class="line">    print(i.math)</span><br><span class="line">print(<span class="string">"___"</span>* <span class="number">30</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_33_2:</span><br><span class="line">    print(i.math)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_33_3:</span><br><span class="line">    print(i.math)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_33_4:</span><br><span class="line">    print(i.math)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_33_5:</span><br><span class="line">    print(i.math)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_33_6:</span><br><span class="line">    print(i.math)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-6-分组"><a href="#11-6-分组" class="headerlink" title="11.6 分组"></a>11.6 分组</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">group_by 分组</span><br><span class="line"></span><br><span class="line">student_39 = sess.query(Student).group_by(Student.gender == <span class="number">1</span>).count()</span><br><span class="line">print(student_39)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-7-having：分组之后条件过滤"><a href="#11-7-having：分组之后条件过滤" class="headerlink" title="11.7 having：分组之后条件过滤"></a>11.7 having：分组之后条件过滤</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">having</span><br><span class="line"></span><br><span class="line">student_39_1 = sess.query(Student).group_by(Student.gender == <span class="number">1</span>).having(Student.math&gt;<span class="number">60</span>).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_39_1:</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-8-计数"><a href="#11-8-计数" class="headerlink" title="11.8 计数"></a>11.8 计数</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">count</span><br><span class="line"></span><br><span class="line">student_38 = sess.query(Student).filter_by(gender=<span class="number">1</span>).count()</span><br><span class="line">student_38_2 = sess.query(func.count(Student.name),Student.name).group_by(Student.name).all()</span><br><span class="line">student_38_3 = sess.query(func.count(Student.name),Student.gender).group_by(Student.gender).all()</span><br><span class="line">print(student_38_2)</span><br><span class="line">print(student_38_3)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-9-去重"><a href="#11-9-去重" class="headerlink" title="11.9 去重"></a>11.9 去重</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">distinct</span><br><span class="line"></span><br><span class="line">student_40 = sess.query(distinct(Student.name)).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_40:</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-10-空值"><a href="#11-10-空值" class="headerlink" title="11.10 空值"></a>11.10 空值</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">是否为null</span><br><span class="line">student_20 = sess.query(Student).filter(Student.name != <span class="literal">None</span>).all()</span><br><span class="line">student_21 = sess.query(Student).filter(~Student.name.is_(<span class="literal">None</span>)).all()</span><br><span class="line">student_22 = sess.query(Student).filter(Student.name.isnot(<span class="literal">None</span>)).all()</span><br><span class="line">student_21_3 = sess.query(Student).filter(Student.name.is_(<span class="string">'zhangsan'</span>)).all()  <span class="comment"># error</span></span><br><span class="line">student_21_2 = sess.query(Student).filter(Student.name.is_(<span class="number">1</span>)).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_20:</span><br><span class="line">    print(i.name)</span><br><span class="line">print(student_20 == student_21 == student_22)</span><br><span class="line"></span><br><span class="line">student_23 = sess.query(Student).filter(Student.math.is_(<span class="number">90</span>)).all()</span><br><span class="line">student_24 = sess.query(Student).filter(Student.math == <span class="literal">None</span>).all()</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-11-逻辑操作"><a href="#11-11-逻辑操作" class="headerlink" title="11.11 逻辑操作"></a>11.11 逻辑操作</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span></span><br><span class="line">student_25 = sess.query(Student).filter(Student.gender == <span class="number">1</span>, Student.math &gt; <span class="number">70</span>).all()</span><br><span class="line">student_26 = sess.query(Student).filter(and_(Student.gender == <span class="number">1</span>, Student.math &gt; <span class="number">70</span>)).all()  <span class="comment"># 别忘了引入该方法</span></span><br><span class="line">student_27 = sess.query(Student).filter(Student.gender == <span class="number">1</span>).filter(Student.math &gt; <span class="number">70</span>).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_25:</span><br><span class="line">    print(i.name)</span><br><span class="line">print(student_25 == student_26 == student_27)</span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">student_28 = sess.query(Student).filter(or_(Student.gender == <span class="number">1</span>, Student.math &gt; <span class="number">80</span>)).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_28:</span><br><span class="line">    print(i.name)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-12-text：原生sql语句"><a href="#11-12-text：原生sql语句" class="headerlink" title="11.12 text：原生sql语句"></a>11.12 text：原生sql语句</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">text  原生sql条件语句</span><br><span class="line">student_31 = sess.query(Student).filter(text(<span class="string">"name='lisi'"</span>)).first()  <span class="comment"># 注意值为字符串时的写法</span></span><br><span class="line">student_32 = sess.query(Student).filter(text(<span class="string">"id=1"</span>)).first()  <span class="comment"># 注意值为 数字 的写法</span></span><br><span class="line">student_31 = sess.query(Student).filter(text(<span class="string">"id&gt;1 and math&gt;10"</span>)).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_31:</span><br><span class="line">    print(i.name)</span><br><span class="line"></span><br><span class="line">text 插入变量</span><br><span class="line">student_34 =sess.query(Student).filter(text(<span class="string">"gender=:sex and math&gt;:score"</span>)).params(sex=<span class="number">1</span>, score=<span class="number">1</span>).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_34:</span><br><span class="line">    print(i.name)</span><br><span class="line"></span><br><span class="line">from_statement 原生sql语句</span><br><span class="line">student_35 = sess.query(Student).from_statement(text(<span class="string">"select * from students where id=:id"</span>)).params(id=<span class="number">1</span>).one()</span><br><span class="line">student_36 = sess.query(Student).from_statement(<span class="string">"select * from students where math&gt;:score"</span>).params(score=<span class="number">10</span>).all()</span><br><span class="line">student_36_1 = sess.query(Student).from_statement(<span class="string">"select * from students where math&gt;10"</span>).all()</span><br><span class="line">print(student_35)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_36:</span><br><span class="line">    print(i.name)</span><br><span class="line">print(student_36 == student_36_1)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-13-使用别名"><a href="#11-13-使用别名" class="headerlink" title="11.13 使用别名"></a>11.13 使用别名</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">student_7 = sess.query(Student.name.label(<span class="string">'std_name'</span>)).all()</span><br><span class="line">print(student_7)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_7:</span><br><span class="line">    print(i.std_name)</span><br><span class="line">    print(i[<span class="number">0</span>])  <span class="comment"># 第二种取值方式</span></span><br><span class="line">    </span><br><span class="line">student_8 = sess.query(Student.name).all()</span><br><span class="line">print(student_8)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_8:</span><br><span class="line">    print(i.name)</span><br><span class="line">    print(i[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-14-取值"><a href="#11-14-取值" class="headerlink" title="11.14 取值"></a>11.14 取值</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">根据主键获取对象</span><br><span class="line">students_1 = sess.query(Student).get(<span class="number">1</span>)</span><br><span class="line">print(students_1</span><br><span class="line"></span><br><span class="line">value指定要获取的字段 返回的是生成器</span><br><span class="line">students_3  = sess.query(Student).value(Student.name)</span><br><span class="line">print(students_3)</span><br><span class="line"></span><br><span class="line">values 指定多个字段 返回的是生成器</span><br><span class="line">students_3_2  = sess.query(Student).values(Student.id,Student.name)</span><br><span class="line">print(students_3_2)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> students_3_2:</span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">一次获取多个字段值</span><br><span class="line">students_4 = sess.query(Student.name,Student.gender).all()</span><br><span class="line">print(students_4)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> students_4:</span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line">后续添加的方式选择要得到的字段结果</span><br><span class="line">students_5 = sess.query(Student.name).add_columns(Student.gender).all()</span><br><span class="line">print(students_5)</span><br><span class="line">student_6 = sess.query(Student).filter_by(name=<span class="string">"王大麻子"</span>).one()</span><br><span class="line">print(student_6)</span><br><span class="line"></span><br><span class="line">错误用法</span><br><span class="line">error_1 = sess.query(Student).filter_by(and_(Student.id == <span class="number">1</span>, Student.name == <span class="string">'lisi'</span>)).first()</span><br><span class="line">error_2 = sess.query(Student).filter_by(and_(id=<span class="number">1</span>, name=<span class="string">'lisi'</span>)).first()</span><br><span class="line">error_3 = sess.query(Student).filter(and_(id=<span class="number">1</span>, name=<span class="string">'lisi'</span>)).first()</span><br><span class="line"></span><br><span class="line">one 有且只有一个，否则报错</span><br><span class="line">student_30 = sess.query(Student).filter(Student.id == <span class="number">1</span>).one()</span><br><span class="line">print(student_30)</span><br><span class="line">可以只有一个或者没有，不能为多个结果，否则报错</span><br><span class="line">student_31 = sess.query(Student).filter(Student.id == <span class="number">10</span>).one_or_none()</span><br><span class="line">print(student_31)</span><br><span class="line"></span><br><span class="line">student_13 = sess.query(Student).filter_by(id=<span class="number">1</span>).one_or_none()</span><br><span class="line">student_14 = sess.query(Student).filter(Student.id == <span class="number">1</span>).one_or_none()</span><br><span class="line">print(student_13)</span><br><span class="line">print(student_14)</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="11-15-chain链式调用"><a href="#11-15-chain链式调用" class="headerlink" title="11.15 chain链式调用"></a>11.15 chain链式调用</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">student_15 = sess.query(Student).filter_by(gender=<span class="number">1</span>).filter(Student.math&gt;<span class="number">80</span>).all()</span><br><span class="line"><span class="comment"># student_15_2 = sess.query(Student).filter_by(gender=1).filter_by(math&gt;80).all()  # error</span></span><br><span class="line">student_16 = sess.query(Student).filter(Student.gender == <span class="number">1</span>).filter(Student.math&gt;<span class="number">80</span>).all()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_15:</span><br><span class="line">    print(i.name)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> student_16:</span><br><span class="line">    print(i.name)</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="12-一对多的操作"><a href="#12-一对多的操作" class="headerlink" title="12. 一对多的操作"></a>12. 一对多的操作</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, ForeignKey, UniqueConstraint, Index</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, relationship</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> text</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.engine.result <span class="keyword">import</span> ResultProxy</span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> Users, Hosts, Hobby, Person</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/s6?charset=utf8"</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">session.add_all([</span></span><br><span class="line"><span class="string">    Hobby(caption='乒乓球'),</span></span><br><span class="line"><span class="string">    Hobby(caption='羽毛球'),</span></span><br><span class="line"><span class="string">    Person(name='张三', hobby_id=3),</span></span><br><span class="line"><span class="string">    Person(name='李四', hobby_id=4),</span></span><br><span class="line"><span class="string">])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">person = Person(name='张九', hobby=Hobby(caption='姑娘'))</span></span><br><span class="line"><span class="string">session.add(person)</span></span><br><span class="line"><span class="string">#添加二</span></span><br><span class="line"><span class="string">hb = Hobby(caption='人妖')</span></span><br><span class="line"><span class="string">hb.pers = [Person(name='文飞'), Person(name='博雅')]</span></span><br><span class="line"><span class="string">session.add(hb)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">session.commit()</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用relationship正向查询</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">v = session.query(Person).first()</span></span><br><span class="line"><span class="string">print(v.name)</span></span><br><span class="line"><span class="string">print(v.hobby.caption)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用relationship反向查询</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">v = session.query(Hobby).first()</span></span><br><span class="line"><span class="string">print(v.caption)</span></span><br><span class="line"><span class="string">print(v.pers)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="comment">#方式一，自己链表</span></span><br><span class="line"><span class="comment"># person_list=session.query(models.Person.name,models.Hobby.caption).join(models.Hobby,isouter=True).all()</span></span><br><span class="line">person_list=session.query(models.Person,models.Hobby).join(models.Hobby,isouter=<span class="literal">True</span>).all()</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> person_list:</span><br><span class="line">    <span class="comment"># print(row.name,row.caption)</span></span><br><span class="line">    print(row[<span class="number">0</span>].name,row[<span class="number">1</span>].caption)</span><br><span class="line"></span><br><span class="line"><span class="comment">#方式二：通过relationship</span></span><br><span class="line"></span><br><span class="line">person_list=session.query(models.Person).all()</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> person_list:</span><br><span class="line">    print(row.name,row.hobby.caption)</span><br><span class="line"><span class="comment">#查询喜欢姑娘的所有人</span></span><br><span class="line">obj=session.query(models.Hobby).filter(models.Hobby.id==<span class="number">1</span>).first()</span><br><span class="line">persons=obj.pers</span><br><span class="line">print(persons)</span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="13-多对多的操作"><a href="#13-多对多的操作" class="headerlink" title="13. 多对多的操作"></a>13. 多对多的操作</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, ForeignKey, UniqueConstraint, Index</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, relationship</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> text</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.engine.result <span class="keyword">import</span> ResultProxy</span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> Users, Hosts, Hobby, Person, Group, Server, Server2Group</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/s6?charset=utf8"</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">session.add_all([</span></span><br><span class="line"><span class="string">    Server(hostname='c1.com'),</span></span><br><span class="line"><span class="string">    Server(hostname='c2.com'),</span></span><br><span class="line"><span class="string">    Group(name='A组'),</span></span><br><span class="line"><span class="string">    Group(name='B组'),</span></span><br><span class="line"><span class="string">])</span></span><br><span class="line"><span class="string">session.commit()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">s2g = Server2Group(server_id=1, group_id=1)</span></span><br><span class="line"><span class="string">session.add(s2g)</span></span><br><span class="line"><span class="string">session.commit()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gp = Group(name='C组')</span></span><br><span class="line"><span class="string">gp.servers = [Server(hostname='c3.com'),Server(hostname='c4.com')]</span></span><br><span class="line"><span class="string">session.add(gp)</span></span><br><span class="line"><span class="string">session.commit()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ser = Server(hostname='c6.com')</span></span><br><span class="line"><span class="string">ser.groups = [Group(name='F组'),Group(name='G组')]</span></span><br><span class="line"><span class="string">session.add(ser)</span></span><br><span class="line"><span class="string">session.commit()</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用relationship正向查询</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">v = session.query(Group).first()</span></span><br><span class="line"><span class="string">print(v.name)</span></span><br><span class="line"><span class="string">print(v.servers)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用relationship反向查询</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">v = session.query(Server).first()</span></span><br><span class="line"><span class="string">print(v.hostname)</span></span><br><span class="line"><span class="string">print(v.groups)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="14-其他不常用操作"><a href="#14-其他不常用操作" class="headerlink" title="14. 其他不常用操作"></a>14. 其他不常用操作</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, ForeignKey, UniqueConstraint, Index</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, relationship</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> text, func</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.engine.result <span class="keyword">import</span> ResultProxy</span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> Users, Hosts, Hobby, Person, Group, Server, Server2Group</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/s6?charset=utf8"</span>, max_overflow=<span class="number">0</span>, pool_size=<span class="number">5</span>)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关联子查询:correlate(Group)表示跟Group表做关联，as_scalar相当于对该sql加括号，用于放在后面当子查询</span></span><br><span class="line">subqry = session.query(func.count(Server.id).label(<span class="string">"sid"</span>)).filter(Server.id == Group.id).correlate(Group).as_scalar()</span><br><span class="line">result = session.query(Group.name, subqry)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">SELECT `group`.name AS group_name, (SELECT count(server.id) AS sid </span></span><br><span class="line"><span class="string">FROM server </span></span><br><span class="line"><span class="string">WHERE server.id = `group`.id) AS anon_1 </span></span><br><span class="line"><span class="string">FROM `group`</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">select * from tb where id in [select id from xxx];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">select id,</span></span><br><span class="line"><span class="string">		name,</span></span><br><span class="line"><span class="string">		#必须保证此次查询只有一个值</span></span><br><span class="line"><span class="string">		(select max(id) from xxx) as mid</span></span><br><span class="line"><span class="string">from tb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">例如，第三个字段只能有一个值</span></span><br><span class="line"><span class="string">id name  mid</span></span><br><span class="line"><span class="string">1  lqz   1，2  不合理</span></span><br><span class="line"><span class="string">2  egon   2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原生SQL</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># 查询</span></span><br><span class="line"><span class="string">cursor = session.execute('select * from users')</span></span><br><span class="line"><span class="string">result = cursor.fetchall()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 添加</span></span><br><span class="line"><span class="string">cursor = session.execute('insert into users(name) values(:value)',params=&#123;"value":'wupeiqi'&#125;)</span></span><br><span class="line"><span class="string">session.commit()</span></span><br><span class="line"><span class="string">print(cursor.lastrowid)</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">session.close()</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="四-Flask-sqlalchemy"><a href="#四-Flask-sqlalchemy" class="headerlink" title="四. Flask-sqlalchemy"></a>四. Flask-sqlalchemy</h4><h5 id="1-目录"><a href="#1-目录" class="headerlink" title="1. 目录"></a>1. 目录</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">D</span><span class="selector-pseudo">:.</span></span><br><span class="line">│  <span class="selector-tag">create_table</span><span class="selector-class">.py</span></span><br><span class="line">│  <span class="selector-tag">requirements</span><span class="selector-class">.txt</span></span><br><span class="line">│  <span class="selector-tag">run</span><span class="selector-class">.py</span></span><br><span class="line">│  <span class="selector-tag">settings</span><span class="selector-class">.py</span></span><br><span class="line">│</span><br><span class="line">│</span><br><span class="line">├─<span class="selector-tag">sansa</span></span><br><span class="line">  │  <span class="selector-tag">models</span><span class="selector-class">.py</span></span><br><span class="line">  │  __<span class="selector-tag">init__</span><span class="selector-class">.py</span></span><br><span class="line">  │</span><br><span class="line">  ├─<span class="selector-tag">static</span></span><br><span class="line">  ├─<span class="selector-tag">templates</span></span><br><span class="line">  ├─<span class="selector-tag">views</span></span><br><span class="line">     │  <span class="selector-tag">account</span><span class="selector-class">.py</span></span><br></pre></td></tr></table></figure>
<h5 id="2-init-py"><a href="#2-init-py" class="headerlink" title="2. init.py"></a>2. <strong>init</strong>.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="comment"># flask_sqlalchemy,SQLAlchemy</span></span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> account</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">()</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_object(<span class="string">'settings.DevelopmentConfig'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将db注册到app中</span></span><br><span class="line">    db.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注册蓝图</span></span><br><span class="line">    app.register_blueprint(account.account)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<h5 id="3-models-py"><a href="#3-models-py" class="headerlink" title="3. models.py"></a>3. models.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Users</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用户表</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    __tablename__ = <span class="string">'users'</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    email = db.Column(db.String(<span class="number">120</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;User %r&gt;'</span> % self.username</span><br></pre></td></tr></table></figure>
<h5 id="4-settings-py"><a href="#4-settings-py" class="headerlink" title="4. settings.py"></a>4. settings.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseConfig</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># SESSION_TYPE = 'redis'  # session类型为redis</span></span><br><span class="line">    <span class="comment"># SESSION_KEY_PREFIX = 'session:'  # 保存到session中的值的前缀</span></span><br><span class="line">    <span class="comment"># SESSION_PERMANENT = True  # 如果设置为False，则关闭浏览器session就失效。</span></span><br><span class="line">    <span class="comment"># SESSION_USE_SIGNER = False  # 是否对发送到浏览器上 session:cookie值进行加密</span></span><br><span class="line"></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">"mysql+pymysql://root:123@127.0.0.1:3306/tmd?charset=utf8"</span></span><br><span class="line">    SQLALCHEMY_POOL_SIZE = <span class="number">5</span></span><br><span class="line">    SQLALCHEMY_POOL_TIMEOUT = <span class="number">30</span></span><br><span class="line">    SQLALCHEMY_POOL_RECYCLE = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 追踪对象的修改并且发送信号</span></span><br><span class="line">    <span class="comment"># SQLALCHEMY_TRACK_MODIFICATIONS = False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductionConfig</span><span class="params">(BaseConfig)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DevelopmentConfig</span><span class="params">(BaseConfig)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestingConfig</span><span class="params">(BaseConfig)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h5 id="5-create-table-py"><a href="#5-create-table-py" class="headerlink" title="5. create_table.py"></a>5. create_table.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> sansa <span class="keyword">import</span> create_app</span><br><span class="line"><span class="keyword">from</span> sansa <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line">app = create_app()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    db.create_all()</span><br></pre></td></tr></table></figure>
<h5 id="6-account-py"><a href="#6-account-py" class="headerlink" title="6. account.py"></a>6. account.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">account = Blueprint(<span class="string">'account'</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@account.route('/login')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    db.session.add(models.Users(username=<span class="string">'lqz'</span>, email=<span class="string">'123'</span>))</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="comment"># 添加示例</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    db.session.add(models.Users(username='lqz', pwd='123', gender=1))</span></span><br><span class="line"><span class="string">    db.session.commit()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    obj = db.session.query(models.Users).filter(models.Users.id == 1).first()</span></span><br><span class="line"><span class="string">    print(obj)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    PS: db.session和db.create_session</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># db.session.add(models.Users(username='wupeiqi1', email='wupeiqi1@xx.com'))</span></span><br><span class="line">    <span class="comment"># db.session.commit()</span></span><br><span class="line">    <span class="comment"># db.session.close()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># db.session.add(models.Users(username='wupeiqi2', email='wupeiqi2@xx.com'))</span></span><br><span class="line">    <span class="comment"># db.session.commit()</span></span><br><span class="line">    <span class="comment"># db.session.close()</span></span><br><span class="line">    <span class="comment"># db.session.add(models.Users(username='alex1',email='alex1@live.com'))</span></span><br><span class="line">    <span class="comment"># db.session.commit()</span></span><br><span class="line">    <span class="comment"># db.session.close()</span></span><br><span class="line"></span><br><span class="line">    user_list = db.session.query(models.Users).all()</span><br><span class="line">    db.session.close()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> user_list:</span><br><span class="line">        print(item.username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'login'</span></span><br></pre></td></tr></table></figure>
<h5 id="7-run-py"><a href="#7-run-py" class="headerlink" title="7. run.py"></a>7. run.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">生成依赖文件：</span></span><br><span class="line"><span class="string">    pipreqs ./</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> sansa <span class="keyword">import</span> create_app</span><br><span class="line"></span><br><span class="line">app = create_app()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
  <img id="wechat_subscriber_qcode" src="/images/gongzhonghao.jpg" alt="李江洋 wechat" style="width: 200px; max-width: 100%;">
  <div>python分享公众号</div>
</div>

      </div>
    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById(&quot;QR&quot;); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="李江洋 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="李江洋 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python框架/" rel="tag"># python框架</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/02/hello-world/" rel="next" title="Hello World">
                <i class="fa fa-chevron-left"></i> Hello World
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/02/django笔记1/" rel="prev" title="django笔记1">
                django笔记1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="李江洋">
            
              <p class="site-author-name" itemprop="name">李江洋</p>
              <p class="site-description motion-element" itemprop="description">记录学习的技能和遇到的问题</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">179</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">41</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lvdXJuYW1l" title="GitHub &rarr; https://github.com/yourname"><i class="fa fa-fw fa-github"></i>GitHub</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="bWFpbHRvOjEzMjgwNDQzOTJAcXEuY29t" title="E-Mail &rarr; mailto:1328044392@qq.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</span>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cDovL2V4YW1wbGUuY29t" title="http://example.com">Title</span>
                  </li>
                
              </ul>
            </div>
          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Flask框架"><span class="nav-number">1.</span> <span class="nav-text">Flask框架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#STEP-1"><span class="nav-number">1.1.</span> <span class="nav-text">STEP-1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一-flask简介"><span class="nav-number">1.1.1.</span> <span class="nav-text">一.flask简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二-flask安装"><span class="nav-number">1.1.2.</span> <span class="nav-text">二.flask安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三-werkzeug"><span class="nav-number">1.1.3.</span> <span class="nav-text">三.werkzeug</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-简介"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">3.1 简介</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-示例"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">3.2 示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四-flask的快速使用"><span class="nav-number">1.1.4.</span> <span class="nav-text">四.flask的快速使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-首先导入Flask这个类"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">4.1 首先导入Flask这个类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-实例化产生一个Flask的对象"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">4.2 实例化产生一个Flask的对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-设置成调试模式，自动刷新重启"><span class="nav-number">1.1.4.3.</span> <span class="nav-text">4.3 设置成调试模式，自动刷新重启</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-写视图函数并配置路由"><span class="nav-number">1.1.4.4.</span> <span class="nav-text">4.4 写视图函数并配置路由</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-5-启动flask项目"><span class="nav-number">1.1.4.5.</span> <span class="nav-text">4.5 启动flask项目</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-6-示例"><span class="nav-number">1.1.4.6.</span> <span class="nav-text">4.6 示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#五-基于Flask写一个项目具备：登录，显示用户信息"><span class="nav-number">1.1.5.</span> <span class="nav-text">五. 基于Flask写一个项目具备：登录，显示用户信息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#5-1-目录结构"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">5.1 目录结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-2-flask-damon-py"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">5.2 flask_damon.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-3-login-html"><span class="nav-number">1.1.5.3.</span> <span class="nav-text">5.3 login.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-4-user-list-html"><span class="nav-number">1.1.5.4.</span> <span class="nav-text">5.4 user_list.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-5-user-detail-html"><span class="nav-number">1.1.5.5.</span> <span class="nav-text">5.5 user_detail.html</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#六-基于flask的登录认证装饰器"><span class="nav-number">1.1.6.</span> <span class="nav-text">六. 基于flask的登录认证装饰器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STEP-2"><span class="nav-number">1.2.</span> <span class="nav-text">STEP-2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一-Flask的配置文件"><span class="nav-number">1.2.1.</span> <span class="nav-text">一. Flask的配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-默认的配置文件是一个flask-config-Config对象（继承字典"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">1.1 默认的配置文件是一个flask.config.Config对象（继承字典)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-配置文件的方式一：通过config对象字典特性"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">1.2 配置文件的方式一：通过config对象字典特性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-配置文件方式二：通过py文件配置"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">1.3 配置文件方式二：通过py文件配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-配置文件方式三：通过环境变量配置"><span class="nav-number">1.2.1.4.</span> <span class="nav-text">1.4 配置文件方式三：通过环境变量配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-5-配置文件方式四：通过json文件"><span class="nav-number">1.2.1.5.</span> <span class="nav-text">1.5 配置文件方式四：通过json文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-6-配置文件方式五：通过字典映射"><span class="nav-number">1.2.1.6.</span> <span class="nav-text">1.6 配置文件方式五：通过字典映射</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-7-配置文件方式六：通过对象的方式"><span class="nav-number">1.2.1.7.</span> <span class="nav-text">1.7 配置文件方式六：通过对象的方式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-7-1-实例"><span class="nav-number">1.2.1.7.1.</span> <span class="nav-text">1.7.1 实例</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-8-配置文件的路径问题"><span class="nav-number">1.2.1.8.</span> <span class="nav-text">1.8 配置文件的路径问题</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二-Flask的路由系统"><span class="nav-number">1.2.2.</span> <span class="nav-text">二. Flask的路由系统</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1-路由的典型写法"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">2.1 路由的典型写法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-默认的内置转换器"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">2.2 默认的内置转换器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-自定义正则转换器"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">2.3 自定义正则转换器</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-3-1-写一个类继承BaseConverter"><span class="nav-number">1.2.2.3.1.</span> <span class="nav-text">2.3.1 写一个类继承BaseConverter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-3-2-注册转换器"><span class="nav-number">1.2.2.3.2.</span> <span class="nav-text">2.3.2 注册转换器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-3-3-使用转换器"><span class="nav-number">1.2.2.3.3.</span> <span class="nav-text">2.3.3 使用转换器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-3-4-注意"><span class="nav-number">1.2.2.3.4.</span> <span class="nav-text">2.3.4 注意</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-路由的本质"><span class="nav-number">1.2.2.4.</span> <span class="nav-text">2.4 路由的本质</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-0-执行流程"><span class="nav-number">1.2.2.4.1.</span> <span class="nav-text">2.4.0 执行流程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-1-例子代码"><span class="nav-number">1.2.2.4.2.</span> <span class="nav-text">2.4.1 例子代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-2-源码分析：route"><span class="nav-number">1.2.2.4.3.</span> <span class="nav-text">2.4.2 源码分析：route</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-3-源码分析：add-url-rule"><span class="nav-number">1.2.2.4.4.</span> <span class="nav-text">2.4.3 源码分析：add_url_rule</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-4-源码分析：-endpoint-from-view-func"><span class="nav-number">1.2.2.4.5.</span> <span class="nav-text">2.4.4 源码分析：_endpoint_from_view_func</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-5-源码分析：url-rule-class"><span class="nav-number">1.2.2.4.6.</span> <span class="nav-text">2.4.5 源码分析：url_rule_class</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-6-源码分析：self-url-map-add-rule"><span class="nav-number">1.2.2.4.7.</span> <span class="nav-text">2.4.6 源码分析：self.url_map.add(rule)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-7-装饰器执行流程"><span class="nav-number">1.2.2.4.8.</span> <span class="nav-text">2.4.7 装饰器执行流程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-8-例子代码改写"><span class="nav-number">1.2.2.4.9.</span> <span class="nav-text">2.4.8 例子代码改写</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-5-CBV源码解析"><span class="nav-number">1.2.2.5.</span> <span class="nav-text">2.5 CBV源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-1-例子代码"><span class="nav-number">1.2.2.5.1.</span> <span class="nav-text">2.5.1 例子代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-1-as-view"><span class="nav-number">1.2.2.5.2.</span> <span class="nav-text">2.5.1 as_view</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-2-dispatch-request"><span class="nav-number">1.2.2.5.3.</span> <span class="nav-text">2.5.2 dispatch_request</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-3-MethodViewType元类的作用"><span class="nav-number">1.2.2.5.4.</span> <span class="nav-text">2.5.3 MethodViewType元类的作用</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-6-add-url-rule参数"><span class="nav-number">1.2.2.6.</span> <span class="nav-text">2.6 add_url_rule参数</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-1-rule"><span class="nav-number">1.2.2.6.1.</span> <span class="nav-text">2.6.1 rule</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-2-view-func"><span class="nav-number">1.2.2.6.2.</span> <span class="nav-text">2.6.2 view_func</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-3-defaults"><span class="nav-number">1.2.2.6.3.</span> <span class="nav-text">2.6.3 defaults</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-4-endpoint"><span class="nav-number">1.2.2.6.4.</span> <span class="nav-text">2.6.4 endpoint</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-5-methods"><span class="nav-number">1.2.2.6.5.</span> <span class="nav-text">2.6.5 methods</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-6-strict-slashes"><span class="nav-number">1.2.2.6.6.</span> <span class="nav-text">2.6.6 strict_slashes</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-7-redirect-to"><span class="nav-number">1.2.2.6.7.</span> <span class="nav-text">2.6.7 redirect_to</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-8-subdomain"><span class="nav-number">1.2.2.6.8.</span> <span class="nav-text">2.6.8 subdomain</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三-Flask的模板语言-依赖于jinjia2"><span class="nav-number">1.2.3.</span> <span class="nav-text">三.Flask的模板语言(依赖于jinjia2)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-和django模板的不同"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">3.1 和django模板的不同</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-实例"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">3.2 实例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-2-1-视图"><span class="nav-number">1.2.3.2.1.</span> <span class="nav-text">3.2.1 视图</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-2-2-模板"><span class="nav-number">1.2.3.2.2.</span> <span class="nav-text">3.2.2 模板</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-flask处理了xss攻击-如果想显示原生html"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">3.3 flask处理了xss攻击,如果想显示原生html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-注意"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">3.4 注意</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-5-标签：template-global"><span class="nav-number">1.2.3.5.</span> <span class="nav-text">3.5 标签：template_global</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-5-1-使用"><span class="nav-number">1.2.3.5.1.</span> <span class="nav-text">3.5.1 使用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-5-2-实例"><span class="nav-number">1.2.3.5.2.</span> <span class="nav-text">3.5.2 实例</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-6-过滤器：template-filter"><span class="nav-number">1.2.3.6.</span> <span class="nav-text">3.6 过滤器：template_filter</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-6-1-使用"><span class="nav-number">1.2.3.6.1.</span> <span class="nav-text">3.6.1 使用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-6-2-实例"><span class="nav-number">1.2.3.6.2.</span> <span class="nav-text">3.6.2 实例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四-Flask的请求与响应"><span class="nav-number">1.2.4.</span> <span class="nav-text">四. Flask的请求与响应</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-request"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">4.1 request</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-response"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">4.2 response</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-往响应头里面加东西"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">4.3 往响应头里面加东西</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-参考实例"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">4.4 参考实例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#五-session"><span class="nav-number">1.2.5.</span> <span class="nav-text">五.session</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#5-1-使用-一定要加盐"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">5.1 使用:一定要加盐</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-2-实例"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">5.2 实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-3-session源码分析之wsgi-app"><span class="nav-number">1.2.5.3.</span> <span class="nav-text">5.3 session源码分析之wsgi_app</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-流程分析"><span class="nav-number">1.2.5.3.1.</span> <span class="nav-text">1. 流程分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-wsgi-app"><span class="nav-number">1.2.5.3.2.</span> <span class="nav-text">2.  wsgi_app</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-4-session源码分析之：ctx-self-request-context-environ"><span class="nav-number">1.2.5.4.</span> <span class="nav-text">5.4 session源码分析之：ctx = self.request_context(environ)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-5-session源码分析之：ctx-push"><span class="nav-number">1.2.5.5.</span> <span class="nav-text">5.5 session源码分析之：ctx.push()</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-ctx-push"><span class="nav-number">1.2.5.5.1.</span> <span class="nav-text">1. ctx.push()</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-open-session"><span class="nav-number">1.2.5.5.2.</span> <span class="nav-text">2. open_session</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-6-session源码分析之：response-self-full-dispatch-request"><span class="nav-number">1.2.5.6.</span> <span class="nav-text">5.6 session源码分析之：response = self.full_dispatch_request()</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-full-dispatch-request"><span class="nav-number">1.2.5.6.1.</span> <span class="nav-text">1. full_dispatch_request</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-self-finalize-request-rv"><span class="nav-number">1.2.5.6.2.</span> <span class="nav-text">2. self.finalize_request(rv)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-response-self-process-response-response"><span class="nav-number">1.2.5.6.3.</span> <span class="nav-text">3. response = self.process_response(response)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-save-session-self-ctx-session-response"><span class="nav-number">1.2.5.6.4.</span> <span class="nav-text">4. save_session(self, ctx.session, response)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#六-闪现-message"><span class="nav-number">1.2.6.</span> <span class="nav-text">六. 闪现(message)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#6-1-作用"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">6.1 作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-2-设置值"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">6.2 设置值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-3-取值"><span class="nav-number">1.2.6.3.</span> <span class="nav-text">6.3 取值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-4-实例"><span class="nav-number">1.2.6.4.</span> <span class="nav-text">6.4 实例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#七-请求拓展（类似于django中的中间件）"><span class="nav-number">1.2.7.</span> <span class="nav-text">七. 请求拓展（类似于django中的中间件）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#7-1-before-request"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">7.1 before_request</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-1-1-作用"><span class="nav-number">1.2.7.1.1.</span> <span class="nav-text">7.1.1 作用</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-2-after-request"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">7.2 after_request</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-2-1-作用"><span class="nav-number">1.2.7.2.1.</span> <span class="nav-text">7.2.1 作用</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-3-before-first-request"><span class="nav-number">1.2.7.3.</span> <span class="nav-text">7.3 before_first_request</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-3-1-作用"><span class="nav-number">1.2.7.3.1.</span> <span class="nav-text">7.3.1 作用</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-4-teardown-request"><span class="nav-number">1.2.7.4.</span> <span class="nav-text">7.4 teardown_request</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-4-1-作用"><span class="nav-number">1.2.7.4.1.</span> <span class="nav-text">7.4.1 作用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-4-2-实例"><span class="nav-number">1.2.7.4.2.</span> <span class="nav-text">7.4.2 实例</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-5-errorhandler"><span class="nav-number">1.2.7.5.</span> <span class="nav-text">7.5 errorhandler</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-5-1-实例"><span class="nav-number">1.2.7.5.1.</span> <span class="nav-text">7.5.1 实例</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-6-总结"><span class="nav-number">1.2.7.6.</span> <span class="nav-text">7.6 总结</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-7-实例"><span class="nav-number">1.2.7.7.</span> <span class="nav-text">7.7 实例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-7-1-实例一：before-request返回None"><span class="nav-number">1.2.7.7.1.</span> <span class="nav-text">7.7.1 实例一：before_request返回None</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-7-2-实例二：before-request返回非None"><span class="nav-number">1.2.7.7.2.</span> <span class="nav-text">7.7.2 实例二：before_request返回非None</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#八-中间件"><span class="nav-number">1.2.8.</span> <span class="nav-text">八. 中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-1-作用"><span class="nav-number">1.2.8.1.</span> <span class="nav-text">8.1 作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-2-源码分析"><span class="nav-number">1.2.8.2.</span> <span class="nav-text">8.2 源码分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-如何自定义中间件"><span class="nav-number">1.2.8.3.</span> <span class="nav-text">8.3 如何自定义中间件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STEP-3"><span class="nav-number">1.3.</span> <span class="nav-text">STEP-3</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一-蓝图（Blueprint）"><span class="nav-number">1.3.1.</span> <span class="nav-text">一. 蓝图（Blueprint）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-蓝图的作用"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">1. 蓝图的作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-不使用蓝图自己分文件"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">2. 不使用蓝图自己分文件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-1-目录结构"><span class="nav-number">1.3.1.2.1.</span> <span class="nav-text">2.1 目录结构</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-2-manage-py"><span class="nav-number">1.3.1.2.2.</span> <span class="nav-text">2.2 manage.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-3-flask-test下的init-py"><span class="nav-number">1.3.1.2.3.</span> <span class="nav-text">2.3 flask_test下的init.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-order-py"><span class="nav-number">1.3.1.2.4.</span> <span class="nav-text">2.4 order.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-user-py"><span class="nav-number">1.3.1.2.5.</span> <span class="nav-text">2.5 user.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-6-views下面的init"><span class="nav-number">1.3.1.2.6.</span> <span class="nav-text">2.6 views下面的init</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-使用蓝图之中小型项目"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">3. 使用蓝图之中小型项目</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-1-目录结构"><span class="nav-number">1.3.1.3.1.</span> <span class="nav-text">3.1 目录结构</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-2-manage-py"><span class="nav-number">1.3.1.3.2.</span> <span class="nav-text">3.2 manage.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-flask-test下的init-py"><span class="nav-number">1.3.1.3.3.</span> <span class="nav-text">3.3 flask_test下的init.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-4-order-py"><span class="nav-number">1.3.1.3.4.</span> <span class="nav-text">3.4 order.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-5-user-py"><span class="nav-number">1.3.1.3.5.</span> <span class="nav-text">3.5 user.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-6-views下面的init"><span class="nav-number">1.3.1.3.6.</span> <span class="nav-text">3.6 views下面的init</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-使用蓝图之大型项目"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">4. 使用蓝图之大型项目</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#4-1-项目目录"><span class="nav-number">1.3.1.4.1.</span> <span class="nav-text">4.1 项目目录</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-manage-py"><span class="nav-number">1.3.1.4.2.</span> <span class="nav-text">4.2 manage.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-3-flask-app下面的init-py"><span class="nav-number">1.3.1.4.3.</span> <span class="nav-text">4.3 flask_app下面的init.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-4-flask-admin-flask-user下面的init-py"><span class="nav-number">1.3.1.4.4.</span> <span class="nav-text">4.4 flask_admin/flask_user下面的init.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-5-views下面的init-py"><span class="nav-number">1.3.1.4.5.</span> <span class="nav-text">4.5 views下面的init.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-6-views下面的order-py"><span class="nav-number">1.3.1.4.6.</span> <span class="nav-text">4.6 views下面的order.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-7-views下面的user-py"><span class="nav-number">1.3.1.4.7.</span> <span class="nav-text">4.7 views下面的user.py</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-使用蓝图注意事项"><span class="nav-number">1.3.1.5.</span> <span class="nav-text">5. 使用蓝图注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-1-当为templates目录添加目录解耦时"><span class="nav-number">1.3.1.5.1.</span> <span class="nav-text">5.1 当为templates目录添加目录解耦时</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-蓝图总结"><span class="nav-number">1.3.1.6.</span> <span class="nav-text">6. 蓝图总结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二-请求上下文源码分析"><span class="nav-number">1.3.2.</span> <span class="nav-text">二. 请求上下文源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-Flask上下文的种类"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">1. Flask上下文的种类</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-1-应用上下文"><span class="nav-number">1.3.2.1.1.</span> <span class="nav-text">1.1 应用上下文</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-2-请求上下文"><span class="nav-number">1.3.2.1.2.</span> <span class="nav-text">1.2 请求上下文</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-上下文的作用"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">2. 上下文的作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-上下文的生命周期"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">3. 上下文的生命周期</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-请求上下文环境构造"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">4. 请求上下文环境构造</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#4-1-wsgi-app"><span class="nav-number">1.3.2.4.1.</span> <span class="nav-text">4.1 wsgi_app</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-request-context"><span class="nav-number">1.3.2.4.2.</span> <span class="nav-text">4.2 request_context</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-3-ctx-push"><span class="nav-number">1.3.2.4.3.</span> <span class="nav-text">4.3  ctx.push</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-4-full-dispatch-request"><span class="nav-number">1.3.2.4.4.</span> <span class="nav-text">4.4 full_dispatch_request</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-5-RequestCentext类auto-pop"><span class="nav-number">1.3.2.4.5.</span> <span class="nav-text">4.5 RequestCentext类auto_pop</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-LocalStack"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">5. LocalStack</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-1-作用"><span class="nav-number">1.3.2.5.1.</span> <span class="nav-text">5.1 作用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-源码"><span class="nav-number">1.3.2.5.2.</span> <span class="nav-text">5.2 源码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-Local"><span class="nav-number">1.3.2.6.</span> <span class="nav-text">6. Local</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#6-1-作用-1"><span class="nav-number">1.3.2.6.1.</span> <span class="nav-text">6.1 作用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-2-源码"><span class="nav-number">1.3.2.6.2.</span> <span class="nav-text">6.2 源码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-LocalProxy"><span class="nav-number">1.3.2.7.</span> <span class="nav-text">7. LocalProxy</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-1-作用"><span class="nav-number">1.3.2.7.1.</span> <span class="nav-text">7.1 作用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-2-源码"><span class="nav-number">1.3.2.7.2.</span> <span class="nav-text">7.2 源码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-g对象"><span class="nav-number">1.3.2.8.</span> <span class="nav-text">8. g对象</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#8-1-作用-1"><span class="nav-number">1.3.2.8.1.</span> <span class="nav-text">8.1 作用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-2-g对象和session的区别"><span class="nav-number">1.3.2.8.2.</span> <span class="nav-text">8.2 g对象和session的区别</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-3-实例"><span class="nav-number">1.3.2.8.3.</span> <span class="nav-text">8.3 实例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三-flask-session插件"><span class="nav-number">1.3.3.</span> <span class="nav-text">三. flask_session插件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-作用"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">1 作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-安装"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">2 安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-使用方式一"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">3 使用方式一</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-使用方式二"><span class="nav-number">1.3.3.4.</span> <span class="nav-text">4 使用方式二</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四-flask-script插件"><span class="nav-number">1.3.4.</span> <span class="nav-text">四. flask_script插件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-作用-1"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">1. 作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-安装-1"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">2. 安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-使用"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">3. 使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#五-多app应用"><span class="nav-number">1.3.5.</span> <span class="nav-text">五. 多app应用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-作用-2"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">1. 作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-使用"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">2. 使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#六-信号"><span class="nav-number">1.3.6.</span> <span class="nav-text">六. 信号</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-作用-3"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">1. 作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-内置信号"><span class="nav-number">1.3.6.2.</span> <span class="nav-text">2. 内置信号</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-使用信号"><span class="nav-number">1.3.6.3.</span> <span class="nav-text">3. 使用信号</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-Flask中信号的触发点"><span class="nav-number">1.3.6.4.</span> <span class="nav-text">4. Flask中信号的触发点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-自定义信号-了解"><span class="nav-number">1.3.6.5.</span> <span class="nav-text">5. 自定义信号(了解)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STEP-4"><span class="nav-number">1.4.</span> <span class="nav-text">STEP-4</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一-wtforms组件"><span class="nav-number">1.4.1.</span> <span class="nav-text">一. wtforms组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-安装"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">1. 安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-作用"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">2. 作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-使用-1"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">3. 使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-简单使用"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">4. 简单使用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#4-0-使用步骤"><span class="nav-number">1.4.1.4.1.</span> <span class="nav-text">4.0 使用步骤</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-1-视图"><span class="nav-number">1.4.1.4.2.</span> <span class="nav-text">4.1 视图</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-模板"><span class="nav-number">1.4.1.4.3.</span> <span class="nav-text">4.2 模板</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-3-关闭html的form验证功能"><span class="nav-number">1.4.1.4.4.</span> <span class="nav-text">4.3 关闭html的form验证功能</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-复杂使用"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">5. 复杂使用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-1-视图"><span class="nav-number">1.4.1.5.1.</span> <span class="nav-text">5.1 视图</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-模板"><span class="nav-number">1.4.1.5.2.</span> <span class="nav-text">5.2 模板</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二-Python中的数据库连接池DBUtils"><span class="nav-number">1.4.2.</span> <span class="nav-text">二. Python中的数据库连接池DBUtils</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-为什么要用数据库连接池"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">1. 为什么要用数据库连接池</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-1-每个请求开个连接"><span class="nav-number">1.4.2.1.1.</span> <span class="nav-text">1.1 每个请求开个连接</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-2-加锁使用单个数据库连接对象"><span class="nav-number">1.4.2.1.2.</span> <span class="nav-text">1.2 加锁使用单个数据库连接对象</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-3-结论"><span class="nav-number">1.4.2.1.3.</span> <span class="nav-text">1.3 结论</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-什么是DBUtils"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">2. 什么是DBUtils</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-DBUtils的2种模式"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">3. DBUtils的2种模式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-1-模式一：PersistentDB"><span class="nav-number">1.4.2.3.1.</span> <span class="nav-text">3.1 模式一：PersistentDB</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-2-模式二：PooledDB"><span class="nav-number">1.4.2.3.2.</span> <span class="nav-text">3.2 模式二：PooledDB</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三-SQLAlchemy模块"><span class="nav-number">1.4.3.</span> <span class="nav-text">三. SQLAlchemy模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-什么是SQLAlchemy"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">1. 什么是SQLAlchemy</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-安装-2"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">2. 安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-组成"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">3. 组成</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-注意"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">4. 注意</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#4-1-SQLAlchemy本身无法操作数据库，其必须以来pymsql等第三方插件"><span class="nav-number">1.4.3.4.1.</span> <span class="nav-text">4.1 SQLAlchemy本身无法操作数据库，其必须以来pymsql等第三方插件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-Dialect用于和数据API进行交流，根据配置文件的不同调用不同的数据库API，从而实现对数据库的操作"><span class="nav-number">1.4.3.4.2.</span> <span class="nav-text">4.2 Dialect用于和数据API进行交流，根据配置文件的不同调用不同的数据库API，从而实现对数据库的操作</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-简单使用"><span class="nav-number">1.4.3.5.</span> <span class="nav-text">5. 简单使用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-1-注意事项"><span class="nav-number">1.4.3.5.1.</span> <span class="nav-text">5.1 注意事项</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-执行原生sql（不常用）"><span class="nav-number">1.4.3.5.2.</span> <span class="nav-text">5.2 执行原生sql（不常用）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-3-orm使用"><span class="nav-number">1.4.3.5.3.</span> <span class="nav-text">5.3 orm使用</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-单表操作"><span class="nav-number">1.4.3.6.</span> <span class="nav-text">6. 单表操作</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#6-1-增"><span class="nav-number">1.4.3.6.1.</span> <span class="nav-text">6.1 增</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-2-改"><span class="nav-number">1.4.3.6.2.</span> <span class="nav-text">6.2 改</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-3-删"><span class="nav-number">1.4.3.6.3.</span> <span class="nav-text">6.3 删</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-4-查"><span class="nav-number">1.4.3.6.4.</span> <span class="nav-text">6.4 查</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-orm一对多关系"><span class="nav-number">1.4.3.7.</span> <span class="nav-text">7. orm一对多关系</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-1-关联字段写在多的地方"><span class="nav-number">1.4.3.7.1.</span> <span class="nav-text">7.1 关联字段写在多的地方</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-多对多关系"><span class="nav-number">1.4.3.8.</span> <span class="nav-text">8. 多对多关系</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-单表查询"><span class="nav-number">1.4.3.9.</span> <span class="nav-text">9. 单表查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-常用操作-增删改"><span class="nav-number">1.4.3.10.</span> <span class="nav-text">10.常用操作:增删改</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#10-1-插入数据"><span class="nav-number">1.4.3.10.1.</span> <span class="nav-text">10.1 插入数据</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-2-修改数据"><span class="nav-number">1.4.3.10.2.</span> <span class="nav-text">10.2 修改数据</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-删除数据"><span class="nav-number">1.4.3.10.3.</span> <span class="nav-text">10.3 删除数据</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#11-常用操作：查"><span class="nav-number">1.4.3.11.</span> <span class="nav-text">11. 常用操作：查</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#11-1-算术操作符"><span class="nav-number">1.4.3.11.1.</span> <span class="nav-text">11.1 算术操作符</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-2-模糊查询"><span class="nav-number">1.4.3.11.2.</span> <span class="nav-text">11.2 模糊查询</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-3-区间选取"><span class="nav-number">1.4.3.11.3.</span> <span class="nav-text">11.3 区间选取</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-4-分页"><span class="nav-number">1.4.3.11.4.</span> <span class="nav-text">11.4 分页</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-5-排序"><span class="nav-number">1.4.3.11.5.</span> <span class="nav-text">11.5 排序</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-6-分组"><span class="nav-number">1.4.3.11.6.</span> <span class="nav-text">11.6 分组</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-7-having：分组之后条件过滤"><span class="nav-number">1.4.3.11.7.</span> <span class="nav-text">11.7 having：分组之后条件过滤</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-8-计数"><span class="nav-number">1.4.3.11.8.</span> <span class="nav-text">11.8 计数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-9-去重"><span class="nav-number">1.4.3.11.9.</span> <span class="nav-text">11.9 去重</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-10-空值"><span class="nav-number">1.4.3.11.10.</span> <span class="nav-text">11.10 空值</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-11-逻辑操作"><span class="nav-number">1.4.3.11.11.</span> <span class="nav-text">11.11 逻辑操作</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-12-text：原生sql语句"><span class="nav-number">1.4.3.11.12.</span> <span class="nav-text">11.12 text：原生sql语句</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-13-使用别名"><span class="nav-number">1.4.3.11.13.</span> <span class="nav-text">11.13 使用别名</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-14-取值"><span class="nav-number">1.4.3.11.14.</span> <span class="nav-text">11.14 取值</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#11-15-chain链式调用"><span class="nav-number">1.4.3.11.15.</span> <span class="nav-text">11.15 chain链式调用</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#12-一对多的操作"><span class="nav-number">1.4.3.12.</span> <span class="nav-text">12. 一对多的操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-多对多的操作"><span class="nav-number">1.4.3.13.</span> <span class="nav-text">13. 多对多的操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#14-其他不常用操作"><span class="nav-number">1.4.3.14.</span> <span class="nav-text">14. 其他不常用操作</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四-Flask-sqlalchemy"><span class="nav-number">1.4.4.</span> <span class="nav-text">四. Flask-sqlalchemy</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-目录"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">1. 目录</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-init-py"><span class="nav-number">1.4.4.2.</span> <span class="nav-text">2. init.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-models-py"><span class="nav-number">1.4.4.3.</span> <span class="nav-text">3. models.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-settings-py"><span class="nav-number">1.4.4.4.</span> <span class="nav-text">4. settings.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-create-table-py"><span class="nav-number">1.4.4.5.</span> <span class="nav-text">5. create_table.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-account-py"><span class="nav-number">1.4.4.6.</span> <span class="nav-text">6. account.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-run-py"><span class="nav-number">1.4.4.7.</span> <span class="nav-text">7. run.py</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李江洋</span>

  

  
</div>


  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Pisces</span> v7.0.1</div>






  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/7.1.2/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>






















  
  
  <script id="ribbon" size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>





  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.1"></script>


  
  
  
  <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://ljyabc.github.io/2019/03/02/flask/";
    this.page.identifier = "2019/03/02/flask/";
    this.page.title = 'flask';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  

   <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
</body>
</html>
