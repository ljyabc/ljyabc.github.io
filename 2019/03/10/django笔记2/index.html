<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="day17–BBS项目：1.模型层123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596">
<meta property="og:type" content="article">
<meta property="og:title" content="&#39;django笔记2&#39;">
<meta property="og:url" content="https://ljyabc.github.io/2019/03/10/django笔记2/index.html">
<meta property="og:site_name" content="择墅居:李江洋">
<meta property="og:description" content="day17–BBS项目：1.模型层123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ljyabc.github.io/2019/03/10/django笔记2/C:/Users/zhangchenggang/Desktop/序列化组件图.png">
<meta property="og:updated_time" content="2025-04-08T14:37:22.407Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="&#39;django笔记2&#39;">
<meta name="twitter:description" content="day17–BBS项目：1.模型层123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596">
<meta name="twitter:image" content="https://ljyabc.github.io/2019/03/10/django笔记2/C:/Users/zhangchenggang/Desktop/序列化组件图.png">






  <link rel="canonical" href="https://ljyabc.github.io/2019/03/10/django笔记2/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>'django笔记2' | 择墅居:李江洋</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">择墅居:李江洋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">争做长沙别墅豪装第一品牌</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-schedule">

    
    
    
      
    

    

    <a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>日程表</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-book">

    
    
    
      
    

    

    <a href="/book" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>book</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ljyabc.github.io/2019/03/10/django笔记2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李江洋">
      <meta itemprop="description" content="记录学习的技能和遇到的问题">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="择墅居:李江洋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">'django笔记2'

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-10 23:56:47" itemprop="dateCreated datePublished" datetime="2019-03-10T23:56:47+08:00">2019-03-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2025-04-08 22:37:22" itemprop="dateModified" datetime="2025-04-08T22:37:22+08:00">2025-04-08</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2019/03/10/django笔记2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/10/django笔记2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="day17–BBS项目："><a href="#day17–BBS项目：" class="headerlink" title="day17–BBS项目："></a>day17–BBS项目：</h3><h4 id="1-模型层"><a href="#1-模型层" class="headerlink" title="1.模型层"></a>1.模型层</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1.userinfo：用户信息表，</span></span><br><span class="line"><span class="string">    字段：</span></span><br><span class="line"><span class="string">        id</span></span><br><span class="line"><span class="string">        username</span></span><br><span class="line"><span class="string">        password</span></span><br><span class="line"><span class="string">        phone</span></span><br><span class="line"><span class="string">        avatar</span></span><br><span class="line"><span class="string">        blog -- 和Blog这张表一对一关联</span></span><br><span class="line"><span class="string">2.Blog：用户博客</span></span><br><span class="line"><span class="string">    字段：</span></span><br><span class="line"><span class="string">        id</span></span><br><span class="line"><span class="string">        title</span></span><br><span class="line"><span class="string">        theme</span></span><br><span class="line"><span class="string">        pathname ---路径名</span></span><br><span class="line"><span class="string">3.Category：文章分类</span></span><br><span class="line"><span class="string">    字段：</span></span><br><span class="line"><span class="string">        id</span></span><br><span class="line"><span class="string">        title</span></span><br><span class="line"><span class="string">        blog  ---一对多关系</span></span><br><span class="line"><span class="string">4.Tag：文章关键字</span></span><br><span class="line"><span class="string">    字段：</span></span><br><span class="line"><span class="string">        id</span></span><br><span class="line"><span class="string">        title</span></span><br><span class="line"><span class="string">        blog ---一对多关系   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">5.Article：文章</span></span><br><span class="line"><span class="string">    字段：</span></span><br><span class="line"><span class="string">        id</span></span><br><span class="line"><span class="string">        title</span></span><br><span class="line"><span class="string">        abstract --摘要</span></span><br><span class="line"><span class="string">        content --内容</span></span><br><span class="line"><span class="string">        create_time  --创建日期</span></span><br><span class="line"><span class="string">        category  --- 文章和分类是一对多关系</span></span><br><span class="line"><span class="string">        tag  ----文章和文章关键字是多对多关系</span></span><br><span class="line"><span class="string">        blog  ---文章和用户博客是一对多的关系</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6.Commit：评论</span></span><br><span class="line"><span class="string">    字段：</span></span><br><span class="line"><span class="string">        id</span></span><br><span class="line"><span class="string">        username  ---哪个用户  评论和作者是一对多的关系：一个作者可以对应多条评论</span></span><br><span class="line"><span class="string">        article   ---对什么文章  评论和文章是一对多的关系：一个文章可以对应多条评论</span></span><br><span class="line"><span class="string">        content   ---评论的内容</span></span><br><span class="line"><span class="string">        commit_time ---评论提交的时间</span></span><br><span class="line"><span class="string">        parent_id  ----评论的父评论（有对应评论的id，没有对应null）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7.UpAndDown:点赞和点踩</span></span><br><span class="line"><span class="string">    字段：</span></span><br><span class="line"><span class="string">        id</span></span><br><span class="line"><span class="string">        username  一对多的关系，一个作者可以点多个赞</span></span><br><span class="line"><span class="string">        article   一对多关系，一篇文章可以有多个赞</span></span><br><span class="line"><span class="string">        is_up  ----点赞是1，没有点赞为0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    phone = models.CharField(max_length=<span class="number">11</span>, null=<span class="literal">True</span>)</span><br><span class="line">    avatar = models.FileField(upload_to=<span class="string">'avatar/'</span>, default=<span class="string">'/img/default.png'</span>)</span><br><span class="line">    blog = models.OneToOneField(to=<span class="string">'Blog'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">88</span>)</span><br><span class="line">    theme = models.CharField(max_length=<span class="number">32</span>, null=<span class="literal">True</span>)</span><br><span class="line">    site = models.CharField(max_length=<span class="number">33</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">88</span>)</span><br><span class="line">    blog = models.ForeignKey(to=<span class="string">'Blog'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">88</span>)</span><br><span class="line">    blog = models.ForeignKey(to=<span class="string">'Blog'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    desc = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    create_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    Comment_num = models.IntegerField(null=<span class="literal">True</span>)</span><br><span class="line">    up_num = models.IntegerField(null=<span class="literal">True</span>)</span><br><span class="line">    down_num = models.IntegerField(null=<span class="literal">True</span>)</span><br><span class="line">    category = models.ForeignKey(to=<span class="string">'Category'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line">    blog = models.ForeignKey(to=<span class="string">'Blog'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line">    tag = models.ManyToManyField(to=<span class="string">'Tag'</span>, through=<span class="string">'ArticleToTag'</span>, through_fields=(<span class="string">'article'</span>, <span class="string">'tag'</span>,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleToTag</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    id = models.AutoField(primary_key=Tag)</span><br><span class="line">    article = models.ForeignKey(to=<span class="string">'Article'</span>, to_field=<span class="string">'id'</span>)</span><br><span class="line">    tag = models.ForeignKey(to=<span class="string">'Tag'</span>, to_field=<span class="string">'id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        unique_together = (<span class="string">'article'</span>, <span class="string">'tag'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    user = models.ForeignKey(to=<span class="string">'UserInfo'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line">    article = models.ForeignKey(to=<span class="string">'Article'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line">    content = models.CharField(max_length=<span class="number">255</span>, null=<span class="literal">True</span>)</span><br><span class="line">    comment_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    parent = models.ForeignKey(to=<span class="string">"Comment"</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpAndDown</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = models.ForeignKey(to=<span class="string">'UserInfo'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line">    article = models.ForeignKey(to=<span class="string">'Article'</span>, to_field=<span class="string">'id'</span>, null=<span class="literal">True</span>)</span><br><span class="line">    is_up = models.BooleanField()</span><br></pre></td></tr></table></figure>
<h4 id="2-前端页面字符串的替换"><a href="#2-前端页面字符串的替换" class="headerlink" title="2.前端页面字符串的替换"></a>2.前端页面字符串的替换</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ss=<span class="string">`</span></span><br><span class="line"><span class="string">&lt;li class="list-group-item"&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;</span></span><br><span class="line"><span class="string">        &lt;span&gt;<span class="subst">$&#123; user_name &#125;</span>&lt;/span&gt;</span></span><br><span class="line"><span class="string">        &lt;span&gt;<span class="subst">$&#123; time &#125;</span>&lt;/span&gt;</span></span><br><span class="line"><span class="string">    &lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p class="well"&gt;@<span class="subst">$&#123;parent_name &#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;content&#125;</span></span></span><br><span class="line"><span class="string">&lt;/li&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">$&#123;&#125; ----里面写需要替换的内容</span><br></pre></td></tr></table></figure>
<h4 id="3-拿到html标签里面的值"><a href="#3-拿到html标签里面的值" class="headerlink" title="3.拿到html标签里面的值"></a>3.拿到html标签里面的值</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>通过页面选择器获取里面的值</span><br><span class="line">--获取子评论的值</span><br><span class="line"><span class="keyword">var</span> obj = $(<span class="keyword">this</span>).children(<span class="string">'span'</span>).text()</span><br><span class="line">--获取兄弟评论的值</span><br><span class="line"><span class="keyword">var</span> obj = $(<span class="keyword">this</span>).sibing(<span class="string">'span'</span>).text()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>通过给标签设置属性，属性里面放入需要获取的值</span><br><span class="line"><span class="comment">//拿到span标签中username属性对应的值</span></span><br><span class="line">&lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">"pull-right replay"</span> username=<span class="string">"&#123;&#123; content.user.username &#125;&#125;"</span></span><br><span class="line">                                  content_id=<span class="string">"&#123;&#123; content.pk &#125;&#125;"</span>&gt;回复&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">var username = $(this).attr('username') ---拿到的就是username属性的值</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">3.判断当前的标签是否有什么类名</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/判断当前点击的div控件,有没有diggit类</span></span><br><span class="line"><span class="regexp">var is_up = $(this).hasClass('diggit')</span></span><br></pre></td></tr></table></figure>
<h4 id="4-前端字符串转成int类型的方式"><a href="#4-前端字符串转成int类型的方式" class="headerlink" title="4.前端字符串转成int类型的方式"></a>4.前端字符串转成int类型的方式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> count= $(<span class="string">"#digg_count"</span>).text()</span><br><span class="line"></span><br><span class="line"><span class="built_in">parseInt</span>(count)/<span class="built_in">Number</span>(count)</span><br></pre></td></tr></table></figure>
<h4 id="5-前端页面聚焦光标"><a href="#5-前端页面聚焦光标" class="headerlink" title="5.前端页面聚焦光标"></a>5.前端页面聚焦光标</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//让光标聚焦到这个控件</span></span><br><span class="line">$(<span class="string">'#content'</span>).focus() --- focus</span><br></pre></td></tr></table></figure>
<h4 id="6-前端输入框内容的截断"><a href="#6-前端输入框内容的截断" class="headerlink" title="6.前端输入框内容的截断"></a>6.前端输入框内容的截断</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取到 \n 索引位置的后一位</span></span><br><span class="line"><span class="keyword">var</span> index = content.indexOf(<span class="string">'\n'</span>) + <span class="number">1</span></span><br><span class="line">alert(index)</span><br><span class="line"></span><br><span class="line"><span class="comment">//slice传一个起始位置,一个结束位置,就可以切出来</span></span><br><span class="line">content = content.slice(index)</span><br></pre></td></tr></table></figure>
<h4 id="7-将时间对象转成字符串"><a href="#7-将时间对象转成字符串" class="headerlink" title="7.将时间对象转成字符串"></a>7.将时间对象转成字符串</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>通过json传输的时候，json不会给我们转时间对象的，而且还会报错，这就需要我们自己来转</span><br><span class="line"><span class="comment"># 把datetime类型转成字符串,因为json是无法序列化datetime</span></span><br><span class="line">response[<span class="string">'time'</span>] = ret.create_time.strftime(<span class="string">'%Y-%m-%d %X'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="8-随机产生验证码"><a href="#8-随机产生验证码" class="headerlink" title="8.随机产生验证码"></a>8.随机产生验证码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">img = Image.new(<span class="string">'RGB'</span>, (<span class="number">320</span>, <span class="number">35</span>), color=get_random_color())</span><br><span class="line"><span class="comment"># 拿到画笔,把图片传入画笔</span></span><br><span class="line">img_draw = ImageDraw.Draw(img)</span><br><span class="line"><span class="comment"># 生成一个字体对象,第一个参数是字体文件的路径,第二个参数是字体大小</span></span><br><span class="line">font = ImageFont.truetype(<span class="string">'static/font/ss.TTF'</span>, size=<span class="number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个参数,xy的坐标,第二个参数:要写的文字,第三个参数:写文字的颜色,第四个参数:字体</span></span><br><span class="line"><span class="comment"># 不同的字体是不同的ttf文件</span></span><br><span class="line">random_code = <span class="string">''</span></span><br><span class="line"><span class="comment"># 弄一个循环,循环5次,每次随机写一个(数字,大写,小写字母)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">char_num = random.randint(<span class="number">0</span>, <span class="number">9</span>)</span><br><span class="line"><span class="comment"># 生成一个97到122的数字,然后用chr转成字符</span></span><br><span class="line">char_lower = chr(random.randint(<span class="number">97</span>, <span class="number">122</span>))</span><br><span class="line">char_upper = chr(random.randint(<span class="number">65</span>, <span class="number">90</span>))</span><br><span class="line">char_str = str(random.choice([char_num, char_lower, char_upper]))</span><br><span class="line">img_draw.text((i * <span class="number">30</span> + <span class="number">20</span>, <span class="number">0</span>), char_str, get_random_color(), font=font)</span><br><span class="line"></span><br><span class="line">random_code += char_str</span><br><span class="line"><span class="comment"># 把验证码保存到session中</span></span><br><span class="line">print(random_code)</span><br><span class="line">request.session[<span class="string">'valid_code'</span>] = random_code</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">1 生成一个随机字符串:ddddsfassda</span></span><br><span class="line"><span class="string">2 在session表中插入一条数据</span></span><br><span class="line"><span class="string">3 在cook中写入 :sessionid=ddddsfassda</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># width = 320</span></span><br><span class="line"><span class="comment"># height = 35</span></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     x1 = random.randint(0, width)</span></span><br><span class="line"><span class="comment">#     x2 = random.randint(0, width)</span></span><br><span class="line"><span class="comment">#     y1 = random.randint(0, height)</span></span><br><span class="line"><span class="comment">#     y2 = random.randint(0, height)</span></span><br><span class="line"><span class="comment">#     # 在图片上画线</span></span><br><span class="line"><span class="comment">#     img_draw.line((x1, y1, x2, y2), fill=get_random_color())</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for i in range(100):</span></span><br><span class="line"><span class="comment">#     # 画点</span></span><br><span class="line"><span class="comment">#     img_draw.point([random.randint(0, width), random.randint(0, height)], fill=get_random_color())</span></span><br><span class="line"><span class="comment">#     x = random.randint(0, width)</span></span><br><span class="line"><span class="comment">#     y = random.randint(0, height)</span></span><br><span class="line"><span class="comment">#     # 画弧形</span></span><br><span class="line"><span class="comment">#     img_draw.arc((x, y, x + 4, y + 4), 0, 90, fill=get_random_color())</span></span><br><span class="line"></span><br><span class="line">f = BytesIO()</span><br><span class="line"><span class="comment"># 把图片保存到f中</span></span><br><span class="line"><span class="comment"># 放到内存中,存取比较快,而且有自动清理</span></span><br><span class="line">img.save(f, <span class="string">'png'</span>)</span><br><span class="line"></span><br><span class="line">data = f.getvalue()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>定义一个公共方法</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidCode</span>:</span></span><br><span class="line">    <span class="comment"># code = make_code(5)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, code_num)</span>:</span></span><br><span class="line">        self.code_num = code_num</span><br><span class="line">        self.code = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_random_color</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_code</span><span class="params">(code_num)</span>:</span></span><br><span class="line">        res = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(code_num):</span><br><span class="line">            s1 = chr(random.randint(<span class="number">65</span>, <span class="number">90</span>))</span><br><span class="line">            s2 = str(random.randint(<span class="number">0</span>, <span class="number">9</span>))</span><br><span class="line">            s3 = chr(random.randint(<span class="number">97</span>, <span class="number">122</span>))</span><br><span class="line">            res += random.choice([s1, s2, s3])</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">valid_code</span><span class="params">(self)</span>:</span></span><br><span class="line">        img = Image.new(<span class="string">'RGB'</span>, (<span class="number">200</span>, <span class="number">34</span>), color=self._get_random_color())</span><br><span class="line">        img_draw = ImageDraw.Draw(img)</span><br><span class="line">        font = ImageFont.truetype(<span class="string">'static/font/ss.TTF'</span>, size=<span class="number">20</span>)</span><br><span class="line">        code = self._make_code(self.code_num)</span><br><span class="line">        self.code = code</span><br><span class="line">        img_draw.text((<span class="number">0</span>, <span class="number">0</span>), code, self._get_random_color(), font=font)</span><br><span class="line"></span><br><span class="line">        f = BytesIO()</span><br><span class="line">        img.save(f, <span class="string">'png'</span>)</span><br><span class="line">        data = f.getvalue()</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">        </span><br><span class="line"><span class="number">2.</span>在视图中使用这个方法</span><br><span class="line"><span class="keyword">from</span> static.common.common <span class="keyword">import</span>  ValidCode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        v = ValidCode(code_num=<span class="number">5</span>)</span><br><span class="line">        data = v.valid_code</span><br><span class="line">        request.session[<span class="string">'valid_code'</span>] = v.code</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(data)</span><br></pre></td></tr></table></figure>
<h4 id="9-多视图共用一个路由视图设计-好好理解"><a href="#9-多视图共用一个路由视图设计-好好理解" class="headerlink" title="9.多视图共用一个路由视图设计(好好理解)"></a>9.多视图共用一个路由视图设计(好好理解)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>路由</span><br><span class="line"> <span class="comment"># 分组分出三个(用户名,category|tag|archive中的一个,可能是分类id,tag_id,时间)</span></span><br><span class="line">url(<span class="string">r'^(?P&lt;username&gt;[\w]+)/(?P&lt;condition&gt;category|tag|archive)/(?P&lt;param&gt;.*)'</span>, views.user_blog),</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>视图</span><br><span class="line">blog = user.blog</span><br><span class="line">article_list = blog.article_set.all()</span><br><span class="line"><span class="comment"># 取出condition中的分类/标签/时间</span></span><br><span class="line">condition = kwargs.get(<span class="string">'condition'</span>)</span><br><span class="line"><span class="comment"># condition可能是category|tag|archive中的一个 还可能是空</span></span><br><span class="line"><span class="comment"># 取出param的值,可能为标签id,分类id,或者是时间</span></span><br><span class="line">param = kwargs.get(<span class="string">'param'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'tag'</span> == condition:</span><br><span class="line">	article_list = article_list.filter(tag__pk=param)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">elif</span> <span class="string">'category'</span> == condition:</span><br><span class="line">	article_list = article_list.filter(category__pk=param)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">elif</span> <span class="string">'archive'</span> == condition:</span><br><span class="line">    <span class="comment">#     2018-11   --&gt;切分---&gt;查询</span></span><br><span class="line">    <span class="comment"># [2018,11]</span></span><br><span class="line">    archive_list = param.split(<span class="string">'-'</span>)</span><br><span class="line">    <span class="comment"># 过滤:发布年为2018年,月为11月的所有文章</span></span><br><span class="line">    article_list = article_list.filter(create_time__year=archive_list[<span class="number">0</span>], create_time__month=archive_list[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<h4 id="10-过滤html文本及标签"><a href="#10-过滤html文本及标签" class="headerlink" title="10.过滤html文本及标签"></a>10.过滤html文本及标签</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>安装BeautifulSoup4</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>导入</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>使用</span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_article</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'back_edit/add_article.html'</span>)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        url = reverse(<span class="string">'back'</span>)</span><br><span class="line">        print(request.POST)</span><br><span class="line">        title = request.POST.get(<span class="string">'title'</span>)</span><br><span class="line">        <span class="comment"># 将页面html代码以及内容全部放入content中</span></span><br><span class="line">        content = request.POST.get(<span class="string">'content'</span>)</span><br><span class="line">        <span class="comment"># 通过Bf类将content通过解析器解析，得到一个对象，该对象的.text是获取页面文本，.find_all是页面标签列表</span></span><br><span class="line">        soup = BeautifulSoup(content, <span class="string">"html.parser"</span>)</span><br><span class="line">        desc = soup.text[:<span class="number">150</span>]</span><br><span class="line">        print(desc)</span><br><span class="line">        tags = soup.find_all()</span><br><span class="line">        <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">            <span class="comment"># 每个页面标签对象的.name 属性可以获取标签名字，可以避免跨站脚本攻击</span></span><br><span class="line">            <span class="keyword">if</span> tag.name == <span class="string">'script'</span>:</span><br><span class="line">                <span class="comment"># 将script标签去掉</span></span><br><span class="line">                tag.decompose()</span><br><span class="line">        ret = Article.objects.create(title=title, desc=desc, content=str(soup), blog=request.user.blog)</span><br><span class="line">        <span class="keyword">return</span> redirect(url)</span><br></pre></td></tr></table></figure>
<h4 id="11-富文本编辑器使用-http-kindeditor-net-doc-php"><a href="#11-富文本编辑器使用-http-kindeditor-net-doc-php" class="headerlink" title="11.富文本编辑器使用(http://kindeditor.net/doc.php)"></a>11.富文本编辑器使用(<span class="exturl" data-url="aHR0cDovL2tpbmRlZGl0b3IubmV0L2RvYy5waHA=" title="http://kindeditor.net/doc.php">http://kindeditor.net/doc.php<i class="fa fa-external-link"></i></span>)</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1.hmtl部分</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> <span class="attr">src</span>=<span class="string">"/static/kindeditor/kindeditor-all.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        KindEditor.ready(<span class="function"><span class="keyword">function</span> <span class="params">(K)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">window</span>.editor = K.create(<span class="string">'#editor_id'</span>, &#123;</span></span><br><span class="line"><span class="actionscript">                width: <span class="string">'100%'</span>,</span></span><br><span class="line"><span class="actionscript">                height: <span class="string">'450px'</span>,</span></span><br><span class="line"><span class="actionscript">                uploadJson: <span class="string">'&#123;% url "save_img" %&#125;'</span>,</span></span><br><span class="line">                extraFileUploadParams:&#123;</span><br><span class="line"><span class="actionscript">                    <span class="string">'csrfmiddlewaretoken'</span>:<span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span></span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="actionscript">                <span class="comment">//修改默认上传文件的名字</span></span></span><br><span class="line"><span class="actionscript">                filePostName:<span class="string">'myfile'</span></span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>视图部分</span><br><span class="line">soup = BeautifulSoup(content, <span class="string">"html.parser"</span>)</span><br><span class="line">desc = soup.text[:<span class="number">150</span>]</span><br><span class="line">print(desc)</span><br><span class="line">tags = soup.find_all()</span><br><span class="line"><span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">    <span class="comment"># 每个页面标签对象的.name 属性可以获取标签名字，可以避免跨站脚本攻击</span></span><br><span class="line">    <span class="keyword">if</span> tag.name == <span class="string">'script'</span>:</span><br><span class="line">        <span class="comment"># 将script标签去掉</span></span><br><span class="line">        tag.decompose()</span><br><span class="line">ret = Article.objects.create(title=title, desc=desc, content=str(soup), blog=request.user.blog)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.</span>上传图片</span><br><span class="line">files = request.FILES.get(<span class="string">'myfile'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    path = os.path.join(BASE_DIR, <span class="string">'media'</span>, <span class="string">'img'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">    	os.mkdir(path)</span><br><span class="line">    file_name = files.name</span><br><span class="line">    new_path = os.path.join(path, file_name)</span><br><span class="line">    <span class="keyword">with</span> open(new_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> files:</span><br><span class="line">            f.write(line)	</span><br><span class="line">    res = &#123;<span class="string">'error'</span>: <span class="number">0</span>, <span class="string">'url'</span>: <span class="string">'media/img/%s'</span> % file_name&#125;</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">	res = &#123;<span class="string">'error'</span>: <span class="number">1</span>, <span class="string">'url'</span>: <span class="string">''</span>&#125;</span><br><span class="line"><span class="keyword">return</span> JsonResponse(res)</span><br></pre></td></tr></table></figure>
<h4 id="12-head"><a href="#12-head" class="headerlink" title="12.head"></a>12.head</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">headers: &#123;</span><br><span class="line">                <span class="string">'X-CSRFToken'</span>: <span class="string">"&#123;&#123; csrf_token &#125;&#125;"</span></span><br><span class="line">            &#125;,</span><br><span class="line">url(<span class="string">r'^media/(?P&lt;path&gt;.*)'</span>, serve, &#123;<span class="string">'document_root'</span>: settings.MEDIA_ROOT&#125;),</span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> blog.views <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br></pre></td></tr></table></figure>
<h3 id="day18—Rest-Framework"><a href="#day18—Rest-Framework" class="headerlink" title="day18—Rest Framework"></a>day18—Rest Framework</h3><h4 id="一-RESTful规范（共十条）"><a href="#一-RESTful规范（共十条）" class="headerlink" title="一.RESTful规范（共十条）"></a>一.RESTful规范（共十条）</h4><h5 id="1-什么是restful规范"><a href="#1-什么是restful规范" class="headerlink" title="1.什么是restful规范"></a>1.什么是restful规范</h5><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="built_in">rest</span>与技术无关，代表的是一种软件架构风格，<span class="built_in">rest</span>是representational state transfer,中文翻译为‘表征状态转移’</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span><span class="built_in">rest</span>从资源的角度审视整个网络，它将分布在网络中某个节点的资源通过url进行标识，客户端应用通过url来获取资源的表征，获得这些表征致使这些应用转变状态。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span><span class="built_in">rest</span>与技术无关，代表的是一种软件架构风格。</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>所有的数据，不过是通过网络获取的还是操作（增删改查）的数据，都是资源，将一切数据视为资源的是<span class="built_in">rest</span>区别与其他架构风格的最本质的属性。</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>对于<span class="built_in">rest</span>这种面向资源的架构风格，有人提出一种全新的结构理念，即：面向资源架构</span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">总结：</span><br><span class="line"><span class="number">1.</span>rest是一种规范</span><br><span class="line"><span class="number">2.</span>面向资源编程：把网络上所有的东西，想象成资源。</span><br></pre></td></tr></table></figure>
<h5 id="2-restful-api设计（规范）"><a href="#2-restful-api设计（规范）" class="headerlink" title="2.restful api设计（规范）"></a>2.restful api设计（规范）</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.api与用户的通信协议，总是使用HTTPs协议。</span><br><span class="line">https比http安全，会SSL加密,但是得购买SSL证书。</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2.域名</span><br><span class="line">尽量将自己的api部署在专用域名</span><br><span class="line">方式一：https://api.example.com</span><br><span class="line">方式二：https://example.org/api</span><br><span class="line"></span><br><span class="line">eg：</span><br><span class="line">例如写一个查询所有图书的api接口，即是api后面接口相关的url</span><br><span class="line">方式一：https://api.example.com/books</span><br><span class="line">方式二：https://127.0.0.1/api/books</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.</span>版本</span><br><span class="line">url：<span class="string">https:</span><span class="comment">//api.example.com/v1/</span></span><br><span class="line"><span class="string">url:</span><span class="string">https:</span><span class="comment">//127.0.0.1/api/v1/books --推荐使用</span></span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>.路径：视网络上的任何东西为资源，均使用名词表示（可复数）</span><br><span class="line">https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>books</span><br><span class="line">https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>animals</span><br><span class="line">https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>employees</span><br><span class="line">不能这么写:</span><br><span class="line">    -获取所有图书:https:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/api/g</span>et_all_books</span><br><span class="line">    -新增一本书:https:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/api/</span>add_book</span><br><span class="line">统一都用这个:</span><br><span class="line">	https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>books</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span><span class="function">.<span class="keyword">method</span></span></span><br><span class="line"><span class="function"><span class="title">GET</span>      ：从服务器取出资源（一项或多项）</span></span><br><span class="line"><span class="function"><span class="title">POST</span>    ：在服务器新建一个资源</span></span><br><span class="line"><span class="function"><span class="title">PUT</span>      ：在服务器更新资源（客户端提供改变后的完整资源）</span></span><br><span class="line"><span class="function"><span class="title">PATCH</span>  ：在服务器更新资源（客户端提供改变的属性）</span></span><br><span class="line"><span class="function"><span class="title">DELETE</span> ：从服务器删除资源</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">注意：</span></span><br><span class="line"><span class="function"><span class="title">put</span>，<span class="title">patch</span>，<span class="title">delete</span>这些请求方式，<span class="title">django</span>内部不会给我们做处理，数据只会存放在<span class="title">body</span>体中，需要手动处理</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">幂等性：</span></span><br><span class="line"><span class="function">多次请求的结果，返回的都是相同的结果。<span class="title">put</span>请求第幂等的。</span></span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6</span>.过滤：通国url传参的方式，传递搜索条件</span><br><span class="line">https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>zoos?limit=<span class="number">10</span>：指定返回记录的数量</span><br><span class="line">https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>zoos?offset=<span class="number">10</span>：指定返回记录的开始位置</span><br><span class="line">https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>zoos?page=<span class="number">2</span>&amp;per_page=<span class="number">100</span>：指定第几页，以及每页的记录数</span><br><span class="line">https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>zoos?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序</span><br><span class="line">https:<span class="regexp">//</span>api.example.com<span class="regexp">/v1/</span>zoos?animal_type_id=<span class="number">1</span>：指定筛选条件</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">7.状态码</span><br><span class="line">200 OK - [<span class="builtin-name">GET</span>]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</span><br><span class="line">201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功。</span><br><span class="line">202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</span><br><span class="line">204 <span class="literal">NO</span> CONTENT - [DELETE]：用户删除数据成功。</span><br><span class="line">400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</span><br><span class="line">401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</span><br><span class="line">403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</span><br><span class="line">404 <span class="keyword">NOT</span> FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</span><br><span class="line">406 <span class="keyword">Not</span> Acceptable - [<span class="builtin-name">GET</span>]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</span><br><span class="line">410 Gone -[<span class="builtin-name">GET</span>]：用户请求的资源被永久删除，且不会再得到的。</span><br><span class="line">422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</span><br><span class="line">500 INTERNAL<span class="built_in"> SERVER </span><span class="builtin-name">ERROR</span> - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</span><br><span class="line"></span><br><span class="line">自定义状态码：</span><br><span class="line">status: 100表示成功</span><br><span class="line">    101表示用户名密码错误</span><br><span class="line">    102我也不知道什么错误</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">8.错误处理</span><br><span class="line">错误处理，应返回错误信息，<span class="selector-tag">error</span>当做<span class="selector-tag">key</span>。</span><br><span class="line">&#123;<span class="attribute">status</span>:<span class="number">101</span>,error:<span class="string">'错误信息写上'</span>&#125;</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">9.返回结果，针对不同操作，服务器向用户返回的结果应该符合以下规范。</span><br><span class="line">GET <span class="string">/books</span>：返回资源对象的列表（数组）</span><br><span class="line">GET <span class="string">/books/1</span>：返回单个资源对象</span><br><span class="line">POST <span class="string">/books</span>：返回新生成的资源对象    -新增,传数据,一旦新增完成,把新的资源对象返回</span><br><span class="line">PUT <span class="string">/books/1</span>：返回完整的资源对象</span><br><span class="line">PATCH <span class="string">/books/1</span>：返回完整的资源对象</span><br><span class="line">DELETE <span class="string">/books/1</span>：返回一个空文档</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">10<span class="selector-class">.Hypermedia</span> <span class="selector-tag">API</span>，<span class="selector-tag">RESTful</span> <span class="selector-tag">API</span>最好做到<span class="selector-tag">Hypermedia</span>，即返回结果中提供链接，连向其他<span class="selector-tag">API</span>方法，使得用户不查文档，也知道下一步应该做什么。</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">status</span>:<span class="number">100</span></span><br><span class="line">    msg:成功</span><br><span class="line">    url:<span class="number">127.0</span>.<span class="number">0.1</span>/books/<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">核心:返回结果中提供链接</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">实例：</span><br><span class="line">复制代码</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">user2</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'GET'</span>:</span><br><span class="line">        dic = &#123;<span class="string">'status'</span>:<span class="number">200</span>,<span class="string">'name'</span>: <span class="string">'lqz2'</span>, <span class="string">'age'</span>: <span class="number">18</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(dic))</span><br><span class="line">    <span class="keyword">elif</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        dic = &#123;<span class="string">'status'</span>: <span class="number">200</span>, <span class="string">'msg'</span>: <span class="string">'修改成功'</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(dic)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Users</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        dic = &#123;<span class="string">'status'</span>:<span class="number">200</span>,<span class="string">'name'</span>: <span class="string">'lqz'</span>, <span class="string">'age'</span>: <span class="number">18</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(dic))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        dic = &#123;<span class="string">'status'</span>: <span class="number">200</span>, <span class="string">'msg'</span>: <span class="string">'修改成功'</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(dic)</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>***    针对book这张表的符合resf规范的视图和路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">&gt; 视图：</span><br><span class="line">&gt; <span class="keyword">from</span> app01.models <span class="keyword">import</span> Book</span><br><span class="line">&gt; <span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line">&gt; <span class="keyword">from</span> rest_framework.request <span class="keyword">import</span> Request</span><br><span class="line">&gt; <span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line">&gt; <span class="keyword">from</span> app01.MySer <span class="keyword">import</span> BookSerializer</span><br><span class="line">&gt; <span class="keyword">from</span> rest_framework.utils.serializer_helpers <span class="keyword">import</span> ReturnDict</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="class"><span class="keyword">class</span> <span class="title">BookView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">&gt;     <span class="string">"""</span></span><br><span class="line"><span class="string">&gt;     GET /Book：返回资源对象的列表（数组）</span></span><br><span class="line"><span class="string">&gt;     GET /Book/1：返回单个资源对象</span></span><br><span class="line"><span class="string">&gt;     POST /Book：返回新生成的资源对象    -新增,传数据,一旦新增完成,把新的资源对象返回</span></span><br><span class="line"><span class="string">&gt;     PUT /Book/1：返回完整的资源对象</span></span><br><span class="line"><span class="string">&gt;     PATCH /Book/1：返回完整的资源对象</span></span><br><span class="line"><span class="string">&gt;     DELETE /Book/1：返回一个空文档</span></span><br><span class="line"><span class="string">&gt; </span></span><br><span class="line"><span class="string">&gt;     """</span></span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">&gt;         response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">&gt;         <span class="keyword">if</span> kwargs:</span><br><span class="line">&gt;             <span class="string">'''有值查一条'''</span></span><br><span class="line">&gt;             book = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).first()</span><br><span class="line">&gt;             ser = BookSerializer(book, many=<span class="literal">False</span>)</span><br><span class="line">&gt;             data = ser.data</span><br><span class="line">&gt;             print(data, type(data))</span><br><span class="line">&gt;             <span class="comment"># &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;-----data类型</span></span><br><span class="line">&gt;             <span class="comment"># response['msg'] = &#123;'name': book.name, 'price': book.price&#125;</span></span><br><span class="line">&gt;             response[<span class="string">'msg'</span>] = data</span><br><span class="line">&gt;             <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line">&gt;         <span class="keyword">else</span>:</span><br><span class="line">&gt;             <span class="string">'''无值查全部'''</span></span><br><span class="line">&gt;             books = Book.objects.all()</span><br><span class="line">&gt;             lis = [&#123;<span class="string">'name'</span>: book.name, <span class="string">'price'</span>: book.price&#125; <span class="keyword">for</span> book <span class="keyword">in</span> books]</span><br><span class="line">&gt;             response[<span class="string">'msg'</span>] = lis</span><br><span class="line">&gt;         <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">&gt;         response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">&gt;         print(request.method)</span><br><span class="line">&gt;         print(request.POST)</span><br><span class="line">&gt;         print(request.GET)</span><br><span class="line">&gt;         print(request.FILES)</span><br><span class="line">&gt;         print(request.META)</span><br><span class="line">&gt;         print(request.data)</span><br><span class="line">&gt;         nn = request.data</span><br><span class="line">&gt;         <span class="string">"""</span></span><br><span class="line"><span class="string">&gt;         POST</span></span><br><span class="line"><span class="string">&gt;         &lt;QueryDict: &#123;'name': ['小李飞刀'], 'price': ['88']&#125;&gt;</span></span><br><span class="line"><span class="string">&gt;         &lt;QueryDict: &#123;&#125;&gt;</span></span><br><span class="line"><span class="string">&gt;         &lt;MultiValueDict: &#123;&#125;&gt;</span></span><br><span class="line"><span class="string">&gt;         &lt;QueryDict: &#123;'name': ['小李飞刀'], 'price': ['88']&#125;&gt;</span></span><br><span class="line"><span class="string">&gt;         """</span></span><br><span class="line">&gt;         name = request.data.get(<span class="string">'name'</span>)</span><br><span class="line">&gt;         price = request.data.get(<span class="string">'price'</span>)</span><br><span class="line">&gt;         book = Book.objects.create(name=name, price=price)</span><br><span class="line">&gt;         response[<span class="string">'msg'</span>] = &#123;<span class="string">'name'</span>: book.name, <span class="string">'price'</span>: book.price&#125;</span><br><span class="line">&gt;         <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">&gt;         response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">&gt;         name = request.data.get(<span class="string">'name'</span>)</span><br><span class="line">&gt;         price = request.data.get(<span class="string">'price'</span>)</span><br><span class="line">&gt;         book = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).update(name=name, price=price)</span><br><span class="line">&gt;         print(book)</span><br><span class="line">&gt;         response[<span class="string">'msg'</span>] = <span class="string">'更新成功'</span></span><br><span class="line">&gt;         response[<span class="string">'url'</span>] = <span class="string">'127.0.0.1/Book/%s'</span> % kwargs[<span class="string">'id'</span>]</span><br><span class="line">&gt;         <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="function"><span class="keyword">def</span> <span class="title">patch</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">&gt;         response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">&gt;         name = request.data.get(<span class="string">'name'</span>)</span><br><span class="line">&gt;         price = request.data.get(<span class="string">'price'</span>)</span><br><span class="line">&gt;         book = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).update(name=name, price=price)</span><br><span class="line">&gt;         print(book)</span><br><span class="line">&gt;         response[<span class="string">'msg'</span>] = <span class="string">'更新成功'</span></span><br><span class="line">&gt;         response[<span class="string">'url'</span>] = <span class="string">'127.0.0.1/Book/%s'</span> % kwargs[<span class="string">'id'</span>]</span><br><span class="line">&gt;         <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">&gt;         response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">&gt;         ret = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).delete()</span><br><span class="line">&gt;         print(ret)  <span class="comment"># (1, &#123;'app01.Book': 1&#125;)</span></span><br><span class="line">&gt;         response[<span class="string">'msg'</span>] = <span class="string">'删除成功'</span></span><br><span class="line">&gt;         <span class="keyword">return</span> JsonResponse(response)</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<h4 id="二-restframework之APIView"><a href="#二-restframework之APIView" class="headerlink" title="二.restframework之APIView"></a>二.restframework之APIView</h4><h5 id="1-安装djangorestframework"><a href="#1-安装djangorestframework" class="headerlink" title="1.安装djangorestframework"></a>1.安装djangorestframework</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">方式一：pip3 install djangorestframework</span><br><span class="line"></span><br><span class="line">方式二：pycharm图形化界面安装</span><br><span class="line"></span><br><span class="line">方式三：pycharm命令行下安装（装在当前工程所用的解释器下）</span><br><span class="line"></span><br><span class="line">**注意：</span><br><span class="line">djangorestframework是一个app,所以需要注册</span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line"><span class="code">    'django.contrib.admin',</span></span><br><span class="line"><span class="code">    'django.contrib.auth',</span></span><br><span class="line"><span class="code">    'django.contrib.contenttypes',</span></span><br><span class="line"><span class="code">    'django.contrib.sessions',</span></span><br><span class="line"><span class="code">    'django.contrib.messages',</span></span><br><span class="line"><span class="code">    'django.contrib.staticfiles',</span></span><br><span class="line"><span class="code">    'app01.apps.App01Config',</span></span><br><span class="line"><span class="code">    'rest_framework', ----注册</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h5 id="2-djangorestframework的APIView分析"><a href="#2-djangorestframework的APIView分析" class="headerlink" title="2.djangorestframework的APIView分析"></a>2.djangorestframework的APIView分析</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1<span class="selector-class">.djangorestframework</span>只是快速的构建<span class="selector-tag">resful</span>规范的接口。</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">使用：</span><br><span class="line"><span class="number">1.</span>先导入</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> app01.models <span class="keyword">import</span> Books</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>写一个类继承APIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    GET /books：返回资源对象的列表（数组）</span></span><br><span class="line"><span class="string">    GET /books/1：返回单个资源对象</span></span><br><span class="line"><span class="string">    POST /books：返回新生成的资源对象    -新增,传数据,一旦新增完成,把新的资源对象返回</span></span><br><span class="line"><span class="string">    PUT /books/1：返回完整的资源对象</span></span><br><span class="line"><span class="string">    PATCH /books/1：返回完整的资源对象</span></span><br><span class="line"><span class="string">    DELETE /books/1：返回一个空文档</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> kwargs:</span><br><span class="line">            <span class="string">'''有值查一条'''</span></span><br><span class="line">            book = Books.objects.filter(pk=kwargs[<span class="string">'id'</span>]).first()</span><br><span class="line">            response[<span class="string">'msg'</span>] = &#123;<span class="string">'name'</span>: book.name, <span class="string">'price'</span>: book.price&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="string">'''无值查全部'''</span></span><br><span class="line">            books = Books.objects.all()</span><br><span class="line">            lis = [&#123;<span class="string">'name'</span>: book.name, <span class="string">'price'</span>: book.price&#125; <span class="keyword">for</span> book <span class="keyword">in</span> books]</span><br><span class="line">            response[<span class="string">'msg'</span>] = lis</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        print(request.method)</span><br><span class="line">        print(request.POST)</span><br><span class="line">        print(request.GET)</span><br><span class="line">        print(request.FILES)</span><br><span class="line">        print(request.META)</span><br><span class="line">        print(request.data)</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        POST</span></span><br><span class="line"><span class="string">        &lt;QueryDict: &#123;'name': ['小李飞刀'], 'price': ['88']&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;QueryDict: &#123;&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;MultiValueDict: &#123;&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;QueryDict: &#123;'name': ['小李飞刀'], 'price': ['88']&#125;&gt;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        name = request.data.get(<span class="string">'name'</span>)</span><br><span class="line">        price = request.data.get(<span class="string">'price'</span>)</span><br><span class="line">        book = Books.objects.create(name=name, price=price)</span><br><span class="line">        response[<span class="string">'msg'</span>] = &#123;<span class="string">'name'</span>: book.name, <span class="string">'price'</span>: book.price&#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        name = request.data.get(<span class="string">'name'</span>)</span><br><span class="line">        price = request.data.get(<span class="string">'price'</span>)</span><br><span class="line">        book = Books.objects.filter(pk=kwargs[<span class="string">'id'</span>]).update(name=name, price=price)</span><br><span class="line">        print(book)</span><br><span class="line">        response[<span class="string">'msg'</span>] = <span class="string">'更新成功'</span></span><br><span class="line">        response[<span class="string">'url'</span>] = <span class="string">'127.0.0.1/books/%s'</span> % kwargs[<span class="string">'id'</span>]</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        name = request.data.get(<span class="string">'name'</span>)</span><br><span class="line">        price = request.data.get(<span class="string">'price'</span>)</span><br><span class="line">        book = Books.objects.filter(pk=kwargs[<span class="string">'id'</span>]).update(name=name, price=price)</span><br><span class="line">        print(book)</span><br><span class="line">        response[<span class="string">'msg'</span>] = <span class="string">'更新成功'</span></span><br><span class="line">        response[<span class="string">'url'</span>] = <span class="string">'127.0.0.1/books/%s'</span> % kwargs[<span class="string">'id'</span>]</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        ret = Books.objects.filter(pk=kwargs[<span class="string">'id'</span>]).delete()</span><br><span class="line">        print(ret)  <span class="comment"># (1, &#123;'app01.Books': 1&#125;)</span></span><br><span class="line">        response[<span class="string">'msg'</span>] = <span class="string">'删除成功'</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response)</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>执行流程分析</span><br><span class="line">路由：</span><br><span class="line">url(<span class="string">r'^books/(?P&lt;id&gt;\d+)'</span>, BookView.as_view()), ---调用<span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView里的as_view方法：</span><br><span class="line"></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, **initkwargs)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Store the original class on the view function.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This allows us to discover information about the view when we do URL</span></span><br><span class="line"><span class="string">    reverse lookups.  Used for breadcrumb generation.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(getattr(cls, <span class="string">'queryset'</span>, <span class="literal">None</span>), models.query.QuerySet):</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">force_evaluation</span><span class="params">()</span>:</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(</span><br><span class="line">                <span class="string">'Do not evaluate the `.queryset` attribute directly, '</span></span><br><span class="line">                <span class="string">'as the result will be cached and reused between requests. '</span></span><br><span class="line">                <span class="string">'Use `.all()` or call `.get_queryset()` instead.'</span></span><br><span class="line">            )</span><br><span class="line">            cls.queryset._fetch_all = force_evaluation</span><br><span class="line">	<span class="comment"># 执行父类的as_view方法</span></span><br><span class="line">    view = super(APIView, cls).as_view(**initkwargs) ----执行View里面as_view</span><br><span class="line">    </span><br><span class="line">    view.cls = cls</span><br><span class="line">    view.initkwargs = initkwargs</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Note: session based authentication is explicitly CSRF validated,</span></span><br><span class="line">    <span class="comment"># all other authentication is CSRF exempt.</span></span><br><span class="line">    <span class="keyword">return</span> csrf_exempt(view)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># from rest_framework.views import APIView执行的是这个类中的as_view</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>先执行APIView下的as_view，将产生的view函数传入到局部禁用方法中</span><br><span class="line"></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, **initkwargs)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Store the original class on the view function.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This allows us to discover information about the view when we do URL</span></span><br><span class="line"><span class="string">    reverse lookups.  Used for breadcrumb generation.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(getattr(cls, <span class="string">'queryset'</span>, <span class="literal">None</span>), models.query.QuerySet):</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">force_evaluation</span><span class="params">()</span>:</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(</span><br><span class="line">                <span class="string">'Do not evaluate the `.queryset` attribute directly, '</span></span><br><span class="line">                <span class="string">'as the result will be cached and reused between requests. '</span></span><br><span class="line">                <span class="string">'Use `.all()` or call `.get_queryset()` instead.'</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        cls.queryset._fetch_all = force_evaluation</span><br><span class="line">        </span><br><span class="line"><span class="number">2.</span>执行View类中的as_view方法---返回值是view函数的内存地址</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重用了父类（View）里面的as_view方法</span></span><br><span class="line">    view = super(APIView, cls).as_view(**initkwargs)</span><br><span class="line">    <span class="comment"># &lt;as_view&gt;-----------------------------------------------------------------------------------1</span></span><br><span class="line">    <span class="comment"># View里面的as_view方法：</span></span><br><span class="line"><span class="meta">    @classonlymethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, **initkwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Main entry point for a request-response process.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> initkwargs:</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> cls.http_method_names:</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">"You tried to pass in the %s method name as a "</span></span><br><span class="line">                                <span class="string">"keyword argument to %s(). Don't do that."</span></span><br><span class="line">                                % (key, cls.__name__))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls, key):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">"%s() received an invalid keyword %r. as_view "</span></span><br><span class="line">                                <span class="string">"only accepts arguments that are already "</span></span><br><span class="line">                                <span class="string">"attributes of the class."</span> % (cls.__name__, key))</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(request, *args, **kwargs)</span>:</span></span><br><span class="line">            <span class="comment"># request这个request还是之前的request</span></span><br><span class="line">            self = cls(**initkwargs)</span><br><span class="line">            <span class="comment"># self是BookView这个CBV的对象</span></span><br><span class="line">            <span class="keyword">if</span> hasattr(self, <span class="string">'get'</span>) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(self, <span class="string">'head'</span>):</span><br><span class="line">                self.head = self.get</span><br><span class="line">            self.request = request</span><br><span class="line">            self.args = args</span><br><span class="line">            self.kwargs = kwargs</span><br><span class="line">            </span><br><span class="line"><span class="number">3.</span>调用APIView类中dispatch方法返回的结果是加工后的self.response</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 是self这个对象调用dispatch方法，自己类中没有，去父类中去找，所以此时的dispatch方法是APIView的。</span></span><br><span class="line">            <span class="keyword">return</span> self.dispatch(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># &lt;dispatch&gt;-----------------------------------------------------------------------------------2</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">                <span class="string">"""</span></span><br><span class="line"><span class="string">                `.dispatch()` is pretty much the same as Django's regular dispatch,</span></span><br><span class="line"><span class="string">                but with extra hooks for startup, finalize, and exception handling.</span></span><br><span class="line"><span class="string">                """</span></span><br><span class="line">                self.args = args</span><br><span class="line">                self.kwargs = kwargs</span><br><span class="line">                </span><br><span class="line"><span class="number">4.</span>调用Request类中__init__方法初始化对象---放回一个Request的对象（此时的是新的request）</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 此时将request（最初的）传到APIView里面的initialize_request（初始化request）--返回一个Request的对象</span></span><br><span class="line">                request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">                <span class="comment"># &lt;initialize_request&gt;-----------------------------------------------------------------------------------3</span></span><br><span class="line">                <span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">                    <span class="string">"""</span></span><br><span class="line"><span class="string">                    Returns the initial request object.</span></span><br><span class="line"><span class="string">                    """</span></span><br><span class="line">                    parser_context = self.get_parser_context(request)</span><br><span class="line">                    <span class="comment"># 将参数以及request传入到from rest_framework.request import Request类中初始化，实例产生对象</span></span><br><span class="line">                    <span class="keyword">return</span> Request(</span><br><span class="line">                        request,</span><br><span class="line">                        parsers=self.get_parsers(),</span><br><span class="line">                        authenticators=self.get_authenticators(),</span><br><span class="line">                        negotiator=self.get_content_negotiator(),</span><br><span class="line">                        parser_context=parser_context</span><br><span class="line">                    )</span><br><span class="line">                    <span class="comment"># &lt;Request&gt;-----------------------------------------------------------------------------------4</span></span><br><span class="line">                    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request, parsers=None, authenticators=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 negotiator=None, parser_context=None)</span>:</span></span><br><span class="line">                        <span class="keyword">assert</span> isinstance(request, HttpRequest), (</span><br><span class="line">                            <span class="string">'The `request` argument must be an instance of '</span></span><br><span class="line">                            <span class="string">'`django.http.HttpRequest`, not `&#123;&#125;.&#123;&#125;`.'</span></span><br><span class="line">                                .format(request.__class__.__module__, request.__class__.__name__)</span><br><span class="line">                        )</span><br><span class="line">                        <span class="comment"># ---此时将最初的request设置成Request对象的一个属性</span></span><br><span class="line">                        self._request = request</span><br><span class="line">                        self.parsers = parsers <span class="keyword">or</span> ()</span><br><span class="line">                        self.authenticators = authenticators <span class="keyword">or</span> ()</span><br><span class="line">                        self.negotiator = negotiator <span class="keyword">or</span> self._default_negotiator()</span><br><span class="line">                        self.parser_context = parser_context</span><br><span class="line">                        self._data = Empty</span><br><span class="line">                        self._files = Empty</span><br><span class="line">                        self._full_data = Empty</span><br><span class="line">                        self._content_type = Empty</span><br><span class="line">                        self._stream = Empty</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> self.parser_context <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                            self.parser_context = &#123;&#125;</span><br><span class="line">                        self.parser_context[<span class="string">'request'</span>] = self</span><br><span class="line">                        self.parser_context[<span class="string">'encoding'</span>] = request.encoding <span class="keyword">or</span> settings.DEFAULT_CHARSET</span><br><span class="line"></span><br><span class="line">                        force_user = getattr(request, <span class="string">'_force_auth_user'</span>, <span class="literal">None</span>)</span><br><span class="line">                        force_token = getattr(request, <span class="string">'_force_auth_token'</span>, <span class="literal">None</span>)</span><br><span class="line">                        <span class="keyword">if</span> force_user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">or</span> force_token <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                            forced_auth = ForcedAuthentication(force_user, force_token)</span><br><span class="line">                            self.authenticators = (forced_auth,)</span><br><span class="line"></span><br><span class="line"><span class="meta">                    @property</span></span><br><span class="line">                    <span class="comment"># 将request.data伪装成对象的属性，其实是对象的方法。data里面可以取body体内的数据</span></span><br><span class="line">                    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> _hasattr(self, <span class="string">'_full_data'</span>):</span><br><span class="line">                            self._load_data_and_files()</span><br><span class="line">                        <span class="keyword">return</span> self._full_data</span><br><span class="line">                    <span class="comment"># 此方法当request.POST等原先的一些属性访问时，找不到时会触发，然后再去原先的request对象的属性中查找并返回</span></span><br><span class="line">                    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, attr)</span>:</span></span><br><span class="line">                        <span class="string">"""</span></span><br><span class="line"><span class="string">                        If an attribute does not exist on this instance, then we also attempt</span></span><br><span class="line"><span class="string">                        to proxy it to the underlying HttpRequest object.</span></span><br><span class="line"><span class="string">                        """</span></span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            <span class="keyword">return</span> getattr(self._request, attr)</span><br><span class="line">                        <span class="keyword">except</span> AttributeError:</span><br><span class="line">                            <span class="keyword">return</span> self.__getattribute__(attr)</span><br><span class="line">                    <span class="comment"># &lt;/Request&gt;-----------------------------------------------------------------------------------4</span></span><br><span class="line">                <span class="comment"># &lt;initialize_request&gt;-----------------------------------------------------------------------------------3</span></span><br><span class="line">                </span><br><span class="line"><span class="number">5.</span>Request的对象（此时的是新的request）赋给对象，作为其属性</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 将新的request赋给CBV的对象。作为其属性</span></span><br><span class="line">                self.request = request</span><br><span class="line">                self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">                    <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">                        handler = getattr(self, request.method.lower(),</span><br><span class="line">                                          self.http_method_not_allowed)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        handler = self.http_method_not_allowed</span><br><span class="line">                        </span><br><span class="line"><span class="number">6.</span>执行CBV里面的视图函数，将最新的request传到视图中执行，将返回的结果赋给response</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 执行CBV里面的视图函数，将返回的结果给response接受</span></span><br><span class="line">                    response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">                    response = self.handle_exception(exc)</span><br><span class="line">                    </span><br><span class="line"><span class="number">7.</span>将返回值response设置成self对象的response属性，对其添加的一些属性</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 将改变后的request和视图函数的执行的结果一并传入到finalize_response方法中（APIView）---执行的结果返回response对象，对其添加的一些属性</span></span><br><span class="line">                <span class="comment"># self.response = response ---&gt;此时的response多了一些属性了</span></span><br><span class="line">                self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">                <span class="comment"># &lt;finalize_response&gt;-----------------------------------------------------------------------------------5</span></span><br><span class="line">                <span class="function"><span class="keyword">def</span> <span class="title">finalize_response</span><span class="params">(self, request, response, *args, **kwargs)</span>:</span></span><br><span class="line">                    <span class="string">"""</span></span><br><span class="line"><span class="string">                    Returns the final response object.</span></span><br><span class="line"><span class="string">                    """</span></span><br><span class="line">                    <span class="comment"># Make the error obvious if a proper response is not returned</span></span><br><span class="line">                    <span class="keyword">assert</span> isinstance(response, HttpResponseBase), (</span><br><span class="line">                            <span class="string">'Expected a `Response`, `HttpResponse` or `HttpStreamingResponse` '</span></span><br><span class="line">                            <span class="string">'to be returned from the view, but received a `%s`'</span></span><br><span class="line">                            % type(response)</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> isinstance(response, Response):</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> getattr(request, <span class="string">'accepted_renderer'</span>, <span class="literal">None</span>):</span><br><span class="line">                            neg = self.perform_content_negotiation(request, force=<span class="literal">True</span>)</span><br><span class="line">                            request.accepted_renderer, request.accepted_media_type = neg</span><br><span class="line"></span><br><span class="line">                        response.accepted_renderer = request.accepted_renderer</span><br><span class="line">                        response.accepted_media_type = request.accepted_media_type</span><br><span class="line">                        response.renderer_context = self.get_renderer_context()</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Add new vary headers to the response instead of overwriting.</span></span><br><span class="line">                    vary_headers = self.headers.pop(<span class="string">'Vary'</span>, <span class="literal">None</span>)</span><br><span class="line">                    <span class="keyword">if</span> vary_headers <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        patch_vary_headers(response, cc_delim_re.split(vary_headers))</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> key, value <span class="keyword">in</span> self.headers.items():</span><br><span class="line">                        response[key] = value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> response</span><br><span class="line">                <span class="comment"># &lt;/finalize_response&gt;-----------------------------------------------------------------------------------5</span></span><br><span class="line">                </span><br><span class="line"><span class="number">8.</span>最后返回对象的response属性，<span class="function"><span class="keyword">def</span> <span class="title">view</span> 的返回值就是视图函数的执行结果，以及添加的一些属性，</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">                # 最后返回<span class="title">self</span>.<span class="title">response</span></span></span><br><span class="line"><span class="function">                <span class="title">return</span> <span class="title">self</span>.<span class="title">response</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">                # &lt;/<span class="title">dispatch</span>&gt;-----------------------------------------------------------------------------------2</span></span><br><span class="line"><span class="function"></span></span><br><span class="line">        view.view_class = cls</span><br><span class="line">        view.view_initkwargs = initkwargs</span><br><span class="line"></span><br><span class="line">        <span class="comment"># take name and docstring from class</span></span><br><span class="line">        update_wrapper(view, cls, updated=())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># and possible attributes set by decorators</span></span><br><span class="line">        <span class="comment"># like csrf_exempt from dispatch</span></span><br><span class="line">        update_wrapper(view, cls.dispatch, assigned=())</span><br><span class="line">        </span><br><span class="line"><span class="number">9.</span>最后将加工好的view函数的内存地址返回出去给view这个变量接受。</span><br><span class="line">        <span class="comment"># 在View中的as_view中执行后返回view这个函数的内存地址</span></span><br><span class="line">        <span class="keyword">return</span> view</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;/as_view&gt;-----------------------------------------------------------------------------------1</span></span><br><span class="line">view.cls = cls</span><br><span class="line">view.initkwargs = initkwargs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note: session based authentication is explicitly CSRF validated,</span></span><br><span class="line"><span class="comment"># all other authentication is CSRF exempt.</span></span><br><span class="line"></span><br><span class="line"><span class="number">10.</span>将加工好的view传入局部禁用csrf方法中，采用其他的验证方式，保证其安全</span><br><span class="line"><span class="comment"># 局部禁用csrf组件，采用其他的验证方式</span></span><br><span class="line"><span class="keyword">return</span> csrf_exempt(view)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注意：</span><br><span class="line"><span class="number">1.</span>所有视图里面没有定义在函数体内的代码，在django程序启动过后，就开始执行</span><br><span class="line"><span class="number">2.</span>所有路由里面的视图函数，在django项目启动后都会将函数的内存地址放在路由后面</span><br><span class="line"><span class="number">3.</span>as_view是将其中的定义的view的视图函数（里面有dispatch方法）放在路由后面</span><br><span class="line"><span class="number">4.</span>当有请求过来后，执行view的方法，以及将参数传入。</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>APIView中dispatch方法</span><br><span class="line">request = self.initialize_request(request, *args, **kwargs) --改变原有的request</span><br></pre></td></tr></table></figure>
<h4 id="三-django及DRF序列化工具"><a href="#三-django及DRF序列化工具" class="headerlink" title="三.django及DRF序列化工具"></a>三.django及DRF序列化工具</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line"></span><br><span class="line">    response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'data'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">    books = models.Book.objects.all()</span><br><span class="line">    <span class="comment"># 先构造出所有书籍的字典的列表</span></span><br><span class="line">    <span class="comment"># 用django提供的序列化组件</span></span><br><span class="line">    ret=serializers.serialize(<span class="string">'json'</span>,books)</span><br><span class="line">    print(ret)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回数据是json格式数据</span></span><br><span class="line">    response[<span class="string">'data'</span>] = ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(ret)</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">结果：</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"model"</span>: <span class="string">"app01.book"</span>,</span><br><span class="line">        <span class="attr">"pk"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"红楼梦"</span>,</span><br><span class="line">            <span class="attr">"price"</span>: <span class="string">"15"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"model"</span>: <span class="string">"app01.book"</span>,</span><br><span class="line">        <span class="attr">"pk"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"水"</span>,</span><br><span class="line">            <span class="attr">"price"</span>: <span class="string">"15"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"model"</span>: <span class="string">"app01.book"</span>,</span><br><span class="line">        <span class="attr">"pk"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"水都是"</span>,</span><br><span class="line">            <span class="attr">"price"</span>: <span class="string">"15"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注意：</span><br><span class="line">自带的序列化工具，不可控，不能指定需要的数据。</span><br></pre></td></tr></table></figure>
<h5 id="1-restframework序列化工具—之序列化"><a href="#1-restframework序列化工具—之序列化" class="headerlink" title="1.restframework序列化工具—之序列化"></a>1.restframework序列化工具—之序列化</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>导入序列化工具</span><br><span class="line"><span class="keyword">from</span> rest_framework.serializers <span class="keyword">import</span> Serializer,ModelSerializer</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line"><span class="number">1.</span>The field <span class="string">'authors_name'</span> was declared on serializer BookSerializer, but has <span class="keyword">not</span> been included <span class="keyword">in</span> the <span class="string">'fields'</span> option.</span><br><span class="line">当抛出这个异常时，需要在fields = [<span class="string">'name'</span>, <span class="string">'price'</span>, ]里面注册</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1.推荐写法</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在app下写一个py文件，如myser</span><br><span class="line"><span class="number">2.</span>在py文件中，导入restframework里面的序列化工具，如上</span><br><span class="line"><span class="number">3.</span>定义一个类，继承Serializer/ModelSerializer</span><br><span class="line"><span class="number">4.</span>在视图中导入py文件中的类</span><br><span class="line"><span class="number">5.</span>实例化产生对象</span><br><span class="line">	<span class="comment"># 单个对象</span></span><br><span class="line">	ser = BookSerializer(book, many=<span class="literal">False</span>)</span><br><span class="line">    data = ser.data</span><br><span class="line">    <span class="comment"># 多个对象</span></span><br><span class="line">    ser = BookSerializer(books, many=<span class="literal">True</span>)</span><br><span class="line">    data = ser.data</span><br><span class="line">    <span class="comment"># 注意：</span></span><br><span class="line">    ser.data是&lt;<span class="class"><span class="keyword">class</span> '<span class="title">rest_framework</span>.<span class="title">utils</span>.<span class="title">serializer_helpers</span>.<span class="title">ReturnDict</span>'&gt;</span></span><br><span class="line">6.将字典通过JsonResponse返回，并指定safe=Fasle</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.实例-继承Serializer</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>myser文件中</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> app01.models <span class="keyword">import</span> Book</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    author_name = serializers.CharField(source=<span class="string">'name'</span>)</span><br><span class="line">    phone = serializers.CharField(source=<span class="string">'author_detail.telephone'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    <span class="comment"># 用source可以为字段取别名，防止有人通过数据库的字段名和表名，做一些黑客行为</span></span><br><span class="line">    <span class="comment"># 一旦用了source属性名一定不能和字段名重复，不然会抛出断言错误AssertionError</span></span><br><span class="line">    aaa = serializers.CharField(source=<span class="string">'name'</span>)</span><br><span class="line">    <span class="comment"># 如果不用source指定字段名，属性必须和model里面的字段对应，不能乱写</span></span><br><span class="line">    price = serializers.CharField()</span><br><span class="line">    <span class="comment"># 直接拿是"Publish object"，相当于print了这个对象,可以在模型中重写__str__</span></span><br><span class="line">    <span class="comment"># publish = serializers.CharField()</span></span><br><span class="line">    <span class="comment"># 查询出版社相关的信息，一对多关系</span></span><br><span class="line">    publish_name = serializers.CharField(source=<span class="string">'publish.name'</span>)  <span class="comment"># "北京出版社",拿到的是出版社的名字</span></span><br><span class="line">    publish_city = serializers.CharField(source=<span class="string">'publish.city'</span>)  <span class="comment"># "publish_city": "北京"</span></span><br><span class="line">    publish_email = serializers.CharField(source=<span class="string">'publish.email'</span>)  <span class="comment"># "publish_email": "888@qq.com"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询作者相关的信息</span></span><br><span class="line">    <span class="comment"># 直接这样写会报错或者是none</span></span><br><span class="line">    <span class="comment"># authors = serializers.CharField(source='authors.name')</span></span><br><span class="line">    <span class="comment"># SerializerMethodField()可以指定一个方法名，方法就是钩子函数</span></span><br><span class="line">    authors = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_authors</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="comment"># 方式一</span></span><br><span class="line">        <span class="comment"># obj就是book这个对象</span></span><br><span class="line">        authors = obj.authors.all()</span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        lis = [&#123;'name': author.name, 'phone': author.author_detail.telephone&#125; for author in authors]</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="comment"># 方式二</span></span><br><span class="line">        <span class="comment"># 再写一个序列化的类，将查询出的对象传入序列化</span></span><br><span class="line">        ret = AuthorSerializer(instance=authors, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> ret.data</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>视图函数中</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">    response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> kwargs:</span><br><span class="line">        <span class="string">'''有值查一条'''</span></span><br><span class="line">        book = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).first()</span><br><span class="line">        ser = BookSerializer(book, many=<span class="literal">False</span>)</span><br><span class="line">        data = ser.data</span><br><span class="line">        print(data, type(data))</span><br><span class="line">        <span class="comment"># &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;-----data类型</span></span><br><span class="line">        <span class="comment"># response['msg'] = &#123;'name': book.name, 'price': book.price&#125;</span></span><br><span class="line">        response[<span class="string">'msg'</span>] = data</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="string">'''无值查全部'''</span></span><br><span class="line">        books = Book.objects.all()</span><br><span class="line">        ret = BookSerializer(instance=books, many=<span class="literal">True</span>)</span><br><span class="line">        data = ret.data</span><br><span class="line">        <span class="comment"># lis = [&#123;'name': book.name, 'price': book.price&#125; for book in books]</span></span><br><span class="line">        response[<span class="string">'msg'</span>] = data</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实例-继承ModelSerializer</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>.myser文件中</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> app01.models <span class="keyword">import</span> Book</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    author_name = serializers.CharField(source=<span class="string">'name'</span>)</span><br><span class="line">    phone = serializers.CharField(source=<span class="string">'author_detail.telephone'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 指定模型</span></span><br><span class="line">        model = Book</span><br><span class="line">        <span class="comment"># 指定获取的全部字段</span></span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># 指定获取局部字段</span></span><br><span class="line">        <span class="comment"># fields = ['name', 'price']</span></span><br><span class="line">        <span class="comment"># 指定排除哪些字段</span></span><br><span class="line">        <span class="comment"># exclude = ['name', 'price']</span></span><br><span class="line">        <span class="comment"># 指定查询深度(即跨表的次数)</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可以重写属性</span></span><br><span class="line">    publish = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_publish</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> obj.publish.name</span><br><span class="line"></span><br><span class="line">    authors = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_authors</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        authors = obj.authors.all()</span><br><span class="line">        ret = AuthorSerializer(instance=authors, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> ret.data</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>在视图函数中</span><br><span class="line"><span class="number">2.</span>视图函数中</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">    response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> kwargs:</span><br><span class="line">        <span class="string">'''有值查一条'''</span></span><br><span class="line">        book = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).first()</span><br><span class="line">        ser = BookSerializer(book, many=<span class="literal">False</span>)</span><br><span class="line">        data = ser.data</span><br><span class="line">        print(data, type(data))</span><br><span class="line">        <span class="comment"># &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;-----data类型</span></span><br><span class="line">        <span class="comment"># response['msg'] = &#123;'name': book.name, 'price': book.price&#125;</span></span><br><span class="line">        response[<span class="string">'msg'</span>] = data</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="string">'''无值查全部'''</span></span><br><span class="line">        books = Book.objects.all()</span><br><span class="line">        ret = BookSerializer(instance=books, many=<span class="literal">True</span>)</span><br><span class="line">        data = ret.data</span><br><span class="line">        <span class="comment"># lis = [&#123;'name': book.name, 'price': book.price&#125; for book in books]</span></span><br><span class="line">        response[<span class="string">'msg'</span>] = data</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<h5 id="2-restframework序列化工具—之反序列化"><a href="#2-restframework序列化工具—之反序列化" class="headerlink" title="2.restframework序列化工具—之反序列化"></a>2.restframework序列化工具—之反序列化</h5><blockquote>
<p>实例-继承ModelSerializer</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>myser文件中</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Book</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line">    name = serializers.CharField(min_length=<span class="number">2</span>, error_messages=&#123;<span class="string">'required'</span>: <span class="string">'该字段必填'</span>&#125;)</span><br><span class="line">    authors = serializers.CharField(required=<span class="literal">False</span>, )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 局部钩子:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="comment"># print(value)</span></span><br><span class="line">        <span class="keyword">if</span> value.startswith(<span class="string">'sb'</span>):</span><br><span class="line">            <span class="comment"># 不能以sb开头</span></span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'不能以sb开头'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 全局钩子找到了</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="comment"># value是所有校验通过数据的字典</span></span><br><span class="line">        print(value)</span><br><span class="line">        name = value.get(<span class="string">'name'</span>)</span><br><span class="line">        price = value.get(<span class="string">'price'</span>)</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">and</span> price:</span><br><span class="line">            <span class="keyword">if</span> str(name) == str(price):</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValidationError(<span class="string">'名字跟价格不相等'</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>视图中</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    GET /Book：返回资源对象的列表（数组）</span></span><br><span class="line"><span class="string">    GET /Book/1：返回单个资源对象</span></span><br><span class="line"><span class="string">    POST /Book：返回新生成的资源对象    -新增,传数据,一旦新增完成,把新的资源对象返回</span></span><br><span class="line"><span class="string">    PUT /Book/1：返回完整的资源对象</span></span><br><span class="line"><span class="string">    PATCH /Book/1：返回完整的资源对象</span></span><br><span class="line"><span class="string">    DELETE /Book/1：返回一个空文档</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> kwargs:</span><br><span class="line">            <span class="string">'''有值查一条'''</span></span><br><span class="line">            book = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).first()</span><br><span class="line">            ser = BookSerializer(book, many=<span class="literal">False</span>)</span><br><span class="line">            data = ser.data</span><br><span class="line">            print(data, type(data))</span><br><span class="line">            <span class="comment"># &lt;class 'rest_framework.utils.serializer_helpers.ReturnDict'&gt;-----data类型</span></span><br><span class="line">            <span class="comment"># response['msg'] = &#123;'name': book.name, 'price': book.price&#125;</span></span><br><span class="line">            response[<span class="string">'msg'</span>] = data</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="string">'''无值查全部'''</span></span><br><span class="line">            books = Book.objects.all()</span><br><span class="line">            ret = BookSerializer(instance=books, many=<span class="literal">True</span>)</span><br><span class="line">            data = ret.data</span><br><span class="line">            <span class="comment"># lis = [&#123;'name': book.name, 'price': book.price&#125; for book in books]</span></span><br><span class="line">            response[<span class="string">'msg'</span>] = data</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># publish = Publish.objects.filter(pk=request.data.get('publish')).first()</span></span><br><span class="line">        <span class="comment"># ret = BookSerializer(data=request.data, context=&#123;'publish': publish&#125;)</span></span><br><span class="line">        <span class="comment"># 新增一条记录通过序列化的类，传入需要新增的内容，给data接受</span></span><br><span class="line">        ret = BookSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ret.is_valid():</span><br><span class="line">            ret.save()</span><br><span class="line">            <span class="keyword">return</span> Response(ret.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(ret.errors)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        book = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).first()</span><br><span class="line">        <span class="comment"># 必须将需要修改的book对象放在里面</span></span><br><span class="line">        <span class="comment"># 更新一条记录时，一定要指定instance的对象</span></span><br><span class="line">        ret = BookSerializer(data=request.data, instance=book)</span><br><span class="line">        <span class="keyword">if</span> ret.is_valid():</span><br><span class="line">            ret.save()</span><br><span class="line">            response[<span class="string">'msg'</span>] = ret.data</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response[<span class="string">'msg'</span>] = ret.errors</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        book = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).first()</span><br><span class="line">        <span class="comment"># 必须将需要修改的book对象放在里面</span></span><br><span class="line">        ret = BookSerializer(data=request.data, instance=book)</span><br><span class="line">        <span class="keyword">if</span> ret.is_valid():</span><br><span class="line">            ret.save()</span><br><span class="line">            response[<span class="string">'msg'</span>] = ret.data</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response[<span class="string">'msg'</span>] = ret.errors</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, safe=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, **kwargs)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        <span class="comment"># 删除就不要用序列化组件了</span></span><br><span class="line">        ret = Book.objects.filter(pk=kwargs[<span class="string">'id'</span>]).delete()</span><br><span class="line">        print(ret)  <span class="comment"># (1, &#123;'app01.Book': 1&#125;)</span></span><br><span class="line">        response[<span class="string">'msg'</span>] = <span class="string">'删除成功'</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response)</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注意：</span><br><span class="line"><span class="number">1.</span>对一张表的增删改查应该对应一个视图类</span><br><span class="line"><span class="number">2.</span>针对get请求方式，查全部或者查单条</span><br><span class="line"><span class="number">3.</span>如何想过滤，需要在视图里面查询的时候进行过滤</span><br><span class="line"><span class="number">4.</span>反序列化时一定不能写depth，否则会报错。</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>有时候需要重写create和update方法，需要手动pop掉多余的字段。</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, validated_data)</span>:</span></span><br><span class="line">    print(validated_data, <span class="string">'mmmmmmmmm'</span>)</span><br><span class="line">    <span class="comment"># &#123;'name': '金瓶梅', 'price': Decimal('45.00'), 'publish_date': datetime.date(2014, 11, 22)&#125;</span></span><br><span class="line">    <span class="keyword">return</span> Book.objects.create(publish=self.context[<span class="string">"publish"</span>], **validated_data)</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, instance, validated_data)</span>:</span></span><br><span class="line">        <span class="comment"># instance 是需要更新的对象，validated_data是验证通过的数据，基于对象的更新</span></span><br><span class="line">        instance.name = validated_data.get(<span class="string">'name'</span>)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>*****手动创建对象，并传入第三张表中（在ModelSerializer）</span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, validated_data)</span>:</span></span><br><span class="line">        print(validated_data, <span class="string">'mmmmmmmmm'</span>)</span><br><span class="line">        <span class="comment"># 如何才能不用传nid</span></span><br><span class="line">        mm = self.fields</span><br><span class="line">        print(mm)</span><br><span class="line">        author_list = validated_data[<span class="string">'authors'</span>]</span><br><span class="line">        print(validated_data[<span class="string">'authors'</span>])  <span class="comment"># [&lt;Author: Author object&gt;, &lt;Author: Author object&gt;]</span></span><br><span class="line">        <span class="comment"># &#123;'name': '金瓶梅', 'price': Decimal('45.00'), 'publish_date': datetime.date(2014, 11, 22)&#125;</span></span><br><span class="line">        author_list = validated_data.pop(<span class="string">'authors'</span>)</span><br><span class="line">        book = Book.objects.create(**validated_data)</span><br><span class="line">        <span class="comment"># 第三张表中添加字段。最好加在事务里面，出错回滚</span></span><br><span class="line">        book.authors.add(*author_list)</span><br><span class="line">        <span class="keyword">return</span> book</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>*****手动创建对象，并传入第三张表中（在Serializer）</span><br><span class="line"><span class="comment"># 假设现在是个博客，有一个创建文章，与修改文章的功能, model为Article。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    <span class="comment"># 将user这个用户保存起来，需要的时候调用</span></span><br><span class="line">    user = serializers.HiddenField(</span><br><span class="line">        default=serializers.CurrentUserDefault())</span><br><span class="line">    name = serializers.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">    content = serializers.CharField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, validated_data)</span>:</span></span><br><span class="line">        <span class="comment"># 除了用户，其他数据可以从validated_data这个字典中获取</span></span><br><span class="line">        <span class="comment"># 注意，users在这里是放在上下文中的request，而不是直接的request</span></span><br><span class="line">        user = self.context[<span class="string">'request'</span>].user</span><br><span class="line">        name = validated_data[<span class="string">'name '</span>]</span><br><span class="line">        content = validated_data[<span class="string">'content '</span>]</span><br><span class="line">        <span class="keyword">return</span> Article.objects.create(**validated_data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, instance, validated_data)</span>:</span></span><br><span class="line">        <span class="comment"># 更新的特别之处在于你已经获取到了这个对象instance</span></span><br><span class="line">        instance.name = validated_data.get(<span class="string">'name'</span>)</span><br><span class="line">        instance.content = validated_data.get(<span class="string">'content'</span>)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>
<p><img src="/2019/03/10/django笔记2/C:/Users\zhangchenggang\Desktop\序列化组件图.png" alt></p>
<h5 id="3-序列化组件中可传参数"><a href="#3-序列化组件中可传参数" class="headerlink" title="3.序列化组件中可传参数"></a>3.序列化组件中可传参数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>read_only</span><br><span class="line">read_only：<span class="literal">True</span>表示不允许用户自己上传，只能用于api的输出。如果某个字段设置了read_only=<span class="literal">True</span>，那么就不需要进行数据验证，只会在返回时，将这个字段序列化后返回.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>write_only</span><br><span class="line">write_only:与read_only对应;就是用户post过来的数据，后台服务器处理后不会再经过序列化后返回给客户端；最常见的就是我们在使用手机注册的验证码和填写的密码。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>required</span><br><span class="line">就是这个字段是否必填，例如要求：用户名，密码等是必须填写的；不填写就直接报错.</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>allow_null/allow_blank</span><br><span class="line">是否允许为NULL/空 。 </span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>error_messages</span><br><span class="line">出错时，信息提示。</span><br><span class="line"></span><br><span class="line"><span class="number">6.l</span>able</span><br><span class="line">页面字段显示的标签</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>max_length/min_length</span><br><span class="line">最大/最小长度</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>help_text</span><br><span class="line">在指定字段增加一些提示文字，这两个字段作用于api页面比较有用 </span><br><span class="line"></span><br><span class="line"><span class="number">9.</span>style</span><br><span class="line">说明字段的类型</span><br><span class="line">eg:</span><br><span class="line">    <span class="comment"># 在api页面，输入密码就会以*显示</span></span><br><span class="line">    password = serializers.CharField( style=&#123;<span class="string">'input_type'</span>: <span class="string">'password'</span>&#125;)</span><br><span class="line">       </span><br><span class="line">    <span class="comment"># 会显示选项框</span></span><br><span class="line">    color_channel = serializers.ChoiceField(</span><br><span class="line">        choices=[<span class="string">'red'</span>, <span class="string">'green'</span>, <span class="string">'blue'</span>],</span><br><span class="line">        style=&#123;<span class="string">'base_template'</span>: <span class="string">'radio.html'</span>&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="4-常用字段"><a href="#4-常用字段" class="headerlink" title="4.常用字段"></a>4.常用字段</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>普通字段</span><br><span class="line">CharField、BooleanField、IntegerField、DateTimeField</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>隐藏字段</span><br><span class="line">HiddenField</span><br><span class="line">HiddenField的值不依靠输入，而需要设置默认的值，不需要用户自己post数据过来，也不会显式返回给用户，最常用的就是user!! </span><br><span class="line">例如：</span><br><span class="line">在登录情况下，进行一些操作，假设一个用户去收藏了某一门课，那么后台应该自动识别这个用户，然后用户只需要将课程的id post过来，那么这样的功能，我们配合CurrentUserDefault()实现。</span><br><span class="line">eg:</span><br><span class="line"><span class="comment"># 这样就可以直接获取到当前用户</span></span><br><span class="line">user = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br></pre></td></tr></table></figure>
<h5 id="5-钩子函数"><a href="#5-钩子函数" class="headerlink" title="5.钩子函数"></a>5.钩子函数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>局部钩子，validata_字段名</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmsSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    为什不用ModelSerializer来完成手机号码的验证呢？</span></span><br><span class="line"><span class="string">    因为VerifyCode中还有一个字段是手机验证码字段，直接使用ModelSerializer来验证会报错</span></span><br><span class="line"><span class="string">    因为ModelSerializer会自动生成VerifyCode模型中的所有字段；但是</span></span><br><span class="line"><span class="string">    我们传递过来的就是一个手机号，判断它是否是合法的</span></span><br><span class="line"><span class="string">    因此使用Serializer来自定义合法性校验规则，相当于就是钩子函数</span></span><br><span class="line"><span class="string">    单独对手机号码进行验证</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    mobile = serializers.CharField(max_length=<span class="number">11</span>)</span><br><span class="line">　　<span class="comment"># 使用validate_字段名(self, 字段名)：要么返回字段，要么抛出异常</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_mobile</span><span class="params">(self, mobile)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        验证手机号码，记住这里的validate_字段名一定要是数据模型中的字段</span></span><br><span class="line"><span class="string">        :param attrs:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 手机号码是否注册，查询UserProfile表即可</span></span><br><span class="line">        <span class="keyword">if</span> User.objects.filter(mobile=mobile).exists():</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"用户已经存在"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证手机号码是否合法，这部分应该是在前端做的，当然后台也需要进行验证</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.match(REGEX_MOBILE, mobile):</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"手机号码格式不正确"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证发送频率，如果不做，用户可以一直向后台发送，请求验证码；</span></span><br><span class="line">        <span class="comment"># 会造成很大的压力，限制一分钟只能发送一次 7-8 09:00</span></span><br><span class="line">        one_minute_ago = datetime.now() - timedelta(hours=<span class="number">0</span>, minutes=<span class="number">1</span>, seconds=<span class="number">0</span>)</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        如果添加时间在一分钟以内，它肯定是大于你一分钟之前的时间的</span></span><br><span class="line"><span class="string">        如果这条记录存在</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> VerifyCode.objects.filter(add_time__gt=one_minute_ago, mobile=mobile):</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">"抱歉，一分钟只能发送一次"</span>)</span><br><span class="line">        <span class="comment"># 如果验证通过，我就将这个mobile返回去，这里一定要有一个返回</span></span><br><span class="line">        <span class="keyword">return</span> mobile</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>全局钩子validate</span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="comment"># value是所有校验通过数据的字典</span></span><br><span class="line">        print(value)</span><br><span class="line">        name = value.get(<span class="string">'name'</span>)</span><br><span class="line">        price = value.get(<span class="string">'price'</span>)</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">and</span> price:</span><br><span class="line">            <span class="keyword">if</span> str(name) == str(price):</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValidationError(<span class="string">'名字跟价格不相等'</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>全局钩子除了验证功能以外，还可以对read_only字段进行赋值操作</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">eg：订单号的生成，我们可以在这步生成一个订单号，然后添加到attrs这个字典中</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    user = serializers.HiddenField(</span><br><span class="line">        default=serializers.CurrentUserDefault()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    pay_status = serializers.CharField(read_only=<span class="literal">True</span>)</span><br><span class="line">    trade_no = serializers.CharField(read_only=<span class="literal">True</span>)</span><br><span class="line">    order_sn = serializers.CharField(read_only=<span class="literal">True</span>)</span><br><span class="line">    pay_time = serializers.DateTimeField(read_only=<span class="literal">True</span>)</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    在用户提交订单的时候，我们在这里给用户新增一个字段，就是支付宝支付的URL</span></span><br><span class="line"><span class="string">    要设置为read_only=True，这样的话，就不能让用户端提交了，而是服务器端生成</span></span><br><span class="line"><span class="string">    返回给用户的</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    alipay_url = serializers.SerializerMethodField(read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_alipay_url</span><span class="params">(self, obj)</span>:</span>  <span class="comment"># obj就是OrderSerializer对象</span></span><br><span class="line">        alipay = AliPay(</span><br><span class="line">            appid=<span class="string">"2016091200490227"</span>,  <span class="comment"># 沙箱环境中可以找到</span></span><br><span class="line">            app_notify_url=<span class="string">"http://47.92.87.172:8000/alipay/return/"</span>,</span><br><span class="line">            app_private_key_path=private_key_path,  <span class="comment"># 个人私钥</span></span><br><span class="line">            alipay_public_key_path=ali_pub_key_path,  <span class="comment"># 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,</span></span><br><span class="line">            debug=<span class="literal">True</span>,  <span class="comment"># 默认False,上线的时候修改为False即可</span></span><br><span class="line">            return_url=<span class="string">"http://47.92.87.172:8000/alipay/return/"</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        url = alipay.direct_pay(</span><br><span class="line">            <span class="comment"># 一个订单里面可能有多个商品，因此subject</span></span><br><span class="line">            <span class="comment"># 不适合使用商品名称</span></span><br><span class="line">            subject=obj.order_sn,</span><br><span class="line">            out_trade_no=obj.order_sn,</span><br><span class="line">            total_amount=obj.order_mount,</span><br><span class="line">        )</span><br><span class="line">        re_url = <span class="string">"https://openapi.alipaydev.com/gateway.do?&#123;data&#125;"</span>.format(data=url)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> re_url</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_order_sn</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        后台系统生成订单号</span></span><br><span class="line"><span class="string">        这个是系统后台生成的：</span></span><br><span class="line"><span class="string">        当前时间+userId+随机数</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        random_ins = Random()</span><br><span class="line">        order_sn = <span class="string">"&#123;time_str&#125;&#123;user_id&#125;   	&#123;random_num&#125;"</span>.format(time_str=time.strftime(<span class="string">"%Y%m%d%H%M%S"</span>),                                                          user_id=self.context[<span class="string">"request"</span>].user.id,                                                    random_num=random_ins.randint(<span class="number">1000</span>, <span class="number">9999</span>))</span><br><span class="line">        <span class="keyword">return</span> order_sn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, attrs)</span>:</span>  <span class="comment"># 全局钩子函数</span></span><br><span class="line">        attrs[<span class="string">"order_sn"</span>] = self.generate_order_sn()</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = OrderInfo</span><br><span class="line">        fields = <span class="string">"__all__"</span></span><br></pre></td></tr></table></figure>
<h5 id="6-联合唯一"><a href="#6-联合唯一" class="headerlink" title="6.联合唯一"></a>6.联合唯一</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>UniqueTogetherValidator</span><br><span class="line">联合唯一，例如我们需要判断用户是否收藏了某个商品，前端只需要传递过来一个商品ID即可。这个时候就不是像上面那样单独作用于某个字段，而是需要进行联合唯一的判断，即用户ID和商品ID；此时我们需要在Meta中设置。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="comment"># 获取到当前用户</span></span><br><span class="line">    user = serializers.HiddenField(</span><br><span class="line">        default=serializers.CurrentUserDefault()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserFav</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        我们需要获取的是当前登入的user</span></span><br><span class="line"><span class="string">        以后要取消收藏，只需要获取这里的id即可</span></span><br><span class="line"><span class="string">        UniqueTogetherValidator作用在多个字段之上</span></span><br><span class="line"><span class="string">        因为是联合唯一主键</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        validators = [</span><br><span class="line">            UniqueTogetherValidator(</span><br><span class="line">                queryset=UserFav.objects.all(),</span><br><span class="line">                fields=(<span class="string">'user'</span>, <span class="string">'goods'</span>),</span><br><span class="line">                message=<span class="string">"已经收藏"</span></span><br><span class="line">            )</span><br><span class="line">        ]</span><br><span class="line">        fields = (<span class="string">"user"</span>, <span class="string">"goods"</span>, <span class="string">"id"</span>)</span><br></pre></td></tr></table></figure>
<h5 id="7-ModelSerializer需要解决的2个问题"><a href="#7-ModelSerializer需要解决的2个问题" class="headerlink" title="7.ModelSerializer需要解决的2个问题"></a>7.ModelSerializer需要解决的2个问题</h5><blockquote>
<p>问题一：某个字段不属于指定model，它是write_only，需要用户传进来，但我们不能对它进行save( )，因为ModelSerializer是基于Model，这个字段在Model中没有对应，这个时候，我们需要重载validate！ </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">实例：</span><br><span class="line">在用户注册时，我们需要填写验证码，这个验证码只需要验证，不需要保存到用户这个Model中：</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, attrs)</span>:</span></span><br><span class="line">    <span class="keyword">del</span> attrs[<span class="string">"code"</span>]</span><br><span class="line">    <span class="keyword">return</span> attrs</span><br></pre></td></tr></table></figure>
<blockquote>
<p>问题二：某个字段不属于指定model，它是read_only，只需要将它序列化传递给用户，但是在这个model中，没有这个字段！我们需要用到SerializerMethodField。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">实例：</span><br><span class="line">假设需要返回用户加入这个网站多久了，不可能维持这样加入的天数这样一个数据，一般会记录用户加入的时间点，然后当用户获取这个数据，我们再计算返回给它。</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span>  </span><br><span class="line">    days_since_joined = serializers.SerializerMethodField()</span><br><span class="line">    <span class="comment"># 方法写法：get_ + 字段</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_days_since_joined</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">    <span class="comment"># obj指这个model的对象</span></span><br><span class="line">        <span class="keyword">return</span> (now() - obj.date_joined).days</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br></pre></td></tr></table></figure>
<h4 id="四-DRF认证组件"><a href="#四-DRF认证组件" class="headerlink" title="四.DRF认证组件"></a>四.DRF认证组件</h4><h5 id="1-源码分析"><a href="#1-源码分析" class="headerlink" title="1.源码分析"></a>1.源码分析</h5><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">APIView</span>--<span class="literal">-</span><span class="comment">dispatch</span>--<span class="literal">-</span><span class="comment">initialize_request（包装request）</span>--<span class="literal">-</span><span class="comment">apiview的get_authenticators</span>--<span class="literal">-</span><span class="comment">将对象列表返回给authenticators</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">执行apiview的initial方法</span>--<span class="literal">-</span><span class="comment">执行apiview的perform_authentication方法</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">（request</span><span class="string">.</span><span class="comment">user）</span>--<span class="literal">-</span><span class="comment">Request</span><span class="string">.</span><span class="comment">user方法</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">执行request对象的_authenticate方法</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">循环request对象的authenticators</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">执行循环出的每个对象的authenticate方法，将自己和request这个对象传入</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">最后返回一个元组（认证通过）或者抛出异常（认证失败）exceptions</span><span class="string">.</span><span class="comment">APIException</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">如果认证通过self</span><span class="string">.</span><span class="comment">user</span><span class="string">,</span> <span class="comment">self</span><span class="string">.</span><span class="comment">auth</span> <span class="comment">=</span> <span class="comment">user_auth_tuple执行的结果解压赋</span> <span class="comment">值，给request对象添加二个属性。</span></span><br></pre></td></tr></table></figure>
<h5 id="2-认证组件如何使用"><a href="#2-认证组件如何使用" class="headerlink" title="2.认证组件如何使用"></a>2.认证组件如何使用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>新建一个认证组件的py文件</span><br><span class="line"><span class="number">2.</span>创建一个认证类</span><br><span class="line"><span class="number">3.</span>在类中定义一个authenticate对象的绑定方法，并接受request这个参数</span><br><span class="line"><span class="number">4.</span>成功返回一个元组，当前认证通过的用户，以及auth</span><br><span class="line"><span class="number">5.</span>失败抛出APIException(<span class="string">'用户不合法'</span>)</span><br><span class="line"><span class="number">6.</span>可以继承</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="keyword">from</span> app01.models <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存到数据库的版本</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginAuth</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        token = request.query_params.get(<span class="string">'token'</span>)</span><br><span class="line">        ret = UserToken.objects.filter(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> ret:</span><br><span class="line">            <span class="keyword">return</span> ret.user, ret</span><br><span class="line">        <span class="keyword">raise</span> exceptions.APIException(<span class="string">'用户不合法'</span>)</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>1.局部使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在视图中导入认证组件</span><br><span class="line"><span class="keyword">from</span> app01.Myauth <span class="keyword">import</span> LoginAuth</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>在视图类中定义一个变量（名字不能变）</span><br><span class="line">authentication_classes = [LoginAuth, ]</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>这样改视图类就具备了验证功能</span><br></pre></td></tr></table></figure>
<blockquote>
<p>​    </p>
</blockquote>
<blockquote>
<p>2.全局使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在settings里面配置</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_AUTHENTICATION_CLASSES'</span>: (</span><br><span class="line">        <span class="string">'app01.Myauth.LoginAuth'</span>,</span><br><span class="line">    ),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>局部禁用</span><br><span class="line">authentication_classes = []</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3.认证组件执行顺序</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">认证类使用顺序：先用视图类中的验证类，再用settings里配置的验证类，最后用默认的验证类</span><br></pre></td></tr></table></figure>
<h4 id="五-DRF权限组件"><a href="#五-DRF权限组件" class="headerlink" title="五.DRF权限组件"></a>五.DRF权限组件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">只用超级用户才能访问指定的数据，普通用户不能访问，所以就要有权限组件对其限制</span><br></pre></td></tr></table></figure>
<h5 id="1-源码分析-1"><a href="#1-源码分析-1" class="headerlink" title="1.源码分析"></a>1.源码分析</h5><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">APIView</span>--<span class="literal">-</span><span class="comment">dispatch</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">执行initial方法</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">执行apiview对象的check_permissions方法（循环对象列表）</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">执行apiview的get_permissions方法（对象列表）</span>--<span class="literal">-</span><span class="comment">执行对象列表里面的has_permission方法，返回结果为True/False</span><span class="string">,</span><span class="comment">传入三个参数，第一个参数是对象本身，第二个参数request，第三个参数是view对象。</span></span><br></pre></td></tr></table></figure>
<h5 id="2-权限组件如何使用"><a href="#2-权限组件如何使用" class="headerlink" title="2.权限组件如何使用"></a>2.权限组件如何使用</h5><blockquote>
<p>1.局部使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建一个py文件</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserPermission</span><span class="params">(BasePermission)</span>:</span></span><br><span class="line">    message = <span class="string">'您没有相关权限'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.user.user_type == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line"><span class="number">1.</span>在视图中导入认证组件</span><br><span class="line"><span class="keyword">from</span> app01.Mypremisssion <span class="keyword">import</span> UserPermission</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>在视图类中定义一个变量（名字不能变）</span><br><span class="line"> permission_classes = [UserPermission,]</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>这样改视图类就具备了权限功能</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.全局使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在settings里面配置</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_AUTHENTICATION_CLASSES'</span>: (</span><br><span class="line">        <span class="string">'app01.Myauth.LoginAuth'</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'DEFAULT_PERMISSION_CLASSES'</span>: (</span><br><span class="line">        <span class="string">'app01.Mypremisssion.UserPermission'</span>,</span><br><span class="line">    ),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>局部禁用</span><br><span class="line">permission_classes = []</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3.权限组件执行顺序</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">权限类使用顺序：先用视图类中的权限类，再用settings里配置的权限类，最后用默认的权限类</span><br></pre></td></tr></table></figure>
<h4 id="六-importlib使用分析"><a href="#六-importlib使用分析" class="headerlink" title="六.importlib使用分析"></a>六.importlib使用分析</h4><h5 id="1-动态导入"><a href="#1-动态导入" class="headerlink" title="1.动态导入"></a>1.动态导入</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前实在执行文件下</span></span><br><span class="line"><span class="comment"># 相对导入模块</span></span><br><span class="line"><span class="comment"># name = ".name" ---模块名，即py文件</span></span><br><span class="line"><span class="comment"># package= "day01.bb" ---包的路径</span></span><br><span class="line"><span class="comment"># 最后返回一个模块对象</span></span><br><span class="line">func = importlib.import_module(name=<span class="string">'.kk'</span>, package=<span class="string">'day01.bb'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(func)</span><br><span class="line">    <span class="comment"># 模块对象可以通过.属性访问里面的方法和属性</span></span><br><span class="line">    func.foo3()</span><br><span class="line">    func.run()</span><br></pre></td></tr></table></figure>
<h4 id="七-UUID模块"><a href="#七-UUID模块" class="headerlink" title="七.UUID模块"></a>七.UUID模块</h4><h5 id="1-什么是uuid"><a href="#1-什么是uuid" class="headerlink" title="1.什么是uuid"></a>1.什么是uuid</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uuid是<span class="number">128</span>位的全局唯一标识符（univeral unique identifier），通常用<span class="number">32</span>位的一个字符串的形式来表现。有时也称guid(<span class="keyword">global</span> unique identifier)，C<span class="comment">#语言中使用。python中自带了uuid模块来进行uuid的生成和管理工作</span></span><br><span class="line"></span><br><span class="line">UUID —— Universally Unique IDentifier  Python中称为 UUID</span><br><span class="line">GUID —— Globally Unique IDentifier     C<span class="comment">#中称为 GUID</span></span><br><span class="line">它是通过MAC地址、 时间戳、 命名空间、 随机数、 伪随机数来保证生成ID的唯一性,，有着固定的大小( <span class="number">128</span> bit位 )，通常由 <span class="number">32</span> 字节的字符串（十六进制）表示</span><br><span class="line"></span><br><span class="line">它的唯一性和一致性特点，使得可以无需注册过程就能够产生一个新的UUID；UUID可以被用作多种用途, 既可以用来短时间内标记一个对象，也可以可靠的辨别网络中的持久性对象</span><br></pre></td></tr></table></figure>
<h5 id="2-uuid有什么用"><a href="#2-uuid有什么用" class="headerlink" title="2.uuid有什么用"></a>2.uuid有什么用</h5><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.需<span class="built_in">要id</span>要唯一，但不需要具体的意义</span><br><span class="line"><span class="number">2</span>.仅仅用来标识一个对象。常见的用处有数据库表<span class="built_in">的id</span>字段；用户session<span class="built_in">的key</span>值；前端的各种UI库，因为它们通常需要动态创建各种UI元素，这些元素需要唯一<span class="built_in">的id</span>， 这时候就需要使用UUID了。例如：一个网站在存储视频、图片等格式的文件时，这些文件的命名方式就可以采用 UUID生成的随机标识符，避免重名的出现</span><br></pre></td></tr></table></figure>
<h5 id="3-python中uuid模块"><a href="#3-python中uuid模块" class="headerlink" title="3.python中uuid模块"></a>3.python中uuid模块</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="comment">#   基于时间戳</span></span><br><span class="line"><span class="comment">#   使用主机ID, 序列号, 和当前时间来生成UUID, 可保证全球范围的唯一性.</span></span><br><span class="line"><span class="comment">#   但由于使用该方法生成的UUID中包含有主机的网络地址, 因此可能危及隐私.</span></span><br><span class="line"><span class="comment">#   该函数有两个参数, 如果 node 参数未指定, 系统将会自动调用 getnode() 函数来获取主机的硬件(mac)地址.</span></span><br><span class="line"><span class="comment">#   如果 clock_seq  参数未指定系统会使用一个随机产生的14位序列号来代替.</span></span><br><span class="line">print(uuid.uuid1())</span><br><span class="line"></span><br><span class="line"><span class="comment">#   通过计算名字和命名空间的MD5散列值得到，保证了同一命名空间中不同名字的唯一性，</span></span><br><span class="line"><span class="comment">#   和不同命名空间的唯一性，***但同一命名空间的同一名字生成相同的uuid****。</span></span><br><span class="line">print(uuid.uuid3(uuid.NAMESPACE_URL, <span class="string">'zhang'</span>))</span><br><span class="line">print(uuid.uuid3(uuid.NAMESPACE_URL, <span class="string">'zhang'</span>))</span><br><span class="line"><span class="comment"># 70670fc3-1147-3c67-b9ae-20bbf7ec0b96</span></span><br><span class="line"><span class="comment"># 70670fc3-1147-3c67-b9ae-20bbf7ec0b96</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过随机数来生成UUID. 使用的是伪随机数有一定的重复概率.</span></span><br><span class="line">print(uuid.uuid4())</span><br><span class="line"><span class="comment"># 3a597f00-9d3e-492f-a73b-c5cb9b6ad808</span></span><br><span class="line"></span><br><span class="line">print(uuid.uuid5(uuid.NAMESPACE_URL, <span class="string">'zhang'</span>))</span><br><span class="line">print(uuid.uuid5(uuid.NAMESPACE_URL, <span class="string">'zhang'</span>))</span><br><span class="line"><span class="comment"># f54fe653-75f9-5cae-ad85-73f4c2765aa4</span></span><br><span class="line"><span class="comment"># f54fe653-75f9-5cae-ad85-73f4c2765aa4</span></span><br></pre></td></tr></table></figure>
<h5 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> Python中没有基于 DCE 的，所以uuid2可以忽略</span><br><span class="line"><span class="number">2</span> uuid4存在概率性重复，由无映射性</span><br><span class="line"><span class="number">3</span> 若在Global的分布式计算环境下，最好用uuid1</span><br><span class="line"><span class="number">4</span> 若有名字的唯一性要求，最好用uuid3或uuid5</span><br></pre></td></tr></table></figure>
<h4 id="八-DRF频率控制组件"><a href="#八-DRF频率控制组件" class="headerlink" title="八.DRF频率控制组件"></a>八.DRF频率控制组件</h4><h5 id="1-什么是频控组件"><a href="#1-什么是频控组件" class="headerlink" title="1.什么是频控组件"></a>1.什么是频控组件</h5><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>为了控制用户对某个url请求的频率，比如，一分钟以内，只能访问三次</span><br><span class="line"><span class="number">2.</span>节流访问控制</span><br></pre></td></tr></table></figure>
<h5 id="2-怎么使用组件"><a href="#2-怎么使用组件" class="headerlink" title="2.怎么使用组件"></a>2.怎么使用组件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>自定义频控</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThrottle</span>:</span></span><br><span class="line">    dic = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.history = <span class="literal">None</span></span><br><span class="line">        self.ctime = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        ip = request.META.get(<span class="string">'REMOTE_ADDR'</span>)</span><br><span class="line">        ctime = time.time()</span><br><span class="line">        self.ctime = ctime</span><br><span class="line">        <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> self.dic:</span><br><span class="line">            self.dic[ip] = [ctime, ]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="comment"># 这里是dic里面有该ip了</span></span><br><span class="line">        history = self.dic.get(ip)</span><br><span class="line">        self.history = history</span><br><span class="line">        <span class="keyword">while</span> history <span class="keyword">and</span> ctime - history[<span class="number">-1</span>] &gt; <span class="number">60</span>:</span><br><span class="line">            <span class="comment"># 默认从尾删</span></span><br><span class="line">            history.pop()</span><br><span class="line">        <span class="keyword">if</span> len(history) &lt; <span class="number">3</span>:</span><br><span class="line">            <span class="comment"># 如果小于3，列表中插入一个时间</span></span><br><span class="line">            history.insert(<span class="number">0</span>, ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># (self.ctime - self.history[-1])最新的时间减去最后的时间，最大时间差</span></span><br><span class="line">        <span class="comment"># 60减去最大时间差，就是还剩下多少秒过后ctime-history[-1]可以pop掉</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span> - (self.ctime - self.history[<span class="number">-1</span>])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>用rest频控组件</span><br><span class="line"><span class="keyword">from</span> app01.myThrottle <span class="keyword">import</span> MyThrottle</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span><span class="params">(MyAPIView)</span>:</span></span><br><span class="line">    throttle_classes = [MyThrottle, ]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.</span>输出错误信息中文方式一：修改源码</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> Throttled, APIException</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Throttled</span><span class="params">(Throttled, APIException)</span>:</span></span><br><span class="line">    default_detail = <span class="string">'傻逼'</span></span><br><span class="line">    extra_detail_singular = <span class="string">'还剩 &#123;wait&#125; 秒.'</span></span><br><span class="line">    extra_detail_plural = <span class="string">'还剩 &#123;wait&#125; 秒'</span></span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">throttled</span><span class="params">(self, request, wait)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    If request is throttled, determine what kind of exception to raise.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 已经修改了源码</span></span><br><span class="line">    <span class="keyword">raise</span> self.Throttled(wait)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="number">4.</span>输出错误信息中文方式二</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">throttled</span><span class="params">(self, request, wait)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyThrottled</span><span class="params">(exceptions.Throttled)</span>:</span></span><br><span class="line">        default_detail = <span class="string">'傻逼'</span></span><br><span class="line">        extra_detail_singular = <span class="string">'还剩 &#123;wait&#125; 秒.'</span></span><br><span class="line">        extra_detail_plural = <span class="string">'还剩 &#123;wait&#125; 秒'</span></span><br><span class="line"></span><br><span class="line">   	<span class="keyword">raise</span> MyThrottled(wait)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3.全局使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在Mythro模块中定义这个类，继承SimpleRateThrottle</span><br><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> BaseThrottle, SimpleRateThrottle</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThrottle</span><span class="params">(SimpleRateThrottle)</span>:</span></span><br><span class="line">    scope = <span class="string">'aaa'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="comment"># 返回ip地址</span></span><br><span class="line">        <span class="comment"># ip=request.META.get('REMOTE_ADDR')</span></span><br><span class="line">        <span class="comment"># return ip</span></span><br><span class="line">        <span class="keyword">return</span> self.get_ident(request)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>在settings里面做配置</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_THROTTLE_CLASSES'</span>: [<span class="string">'app01.MyAuth.MyThrottle'</span>, ],</span><br><span class="line">    <span class="string">'DEFAULT_THROTTLE_RATES'</span>: &#123;</span><br><span class="line">        <span class="string">'aaa'</span>: <span class="string">'10/m'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>4.局部使用少用几个</p>
</blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">throttle_classes</span> = [MyThrottle,]</span><br><span class="line">写几个就用几个</span><br></pre></td></tr></table></figure>
<blockquote>
<p>5.局部使用，全局不使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">throttle_classes = [MyThrottle,]</span><br><span class="line">写几个就用几个</span><br></pre></td></tr></table></figure>
<h4 id="九-DRF解析器"><a href="#九-DRF解析器" class="headerlink" title="九.DRF解析器"></a>九.DRF解析器</h4><h5 id="1-什么是解析器"><a href="#1-什么是解析器" class="headerlink" title="1.什么是解析器"></a>1.什么是解析器</h5><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">根据请求头 content-<span class="keyword">type</span> 选择对应的解析器对请求体内容进行处理。</span><br><span class="line"></span><br><span class="line">有application/json，x-www-<span class="keyword">form</span>-urlencoded，<span class="keyword">form</span>-<span class="keyword">data</span>等格式</span><br></pre></td></tr></table></figure>
<h5 id="2-drf内置的解析器"><a href="#2-drf内置的解析器" class="headerlink" title="2.drf内置的解析器"></a>2.drf内置的解析器</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'DEFAULT_PARSER_CLASSES'</span>: (</span><br><span class="line">        <span class="string">'rest_framework.parsers.JSONParser'</span>,</span><br><span class="line">        <span class="string">'rest_framework.parsers.FormParser'</span>,</span><br><span class="line">        <span class="string">'rest_framework.parsers.MultiPartParser'</span></span><br><span class="line">    ),</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3.全局使用解析器</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在settings里面配置</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_PARSER_CLASSES'</span>:[</span><br><span class="line">        <span class="string">'rest_framework.parsers.JSONParser'</span></span><br><span class="line">        <span class="string">'rest_framework.parsers.FormParser'</span>  </span><br><span class="line">        <span class="string">'rest_framework.parsers.MultiPartParser'</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>4.局部使用解析器</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">在视图函数中,或者视图函数所继承的父类中</span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser  <span class="comment"># 解析json格式</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> FileUploadParser <span class="comment">#解析上传文件</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> FormParser <span class="comment">#application/x-www-form-urlencoded 的请求体</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> MultiPartParser <span class="comment">#multipart/form-data的请求体</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    parser_classes = [JSONParser, ]</span><br></pre></td></tr></table></figure>
<h4 id="十-DRF视图组件"><a href="#十-DRF视图组件" class="headerlink" title="十.DRF视图组件"></a>十.DRF视图组件</h4><h5 id="1-什么是视图组件"><a href="#1-什么是视图组件" class="headerlink" title="1.什么是视图组件"></a>1.什么是视图组件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以控制多个路由响应的视图</span><br></pre></td></tr></table></figure>
<h5 id="2-视图组件的用法一"><a href="#2-视图组件的用法一" class="headerlink" title="2.视图组件的用法一"></a>2.视图组件的用法一</h5><blockquote>
<p>路由</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^publish/$'</span>, views.PublishView.as_view()),</span><br><span class="line">url(<span class="string">r'^publish/(?P&lt;pk&gt;\d+)/$'</span>, views.PublishDetailView.as_view()),</span><br></pre></td></tr></table></figure>
<blockquote>
<p>视图</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> ListModelMixin, \ <span class="comment"># 可以返回get多个对象</span></span><br><span class="line">                                  CreateModelMixin, \<span class="comment"># 添加一条记录</span></span><br><span class="line">                                  RetrieveModelMixin, \<span class="comment"># 可以返回get单个对象</span></span><br><span class="line">                                  UpdateModelMixin,\ <span class="comment"># 更新一个记录</span></span><br><span class="line">                                  DestroyModelMixin <span class="comment">#删除一条记录</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(GenericAPIView, ListModelMixin, CreateModelMixin)</span>:</span></span><br><span class="line">    queryset = Publish.objects.all()</span><br><span class="line">    serializer_class = PublishSerializers</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.list(request)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 添加一条数据</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishDetailView</span><span class="params">(GenericAPIView, RetrieveModelMixin, UpdateModelMixin, DestroyModelMixin)</span>:</span></span><br><span class="line">    queryset = Publish.objects.all()</span><br><span class="line">    serializer_class = PublishSerializers</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, pk)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, pk)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, pk)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, pk)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, pk)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request, pk)</span><br></pre></td></tr></table></figure>
<h5 id="3-视图组件的用法二"><a href="#3-视图组件的用法二" class="headerlink" title="3.视图组件的用法二"></a>3.视图组件的用法二</h5><blockquote>
<p>路由</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^publish/$'</span>, views.PublishView.as_view()),</span><br><span class="line">url(<span class="string">r'^publish/(?P&lt;pk&gt;\d+)/$'</span>, views.PublishDetailView.as_view()),</span><br></pre></td></tr></table></figure>
<blockquote>
<p>视图</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListCreateAPIView, ListAPIView, RetrieveUpdateDestroyAPIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(ListCreateAPIView)</span>:</span></span><br><span class="line">    queryset = Publish.objects.all()</span><br><span class="line">    serializer_class = PublishSerializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishDetailView</span><span class="params">(RetrieveUpdateDestroyAPIView)</span>:</span></span><br><span class="line">    queryset = Publish.objects.all()</span><br><span class="line">    serializer_class = PublishSerializers</span><br></pre></td></tr></table></figure>
<h5 id="3-视图组件的用法三"><a href="#3-视图组件的用法三" class="headerlink" title="3.视图组件的用法三"></a>3.视图组件的用法三</h5><blockquote>
<p>路由</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^publish'</span>, views.PublishView.as_view(&#123;<span class="string">'get'</span>: <span class="string">'list'</span>, <span class="string">'post'</span>: <span class="string">'create'</span>&#125;)),</span><br><span class="line">url(<span class="string">r'^publish/(?P&lt;pk&gt;\d+)'</span>, views.PublishView.as_view(&#123;<span class="string">'get'</span>: <span class="string">'retrieve'</span>, <span class="string">'put'</span>: <span class="string">'update'</span>,<span class="string">'delete'</span>:<span class="string">'destroy'</span>&#125;)),</span><br></pre></td></tr></table></figure>
<blockquote>
<p>视图</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset = Publish.objects.all()</span><br><span class="line">    serializer_class = PublishSerializers</span><br></pre></td></tr></table></figure>
<h5 id="4-注意：以上三种用法都不建议使用"><a href="#4-注意：以上三种用法都不建议使用" class="headerlink" title="4.注意：以上三种用法都不建议使用"></a>4.注意：以上三种用法都不建议使用</h5><h5 id="5-魔法类ViewSetMixin"><a href="#5-魔法类ViewSetMixin" class="headerlink" title="5.魔法类ViewSetMixin"></a>5.魔法类ViewSetMixin</h5><blockquote>
<p>导入</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ViewSetMixin</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>路由</span><br><span class="line">url(<span class="string">r'^test1/$'</span>, views.TestAll.as_view(&#123;<span class="string">'get'</span>: <span class="string">'test'</span>&#125;)),</span><br><span class="line">url(<span class="string">r'^test2/$'</span>, views.TestAll.as_view(&#123;<span class="string">'get'</span>: <span class="string">'test2'</span>&#125;)),</span><br><span class="line">url(<span class="string">r'^test3/$'</span>, views.TestAll.as_view(&#123;<span class="string">'get'</span>: <span class="string">'test3'</span>&#125;)),</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>视图</span><br><span class="line"><span class="comment"># 注意先后顺序,ViewSetMixin写在前面</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestAll</span><span class="params">(ViewSetMixin, APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(settings.DEBUG)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test2</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'test2'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test3</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'test3'</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>作用</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以让不同的路由，响应到同一个视图类中的不同的视图方法。</span><br><span class="line">比如：和book相关的路由，用一个视图类，和publish相关的，用一个视图类</span><br></pre></td></tr></table></figure>
<blockquote>
<p>源码分析</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewSetMixin</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    This is the magic.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Overrides `.as_view()` so that it takes an `actions` keyword that performs</span></span><br><span class="line"><span class="string">    the binding of HTTP methods to actions on the Resource.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For example, to create a concrete view binding the 'GET' and 'POST' methods</span></span><br><span class="line"><span class="string">    to the 'list' and 'create' actions...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    view = MyViewSet.as_view(&#123;'get': 'list', 'post': 'create'&#125;)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classonlymethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, actions=None, **initkwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 重写了as_view，将传入的字典给actions参数接收</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(request, *args, **kwargs)</span>:</span></span><br><span class="line">            <span class="comment"># 实例化产生一个视图类的对象</span></span><br><span class="line">            self = cls(**initkwargs)</span><br><span class="line">            self.action_map = actions</span><br><span class="line">            <span class="keyword">for</span> method, action <span class="keyword">in</span> actions.items():</span><br><span class="line">                <span class="comment"># &#123;"get":"list"&#125;</span></span><br><span class="line">                <span class="comment"># handler拿到是视图类中的方法的内存地址</span></span><br><span class="line">                handler = getattr(self, action)</span><br><span class="line">                <span class="comment"># 将视图类中的内存地址设置成视图对象self的属性</span></span><br><span class="line">                setattr(self, method, handler)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> hasattr(self, <span class="string">'get'</span>) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(self, <span class="string">'head'</span>):</span><br><span class="line">                self.head = self.get</span><br><span class="line"></span><br><span class="line">            self.request = request</span><br><span class="line">            self.args = args</span><br><span class="line">            self.kwargs = kwargs</span><br><span class="line"></span><br><span class="line">            <span class="comment"># And continue as usual</span></span><br><span class="line">            <span class="keyword">return</span> self.dispatch(request, *args, **kwargs)</span><br><span class="line">        update_wrapper(view, cls, updated=())</span><br><span class="line">        update_wrapper(view, cls.dispatch, assigned=())</span><br><span class="line">        view.cls = cls</span><br><span class="line">        view.initkwargs = initkwargs</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>无论以后执行的是什么路由，全部响应到这个ViewSetMixin这个里面的as_view的魔法方法中</span><br></pre></td></tr></table></figure>
<h4 id="十一-DRF之响应器"><a href="#十一-DRF之响应器" class="headerlink" title="十一.DRF之响应器"></a>十一.DRF之响应器</h4><h5 id="1-什么是响应器"><a href="#1-什么是响应器" class="headerlink" title="1.什么是响应器"></a>1.什么是响应器</h5><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据用户请求的<span class="built_in">url</span>或用户可接受的类型，筛选出合适渲染组建</span><br></pre></td></tr></table></figure>
<h5 id="2-内置渲染器"><a href="#2-内置渲染器" class="headerlink" title="2.内置渲染器"></a>2.内置渲染器</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>显示json格式：JSONRenderer</span><br><span class="line"></span><br><span class="line">访问URL：</span><br><span class="line"></span><br><span class="line">http://127.0.0.1:8000/test/?format=json</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/test.json</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/test/</span><br><span class="line"> </span><br><span class="line"><span class="number">2.</span>默认显示格式：BrowsableAPIRenderer（可以修改它的html文件）</span><br><span class="line"></span><br><span class="line">访问URL：</span><br><span class="line"></span><br><span class="line">http://127.0.0.1:8000/test/?format=api</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/test.api</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/test/</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>表格方式：AdminRenderer</span><br><span class="line"></span><br><span class="line">访问URL：</span><br><span class="line"></span><br><span class="line">http://127.0.0.1:8000/test/?format=admin</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/test.admin</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/test/</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>form表单方式：HTMLFormRenderer</span><br><span class="line"></span><br><span class="line">访问URL：</span><br><span class="line"></span><br><span class="line">http://127.0.0.1:8000/test/?format=form</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/test.form</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/test/</span><br></pre></td></tr></table></figure>
<h5 id="3-局部使用"><a href="#3-局部使用" class="headerlink" title="3.局部使用"></a>3.局部使用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span>  HTMLFormRenderer,BrowsableAPIRenderer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookDetailView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    renderer_classes = [HTMLFormRenderer,BrowsableAPIRenderer ]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,pk)</span>:</span></span><br><span class="line">        book_obj=models.Book.objects.filter(pk=pk).first()</span><br><span class="line">        bs=BookSerializers(book_obj,many=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(bs.data)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,request,pk)</span>:</span></span><br><span class="line">        book_obj = models.Book.objects.filter(pk=pk).first()</span><br><span class="line"></span><br><span class="line">        bs=BookSerializers(data=request.data,instance=book_obj)</span><br><span class="line">        <span class="keyword">if</span> bs.is_valid():</span><br><span class="line">            bs.save() <span class="comment"># update</span></span><br><span class="line">            <span class="keyword">return</span> Response(bs.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(bs.errors)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,request,pk)</span>:</span></span><br><span class="line">        models.Book.objects.filter(pk=pk).delete()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">""</span>)</span><br></pre></td></tr></table></figure>
<h5 id="4-全局使用"><a href="#4-全局使用" class="headerlink" title="4.全局使用"></a>4.全局使用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在settings里面配置</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_RENDERER_CLASSES'</span>:[<span class="string">'rest_framework.renderers.JSONRenderer'</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-自定义显示模板"><a href="#5-自定义显示模板" class="headerlink" title="5.自定义显示模板"></a>5.自定义显示模板</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> TemplateHTMLRenderer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookDetailView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    renderer_classes = [TemplateHTMLRenderer]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,pk)</span>:</span></span><br><span class="line">        book_obj=models.Book.objects.filter(pk=pk).first()</span><br><span class="line">        bs=BookSerializers(book_obj,many=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(bs.data,template_name=<span class="string">'aa.html'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="6-注意"><a href="#6-注意" class="headerlink" title="6.注意"></a>6.注意</h5><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：如果同时多个存在时，自动根据<span class="built_in">URL</span>后缀来选择渲染器。</span><br></pre></td></tr></table></figure>
<h4 id="十二-DRF之url控制"><a href="#十二-DRF之url控制" class="headerlink" title="十二.DRF之url控制"></a>十二.DRF之url控制</h4><h5 id="1-原始的路由"><a href="#1-原始的路由" class="headerlink" title="1.原始的路由"></a>1.原始的路由</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^books/$'</span>, views.BookView.as_view()),</span><br><span class="line">    url(<span class="string">r'^books/(?P&lt;pk&gt;\d+)$'</span>, views.BookDetailView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h5 id="2-半自动路由（视图类继承ModelViewSet）"><a href="#2-半自动路由（视图类继承ModelViewSet）" class="headerlink" title="2.半自动路由（视图类继承ModelViewSet）"></a>2.半自动路由（视图类继承ModelViewSet）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^publish/$'</span>, views.PublishView.as_view(&#123;<span class="string">'get'</span>:<span class="string">'list'</span>,<span class="string">'post'</span>:<span class="string">'create'</span>&#125;)),</span><br><span class="line">    url(<span class="string">r'^publish/(?P&lt;pk&gt;\d+)/$'</span>, views.PublishView.as_view(&#123;<span class="string">'get'</span>:<span class="string">'retrieve'</span>,<span class="string">'put'</span>:<span class="string">'update'</span>,<span class="string">'delete'</span>:<span class="string">'destroy'</span>&#125;)),</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h5 id="3-全自动路由-不推荐使用"><a href="#3-全自动路由-不推荐使用" class="headerlink" title="3.全自动路由(不推荐使用)"></a>3.全自动路由(不推荐使用)</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>路由</span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url,include</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</span><br><span class="line">router=routers.DefaultRouter()</span><br><span class="line"><span class="comment"># 两个参数，一个是匹配的路由，一个是视图中写的CBV的类</span></span><br><span class="line">router.register(<span class="string">'publish'</span>,views.PublishView)</span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># http://127.0.0.1:8000/publish/format=json(渲染器通过这个判断，返回渲染的页面)</span></span><br><span class="line">    <span class="comment"># url(r'^publish/', views.PublishView.as_view(&#123;'get':'list','post':'create'&#125;)),</span></span><br><span class="line">    <span class="comment"># http://127.0.0.1:8000/publish.json(渲染器通过这个判断，返回渲染的页面)</span></span><br><span class="line">    <span class="comment"># url(r'^publish\.(?P&lt;format&gt;\w+)$', views.PublishView.as_view(&#123;'get':'list','post':'create'&#125;)),</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 可以用 以下方式访问</span></span><br><span class="line">    <span class="comment"># 1 http://127.0.0.1:8000/publish/</span></span><br><span class="line">    <span class="comment"># 2 http://127.0.0.1:8000/publish.json</span></span><br><span class="line">    <span class="comment"># 3 http://127.0.0.1:8000/publish/3</span></span><br><span class="line">    <span class="comment"># 4 http://127.0.0.1:8000/publish/3.json   </span></span><br><span class="line">    url(<span class="string">r''</span>,include(router.urls))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>视图</span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset=models.Publish.objects.all()</span><br><span class="line">    serializer_class=PublishSerializers</span><br></pre></td></tr></table></figure>
<h4 id="十三-DRF之分页器"><a href="#十三-DRF之分页器" class="headerlink" title="十三.DRF之分页器"></a>十三.DRF之分页器</h4><h5 id="1-简单分页"><a href="#1-简单分页" class="headerlink" title="1.简单分页"></a>1.简单分页</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>四个核心参数</span><br><span class="line"><span class="comment"># 每页显示多少条</span></span><br><span class="line">page_size = <span class="number">3</span></span><br><span class="line"><span class="comment"># 查询的key,问号后面的key</span></span><br><span class="line">page_query_param = <span class="string">'aa'</span></span><br><span class="line"><span class="comment"># 指定当前页显示多少条</span></span><br><span class="line">page_size_query_param = <span class="string">'size'</span></span><br><span class="line"><span class="comment"># 每页最多显示多少条</span></span><br><span class="line">max_page_size = <span class="number">4</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>如何使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 普通分页</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all</span><span class="params">(self, request)</span>:</span></span><br><span class="line">    response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="string">'查询成功'</span>&#125;</span><br><span class="line">    book_list = models.Book.objects.all()</span><br><span class="line">    <span class="comment"># 实例化产生一个分页对象</span></span><br><span class="line">    <span class="comment"># 不继承来修改对象的值</span></span><br><span class="line">    page = PageNumberPagination()</span><br><span class="line">    page.page_size = <span class="number">2</span></span><br><span class="line">    <span class="comment"># 页面访问参数</span></span><br><span class="line">    page.page_query_param = <span class="string">'bb'</span></span><br><span class="line">    <span class="comment"># page = MyPageNumberPagination()</span></span><br><span class="line">    <span class="comment"># 第一个参数:要分页的数据,第二个参数request对象,第三个参数,当前视图对象</span></span><br><span class="line">    page_list = page.paginate_queryset(book_list, request, self)</span><br><span class="line">    <span class="comment"># 再序列化的时候,用分页之后的数据</span></span><br><span class="line">    ser = mySer.BookSerializer(instance=page_list, many=<span class="literal">True</span>)</span><br><span class="line">    response[<span class="string">'data'</span>] = ser.data</span><br><span class="line">    <span class="comment"># return Response(response)</span></span><br><span class="line">    <span class="comment"># 会带着链接,和总共的条数(不建议用)</span></span><br><span class="line">    <span class="keyword">return</span> page.get_paginated_response(response)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>可以在setting里面配置全局的page_size</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 每页显示两条</span></span><br><span class="line">    <span class="string">'PAGE_SIZE'</span>:<span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-偏移分页"><a href="#2-偏移分页" class="headerlink" title="2.偏移分页"></a>2.偏移分页</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认每页显示几条</span></span><br><span class="line">default_limit = <span class="number">2</span></span><br><span class="line"><span class="comment">#自定义偏移后取几条的参数</span></span><br><span class="line">limit_query_param = <span class="string">'limit'</span></span><br><span class="line"><span class="comment">#自定义偏移位置的参数</span></span><br><span class="line">offset_query_param = <span class="string">'offset'</span></span><br><span class="line"><span class="comment">#最多每页显示的条数</span></span><br><span class="line">max_limit = <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 偏移分页</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> LimitOffsetPagination</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(ViewSetMixin, APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_all</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="number">100</span>, <span class="string">'msg'</span>: <span class="string">'查询成功'</span>&#125;</span><br><span class="line">        book_list = models.Book.objects.all()</span><br><span class="line">        <span class="comment"># 实例化产生一个偏移分页对象</span></span><br><span class="line">        page = LimitOffsetPagination()</span><br><span class="line">        page.default_limit = <span class="number">3</span></span><br><span class="line">        page.max_limit = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">        page_list = page.paginate_queryset(book_list, request, self)</span><br><span class="line">        ser = mySer.BookSerializer(instance=page_list, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>
<h5 id="3-加密分页（查询速度快，但是只能查上一页和下一页，cursor加密）"><a href="#3-加密分页（查询速度快，但是只能查上一页和下一页，cursor加密）" class="headerlink" title="3.加密分页（查询速度快，但是只能查上一页和下一页，cursor加密）"></a>3.加密分页（查询速度快，但是只能查上一页和下一页，cursor加密）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询的关键字，后谜案是随机生成的字符串</span></span><br><span class="line">cursor_query_param = <span class="string">'cursor'</span></span><br><span class="line"><span class="comment">#指定每页显示的多少条</span></span><br><span class="line">page_size = <span class="number">2</span></span><br><span class="line"><span class="comment">#指定的排序方式</span></span><br><span class="line">ordering = <span class="string">'-created'</span></span><br></pre></td></tr></table></figure>
<h4 id="十四-反向解析"><a href="#十四-反向解析" class="headerlink" title="十四.反向解析"></a>十四.反向解析</h4><h5 id="1-get-all"><a href="#1-get-all" class="headerlink" title="1.get_all"></a>1.get_all</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^(?P&lt;version&gt;[v1|v2|v3]+)/books/$'</span>, views.Book.as_view(&#123;<span class="string">'get'</span>: <span class="string">'get_all'</span>&#125;), name=<span class="string">'ttt'</span>),</span><br><span class="line">url2 = request.versioning_scheme.reverse(<span class="string">'ttt'</span>, request=request)</span><br></pre></td></tr></table></figure>
<h5 id="2-get-one"><a href="#2-get-one" class="headerlink" title="2.get_one"></a>2.get_one</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^(?P&lt;version&gt;[v1|v2|v3]+)/books/(?P&lt;pk&gt;\d+)'</span>, views.Book.as_view(&#123;<span class="string">'get'</span>: <span class="string">'get_one'</span>&#125;), name=<span class="string">'mmm'</span>),</span><br><span class="line"></span><br><span class="line">url = reverse(<span class="string">'mmm'</span>, kwargs=kwargs)</span><br></pre></td></tr></table></figure>
<h4 id="十五-DRF之版本控制"><a href="#十五-DRF之版本控制" class="headerlink" title="十五.DRF之版本控制"></a>十五.DRF之版本控制</h4><h5 id="1-如何使用"><a href="#1-如何使用" class="headerlink" title="1.如何使用"></a>1.如何使用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>setting里面配置</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 'DEFAULT_VERSIONING_CLASS':'rest_framework.versioning.QueryParameterVersioning', #全局配置</span></span><br><span class="line">    <span class="string">'VERSION_PARAM'</span>:<span class="string">'version'</span>, <span class="comment">#版本的key值，也就是路由的有名分组的名字</span></span><br><span class="line">    <span class="string">'DEFAULT_VERSION'</span>:<span class="string">'v1'</span>, <span class="comment"># 默认的版本</span></span><br><span class="line">    <span class="string">'ALLOWED_VERSIONS'</span>: [<span class="string">'v1'</span>, <span class="string">'v2'</span>], <span class="comment"># 允许的版本</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>视图</span><br><span class="line"><span class="keyword">from</span> rest_framework.versioning <span class="keyword">import</span> URLPathVersioning, QueryParameterVersioning, AcceptHeaderVersioning</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(ViewSetMixin, APIView)</span>:</span></span><br><span class="line">    <span class="comment"># 局部使用</span></span><br><span class="line">    versioning_class = URLPathVersioning</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.</span>url</span><br><span class="line">url(<span class="string">r'^(?P&lt;version&gt;[v1|v2|v3]+)/books/(?P&lt;pk&gt;\d+)'</span>, views.Book.as_view(&#123;<span class="string">'get'</span>: <span class="string">'get_one'</span>&#125;), name=<span class="string">'mmm'</span>),</span><br><span class="line">url(<span class="string">r'^(?P&lt;version&gt;[v1|v2|v3]+)/books/$'</span>, views.Book.as_view(&#123;<span class="string">'get'</span>: <span class="string">'get_all'</span>&#125;), name=<span class="string">'ttt'</span>),</span><br></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如何访问</span><br><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/v1/</span>books<span class="regexp">/1</span></span><br></pre></td></tr></table></figure>
<h4 id="十六-ContentType组件"><a href="#十六-ContentType组件" class="headerlink" title="十六.ContentType组件"></a>十六.ContentType组件</h4><h5 id="1-model层"><a href="#1-model层" class="headerlink" title="1.model层"></a>1.model层</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.fields <span class="keyword">import</span> GenericForeignKey, GenericRelation</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="comment"># 主要是为了方便根据课程查询价格策略</span></span><br><span class="line">    policy = GenericRelation(to=<span class="string">'PricePolicy'</span>, object_id_field=<span class="string">'course_id'</span>, content_type_field=<span class="string">'table'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DegreeCourse</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    policy = GenericRelation(to=<span class="string">'PricePolicy'</span>, object_id_field=<span class="string">'course_id'</span>, content_type_field=<span class="string">'table'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PricePolicy</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">8</span>, decimal_places=<span class="number">2</span>)</span><br><span class="line">    period = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    course_id = models.IntegerField()</span><br><span class="line">    <span class="comment"># 外键关联contentType，一对多的关系，contenttypes是app名字，后面是表名</span></span><br><span class="line">    table = models.ForeignKey(to=<span class="string">'contenttypes.ContentType'</span>)</span><br><span class="line">    <span class="comment"># 不会在数据库中字段，为了方便查询和更新</span></span><br><span class="line">    union = GenericForeignKey(<span class="string">'table'</span>, <span class="string">'course_id'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="2-视图层"><a href="#2-视图层" class="headerlink" title="2.视图层"></a>2.视图层</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse</span><br><span class="line"><span class="keyword">from</span> app01.models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.models <span class="keyword">import</span> ContentType</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 为Django专题课，添加三个价格策略</span></span><br><span class="line">    <span class="comment"># 原始方式</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    course = Course.objects.filter(pk=1).first()</span></span><br><span class="line"><span class="string">    table = ContentType.objects.filter(model='course').first()</span></span><br><span class="line"><span class="string">    ret = PricePolicy.objects.create(price=10000, period=1, table=table, course_id=course.pk)</span></span><br><span class="line"><span class="string">    ret = PricePolicy.objects.create(price=20000, period=2, table=table, course_id=course.pk)</span></span><br><span class="line"><span class="string">    ret = PricePolicy.objects.create(price=30000, period=3, table=table, course_id=course.pk)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># contenttype方式,添加三个价格策略</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    course = Course.objects.filter(pk=2).first()</span></span><br><span class="line"><span class="string">    ret = PricePolicy.objects.create(price=10000, period=1, union=course)</span></span><br><span class="line"><span class="string">    ret = PricePolicy.objects.create(price=20000, period=2, union=course)</span></span><br><span class="line"><span class="string">    ret = PricePolicy.objects.create(price=30000, period=3, union=course)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 给学位课加一个价格策略</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    degree = DegreeCourse.objects.filter(pk=1).first()</span></span><br><span class="line"><span class="string">    ret = PricePolicy.objects.create(price=50000, period=5.5, union=degree)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 查询所有价格策略，并且显示对应的课程名称</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 查出所有的价格策略</span></span><br><span class="line"><span class="string">    price_policy = PricePolicy.objects.all()</span></span><br><span class="line"><span class="string">    # 循环所有的价格策略，拿到单个策略对象</span></span><br><span class="line"><span class="string">    for i in price_policy:</span></span><br><span class="line"><span class="string">        print(type(i))  # &lt;class 'app01.models.PricePolicy'&gt;</span></span><br><span class="line"><span class="string">        print(i.union)  # python21天基础,拿到的是课程的对象，通过i.union拿到课程对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 查询Django所有的价格策略</span></span><br><span class="line">    course = Course.objects.filter(pk=<span class="number">1</span>).first()</span><br><span class="line">    price_policy = course.policy.all()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> price_policy:</span><br><span class="line">        print(type(i))  <span class="comment"># PricePolicy object</span></span><br><span class="line">        print(i.period)  <span class="comment"># 1</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="十七-Django的缓存机制"><a href="#十七-Django的缓存机制" class="headerlink" title="十七.Django的缓存机制"></a>十七.Django的缓存机制</h4><h5 id="1-缓存介绍"><a href="#1-缓存介绍" class="headerlink" title="1.缓存介绍"></a>1.缓存介绍</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在动态网站中，用户所有的请求，服务器都会取数据库中进行相应的增，删，改，查，渲染模板，执行业务逻辑，最后生成用户能看到的页面。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>当一个网站的用户访问量很大的时候，每一次的后台操作，都会消耗很多的服务端的资源，所以必须使用缓存来减轻后端服务器的压力。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>缓存是将一些常用的数据保存内存或者memcache中，在一定时间内有人来访问这些数据时，则不再去执行数据库及渲染等操作，而是直接从内存或memcache的缓存中去取得数据，然后返回给用户。</span><br></pre></td></tr></table></figure>
<h5 id="2-django中的6种缓存的配置"><a href="#2-django中的6种缓存的配置" class="headerlink" title="2.django中的6种缓存的配置"></a>2.django中的6种缓存的配置</h5><blockquote>
<p>方式一：开发调试（此模式为开发调试使用，实际上不执行任何操作）</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line"> <span class="string">'default'</span>: &#123;</span><br><span class="line">  <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.db.DatabaseCache'</span>,  <span class="comment"># 指定缓存使用的引擎</span></span><br><span class="line">  <span class="string">'LOCATION'</span>: <span class="string">'cache_table'</span>,          <span class="comment"># 数据库表    </span></span><br><span class="line">  <span class="string">'OPTIONS'</span>:&#123;</span><br><span class="line">   <span class="string">'MAX_ENTRIES'</span>: <span class="number">300</span>,           <span class="comment"># 最大缓存记录的数量（默认300）</span></span><br><span class="line">   <span class="string">'CULL_FREQUENCY'</span>: <span class="number">3</span>,          <span class="comment"># 缓存到达最大个数之后，剔除缓存个数的比例，即：1/CULL_FREQUENCY（默认3）</span></span><br><span class="line">  &#125;  </span><br><span class="line"> &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>方式二：内存缓存(将缓存内容保存至内存区域中)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line"> <span class="string">'default'</span>: &#123;</span><br><span class="line">  <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.locmem.LocMemCache'</span>,  <span class="comment"># 指定缓存使用的引擎</span></span><br><span class="line">  <span class="string">'LOCATION'</span>: <span class="string">'unique-snowflake'</span>,         <span class="comment"># 写在内存中的变量的唯一值 </span></span><br><span class="line">  <span class="string">'TIMEOUT'</span>:<span class="number">300</span>,             <span class="comment"># 缓存超时时间(默认为300秒,None表示永不过期)</span></span><br><span class="line">  <span class="string">'OPTIONS'</span>:&#123;</span><br><span class="line">   <span class="string">'MAX_ENTRIES'</span>: <span class="number">300</span>,           <span class="comment"># 最大缓存记录的数量（默认300）</span></span><br><span class="line">   <span class="string">'CULL_FREQUENCY'</span>: <span class="number">3</span>,          <span class="comment"># 缓存到达最大个数之后，剔除缓存个数的比例，即：1/CULL_FREQUENCY（默认3）</span></span><br><span class="line">  &#125;  </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>方式三：<strong>文件缓存(把缓存数据存储在文件中)</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line"> <span class="string">'default'</span>: &#123;</span><br><span class="line">  <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.filebased.FileBasedCache'</span>, <span class="comment">#指定缓存使用的引擎</span></span><br><span class="line">  <span class="string">'LOCATION'</span>: <span class="string">'/var/tmp/django_cache'</span>,        <span class="comment">#指定缓存的路径</span></span><br><span class="line">  <span class="string">'TIMEOUT'</span>:<span class="number">300</span>,              <span class="comment">#缓存超时时间(默认为300秒,None表示永不过期)</span></span><br><span class="line">  <span class="string">'OPTIONS'</span>:&#123;</span><br><span class="line">   <span class="string">'MAX_ENTRIES'</span>: <span class="number">300</span>,            <span class="comment"># 最大缓存记录的数量（默认300）</span></span><br><span class="line">   <span class="string">'CULL_FREQUENCY'</span>: <span class="number">3</span>,           <span class="comment"># 缓存到达最大个数之后，剔除缓存个数的比例，即：1/CULL_FREQUENCY（默认3）</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>方式四：<strong>数据库缓存（把缓存数据存在数据库中）</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line"> <span class="string">'default'</span>: &#123;</span><br><span class="line">  <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.db.DatabaseCache'</span>,  <span class="comment"># 指定缓存使用的引擎</span></span><br><span class="line">  <span class="string">'LOCATION'</span>: <span class="string">'cache_table'</span>,          <span class="comment"># 数据库表    </span></span><br><span class="line">  <span class="string">'OPTIONS'</span>:&#123;</span><br><span class="line">   <span class="string">'MAX_ENTRIES'</span>: <span class="number">300</span>,           <span class="comment"># 最大缓存记录的数量（默认300）</span></span><br><span class="line">   <span class="string">'CULL_FREQUENCY'</span>: <span class="number">3</span>,          <span class="comment"># 缓存到达最大个数之后，剔除缓存个数的比例，即：1/CULL_FREQUENCY（默认3）</span></span><br><span class="line">  &#125;  </span><br><span class="line"> &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.注意,创建缓存的数据库表使用的语句</span><br><span class="line"><span class="keyword">python</span> manage.<span class="keyword">py</span> createcachetable</span><br></pre></td></tr></table></figure>
<blockquote>
<p>方式五</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>方式六</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-django中缓存的应用"><a href="#3-django中缓存的应用" class="headerlink" title="3.django中缓存的应用"></a>3.django中缓存的应用</h5><blockquote>
<p>1.全站使用缓存</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>settings里面中间键配置</span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="comment"># 重写了中间件的response_process方法</span></span><br><span class="line">    <span class="string">'django.middleware.cache.UpdateCacheMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">    <span class="comment"># 重写了中间件的process_request方法</span></span><br><span class="line">    <span class="string">'django.middleware.cache.FetchFromCacheMiddleware'</span>,</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 以秒为单位，设置缓存时间</span></span><br><span class="line">CACHE_MIDDLEWARE_SECONDS = <span class="number">10</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.单个页面使用缓存</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>视图中</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="meta">@cache_page(15)          #超时时间为15秒</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">　　t=time.time()      <span class="comment">#获取当前时间</span></span><br><span class="line">　　bookList=Book.objects.all()</span><br><span class="line">　　<span class="keyword">return</span> render(request,<span class="string">"index.html"</span>,locals())</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3.页面中局部标签使用缓存</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    &#123;% load cache %&#125;</span><br><span class="line">    &#123;% cache 5 'test' %&#125;</span><br><span class="line">    缓存的时间:</span><br><span class="line">    &#123;&#123; ctime &#125;&#125;</span><br><span class="line">    &#123;% endcache %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    实际时间:</span><br><span class="line">    &#123;&#123; ctime &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>4.如果需要把缓存的数据放到文件中，怎么做</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.filebased.FileBasedCache'</span>,  <span class="comment"># 指定缓存使用的引擎</span></span><br><span class="line">        <span class="string">'LOCATION'</span>: <span class="string">'D:\lqz\catch'</span>,  <span class="comment"># 指定缓存的路径</span></span><br><span class="line">        <span class="string">'TIMEOUT'</span>: <span class="number">300</span>,  <span class="comment"># 缓存超时时间(默认为300秒,None表示永不过期)</span></span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">            <span class="string">'MAX_ENTRIES'</span>: <span class="number">300</span>,  <span class="comment"># 最大缓存记录的数量（默认300）</span></span><br><span class="line">            <span class="string">'CULL_FREQUENCY'</span>: <span class="number">3</span>,  <span class="comment"># 缓存到达最大个数之后，剔除缓存个数的比例，即：1/CULL_FREQUENCY（默认3）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="十八-django解决跨域问题"><a href="#十八-django解决跨域问题" class="headerlink" title="十八.django解决跨域问题"></a>十八.django解决跨域问题</h4><h5 id="1-跨域产生的原因"><a href="#1-跨域产生的原因" class="headerlink" title="1.跨域产生的原因"></a>1.跨域产生的原因</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">浏览器同源策略</span><br></pre></td></tr></table></figure>
<h5 id="2-简单请求"><a href="#2-简单请求" class="headerlink" title="2.简单请求"></a>2.简单请求</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">发一次请求：</span><br><span class="line">请求方式：GET/HEAD/POST</span><br><span class="line">头部信息不超过以下几种字段：</span><br><span class="line">Accept</span><br><span class="line">Accept-Language</span><br><span class="line">Content-Language</span><br><span class="line">Last-Event-ID</span><br><span class="line">Content-Type：只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain</span><br></pre></td></tr></table></figure>
<h5 id="3-复杂请求"><a href="#3-复杂请求" class="headerlink" title="3.复杂请求"></a>3.复杂请求</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>非同源</span><br><span class="line"><span class="number">2.</span>请求方式：非get/head/post</span><br><span class="line"><span class="number">3.</span>或者请求方式：GET/HEAD/POST</span><br><span class="line">但是Content-Type为json格式</span><br><span class="line"><span class="number">4.</span>非同源，头部信息超过以上<span class="number">5</span>中字段的</span><br></pre></td></tr></table></figure>
<h5 id="4-解决跨域"><a href="#4-解决跨域" class="headerlink" title="4.解决跨域"></a>4.解决跨域</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CorsMiddleWare</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self,request,response)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">"OPTIONS"</span>:</span><br><span class="line">    <span class="comment">#可以加*</span></span><br><span class="line">    	response[<span class="string">"Access-Control-Allow-Headers"</span>]=<span class="string">"Content-Type,token"</span></span><br><span class="line">    response[<span class="string">"Access-Control-Allow-Origin"</span>] = <span class="string">"http://localhost:8080"</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h4 id="十九-通过命令导出python项目依赖"><a href="#十九-通过命令导出python项目依赖" class="headerlink" title="十九.通过命令导出python项目依赖"></a>十九.通过命令导出python项目依赖</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip3 freeze &gt; requirement.txt</span><br><span class="line">显示效果如下</span><br><span class="line">requirement.txt</span><br><span class="line">pip3 install -r requirement.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">asn1crypto</span>==<span class="number">0.24</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">beautifulsoup4</span>==<span class="number">4.6</span>.<span class="number">3</span></span><br><span class="line"><span class="attr">certifi</span>==<span class="number">2018.10</span>.<span class="number">15</span></span><br><span class="line"><span class="attr">cffi</span>==<span class="number">1.11</span>.<span class="number">5</span></span><br><span class="line"><span class="attr">chardet</span>==<span class="number">3.0</span>.<span class="number">4</span></span><br><span class="line"><span class="attr">Click</span>==<span class="number">7.0</span></span><br><span class="line"><span class="attr">cryptography</span>==<span class="number">2.3</span>.<span class="number">1</span></span><br><span class="line"><span class="attr">Django</span>==<span class="number">1.11</span>.<span class="number">9</span></span><br><span class="line"><span class="attr">djangorestframework</span>==<span class="number">3.9</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">Flask</span>==<span class="number">1.0</span>.<span class="number">2</span></span><br><span class="line"><span class="attr">Flask-Cors</span>==<span class="number">3.0</span>.<span class="number">6</span></span><br><span class="line"><span class="attr">gevent</span>==<span class="number">1.3</span>.<span class="number">7</span></span><br><span class="line"><span class="attr">greenlet</span>==<span class="number">0.4</span>.<span class="number">15</span></span><br><span class="line"><span class="attr">idna</span>==<span class="number">2.7</span></span><br><span class="line"><span class="attr">itsdangerous</span>==<span class="number">1.1</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">Jinja2</span>==<span class="number">2.10</span></span><br><span class="line"><span class="attr">MarkupSafe</span>==<span class="number">1.0</span></span><br><span class="line"><span class="attr">numpy</span>==<span class="number">1.15</span>.<span class="number">4</span></span><br><span class="line"><span class="attr">pandas</span>==<span class="number">0.23</span>.<span class="number">4</span></span><br><span class="line"><span class="attr">Pillow</span>==<span class="number">5.3</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">Pillow-PIL</span>==<span class="number">0.1</span>.dev0</span><br><span class="line"><span class="attr">pycparser</span>==<span class="number">2.19</span></span><br><span class="line"><span class="attr">PyMySQL</span>==<span class="number">0.9</span>.<span class="number">2</span></span><br><span class="line"><span class="attr">python-dateutil</span>==<span class="number">2.7</span>.<span class="number">5</span></span><br><span class="line"><span class="attr">pytz</span>==<span class="number">2018.7</span></span><br><span class="line"><span class="attr">requests</span>==<span class="number">2.20</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">six</span>==<span class="number">1.11</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">urllib3</span>==<span class="number">1.24</span></span><br><span class="line"><span class="attr">Werkzeug</span>==<span class="number">0.14</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="day19–路飞项目"><a href="#day19–路飞项目" class="headerlink" title="day19–路飞项目"></a>day19–路飞项目</h4><h4 id="一-设置token超时时间"><a href="#一-设置token超时时间" class="headerlink" title="一.设置token超时时间"></a>一.设置token超时时间</h4><blockquote>
<p>1.如何将datatime类型转换层时间戳</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">ctime = time.time()</span><br><span class="line">usertoken = UserToken.objects.filter(token=<span class="string">'19e40213-c879-4318-81fb-e567fd902cf6'</span>).first()</span><br><span class="line">old_time = usertoken.time</span><br><span class="line"><span class="comment"># 将datatime类型转换成时间戳</span></span><br><span class="line">online_seconds = int(time.mktime(old_time.timetuple()))</span><br><span class="line">print(ctime-online_seconds)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.时间戳和datatime相互转换</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">python datetime 与时间戳相互转换</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">首先需要引入的时间相关模块：</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time, datetime</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date, datetime, timedelta</span><br><span class="line"></span><br><span class="line">字符串时间online_time变为datetime类型online_dt：</span><br><span class="line">DT_FORMAT=<span class="string">'%Y%m%d %H:%M:%S'</span></span><br><span class="line"></span><br><span class="line">online_time = <span class="string">'20170219 00:02:07'</span></span><br><span class="line"></span><br><span class="line">online_dt = datetime.strptime(online_time, DT_FORMAT)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">datetime类型online_dt变为时间戳秒online_seconds：</span><br><span class="line"></span><br><span class="line">online_seconds = int(time.mktime(online_dt.timetuple()))</span><br><span class="line"></span><br><span class="line">时间戳秒online_seconds变为datetime类型online_dt2(忽略时区):</span><br><span class="line">online_dt2 = datetime.fromtimestamp(online_seconds)</span><br><span class="line">datetime类型online_dt2变为字符串时间online_time2:</span><br><span class="line"></span><br><span class="line">online_time2=online_dt2.strftime(DT_FORMAT)</span><br><span class="line">显然online_time==online_time2。形成完成变换链</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3.实例—实例之数据库版本</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>settings</span><br><span class="line"><span class="comment"># 自定义token超时时间，后面会根据这个变量值，做切分，s代表秒，m代表分钟，h代表小时，d代表日，w代表一周</span></span><br><span class="line">TOKEN_TIMEOUT = <span class="string">"18/H"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>myauth:登录验证</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="keyword">from</span> user.models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> static.utils.Mycommon <span class="keyword">import</span> ValidTokenTime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存到数据库的版本</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginAuth</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line"></span><br><span class="line">        token = request.query_params.get(<span class="string">'token'</span>)</span><br><span class="line">        <span class="comment"># 查出token对象</span></span><br><span class="line">        usertoken = UserToken.objects.filter(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> usertoken:</span><br><span class="line">            <span class="comment"># 将对象传入超时验证组件</span></span><br><span class="line">            res = ValidTokenTime(usertoken)</span><br><span class="line">            <span class="comment"># 判断是否验证通过</span></span><br><span class="line">            <span class="keyword">if</span> res.id_valid():</span><br><span class="line">                <span class="keyword">return</span> usertoken.user, usertoken</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> exceptions.APIException(<span class="string">'请重新登录，您的登录已超时'</span>)</span><br><span class="line">        <span class="keyword">raise</span> exceptions.APIException(<span class="string">'用户不合法'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.</span>mycommon</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidTokenTime</span>:</span></span><br><span class="line">    <span class="string">"""将token的超时时间放在这里面验证"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, usertoken_obj)</span>:</span></span><br><span class="line">        self.usertoken_obj = usertoken_obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">id_valid</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 获取当前时间</span></span><br><span class="line">        ctime = time.time()</span><br><span class="line">        <span class="comment"># 获取数据库最后存取token的时间</span></span><br><span class="line">        old_time = self.usertoken_obj.time</span><br><span class="line">        <span class="comment"># 当前时间和数据库的时间差</span></span><br><span class="line">        time_difference = ctime - int(time.mktime(old_time.timetuple()))</span><br><span class="line">        is_allow = self._allow(time_difference)</span><br><span class="line">        <span class="keyword">return</span> is_allow</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_allow</span><span class="params">(self, time_difference)</span>:</span></span><br><span class="line">        time_out = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 将所有时间，转成时间戳的形式，统一进行计算</span></span><br><span class="line">            num, unit = settings.TOKEN_TIMEOUT.strip(<span class="string">' '</span>).split(<span class="string">'/'</span>)</span><br><span class="line">            <span class="keyword">if</span> unit[<span class="number">0</span>] <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'s'</span>, <span class="string">'S'</span>, <span class="string">'m'</span>, <span class="string">'M'</span>, <span class="string">'h'</span>, <span class="string">'H'</span>]:</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">'配置文件错误'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> unit[<span class="number">0</span>] <span class="keyword">in</span> [<span class="string">'s'</span>, <span class="string">'S'</span>]:</span><br><span class="line">                    time_out = int(num)</span><br><span class="line">                <span class="keyword">elif</span> unit[<span class="number">0</span>] <span class="keyword">in</span> [<span class="string">'m'</span>, <span class="string">'M'</span>]:</span><br><span class="line">                    time_out = int(num) * <span class="number">60</span></span><br><span class="line">                <span class="keyword">elif</span> unit[<span class="number">0</span>] <span class="keyword">in</span> [<span class="string">'h'</span>, <span class="string">'H'</span>]:</span><br><span class="line">                    time_out = int(num) * <span class="number">60</span> * <span class="number">60</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.APIException(<span class="string">'配置文件格式不正确'</span>)</span><br><span class="line">        <span class="keyword">if</span> int(time_difference) &gt; time_out:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>4.实例—redis数据库版本</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>myredis</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">POOL = redis.ConnectionPool(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">6379</span>, max_connections=<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>myauth</span><br><span class="line"><span class="keyword">from</span> static.utils.MYredis <span class="keyword">import</span> POOL</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginAuth</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        token = request.query_params.get(<span class="string">'token'</span>)</span><br><span class="line">        <span class="comment"># 判断是否前端传来token</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.APIException(<span class="string">'用户不合法'</span>)</span><br><span class="line">        <span class="comment"># 查出token对象</span></span><br><span class="line">        conn = redis.Redis(connection_pool=POOL)</span><br><span class="line">        b_username = conn.get(token)</span><br><span class="line">        <span class="comment"># 判断redis中是否存在这个token</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> b_username:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.APIException(<span class="string">'用户不合法'</span>)</span><br><span class="line">        username = b_username.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        user = User.objects.filter(name=username).first()</span><br><span class="line">        <span class="comment"># 判断数据库中是否有这个用户</span></span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="keyword">return</span> user, username</span><br><span class="line">        <span class="keyword">raise</span> exceptions.APIException(<span class="string">'用户不存在'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.</span>视图中</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span><span class="params">(ViewSetMixin, APIView)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        name = request.data.get(<span class="string">'username'</span>)</span><br><span class="line">        password = request.data.get(<span class="string">'password'</span>)</span><br><span class="line">        user = User.objects.filter(name=name, password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            token = uuid.uuid4()</span><br><span class="line">            <span class="comment"># UserToken.objects.update_or_create(user=user, defaults=&#123;'token': token&#125;)</span></span><br><span class="line">            conn = redis.Redis(connection_pool=POOL)</span><br><span class="line">            <span class="comment"># uuid需要转成字符串格式，才能存入到redis中,超时时间为60s，存在则不更新</span></span><br><span class="line">            conn.set(str(token), name, ex=<span class="number">60</span>, nx=<span class="literal">True</span>)</span><br><span class="line">            response.msg = <span class="string">'登录成功'</span></span><br><span class="line">            response.token = token</span><br><span class="line">            response.name = name</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            response.status = <span class="number">101</span></span><br><span class="line">            response.msg = <span class="string">'用户名或密码错误'</span></span><br><span class="line">        <span class="keyword">return</span> response.magic_response</span><br></pre></td></tr></table></figure>
<h5 id="二-封装response"><a href="#二-封装response" class="headerlink" title="二.封装response"></a>二.封装response</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Myresponse</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.status = <span class="number">100</span></span><br><span class="line">        self.msg = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># self.dict = None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">magic_response</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Response(self.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任何位置导入，只执行一次模块代码，实现单例</span></span><br><span class="line">response = Myresponse()</span><br></pre></td></tr></table></figure>
<h5 id="三-购物车存redis，redis中数据结构设计"><a href="#三-购物车存redis，redis中数据结构设计" class="headerlink" title="三.购物车存redis，redis中数据结构设计"></a>三.购物车存redis，redis中数据结构设计</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># shopping_1用户的id</span><br><span class="line">shopping_1:&#123;</span><br><span class="line">    "status": 103,</span><br><span class="line">    "msg": "查询成功",</span><br><span class="line">    "data": &#123;</span><br><span class="line">        # 课程的id</span><br><span class="line">        "1": &#123;</span><br><span class="line">            "title": "python从入门到放弃",</span><br><span class="line">            "img": "/media/img/lhf.jpeg",</span><br><span class="line">            "default_policy": "2", # 默认价格策略的id</span><br><span class="line">            "policy": &#123;</span><br><span class="line">        		# 价格策略id</span><br><span class="line">                "1": &#123;</span><br><span class="line">                    "policy": 1,</span><br><span class="line">                    "period_display": "1周",</span><br><span class="line">                    "price": 9.9</span><br><span class="line">                &#125;,</span><br><span class="line">                "2": &#123;</span><br><span class="line">                    "policy": 2,</span><br><span class="line">                    "period_display": "1个月",</span><br><span class="line">                    "price": 19.9</span><br><span class="line">                &#125;,</span><br><span class="line">                "3": &#123;</span><br><span class="line">                    "policy": 3,</span><br><span class="line">                    "period_display": "3个月",</span><br><span class="line">                    "price": 29.9</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "2": &#123;</span><br><span class="line">            "title": "linuc架构",</span><br><span class="line">            "img": "/media/img/alax.jpeg",</span><br><span class="line">            "default_policy": "4",</span><br><span class="line">            "policy": &#123;</span><br><span class="line">                "4": &#123;</span><br><span class="line">                    "policy": 4,</span><br><span class="line">                    "period_display": "1周",</span><br><span class="line">                    "price": 8.8</span><br><span class="line">                &#125;,</span><br><span class="line">                "5": &#123;</span><br><span class="line">                    "policy": 5,</span><br><span class="line">                    "period_display": "1个月",</span><br><span class="line">                    "price": 18.8</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="四-秒杀系统：一定要加锁"><a href="#四-秒杀系统：一定要加锁" class="headerlink" title="四.秒杀系统：一定要加锁"></a>四.秒杀系统：一定要加锁</h4>
      
    </div>

    

    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
  <img id="wechat_subscriber_qcode" src="/images/gongzhonghao.jpg" alt="李江洋 wechat" style="width: 200px; max-width: 100%;">
  <div>python分享公众号</div>
</div>

      </div>
    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById(&quot;QR&quot;); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="李江洋 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="李江洋 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/07/nginxlinux班/" rel="next" title="nginxlinux班">
                <i class="fa fa-chevron-left"></i> nginxlinux班
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/14/Python数据库连接池DBUtils/" rel="prev" title="Python数据库连接池DBUtils">
                Python数据库连接池DBUtils <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="李江洋">
            
              <p class="site-author-name" itemprop="name">李江洋</p>
              <p class="site-description motion-element" itemprop="description">记录学习的技能和遇到的问题</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">179</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">41</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lvdXJuYW1l" title="GitHub &rarr; https://github.com/yourname"><i class="fa fa-fw fa-github"></i>GitHub</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="bWFpbHRvOjEzMjgwNDQzOTJAcXEuY29t" title="E-Mail &rarr; mailto:1328044392@qq.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</span>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cDovL2V4YW1wbGUuY29t" title="http://example.com">Title</span>
                  </li>
                
              </ul>
            </div>
          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#day17–BBS项目："><span class="nav-number">1.</span> <span class="nav-text">day17–BBS项目：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-模型层"><span class="nav-number">1.1.</span> <span class="nav-text">1.模型层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-前端页面字符串的替换"><span class="nav-number">1.2.</span> <span class="nav-text">2.前端页面字符串的替换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-拿到html标签里面的值"><span class="nav-number">1.3.</span> <span class="nav-text">3.拿到html标签里面的值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-前端字符串转成int类型的方式"><span class="nav-number">1.4.</span> <span class="nav-text">4.前端字符串转成int类型的方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-前端页面聚焦光标"><span class="nav-number">1.5.</span> <span class="nav-text">5.前端页面聚焦光标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-前端输入框内容的截断"><span class="nav-number">1.6.</span> <span class="nav-text">6.前端输入框内容的截断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-将时间对象转成字符串"><span class="nav-number">1.7.</span> <span class="nav-text">7.将时间对象转成字符串</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-随机产生验证码"><span class="nav-number">1.8.</span> <span class="nav-text">8.随机产生验证码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-多视图共用一个路由视图设计-好好理解"><span class="nav-number">1.9.</span> <span class="nav-text">9.多视图共用一个路由视图设计(好好理解)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-过滤html文本及标签"><span class="nav-number">1.10.</span> <span class="nav-text">10.过滤html文本及标签</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-富文本编辑器使用-http-kindeditor-net-doc-php"><span class="nav-number">1.11.</span> <span class="nav-text">11.富文本编辑器使用(http://kindeditor.net/doc.php)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-head"><span class="nav-number">1.12.</span> <span class="nav-text">12.head</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#day18—Rest-Framework"><span class="nav-number">2.</span> <span class="nav-text">day18—Rest Framework</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一-RESTful规范（共十条）"><span class="nav-number">2.1.</span> <span class="nav-text">一.RESTful规范（共十条）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-什么是restful规范"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.什么是restful规范</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-restful-api设计（规范）"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.restful api设计（规范）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二-restframework之APIView"><span class="nav-number">2.2.</span> <span class="nav-text">二.restframework之APIView</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-安装djangorestframework"><span class="nav-number">2.2.1.</span> <span class="nav-text">1.安装djangorestframework</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-djangorestframework的APIView分析"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.djangorestframework的APIView分析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三-django及DRF序列化工具"><span class="nav-number">2.3.</span> <span class="nav-text">三.django及DRF序列化工具</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-restframework序列化工具—之序列化"><span class="nav-number">2.3.1.</span> <span class="nav-text">1.restframework序列化工具—之序列化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-restframework序列化工具—之反序列化"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.restframework序列化工具—之反序列化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-序列化组件中可传参数"><span class="nav-number">2.3.3.</span> <span class="nav-text">3.序列化组件中可传参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-常用字段"><span class="nav-number">2.3.4.</span> <span class="nav-text">4.常用字段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-钩子函数"><span class="nav-number">2.3.5.</span> <span class="nav-text">5.钩子函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-联合唯一"><span class="nav-number">2.3.6.</span> <span class="nav-text">6.联合唯一</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-ModelSerializer需要解决的2个问题"><span class="nav-number">2.3.7.</span> <span class="nav-text">7.ModelSerializer需要解决的2个问题</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四-DRF认证组件"><span class="nav-number">2.4.</span> <span class="nav-text">四.DRF认证组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-源码分析"><span class="nav-number">2.4.1.</span> <span class="nav-text">1.源码分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-认证组件如何使用"><span class="nav-number">2.4.2.</span> <span class="nav-text">2.认证组件如何使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#五-DRF权限组件"><span class="nav-number">2.5.</span> <span class="nav-text">五.DRF权限组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-源码分析-1"><span class="nav-number">2.5.1.</span> <span class="nav-text">1.源码分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-权限组件如何使用"><span class="nav-number">2.5.2.</span> <span class="nav-text">2.权限组件如何使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#六-importlib使用分析"><span class="nav-number">2.6.</span> <span class="nav-text">六.importlib使用分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-动态导入"><span class="nav-number">2.6.1.</span> <span class="nav-text">1.动态导入</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#七-UUID模块"><span class="nav-number">2.7.</span> <span class="nav-text">七.UUID模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-什么是uuid"><span class="nav-number">2.7.1.</span> <span class="nav-text">1.什么是uuid</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-uuid有什么用"><span class="nav-number">2.7.2.</span> <span class="nav-text">2.uuid有什么用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-python中uuid模块"><span class="nav-number">2.7.3.</span> <span class="nav-text">3.python中uuid模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-总结"><span class="nav-number">2.7.4.</span> <span class="nav-text">4.总结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#八-DRF频率控制组件"><span class="nav-number">2.8.</span> <span class="nav-text">八.DRF频率控制组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-什么是频控组件"><span class="nav-number">2.8.1.</span> <span class="nav-text">1.什么是频控组件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-怎么使用组件"><span class="nav-number">2.8.2.</span> <span class="nav-text">2.怎么使用组件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#九-DRF解析器"><span class="nav-number">2.9.</span> <span class="nav-text">九.DRF解析器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-什么是解析器"><span class="nav-number">2.9.1.</span> <span class="nav-text">1.什么是解析器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-drf内置的解析器"><span class="nav-number">2.9.2.</span> <span class="nav-text">2.drf内置的解析器</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十-DRF视图组件"><span class="nav-number">2.10.</span> <span class="nav-text">十.DRF视图组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-什么是视图组件"><span class="nav-number">2.10.1.</span> <span class="nav-text">1.什么是视图组件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-视图组件的用法一"><span class="nav-number">2.10.2.</span> <span class="nav-text">2.视图组件的用法一</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-视图组件的用法二"><span class="nav-number">2.10.3.</span> <span class="nav-text">3.视图组件的用法二</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-视图组件的用法三"><span class="nav-number">2.10.4.</span> <span class="nav-text">3.视图组件的用法三</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-注意：以上三种用法都不建议使用"><span class="nav-number">2.10.5.</span> <span class="nav-text">4.注意：以上三种用法都不建议使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-魔法类ViewSetMixin"><span class="nav-number">2.10.6.</span> <span class="nav-text">5.魔法类ViewSetMixin</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十一-DRF之响应器"><span class="nav-number">2.11.</span> <span class="nav-text">十一.DRF之响应器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-什么是响应器"><span class="nav-number">2.11.1.</span> <span class="nav-text">1.什么是响应器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-内置渲染器"><span class="nav-number">2.11.2.</span> <span class="nav-text">2.内置渲染器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-局部使用"><span class="nav-number">2.11.3.</span> <span class="nav-text">3.局部使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-全局使用"><span class="nav-number">2.11.4.</span> <span class="nav-text">4.全局使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-自定义显示模板"><span class="nav-number">2.11.5.</span> <span class="nav-text">5.自定义显示模板</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-注意"><span class="nav-number">2.11.6.</span> <span class="nav-text">6.注意</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十二-DRF之url控制"><span class="nav-number">2.12.</span> <span class="nav-text">十二.DRF之url控制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-原始的路由"><span class="nav-number">2.12.1.</span> <span class="nav-text">1.原始的路由</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-半自动路由（视图类继承ModelViewSet）"><span class="nav-number">2.12.2.</span> <span class="nav-text">2.半自动路由（视图类继承ModelViewSet）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-全自动路由-不推荐使用"><span class="nav-number">2.12.3.</span> <span class="nav-text">3.全自动路由(不推荐使用)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十三-DRF之分页器"><span class="nav-number">2.13.</span> <span class="nav-text">十三.DRF之分页器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-简单分页"><span class="nav-number">2.13.1.</span> <span class="nav-text">1.简单分页</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-偏移分页"><span class="nav-number">2.13.2.</span> <span class="nav-text">2.偏移分页</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-加密分页（查询速度快，但是只能查上一页和下一页，cursor加密）"><span class="nav-number">2.13.3.</span> <span class="nav-text">3.加密分页（查询速度快，但是只能查上一页和下一页，cursor加密）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十四-反向解析"><span class="nav-number">2.14.</span> <span class="nav-text">十四.反向解析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-get-all"><span class="nav-number">2.14.1.</span> <span class="nav-text">1.get_all</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-get-one"><span class="nav-number">2.14.2.</span> <span class="nav-text">2.get_one</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十五-DRF之版本控制"><span class="nav-number">2.15.</span> <span class="nav-text">十五.DRF之版本控制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-如何使用"><span class="nav-number">2.15.1.</span> <span class="nav-text">1.如何使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十六-ContentType组件"><span class="nav-number">2.16.</span> <span class="nav-text">十六.ContentType组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-model层"><span class="nav-number">2.16.1.</span> <span class="nav-text">1.model层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-视图层"><span class="nav-number">2.16.2.</span> <span class="nav-text">2.视图层</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十七-Django的缓存机制"><span class="nav-number">2.17.</span> <span class="nav-text">十七.Django的缓存机制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-缓存介绍"><span class="nav-number">2.17.1.</span> <span class="nav-text">1.缓存介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-django中的6种缓存的配置"><span class="nav-number">2.17.2.</span> <span class="nav-text">2.django中的6种缓存的配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-django中缓存的应用"><span class="nav-number">2.17.3.</span> <span class="nav-text">3.django中缓存的应用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十八-django解决跨域问题"><span class="nav-number">2.18.</span> <span class="nav-text">十八.django解决跨域问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-跨域产生的原因"><span class="nav-number">2.18.1.</span> <span class="nav-text">1.跨域产生的原因</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-简单请求"><span class="nav-number">2.18.2.</span> <span class="nav-text">2.简单请求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-复杂请求"><span class="nav-number">2.18.3.</span> <span class="nav-text">3.复杂请求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-解决跨域"><span class="nav-number">2.18.4.</span> <span class="nav-text">4.解决跨域</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#十九-通过命令导出python项目依赖"><span class="nav-number">2.19.</span> <span class="nav-text">十九.通过命令导出python项目依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#day19–路飞项目"><span class="nav-number">2.20.</span> <span class="nav-text">day19–路飞项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#一-设置token超时时间"><span class="nav-number">2.21.</span> <span class="nav-text">一.设置token超时时间</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#二-封装response"><span class="nav-number">2.21.1.</span> <span class="nav-text">二.封装response</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#三-购物车存redis，redis中数据结构设计"><span class="nav-number">2.21.2.</span> <span class="nav-text">三.购物车存redis，redis中数据结构设计</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四-秒杀系统：一定要加锁"><span class="nav-number">2.22.</span> <span class="nav-text">四.秒杀系统：一定要加锁</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李江洋</span>

  

  
</div>


  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Pisces</span> v7.0.1</div>






  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/7.1.2/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>






















  
  
  <script id="ribbon" size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>





  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.1"></script>


  
  
  
  <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://ljyabc.github.io/2019/03/10/django笔记2/";
    this.page.identifier = "2019/03/10/django笔记2/";
    this.page.title = '\'django笔记2\'';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  

   <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
</body>
</html>
